<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>14.13. Python操作Rabbitmq详解 &mdash; 运维开发修炼之路</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="14.14. 打包和发布" href="14.%E6%89%93%E5%8C%85%E5%92%8C%E5%8F%91%E5%B8%83.html" />
    <link rel="prev" title="14.12. Python3读写Excel文件" href="12.Python3%E8%AF%BB%E5%86%99Excel%E6%96%87%E4%BB%B6.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> 小健_Python_go_Devops
            <img src="../../_static/python_go.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                2.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../Go/index.html">Go语言学习</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Go_vs_Python/index.html">Go vs Python</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Python全栈系列</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../01.Python%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/index.html">1. Python数据类型</a></li>
<li class="toctree-l2"><a class="reference internal" href="../02.Python%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6%E8%AF%AD%E5%8F%A5/index.html">2. Python流程控制语句</a></li>
<li class="toctree-l2"><a class="reference internal" href="../03.Python%E5%87%BD%E6%95%B0/index.html">3. Python函数</a></li>
<li class="toctree-l2"><a class="reference internal" href="../04.Python%E5%86%85%E5%BB%BA%E5%87%BD%E6%95%B0/index.html">4. Python内建函数</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05.Python%E6%8E%A8%E5%AF%BC%E5%BC%8F%E5%AD%A6%E4%B9%A0/index.html">5. Python推导式学习</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06.Python%E8%BF%AD%E4%BB%A3%E5%99%A8_%E7%94%9F%E6%88%90%E5%99%A8_%E8%A3%85%E9%A5%B0%E5%99%A8/index.html">6. Python生成器、迭代器、装饰器</a></li>
<li class="toctree-l2"><a class="reference internal" href="../07.Python%E9%9D%A2%E5%AF%B9%E5%AF%B9%E8%B1%A1%E8%AE%BE%E8%AE%A1_OOP/index.html">7. Python面对对象设计_OOP</a></li>
<li class="toctree-l2"><a class="reference internal" href="../08.Python%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86/index.html">8. Python异常处理</a></li>
<li class="toctree-l2"><a class="reference internal" href="../09.Python%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C/index.html">9. Python文件操作</a></li>
<li class="toctree-l2"><a class="reference internal" href="../10.Python%E4%B8%AD%E7%9A%84%E5%8C%85%E5%92%8C%E6%A8%A1%E5%9D%97/index.html">10. Python中包和模块</a></li>
<li class="toctree-l2"><a class="reference internal" href="../11.Python%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/index.html">11. Python正则表达式</a></li>
<li class="toctree-l2"><a class="reference internal" href="../12.Python%E6%A0%87%E5%87%86%E5%BA%93/index.html">12. Python 标准库学习</a></li>
<li class="toctree-l2"><a class="reference internal" href="../13.Python%E6%93%8D%E4%BD%9C%E6%95%B0%E6%8D%AE%E5%BA%93/index.html">13. Python对数据库的操作</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">14. Python 三方库学习</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="01.psutil%E6%A8%A1%E5%9D%97.html">14.1. psutil模块</a></li>
<li class="toctree-l3"><a class="reference internal" href="02.paramiko%28ssh%E7%A7%98%E9%92%A5%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4%29.html">14.2. paramiko(ssh秘钥执行命令)</a></li>
<li class="toctree-l3"><a class="reference internal" href="03.IPy%E6%A8%A1%E5%9D%97.html">14.3. IPy模块</a></li>
<li class="toctree-l3"><a class="reference internal" href="04.dnspython%E6%A8%A1%E5%9D%97.html">14.4. DNS处理模块dnspython</a></li>
<li class="toctree-l3"><a class="reference internal" href="05.difflib%E6%96%87%E6%9C%AC%E6%AF%94%E8%BE%83%E6%A8%A1%E5%9D%97.html">14.5. difflib文本比较模块</a></li>
<li class="toctree-l3"><a class="reference internal" href="06.pycurl%E6%8E%A2%E6%B5%8Bweb%E6%9C%8D%E5%8A%A1%E5%90%84%E9%A1%B9%E6%8C%87%E6%A0%87.html">14.6. pycurl探测web服务状态</a></li>
<li class="toctree-l3"><a class="reference internal" href="07.Excel%E6%93%8D%E4%BD%9CXlsxWriter%E6%A8%A1%E5%9D%97.html">14.7. Excel操作XlsxWriter模块</a></li>
<li class="toctree-l3"><a class="reference internal" href="08.%E4%BD%BF%E7%94%A8PyInstaller%E7%94%9F%E6%88%90%E5%8F%AF%E6%89%A7%E8%A1%8C%E7%A8%8B%E5%BA%8F.html">14.8. 使用PyInstaller生成可执行程序</a></li>
<li class="toctree-l3"><a class="reference internal" href="09.%E7%94%A8py2exe%E7%94%9F%E6%88%90%E5%8F%AF%E6%89%A7%E8%A1%8C%E7%A8%8B%E5%BA%8F.html">14.9. 用py2exe生成可执行程序</a></li>
<li class="toctree-l3"><a class="reference internal" href="10.%E7%94%A8cx_freeze%E7%94%9F%E6%88%90%E5%8F%AF%E6%89%A7%E8%A1%8C%E6%96%87%E4%BB%B6.html">14.10. 用cx_freeze生成可执行文件</a></li>
<li class="toctree-l3"><a class="reference internal" href="11.%E4%BD%BF%E7%94%A8python%E5%AE%9A%E6%97%B6%E6%89%A7%E8%A1%8C%E4%BB%BB%E5%8A%A1.html">14.11. 使用python定时执行任务</a></li>
<li class="toctree-l3"><a class="reference internal" href="12.Python3%E8%AF%BB%E5%86%99Excel%E6%96%87%E4%BB%B6.html">14.12. Python3读写Excel文件</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">14.13. Python操作Rabbitmq详解</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id1">14.13.1. python操作rabbitmq</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id2">14.13.2. 技术亮点</a></li>
<li class="toctree-l4"><a class="reference internal" href="#rabbitmq">14.13.3. RabbitMQ 消息队列介绍</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id5">14.13.4. 2.RabbitMq 持久化</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id6">14.13.5. 3.消息公平分发</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id7">14.13.6. 4.RabbitMq 发布与订阅</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="14.%E6%89%93%E5%8C%85%E5%92%8C%E5%8F%91%E5%B8%83.html">14.14. 打包和发布</a></li>
<li class="toctree-l3"><a class="reference internal" href="15.Jinja2%E6%A8%A1%E6%9D%BF.html">14.15. Jinja2模板</a></li>
<li class="toctree-l3"><a class="reference internal" href="16.python%E7%AC%AC%E4%B8%89%E6%96%B9%E5%BA%93request.html">14.16. Python第三方库requests学习笔记</a></li>
<li class="toctree-l3"><a class="reference internal" href="17.docker-py%E6%A8%A1%E5%9D%97%E7%9A%84%E7%94%A8%E6%B3%95.html">14.17. docker-py模块的用法</a></li>
<li class="toctree-l3"><a class="reference internal" href="18.python%E6%93%8D%E4%BD%9Ckubernetes.html">14.18. python操作kubernetes</a></li>
<li class="toctree-l3"><a class="reference internal" href="19.python%E8%AF%BB%E5%86%99yaml.html">14.19. python读写yaml</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../15.Python%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/index.html">15. Python 网络编程</a></li>
<li class="toctree-l2"><a class="reference internal" href="../16.Python%E7%BA%BF%E7%A8%8B%E5%92%8C%E8%BF%9B%E7%A8%8B/index.html">16. Python 进程和线程</a></li>
<li class="toctree-l2"><a class="reference internal" href="../17.Python%E8%AF%AD%E8%A8%80%E7%9A%84%E6%89%A9%E5%B1%95%E4%B8%8E%E5%B5%8C%E5%85%A5/index.html">17. Python与C语言扩展</a></li>
<li class="toctree-l2"><a class="reference internal" href="../18.%E7%B3%BB%E7%BB%9F%E7%AE%A1%E7%90%86%E5%91%98%E7%9A%84Python%E8%84%9A%E6%9C%AC%E7%BC%96%E7%A8%8B%E6%8C%87%E5%8D%97-%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/index.html">18. 系统管理员的Python脚本编程指南-读书笔记</a></li>
<li class="toctree-l2"><a class="reference internal" href="../20.Python%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/index.html">19. Python自动化运维最佳实践</a></li>
<li class="toctree-l2"><a class="reference internal" href="../21.Python%E8%BF%9B%E9%98%B6%E5%AD%A6%E4%B9%A0/index.html">20. Python进阶学习</a></li>
<li class="toctree-l2"><a class="reference internal" href="../22.Python%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB/index.html">21. Python网络爬虫</a></li>
<li class="toctree-l2"><a class="reference internal" href="../23.%E5%89%8D%E7%AB%AF%E6%8A%80%E6%9C%AF/index.html">22. 前端基础知识</a></li>
<li class="toctree-l2"><a class="reference internal" href="../24.Python%E6%A1%86%E6%9E%B6/index.html">23. Python框架</a></li>
<li class="toctree-l2"><a class="reference internal" href="../25.Python%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2/index.html">24. Python开发环境部署</a></li>
<li class="toctree-l2"><a class="reference internal" href="../26.%E6%88%91%E7%9A%84%E7%AC%AC%E4%B8%80%E6%9C%AC%E7%AE%97%E6%B3%95%E4%B9%A6/index.html">25. 我的第一本算法书</a></li>
<li class="toctree-l2"><a class="reference internal" href="../27.Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98/index.html">26. Python3网络爬虫开发实战</a></li>
<li class="toctree-l2"><a class="reference internal" href="../28.Python%E8%AE%A9%E7%B9%81%E7%90%90%E7%9A%84%E5%B7%A5%E4%BD%9C%E8%87%AA%E5%8A%A8%E5%8C%96/index.html">27. Python让繁琐的工作自动化</a></li>
<li class="toctree-l2"><a class="reference internal" href="../29.%E7%96%AF%E7%8B%82%E7%9A%84Python%E8%AE%B2%E4%B9%89/index.html">28. 疯狂的Python讲义</a></li>
<li class="toctree-l2"><a class="reference internal" href="../30.Django_Vue/index.html">29. Django_Vue</a></li>
<li class="toctree-l2"><a class="reference internal" href="../31.%E7%BC%96%E5%86%99Python%E7%9A%8490%E4%B8%AA%E6%9C%89%E6%95%88%E6%96%B9%E6%B3%95/index.html">30. 编写Python的90个有效方法</a></li>
<li class="toctree-l2"><a class="reference internal" href="../32.Vue3.0%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F/index.html">31. Vue3.0管理系统</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../Python%E6%B5%8B%E8%AF%95%E5%BC%80%E5%8F%91%E5%85%A5%E9%97%A8%E4%B8%8E%E5%AE%9E%E8%B7%B5/index.html">Python测试开发入门与实践</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Vue/index.html">Vue.js企业开发实战</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Vue_Node.js/index.html">Vue.js+Node.js开发实战</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">小健_Python_go_Devops</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html">Python全栈系列</a> &raquo;</li>
          <li><a href="index.html"><span class="section-number">14. </span>Python 三方库学习</a> &raquo;</li>
      <li><span class="section-number">14.13. </span>Python操作Rabbitmq详解</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/Python/14.Python三方库/13.Python操作Rabbitmq详解.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="contents topic" id="contents">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#pythonrabbitmq" id="id8">Python操作Rabbitmq详解</a></p>
<ul>
<li><p><a class="reference internal" href="#id1" id="id9">python操作rabbitmq</a></p></li>
<li><p><a class="reference internal" href="#id2" id="id10">技术亮点</a></p></li>
<li><p><a class="reference internal" href="#rabbitmq" id="id11">RabbitMQ 消息队列介绍</a></p>
<ul>
<li><p><a class="reference internal" href="#id3" id="id12">几个概念说明：</a></p></li>
<li><p><a class="reference internal" href="#id4" id="id13">1.RabbitMq生产和消费简单示例</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id5" id="id14">2.RabbitMq 持久化</a></p></li>
<li><p><a class="reference internal" href="#id6" id="id15">3.消息公平分发</a></p></li>
<li><p><a class="reference internal" href="#id7" id="id16">4.RabbitMq 发布与订阅</a></p>
<ul>
<li><p><a class="reference internal" href="#fanoutall" id="id17">模式一:fanout纯广播、all</a></p></li>
<li><p><a class="reference internal" href="#direct" id="id18">模式二:direct有选择的接收消息</a></p></li>
<li><p><a class="reference internal" href="#topic" id="id19">模式三:topic更细致的过滤</a></p></li>
<li><p><a class="reference internal" href="#rpc-remote-procedure-call" id="id20">RPC(Remote procedure call)</a></p></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<section id="pythonrabbitmq">
<h1><a class="toc-backref" href="#id8"><span class="section-number">14.13. </span>Python操作Rabbitmq详解</a><a class="headerlink" href="#pythonrabbitmq" title="Permalink to this headline">¶</a></h1>
<section id="id1">
<h2><a class="toc-backref" href="#id9"><span class="section-number">14.13.1. </span>python操作rabbitmq</a><a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p>RabbitMQ是消息代理，一个消息传递的中介。它给应用程序中一个共同的平台来发送和接收消息，并安全的保存消息，直到收到消息。</p>
<p>Rabbitmq由Erlang语言写成，以高性能、健壮以及可伸缩性著称。</p>
<p>你可以把Rabbitmq想象成一个邮局、邮箱、邮递员，你会相信邮递员最终会将邮件发送到收件人手上。
Rabbitmq不处理文件，而是接收，并存储和以二进制形式将消息转发。</p>
</section>
<section id="id2">
<h2><a class="toc-backref" href="#id10"><span class="section-number">14.13.2. </span>技术亮点</a><a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>可靠性
RabbitMQ 提供了多种技术可以让你在性能和可靠性之间进行权衡。这些技术包括持久性、投递确认、发布者证实和高可用性。

灵活的路由
消息在到达队列前是通过交换机进行路由的。RabbitMQ 为典型的路由逻辑提供了多种内置交换机类型。如果你有更复杂的路由需求，可以将这些交换机组合起来使用，甚至你可以写自己的交换机类型，并且当做 RabbitMQ 的插件来使用。

集群
在相同局域网中的多个 RabbitMQ 服务器可以被聚合在一起，作为一个独立的逻辑代理来使用。

联合
对于服务器来说，它比集群需要更多的松散和非可靠链接。为此 RabbitMQ 提供了联合模型。

高可用的队列
在同一个集群中，队列可以被镜像到多个机器中，以确保当其中某些硬件出现事故后，你的消息仍然是安全的。

多协议
RabbitMQ 支持多种消息协议中的消息传递。

广泛的客户端
只要是你能想到的语言几乎都有与其相适配的 RabbitMQ 客户端。

可视化管理工具
RabbitMQ 附带了一个易于使用的可视化管理工具，它可以帮助你监控消息代理的每一个环节。

追踪
如果你的消息系统有异常行为，RabbitMQ 还提供了追踪的支持，让你能够发现问题所在。

插件系统
RabbitMQ 附带了各种各样的插件来对自己进行扩展。甚至你也可以写自己的插件来使用。

商业支持
可以提供商业支持，包括培训和咨询。

大型社区
围绕着 RabbitMQ 有一个大型的社区，在那儿产生了各种各样的客户端、插件、指南等等。快加入我们的邮件列表参与其中吧！
</pre></div>
</div>
</section>
<section id="rabbitmq">
<h2><a class="toc-backref" href="#id11"><span class="section-number">14.13.3. </span>RabbitMQ 消息队列介绍</a><a class="headerlink" href="#rabbitmq" title="Permalink to this headline">¶</a></h2>
<p>RabbitMQ也是消息队列，那RabbitMQ和之前python的Queue有什么区别么？</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>py 消息队列:
    线程 queue（同一进程下线程之间进行交互）
    进程 Queue（父子进程进行交互 或者 同属于同一进程下的多个子进程进行交互）
</pre></div>
</div>
<p>如果是两个完全独立的python程序，也是不能用上面两个queue进行交互的，
或者和其他语言交互有哪些实现方式呢。</p>
<p>【Disk、Socket、其他中间件】这里中间件不仅可以支持两个程序之间交互，可以支持多个程序，
可以维护好多个程序的队列。</p>
<p>像这种公共的中间件有好多成熟的产品：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">RabbitMQ</span>
<span class="n">ZeroMQ</span>
<span class="n">ActiveMQ</span>
<span class="o">........</span>
</pre></div>
</div>
<p>RabbitMQ：erlang语言 开发的。</p>
<p>Python中连接RabbitMQ的模块：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>pika 、Celery(分布式任务队列) 、haigha可以维护很多的队列
</pre></div>
</div>
<p>RabbitMQ 教程官网：<a class="reference external" href="http://www.rabbitmq.com/getstarted.html">http://www.rabbitmq.com/getstarted.html</a></p>
<section id="id3">
<h3><a class="toc-backref" href="#id12">几个概念说明：</a><a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Broker：简单来说就是消息队列服务器实体。
Exchange：消息交换机，它指定消息按什么规则，路由到哪个队列。
Queue：消息队列载体，每个消息都会被投入到一个或多个队列。
Binding：绑定，它的作用就是把exchange和queue按照路由规则绑定起来。
Routing Key：路由关键字，exchange根据这个关键字进行消息投递。
vhost：虚拟主机，一个broker里可以开设多个vhost，用作不同用户的权限分离。
producer：消息生产者，就是投递消息的程序。
consumer：消息消费者，就是接受消息的程序。
channel：消息通道，在客户端的每个连接里，可建立多个channel，每个channel代表一个会话任务
</pre></div>
</div>
</section>
<section id="id4">
<h3><a class="toc-backref" href="#id13">1.RabbitMq生产和消费简单示例</a><a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<p>在本机安装有rabbitmq服务器的前提下。</p>
<img alt="../../_images/python_rabbitmq000002.png" src="../../_images/python_rabbitmq000002.png" />
<p>生产者（producter）：队列消息的产生者，负责生产消息，并将消息传入队列
producer.py</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># -*- coding:utf8 -*-</span>
<span class="c1"># auther; 18793</span>
<span class="c1"># Date：2020/1/7 17:01</span>
<span class="c1"># filename: producer.py</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">import</span> <span class="nn">pika</span>
<span class="kn">import</span> <span class="nn">json</span>

<span class="n">credentials</span> <span class="o">=</span> <span class="n">pika</span><span class="o">.</span><span class="n">PlainCredentials</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">)</span>  <span class="c1"># mq用户名和密码</span>
<span class="c1"># 虚拟队列需要指定参数 virtual_host，如果是默认的可以不填。</span>
<span class="n">connection</span> <span class="o">=</span> <span class="n">pika</span><span class="o">.</span><span class="n">BlockingConnection</span><span class="p">(</span>
    <span class="n">pika</span><span class="o">.</span><span class="n">ConnectionParameters</span><span class="p">(</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">5672</span><span class="p">))</span>

<span class="n">channel</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">channel</span><span class="p">()</span>      <span class="c1"># 声明一个管道，在管道里发消息</span>
<span class="c1"># 申明消息队列，消息在这个队列传递，如果不存在，则创建队列,在管道里声明queue</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="n">queue_declare</span><span class="p">(</span><span class="n">queue</span><span class="o">=</span><span class="s1">&#39;python-test&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">50</span><span class="p">):</span>
    <span class="n">message</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s1">&#39;OrderId&#39;</span><span class="p">:</span> <span class="s2">&quot;1000</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">i</span><span class="p">})</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="c1"># 向队列插入数值 routing_key是队列名</span>
    <span class="n">channel</span><span class="o">.</span><span class="n">basic_publish</span><span class="p">(</span><span class="n">exchange</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">routing_key</span><span class="o">=</span><span class="s1">&#39;python-test&#39;</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">message</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
<p>consumer.py</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># -*- coding:utf8 -*-</span>
<span class="c1"># auther; 18793</span>
<span class="c1"># Date：2020/1/7 17:02</span>
<span class="c1"># filename: consumer.py</span>

<span class="kn">import</span> <span class="nn">pika</span>

<span class="n">credentials</span> <span class="o">=</span> <span class="n">pika</span><span class="o">.</span><span class="n">PlainCredentials</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">)</span>  <span class="c1"># mq用户名和密码</span>
<span class="n">connection</span> <span class="o">=</span> <span class="n">pika</span><span class="o">.</span><span class="n">BlockingConnection</span><span class="p">(</span>
    <span class="n">pika</span><span class="o">.</span><span class="n">ConnectionParameters</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">5672</span><span class="p">))</span>

<span class="n">channel</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">channel</span><span class="p">()</span>      <span class="c1">## 声明一个管道，在管道里发消息</span>
<span class="c1"># 申明消息队列，消息在这个队列传递，如果不存在，则创建队列,在管道里声明queue</span>
<span class="n">channel</span><span class="o">.</span><span class="n">queue_declare</span><span class="p">(</span><span class="n">queue</span><span class="o">=</span><span class="s1">&#39;python-test&#39;</span><span class="p">,</span> <span class="n">durable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="c1"># 定义一个回调函数来处理消息队列中的消息，这里是打印出来</span>
<span class="k">def</span> <span class="nf">callback</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">properties</span><span class="p">,</span> <span class="n">body</span><span class="p">):</span>
    <span class="n">ch</span><span class="o">.</span><span class="n">basic_ack</span><span class="p">(</span><span class="n">delivery_tag</span><span class="o">=</span><span class="n">method</span><span class="o">.</span><span class="n">delivery_tag</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">body</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>


<span class="c1"># 告诉rabbitmq，用callback来接收消息</span>
<span class="n">channel</span><span class="o">.</span><span class="n">basic_consume</span><span class="p">(</span><span class="s1">&#39;python-test&#39;</span><span class="p">,</span> <span class="n">callback</span><span class="p">)</span>
<span class="c1"># 开始接收信息，并进入阻塞状态，队列里有信息才会调用callback进行处理</span>
<span class="n">channel</span><span class="o">.</span><span class="n">start_consuming</span><span class="p">()</span>
</pre></div>
</div>
<p>执行生产者，生成消息队列。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">root</span><span class="nd">@ftnode</span><span class="o">-</span><span class="mi">172</span><span class="o">-</span><span class="mi">16</span><span class="o">-</span><span class="mi">72</span><span class="o">-</span><span class="mi">19</span> <span class="n">module</span><span class="p">]</span><span class="c1"># python producer.py</span>

<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;10000&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;10001&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;10002&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;10003&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;10004&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;10005&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;10006&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;10007&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;10008&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;10009&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;100010&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;100011&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;100012&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;100013&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;100014&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;100015&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;100016&quot;</span><span class="p">}</span>
</pre></div>
</div>
<p>查看消息队列中数据</p>
<p>RabbitMQ 相关命令</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">root</span><span class="nd">@ftnode</span><span class="o">-</span><span class="mi">172</span><span class="o">-</span><span class="mi">16</span><span class="o">-</span><span class="mi">72</span><span class="o">-</span><span class="mi">19</span> <span class="n">module</span><span class="p">]</span><span class="c1"># rabbitmqctl list_queues</span>
<span class="n">WARNING</span><span class="p">:</span> <span class="n">ignoring</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">rabbitmq</span><span class="o">/</span><span class="n">rabbitmq</span><span class="o">.</span><span class="n">conf</span> <span class="o">--</span> <span class="n">location</span> <span class="n">has</span> <span class="n">moved</span> <span class="n">to</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">rabbitmq</span><span class="o">/</span><span class="n">rabbitmq</span><span class="o">-</span><span class="n">env</span><span class="o">.</span><span class="n">conf</span>
<span class="n">Listing</span> <span class="n">queues</span> <span class="o">...</span>
<span class="n">hello</span>   <span class="mi">2</span>
<span class="n">python</span><span class="o">-</span><span class="n">test</span> <span class="mi">50</span>
</pre></div>
</div>
<p>python-test这个队列里面有50条数据，暂未处理。</p>
<p>执行消费者 consumer.py</p>
<p>消费者会一直阻塞在这里，等待有新的队列信息进来。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">root</span><span class="o">@</span><span class="mi">172</span><span class="o">-</span><span class="mi">16</span><span class="o">-</span><span class="mi">72</span><span class="o">-</span><span class="mi">19</span> <span class="n">module</span><span class="p">]</span><span class="c1"># python consumer.py</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;10000&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;10001&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;10002&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;10003&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;10004&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;10005&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;10006&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;10007&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;10008&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;10009&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;100010&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;100011&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;100012&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;100013&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;100014&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;100015&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;100016&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;100017&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;100018&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;100019&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;100020&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;100021&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;100022&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;100023&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;100024&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;100025&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;100026&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;100027&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;100028&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;100029&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;100030&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;100031&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;100032&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;100033&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;100034&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;100035&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;100036&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;100037&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;100038&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;100039&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;100040&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;100041&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;100042&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;100043&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;100044&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;100045&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;100046&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;100047&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;100048&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;100049&quot;</span><span class="p">}</span>
</pre></div>
</div>
<p>再次查看队列里面的信息如下：</p>
<p>已经全部取出。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">root</span><span class="nd">@ftnode</span><span class="o">-</span><span class="mi">172</span><span class="o">-</span><span class="mi">16</span><span class="o">-</span><span class="mi">72</span><span class="o">-</span><span class="mi">19</span> <span class="n">module</span><span class="p">]</span><span class="c1"># rabbitmqctl list_queues</span>
<span class="n">WARNING</span><span class="p">:</span> <span class="n">ignoring</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">rabbitmq</span><span class="o">/</span><span class="n">rabbitmq</span><span class="o">.</span><span class="n">conf</span> <span class="o">--</span> <span class="n">location</span> <span class="n">has</span> <span class="n">moved</span> <span class="n">to</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">rabbitmq</span><span class="o">/</span><span class="n">rabbitmq</span><span class="o">-</span><span class="n">env</span><span class="o">.</span><span class="n">conf</span>
<span class="n">Listing</span> <span class="n">queues</span> <span class="o">...</span>
<span class="n">hello</span>   <span class="mi">2</span>
<span class="n">python</span><span class="o">-</span><span class="n">test</span> <span class="mi">0</span>
<span class="o">...</span><span class="n">done</span><span class="o">.</span>
</pre></div>
</div>
</section>
</section>
<section id="id5">
<h2><a class="toc-backref" href="#id14"><span class="section-number">14.13.4. </span>2.RabbitMq 持久化</a><a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h2>
<p>MQ默认建立的是临时 queue 和 exchange，如果不声明持久化，一旦 rabbitmq
挂掉，queue、exchange 将会全部丢失。 所以我们一般在创建 queue 或者
exchange 的时候会声明 持久化。</p>
<p>1.queue 声明持久化</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># 声明消息队列，消息将在这个队列传递，如不存在，则创建。durable = True 代表消息队列持久化存储，False 非持久化存储</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="n">queue_declare</span><span class="p">(</span><span class="n">queue</span> <span class="o">=</span> <span class="s1">&#39;python-test&#39;</span><span class="p">,</span><span class="n">durable</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>2.exchange 声明持久化</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># 声明exchange，由exchange指定消息在哪个队列传递，如不存在，则创建.durable = True 代表exchange持久化存储，False 非持久化存储</span>
<span class="n">channel</span><span class="o">.</span><span class="n">exchange_declare</span><span class="p">(</span><span class="n">exchange</span> <span class="o">=</span> <span class="s1">&#39;python-test&#39;</span><span class="p">,</span> <span class="n">durable</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>注意：如果已存在一个非持久化的 queue 或 exchange
，执行上述代码会报错，因为当前状态不能更改 queue 或 exchange
存储属性，需要删除重建。 如果 queue 和 exchange
中一个声明了持久化，另一个没有声明持久化，则不允许绑定。</p>
<p>3.消息持久化</p>
<p>虽然 exchange 和 queue 都申明了持久化，但如果消息只存在内存里，rabbitmq
重启后，内存里的东西还是会丢失。所以必须声明消息也是持久化，从内存转存到硬盘。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># 向队列插入数值 routing_key是队列名。delivery_mode = 2 声明消息在队列中持久化，delivery_mod = 1 消息非持久化</span>
    <span class="n">channel</span><span class="o">.</span><span class="n">basic_publish</span><span class="p">(</span><span class="n">exchange</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">routing_key</span> <span class="o">=</span> <span class="s1">&#39;python-test&#39;</span><span class="p">,</span><span class="n">body</span> <span class="o">=</span> <span class="n">message</span><span class="p">,</span>
                          <span class="n">properties</span><span class="o">=</span><span class="n">pika</span><span class="o">.</span><span class="n">BasicProperties</span><span class="p">(</span><span class="n">delivery_mode</span> <span class="o">=</span> <span class="mi">2</span><span class="p">))</span>
</pre></div>
</div>
<p>4.acknowledgement 消息不丢失</p>
<p>消费者（consumer）调用callback函数时，会存在处理消息失败的风险，如果处理失败，则消息丢失。但是也可以选择消费者处理失败时，将消息回退给
rabbitmq ，重新再被消费者消费，这个时候需要设置确认标识。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">channel</span><span class="o">.</span><span class="n">basic_consume</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span><span class="n">queue</span> <span class="o">=</span> <span class="s1">&#39;python-test&#39;</span><span class="p">,</span>
<span class="c1"># no_ack 设置成 False，在调用callback函数时，未收到确认标识，消息会重回队列。True，无论调用callback成功与否，消息都被消费掉</span>
                      <span class="n">no_ack</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<p>示例</p>
<p>通过远程连接rabbitmq-Server服务器。</p>
<p>producer.py</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># -*- coding:utf8 -*-</span>
<span class="c1"># auther; 18793</span>
<span class="c1"># Date：2020/1/7 17:01</span>
<span class="c1"># filename: producer.py</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">import</span> <span class="nn">pika</span>
<span class="kn">import</span> <span class="nn">json</span>

<span class="n">credentials</span> <span class="o">=</span> <span class="n">pika</span><span class="o">.</span><span class="n">PlainCredentials</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">)</span>  <span class="c1"># mq用户名和密码</span>
<span class="c1"># 虚拟队列需要指定参数 virtual_host，如果是默认的可以不填。</span>
<span class="n">connection</span> <span class="o">=</span> <span class="n">pika</span><span class="o">.</span><span class="n">BlockingConnection</span><span class="p">(</span>
    <span class="n">pika</span><span class="o">.</span><span class="n">ConnectionParameters</span><span class="p">(</span><span class="s1">&#39;172.16.72.19&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">5672</span><span class="p">,</span> <span class="n">virtual_host</span><span class="o">=</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">credentials</span><span class="o">=</span><span class="n">credentials</span><span class="p">))</span>

<span class="n">channel</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">channel</span><span class="p">()</span>  <span class="c1"># 声明一个管道，在管道里发消息</span>

<span class="c1"># 申明消息队列，消息在这个队列传递，如果不存在，则创建队列,在管道里声明queue</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="n">queue_declare</span><span class="p">(</span><span class="n">queue</span><span class="o">=</span><span class="s1">&#39;python-test&#39;</span><span class="p">,</span> <span class="n">durable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">50</span><span class="p">):</span>
    <span class="n">message</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s1">&#39;OrderId&#39;</span><span class="p">:</span> <span class="s2">&quot;1000</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">i</span><span class="p">})</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="c1"># 向队列插入数值 routing_key是队列名</span>
    <span class="n">channel</span><span class="o">.</span><span class="n">basic_publish</span><span class="p">(</span><span class="n">exchange</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">routing_key</span><span class="o">=</span><span class="s1">&#39;python-test&#39;</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">message</span><span class="p">,</span>
                          <span class="n">properties</span><span class="o">=</span><span class="n">pika</span><span class="o">.</span><span class="n">BasicProperties</span><span class="p">(</span><span class="n">delivery_mode</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
<p>consumer.py</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># -*- coding:utf8 -*-</span>
<span class="c1"># auther; 18793</span>
<span class="c1"># Date：2020/1/7 17:02</span>
<span class="c1"># filename: consumer.py</span>

<span class="kn">import</span> <span class="nn">pika</span>

<span class="n">credentials</span> <span class="o">=</span> <span class="n">pika</span><span class="o">.</span><span class="n">PlainCredentials</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">)</span>  <span class="c1"># mq用户名和密码</span>
<span class="c1"># 虚拟队列需要指定参数 virtual_host，如果是默认的可以不填。</span>
<span class="n">connection</span> <span class="o">=</span> <span class="n">pika</span><span class="o">.</span><span class="n">BlockingConnection</span><span class="p">(</span>
    <span class="n">pika</span><span class="o">.</span><span class="n">ConnectionParameters</span><span class="p">(</span><span class="s1">&#39;172.16.72.19&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">5672</span><span class="p">,</span> <span class="n">virtual_host</span><span class="o">=</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">credentials</span><span class="o">=</span><span class="n">credentials</span><span class="p">))</span>

<span class="n">channel</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">channel</span><span class="p">()</span>  <span class="c1">## 声明一个管道，在管道里发消息</span>

<span class="c1"># 申明消息队列，消息在这个队列传递，如果不存在，则创建队列,在管道里声明queue</span>
<span class="n">channel</span><span class="o">.</span><span class="n">queue_declare</span><span class="p">(</span><span class="n">queue</span><span class="o">=</span><span class="s1">&#39;python-test&#39;</span><span class="p">,</span> <span class="n">durable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="c1"># 定义一个回调函数来处理消息队列中的消息，这里是打印出来</span>
<span class="k">def</span> <span class="nf">callback</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">properties</span><span class="p">,</span> <span class="n">body</span><span class="p">):</span>
    <span class="n">ch</span><span class="o">.</span><span class="n">basic_ack</span><span class="p">(</span><span class="n">delivery_tag</span><span class="o">=</span><span class="n">method</span><span class="o">.</span><span class="n">delivery_tag</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">body</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>


<span class="c1"># 告诉rabbitmq，用callback来接收消息.</span>
<span class="n">channel</span><span class="o">.</span><span class="n">basic_consume</span><span class="p">(</span><span class="s1">&#39;python-test&#39;</span><span class="p">,</span> <span class="n">callback</span><span class="p">)</span>        <span class="c1">#acknowledgement 消息不丢失</span>

<span class="c1"># 开始接收信息，并进入阻塞状态，队列里有信息才会调用callback进行处理</span>
<span class="n">channel</span><span class="o">.</span><span class="n">start_consuming</span><span class="p">()</span>
</pre></div>
</div>
<p>向队列里面放入持久化的数据</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">root</span><span class="nd">@ftnode</span><span class="o">-</span><span class="mi">172</span><span class="o">-</span><span class="mi">16</span><span class="o">-</span><span class="mi">72</span><span class="o">-</span><span class="mi">19</span> <span class="n">module</span><span class="p">]</span><span class="c1"># python producer.py</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;10000&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;10001&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;10002&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;10003&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;10004&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;10005&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;10006&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;10007&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;10008&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;10009&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;100010&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;100011&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;100012&quot;</span><span class="p">}</span>
<span class="o">...........</span>


<span class="p">[</span><span class="n">root</span><span class="nd">@ftnode</span><span class="o">-</span><span class="mi">172</span><span class="o">-</span><span class="mi">16</span><span class="o">-</span><span class="mi">72</span><span class="o">-</span><span class="mi">19</span> <span class="n">module</span><span class="p">]</span><span class="c1"># rabbitmqctl list_queues</span>
<span class="n">WARNING</span><span class="p">:</span> <span class="n">ignoring</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">rabbitmq</span><span class="o">/</span><span class="n">rabbitmq</span><span class="o">.</span><span class="n">conf</span> <span class="o">--</span> <span class="n">location</span> <span class="n">has</span> <span class="n">moved</span> <span class="n">to</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">rabbitmq</span><span class="o">/</span><span class="n">rabbitmq</span><span class="o">-</span><span class="n">env</span><span class="o">.</span><span class="n">conf</span>
<span class="n">Listing</span> <span class="n">queues</span> <span class="o">...</span>
<span class="n">hello</span>   <span class="mi">2</span>
<span class="n">python</span><span class="o">-</span><span class="n">test</span> <span class="mi">0</span>
<span class="n">python</span><span class="o">-</span><span class="n">test2</span>    <span class="mi">82</span>
</pre></div>
</div>
<p>运行消费者</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">root</span><span class="o">@</span><span class="mi">172</span><span class="o">-</span><span class="mi">16</span><span class="o">-</span><span class="mi">72</span><span class="o">-</span><span class="mi">19</span> <span class="n">module</span><span class="p">]</span><span class="c1"># python consumer.py</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;10000&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;10001&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;10002&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;10003&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;10004&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;10005&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;10006&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;10007&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;10008&quot;</span><span class="p">}</span>
<span class="o">.........</span>
</pre></div>
</div>
</section>
<section id="id6">
<h2><a class="toc-backref" href="#id15"><span class="section-number">14.13.5. </span>3.消息公平分发</a><a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h2>
<p>每一个消费者同时只处理一个任务，比如说现在有三个消费者，刚开始来了三个任务，平均分配给了三个消费者，
那么这三个消费者目前都在同时执行任务，当第四个任务到来的时候依旧会分配给第一个消费者，
第五个任务到来的时候会分配给第二个消费者，以此类推。</p>
<p>那么以上的状况有什么不妥呢？譬如说不同的消费者执行任务的时间不同，
我们现在需要的时候，当三个消费者都在执行任务的时候，
比如说第二个消费者任务执行完了，其他消费者都还在执行任务，
当第四个任务到来的时候希望交给第二个消费者，若要实现此功能，只需要在消费者加上一下代码即可：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">channel</span><span class="o">.</span><span class="n">basic_qos</span><span class="p">(</span><span class="n">prefetch_count</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<div class="line-block">
<div class="line">发布者</div>
<div class="line">producer.py</div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1">#-*- coding:utf8 -*-</span>
<span class="c1"># auther; 18793</span>
<span class="c1"># Date：2020/1/8 12:44</span>
<span class="c1"># filename: producer.py</span>

<span class="kn">import</span> <span class="nn">pika</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">credentials</span> <span class="o">=</span> <span class="n">pika</span><span class="o">.</span><span class="n">PlainCredentials</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">)</span>  <span class="c1"># mq用户名和密码</span>
<span class="c1"># 虚拟队列需要指定参数 virtual_host，如果是默认的可以不填。</span>
<span class="n">connection</span> <span class="o">=</span> <span class="n">pika</span><span class="o">.</span><span class="n">BlockingConnection</span><span class="p">(</span>
    <span class="n">pika</span><span class="o">.</span><span class="n">ConnectionParameters</span><span class="p">(</span><span class="s1">&#39;172.16.72.19&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">5672</span><span class="p">,</span> <span class="n">virtual_host</span><span class="o">=</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">credentials</span><span class="o">=</span><span class="n">credentials</span><span class="p">))</span>

<span class="n">channel</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">channel</span><span class="p">()</span>

<span class="n">channel</span><span class="o">.</span><span class="n">queue_declare</span><span class="p">(</span><span class="n">queue</span><span class="o">=</span><span class="s1">&#39;task_queue&#39;</span><span class="p">,</span> <span class="n">durable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Hello World! </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">channel</span><span class="o">.</span><span class="n">basic_publish</span><span class="p">(</span><span class="n">exchange</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                          <span class="n">routing_key</span><span class="o">=</span><span class="s1">&#39;task_queue&#39;</span><span class="p">,</span>
                          <span class="n">body</span><span class="o">=</span><span class="n">message</span><span class="p">,</span>
                          <span class="n">properties</span><span class="o">=</span><span class="n">pika</span><span class="o">.</span><span class="n">BasicProperties</span><span class="p">(</span>
                              <span class="n">delivery_mode</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>  <span class="c1"># make message persistent</span>
                          <span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; [x] Sent </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>
<span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
<p>订阅者 consumer.py</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># -*- coding:utf8 -*-</span>
<span class="c1"># auther; 18793</span>
<span class="c1"># Date：2020/1/8 12:44</span>
<span class="c1"># filename: consumer.py</span>
<span class="kn">import</span> <span class="nn">pika</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="n">credentials</span> <span class="o">=</span> <span class="n">pika</span><span class="o">.</span><span class="n">PlainCredentials</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">)</span>  <span class="c1"># mq用户名和密码</span>
<span class="c1"># 虚拟队列需要指定参数 virtual_host，如果是默认的可以不填。</span>
<span class="n">connection</span> <span class="o">=</span> <span class="n">pika</span><span class="o">.</span><span class="n">BlockingConnection</span><span class="p">(</span>
    <span class="n">pika</span><span class="o">.</span><span class="n">ConnectionParameters</span><span class="p">(</span><span class="s1">&#39;172.16.72.19&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">5672</span><span class="p">,</span> <span class="n">virtual_host</span><span class="o">=</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">credentials</span><span class="o">=</span><span class="n">credentials</span><span class="p">))</span>
<span class="n">channel</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">channel</span><span class="p">()</span>

<span class="n">channel</span><span class="o">.</span><span class="n">queue_declare</span><span class="p">(</span><span class="n">queue</span><span class="o">=</span><span class="s1">&#39;task_queue&#39;</span><span class="p">,</span> <span class="n">durable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39; [*] Waiting for messages. To exit press CTRL+C&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">callback</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">properties</span><span class="p">,</span> <span class="n">body</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; [x] Received </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">body</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; [x] Done&quot;</span><span class="p">)</span>
    <span class="n">ch</span><span class="o">.</span><span class="n">basic_ack</span><span class="p">(</span><span class="n">delivery_tag</span><span class="o">=</span><span class="n">method</span><span class="o">.</span><span class="n">delivery_tag</span><span class="p">)</span>
</pre></div>
</div>
<p>消费者一直监听，执行如下：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">root</span><span class="nd">@ftnode</span><span class="o">-</span><span class="mi">172</span><span class="o">-</span><span class="mi">16</span><span class="o">-</span><span class="mi">72</span><span class="o">-</span><span class="mi">19</span> <span class="n">ftinstall</span><span class="o">.</span><span class="n">v3</span><span class="o">.</span><span class="mi">5</span><span class="o">-</span><span class="n">distributed</span><span class="p">]</span><span class="c1"># python consumer.py</span>
 <span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Waiting</span> <span class="k">for</span> <span class="n">messages</span><span class="o">.</span> <span class="n">To</span> <span class="n">exit</span> <span class="n">press</span> <span class="n">CTRL</span><span class="o">+</span><span class="n">C</span>
 <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="n">Received</span> <span class="s1">&#39;Hello World! 3&#39;</span>
 <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="n">Done</span>
 <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="n">Received</span> <span class="s1">&#39;Hello World! 4&#39;</span>
 <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="n">Done</span>
 <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="n">Received</span> <span class="s1">&#39;Hello World! 5&#39;</span>
 <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="n">Done</span>
 <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="n">Received</span> <span class="s1">&#39;Hello World! 6&#39;</span>
 <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="n">Done</span>
 <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="n">Received</span> <span class="s1">&#39;Hello World! 7&#39;</span>
 <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="n">Done</span>
 <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="n">Received</span> <span class="s1">&#39;Hello World! 8&#39;</span>
 <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="n">Done</span>
 <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="n">Received</span> <span class="s1">&#39;Hello World! 9&#39;</span>
</pre></div>
</div>
<p>生产者，往里面送数据</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">root</span><span class="nd">@ftnode</span><span class="o">-</span><span class="mi">172</span><span class="o">-</span><span class="mi">16</span><span class="o">-</span><span class="mi">72</span><span class="o">-</span><span class="mi">19</span> <span class="n">ftinstall</span><span class="o">.</span><span class="n">v3</span><span class="o">.</span><span class="mi">5</span><span class="o">-</span><span class="n">distributed</span><span class="p">]</span><span class="c1"># python producer.py</span>
 <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="n">Sent</span> <span class="s1">&#39;Hello World! 1&#39;</span>
 <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="n">Sent</span> <span class="s1">&#39;Hello World! 2&#39;</span>
 <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="n">Sent</span> <span class="s1">&#39;Hello World! 3&#39;</span>
 <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="n">Sent</span> <span class="s1">&#39;Hello World! 4&#39;</span>
 <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="n">Sent</span> <span class="s1">&#39;Hello World! 5&#39;</span>
 <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="n">Sent</span> <span class="s1">&#39;Hello World! 6&#39;</span>
 <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="n">Sent</span> <span class="s1">&#39;Hello World! 7&#39;</span>
 <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="n">Sent</span> <span class="s1">&#39;Hello World! 8&#39;</span>
 <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="n">Sent</span> <span class="s1">&#39;Hello World! 9&#39;</span>
 <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="n">Sent</span> <span class="s1">&#39;Hello World! 10&#39;</span>
</pre></div>
</div>
</section>
<section id="id7">
<h2><a class="toc-backref" href="#id16"><span class="section-number">14.13.6. </span>4.RabbitMq 发布与订阅</a><a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h2>
<p>rabbitmq 的发布与订阅要借助交换机（Exchange）的原理实现：</p>
<img alt="../../_images/python_rabbitmq00001.png" src="../../_images/python_rabbitmq00001.png" />
<p>· <code class="docutils literal notranslate"><span class="pre">Exchange</span> <span class="pre">一共有三种工作模式：fanout,</span> <span class="pre">direct,</span> <span class="pre">topicd</span></code></p>
<section id="fanoutall">
<h3><a class="toc-backref" href="#id17">模式一:fanout纯广播、all</a><a class="headerlink" href="#fanoutall" title="Permalink to this headline">¶</a></h3>
<p>这种模式下，传递到 exchange 的消息将会转发到所有与其绑定的 queue 上。
<img alt="image1" src="../../_images/python_rabbitmq000003.png" /></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>不需要指定 routing_key ，即使指定了也是无效。
需要提前将 exchange 和 queue 绑定，一个 exchange 可以绑定多个 queue，一个queue可以绑定多个exchange。
需要先启动 订阅者，此模式下的队列是 consumer 随机生成的，发布者 仅仅发布消息到 exchange ，由 exchange 转发消息至 queue。
</pre></div>
</div>
<p>· <code class="docutils literal notranslate"><span class="pre">注意：广播，是实时的，收不到就没了，消息不会存下来，类似收音机。</span></code></p>
<p>· producer01.py</p>
<p>发布者</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># -*- coding:utf8 -*-</span>
<span class="c1"># auther; 18793</span>
<span class="c1"># Date：2020/1/7 17:01</span>
<span class="c1"># filename: producer01.py</span>
<span class="kn">import</span> <span class="nn">pika</span>
<span class="kn">import</span> <span class="nn">json</span>

<span class="n">credentials</span> <span class="o">=</span> <span class="n">pika</span><span class="o">.</span><span class="n">PlainCredentials</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">)</span>  <span class="c1"># mq用户名和密码</span>
<span class="c1"># 虚拟队列需要指定参数 virtual_host，如果是默认的可以不填。</span>
<span class="n">connection</span> <span class="o">=</span> <span class="n">pika</span><span class="o">.</span><span class="n">BlockingConnection</span><span class="p">(</span>
    <span class="n">pika</span><span class="o">.</span><span class="n">ConnectionParameters</span><span class="p">(</span><span class="s1">&#39;172.16.72.19&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">5672</span><span class="p">,</span> <span class="n">virtual_host</span><span class="o">=</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">credentials</span><span class="o">=</span><span class="n">credentials</span><span class="p">))</span>

<span class="n">channel</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">channel</span><span class="p">()</span>
<span class="c1"># 声明exchange，由exchange指定消息在哪个队列传递，如不存在，则创建。durable = True 代表exchange持久化存储，False 非持久化存储</span>
<span class="n">channel</span><span class="o">.</span><span class="n">exchange_declare</span><span class="p">(</span><span class="n">exchange</span><span class="o">=</span><span class="s1">&#39;python-test&#39;</span><span class="p">,</span> <span class="n">durable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exchange_type</span><span class="o">=</span><span class="s1">&#39;fanout&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">):</span>
    <span class="n">message</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s1">&#39;OrderId&#39;</span><span class="p">:</span> <span class="s2">&quot;1000</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">i</span><span class="p">})</span>
    <span class="c1"># 向队列插入数值 routing_key是队列名。delivery_mode = 2 声明消息在队列中持久化，delivery_mod = 1 消息非持久化。routing_key 不需要配置</span>
    <span class="n">channel</span><span class="o">.</span><span class="n">basic_publish</span><span class="p">(</span><span class="n">exchange</span><span class="o">=</span><span class="s1">&#39;python-test&#39;</span><span class="p">,</span> <span class="n">routing_key</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">message</span><span class="p">,</span>
                          <span class="n">properties</span><span class="o">=</span><span class="n">pika</span><span class="o">.</span><span class="n">BasicProperties</span><span class="p">(</span><span class="n">delivery_mode</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># 广播数据不会存储</span>
<span class="p">[</span><span class="n">root</span><span class="nd">@ftnode</span><span class="o">-</span><span class="mi">172</span><span class="o">-</span><span class="mi">16</span><span class="o">-</span><span class="mi">72</span><span class="o">-</span><span class="mi">19</span> <span class="n">module</span><span class="p">]</span><span class="c1"># python producer.py</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;10000&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;10001&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;10002&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;10003&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;10004&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;10005&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;10006&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;10007&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;10008&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;10009&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;OrderId&quot;</span><span class="p">:</span> <span class="s2">&quot;100010&quot;</span><span class="p">}</span>
<span class="p">[</span><span class="n">root</span><span class="nd">@ftnode</span><span class="o">-</span><span class="mi">172</span><span class="o">-</span><span class="mi">16</span><span class="o">-</span><span class="mi">72</span><span class="o">-</span><span class="mi">19</span> <span class="n">module</span><span class="p">]</span><span class="c1"># rabbitmqctl list_queues</span>
<span class="n">WARNING</span><span class="p">:</span> <span class="n">ignoring</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">rabbitmq</span><span class="o">/</span><span class="n">rabbitmq</span><span class="o">.</span><span class="n">conf</span> <span class="o">--</span> <span class="n">location</span> <span class="n">has</span> <span class="n">moved</span> <span class="n">to</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">rabbitmq</span><span class="o">/</span><span class="n">rabbitmq</span><span class="o">-</span><span class="n">env</span><span class="o">.</span><span class="n">conf</span>
<span class="n">Listing</span> <span class="n">queues</span> <span class="o">...</span>
<span class="o">...</span><span class="n">done</span><span class="o">.</span>
</pre></div>
</div>
<p>· consumer01.py</p>
<p>执行订阅者，先阻塞着，等待生产者产生数据，因为是广播，不会存储到队列中。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># -*- coding:utf8 -*-</span>
<span class="c1"># auther; 18793</span>
<span class="c1"># Date：2020/1/7 17:01</span>
<span class="kn">import</span> <span class="nn">pika</span>

<span class="n">credentials</span> <span class="o">=</span> <span class="n">pika</span><span class="o">.</span><span class="n">PlainCredentials</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">)</span>  <span class="c1"># mq用户名和密码</span>
<span class="c1"># 虚拟队列需要指定参数 virtual_host，如果是默认的可以不填。</span>
<span class="n">connection</span> <span class="o">=</span> <span class="n">pika</span><span class="o">.</span><span class="n">BlockingConnection</span><span class="p">(</span>
    <span class="n">pika</span><span class="o">.</span><span class="n">ConnectionParameters</span><span class="p">(</span><span class="s1">&#39;172.16.72.19&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">5672</span><span class="p">,</span> <span class="n">virtual_host</span><span class="o">=</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">credentials</span><span class="o">=</span><span class="n">credentials</span><span class="p">))</span>

<span class="n">channel</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">channel</span><span class="p">()</span>
<span class="c1"># 创建临时队列,队列名传空字符，consumer关闭后，队列自动删除</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="n">queue_declare</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">exclusive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1"># 声明exchange，由exchange指定消息在哪个队列传递，如不存在，则创建。durable = True 代表exchange持久化存储，False 非持久化存储</span>
<span class="n">channel</span><span class="o">.</span><span class="n">exchange_declare</span><span class="p">(</span><span class="n">exchange</span><span class="o">=</span><span class="s1">&#39;python-test&#39;</span><span class="p">,</span> <span class="n">durable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exchange_type</span><span class="o">=</span><span class="s1">&#39;fanout&#39;</span><span class="p">)</span>
<span class="c1"># 绑定exchange和队列  exchange 使我们能够确切地指定消息应该到哪个队列去</span>
<span class="n">channel</span><span class="o">.</span><span class="n">queue_bind</span><span class="p">(</span><span class="n">exchange</span><span class="o">=</span><span class="s1">&#39;python-test&#39;</span><span class="p">,</span> <span class="n">queue</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">method</span><span class="o">.</span><span class="n">queue</span><span class="p">)</span>


<span class="c1"># 定义一个回调函数来处理消息队列中的消息，这里是打印出来</span>
<span class="k">def</span> <span class="nf">callback</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">properties</span><span class="p">,</span> <span class="n">body</span><span class="p">):</span>
    <span class="n">ch</span><span class="o">.</span><span class="n">basic_ack</span><span class="p">(</span><span class="n">delivery_tag</span><span class="o">=</span><span class="n">method</span><span class="o">.</span><span class="n">delivery_tag</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">body</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>


<span class="n">channel</span><span class="o">.</span><span class="n">basic_consume</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">method</span><span class="o">.</span><span class="n">queue</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span>
                      <span class="c1"># 设置成 False，在调用callback函数时，未收到确认标识，消息会重回队列。True，无论调用callback成功与否，消息都被消费掉</span>
                      <span class="n">auto_ack</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">channel</span><span class="o">.</span><span class="n">start_consuming</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="direct">
<h3><a class="toc-backref" href="#id18">模式二:direct有选择的接收消息</a><a class="headerlink" href="#direct" title="Permalink to this headline">¶</a></h3>
<p>direct(关键字)
RabbitMQ还支持根据关键字发送，即：队列绑定关键字，发送者将数据根据关键字发送到消息exchange，exchange根据
关键字 判定应该将数据发送至指定队列。</p>
<img alt="../../_images/python_rabbitmq000004.png" src="../../_images/python_rabbitmq000004.png" />
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>这种工作模式的原理是 消息发送至 exchange，

exchange 根据 路由键（routing_key）转发到相对应的 queue 上。

  可以使用默认 exchange =&#39; &#39; ，也可以自定义 exchange这种模式下不需要将 exchange 和 任何进行绑定，当然绑定也是可以的。可以将 exchange 和 queue ，routing_key 和 queue 进行绑定
传递或接受消息时 需要 指定 routing_key
需要先启动 订阅者，此模式下的队列是 consumer 随机生成的，发布者 仅仅发布消息到 exchange ，由 exchange 转发消息至 queue。
</pre></div>
</div>
<p>producer02.py</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># -*- coding:utf8 -*-</span>
<span class="c1"># auther; 18793</span>
<span class="c1"># Date：2020/1/8 10:15</span>
<span class="c1"># filename: producer02.py</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">pika</span>

<span class="n">credentials</span> <span class="o">=</span> <span class="n">pika</span><span class="o">.</span><span class="n">PlainCredentials</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">)</span>  <span class="c1"># mq用户名和密码</span>
<span class="c1"># 虚拟队列需要指定参数 virtual_host，如果是默认的可以不填。</span>
<span class="n">connection</span> <span class="o">=</span> <span class="n">pika</span><span class="o">.</span><span class="n">BlockingConnection</span><span class="p">(</span>
    <span class="n">pika</span><span class="o">.</span><span class="n">ConnectionParameters</span><span class="p">(</span><span class="s1">&#39;172.16.72.19&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">5672</span><span class="p">,</span> <span class="n">virtual_host</span><span class="o">=</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">credentials</span><span class="o">=</span><span class="n">credentials</span><span class="p">))</span>
<span class="n">channel</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">channel</span><span class="p">()</span>

<span class="n">channel</span><span class="o">.</span><span class="n">exchange_declare</span><span class="p">(</span><span class="n">exchange</span><span class="o">=</span><span class="s1">&#39;direct_logs&#39;</span><span class="p">,</span> <span class="n">exchange_type</span><span class="o">=</span><span class="s1">&#39;direct&#39;</span><span class="p">)</span>
<span class="c1"># 设置 过滤 级别</span>
<span class="n">log_levels</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;info&#39;</span>

<span class="n">message</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span> <span class="ow">or</span> <span class="s1">&#39;Hello World!&#39;</span>
<span class="n">channel</span><span class="o">.</span><span class="n">basic_publish</span><span class="p">(</span>
    <span class="n">exchange</span><span class="o">=</span><span class="s1">&#39;direct_logs&#39;</span><span class="p">,</span> <span class="n">routing_key</span><span class="o">=</span><span class="n">log_levels</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">message</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot; [x] Sent </span><span class="si">%r</span><span class="s2">:</span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">log_levels</span><span class="p">,</span> <span class="n">message</span><span class="p">))</span>
<span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
<p>consumer02.py</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># -*- coding:utf8 -*-</span>
<span class="c1"># auther; 18793</span>
<span class="c1"># Date：2020/1/8 10:17</span>
<span class="c1"># filename: consumer02.py</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">pika</span>

<span class="n">credentials</span> <span class="o">=</span> <span class="n">pika</span><span class="o">.</span><span class="n">PlainCredentials</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">)</span>  <span class="c1"># mq用户名和密码</span>
<span class="c1"># 虚拟队列需要指定参数 virtual_host，如果是默认的可以不填。</span>
<span class="n">connection</span> <span class="o">=</span> <span class="n">pika</span><span class="o">.</span><span class="n">BlockingConnection</span><span class="p">(</span>
    <span class="n">pika</span><span class="o">.</span><span class="n">ConnectionParameters</span><span class="p">(</span><span class="s1">&#39;172.16.72.19&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">5672</span><span class="p">,</span> <span class="n">virtual_host</span><span class="o">=</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">credentials</span><span class="o">=</span><span class="n">credentials</span><span class="p">))</span>
<span class="n">channel</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">channel</span><span class="p">()</span>

<span class="n">channel</span><span class="o">.</span><span class="n">exchange_declare</span><span class="p">(</span><span class="n">exchange</span><span class="o">=</span><span class="s1">&#39;direct_logs&#39;</span><span class="p">,</span> <span class="n">exchange_type</span><span class="o">=</span><span class="s1">&#39;direct&#39;</span><span class="p">)</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="n">queue_declare</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">exclusive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">queue_name</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">method</span><span class="o">.</span><span class="n">queue</span>

<span class="c1"># 拿到接收的 级别</span>
<span class="n">log_levels</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">log_levels</span><span class="p">:</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Usage: </span><span class="si">%s</span><span class="s2"> [info] [warning] [error]</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># 可能有多个级别</span>
<span class="k">for</span> <span class="n">severity</span> <span class="ow">in</span> <span class="n">log_levels</span><span class="p">:</span>
    <span class="n">channel</span><span class="o">.</span><span class="n">queue_bind</span><span class="p">(</span>
        <span class="n">exchange</span><span class="o">=</span><span class="s1">&#39;direct_logs&#39;</span><span class="p">,</span> <span class="n">queue</span><span class="o">=</span><span class="n">queue_name</span><span class="p">,</span> <span class="n">routing_key</span><span class="o">=</span><span class="n">severity</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39; [*] Waiting for logs. To exit press CTRL+C&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">callback</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">properties</span><span class="p">,</span> <span class="n">body</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; [x] </span><span class="si">%r</span><span class="s2">:</span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">method</span><span class="o">.</span><span class="n">routing_key</span><span class="p">,</span> <span class="n">body</span><span class="p">))</span>


<span class="n">channel</span><span class="o">.</span><span class="n">basic_consume</span><span class="p">(</span>
    <span class="n">queue</span><span class="o">=</span><span class="n">queue_name</span><span class="p">,</span> <span class="n">on_message_callback</span><span class="o">=</span><span class="n">callback</span><span class="p">,</span> <span class="n">auto_ack</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">channel</span><span class="o">.</span><span class="n">start_consuming</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">root</span><span class="nd">@ftnode</span><span class="o">-</span><span class="mi">172</span><span class="o">-</span><span class="mi">16</span><span class="o">-</span><span class="mi">72</span><span class="o">-</span><span class="mi">19</span> <span class="n">ftinstall</span><span class="o">.</span><span class="n">v3</span><span class="o">.</span><span class="mi">5</span><span class="o">-</span><span class="n">distributed</span><span class="p">]</span><span class="c1"># python producer02.py 123 32dsadasds122</span>
 <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="n">Sent</span> <span class="s1">&#39;123&#39;</span><span class="p">:</span><span class="s1">&#39;32dsadasds122&#39;</span>


<span class="p">[</span><span class="n">root</span><span class="nd">@ftnode</span><span class="o">-</span><span class="mi">172</span><span class="o">-</span><span class="mi">16</span><span class="o">-</span><span class="mi">72</span><span class="o">-</span><span class="mi">19</span> <span class="n">ftinstall</span><span class="o">.</span><span class="n">v3</span><span class="o">.</span><span class="mi">5</span><span class="o">-</span><span class="n">distributed</span><span class="p">]</span><span class="c1"># python consumer02.py 123 321</span>
 <span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Waiting</span> <span class="k">for</span> <span class="n">logs</span><span class="o">.</span> <span class="n">To</span> <span class="n">exit</span> <span class="n">press</span> <span class="n">CTRL</span><span class="o">+</span><span class="n">C</span>
 <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="s1">&#39;123&#39;</span><span class="p">:</span><span class="s1">&#39;321&#39;</span>
 <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="s1">&#39;123&#39;</span><span class="p">:</span><span class="s1">&#39;32122&#39;</span>
 <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="s1">&#39;123&#39;</span><span class="p">:</span><span class="s1">&#39;32dsadasds122&#39;</span>
</pre></div>
</div>
</section>
<section id="topic">
<h3><a class="toc-backref" href="#id19">模式三:topic更细致的过滤</a><a class="headerlink" href="#topic" title="Permalink to this headline">¶</a></h3>
<p>表达式符号说明：</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 14%" />
<col style="width: 86%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>符号</p></th>
<th class="head"><p>描述</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>#</p></td>
<td><p>表示可以匹配0个或多个单词</p></td>
</tr>
<tr class="row-odd"><td><p>*</p></td>
<td><p>表示只能匹配一个单词</p></td>
</tr>
</tbody>
</table>
<p>比如把error中，apache和mysql的分别或取出来</p>
<p>producer04.py</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># -*- coding:utf8 -*-</span>
<span class="c1"># auther; 18793</span>
<span class="c1"># Date：2020/1/8 10:58</span>
<span class="c1"># filename: producer04.py</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">pika</span>

<span class="n">credentials</span> <span class="o">=</span> <span class="n">pika</span><span class="o">.</span><span class="n">PlainCredentials</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">)</span>  <span class="c1"># mq用户名和密码</span>
<span class="c1"># 虚拟队列需要指定参数 virtual_host，如果是默认的可以不填。</span>
<span class="n">connection</span> <span class="o">=</span> <span class="n">pika</span><span class="o">.</span><span class="n">BlockingConnection</span><span class="p">(</span>
    <span class="n">pika</span><span class="o">.</span><span class="n">ConnectionParameters</span><span class="p">(</span><span class="s1">&#39;172.16.72.19&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">5672</span><span class="p">,</span> <span class="n">virtual_host</span><span class="o">=</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">credentials</span><span class="o">=</span><span class="n">credentials</span><span class="p">))</span>

<span class="n">channel</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">channel</span><span class="p">()</span>

<span class="n">channel</span><span class="o">.</span><span class="n">exchange_declare</span><span class="p">(</span><span class="n">exchange</span><span class="o">=</span><span class="s1">&#39;topic_logs&#39;</span><span class="p">,</span> <span class="n">exchange_type</span><span class="o">=</span><span class="s1">&#39;topic&#39;</span><span class="p">)</span>

<span class="c1"># 这里上面不同，这里是用 点 距隔</span>
<span class="n">routing_key</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="k">else</span> <span class="s1">&#39;anonymous.info&#39;</span>
<span class="n">message</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span> <span class="ow">or</span> <span class="s1">&#39;Hello World!&#39;</span>

<span class="n">channel</span><span class="o">.</span><span class="n">basic_publish</span><span class="p">(</span>
    <span class="n">exchange</span><span class="o">=</span><span class="s1">&#39;topic_logs&#39;</span><span class="p">,</span> <span class="n">routing_key</span><span class="o">=</span><span class="n">routing_key</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">message</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot; [x] Sent </span><span class="si">%r</span><span class="s2">:</span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">routing_key</span><span class="p">,</span> <span class="n">message</span><span class="p">))</span>
<span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
<p>consumer04.py</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># -*- coding:utf8 -*-</span>
<span class="c1"># auther; 18793</span>
<span class="c1"># Date：2020/1/8 10:58</span>
<span class="c1"># filename: consumer04.py</span>

<span class="kn">import</span> <span class="nn">pika</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">credentials</span> <span class="o">=</span> <span class="n">pika</span><span class="o">.</span><span class="n">PlainCredentials</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">)</span>  <span class="c1"># mq用户名和密码</span>
<span class="c1"># 虚拟队列需要指定参数 virtual_host，如果是默认的可以不填。</span>
<span class="n">connection</span> <span class="o">=</span> <span class="n">pika</span><span class="o">.</span><span class="n">BlockingConnection</span><span class="p">(</span>
    <span class="n">pika</span><span class="o">.</span><span class="n">ConnectionParameters</span><span class="p">(</span><span class="s1">&#39;172.16.72.19&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">5672</span><span class="p">,</span> <span class="n">virtual_host</span><span class="o">=</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">credentials</span><span class="o">=</span><span class="n">credentials</span><span class="p">))</span>

<span class="n">channel</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">channel</span><span class="p">()</span>

<span class="n">channel</span><span class="o">.</span><span class="n">exchange_declare</span><span class="p">(</span><span class="n">exchange</span><span class="o">=</span><span class="s1">&#39;topic_logs&#39;</span><span class="p">,</span> <span class="n">exchange_type</span><span class="o">=</span><span class="s1">&#39;topic&#39;</span><span class="p">)</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="n">queue_declare</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">exclusive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">queue_name</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">method</span><span class="o">.</span><span class="n">queue</span>

<span class="n">binding_keys</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">binding_keys</span><span class="p">:</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Usage: </span><span class="si">%s</span><span class="s2"> [binding_key]...</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="k">for</span> <span class="n">binding_key</span> <span class="ow">in</span> <span class="n">binding_keys</span><span class="p">:</span>
    <span class="n">channel</span><span class="o">.</span><span class="n">queue_bind</span><span class="p">(</span>
        <span class="n">exchange</span><span class="o">=</span><span class="s1">&#39;topic_logs&#39;</span><span class="p">,</span> <span class="n">queue</span><span class="o">=</span><span class="n">queue_name</span><span class="p">,</span> <span class="n">routing_key</span><span class="o">=</span><span class="n">binding_key</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39; [*] Waiting for logs. To exit press CTRL+C&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">callback</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">properties</span><span class="p">,</span> <span class="n">body</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; [x] </span><span class="si">%r</span><span class="s2">:</span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">method</span><span class="o">.</span><span class="n">routing_key</span><span class="p">,</span> <span class="n">body</span><span class="p">))</span>


<span class="n">channel</span><span class="o">.</span><span class="n">basic_consume</span><span class="p">(</span>
    <span class="n">queue</span><span class="o">=</span><span class="n">queue_name</span><span class="p">,</span> <span class="n">on_message_callback</span><span class="o">=</span><span class="n">callback</span><span class="p">,</span> <span class="n">auto_ack</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">channel</span><span class="o">.</span><span class="n">start_consuming</span><span class="p">()</span>
</pre></div>
</div>
<p>生产者</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">root</span><span class="nd">@ftnode</span><span class="o">-</span><span class="mi">172</span><span class="o">-</span><span class="mi">16</span><span class="o">-</span><span class="mi">72</span><span class="o">-</span><span class="mi">19</span> <span class="n">ftinstall</span><span class="o">.</span><span class="n">v3</span><span class="o">.</span><span class="mi">5</span><span class="o">-</span><span class="n">distributed</span><span class="p">]</span><span class="c1"># python producer04.py mysql</span>
 <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="n">Sent</span> <span class="s1">&#39;anonymous.info&#39;</span><span class="p">:</span><span class="s1">&#39;Hello World!&#39;</span>
<span class="p">[</span><span class="n">root</span><span class="nd">@ftnode</span><span class="o">-</span><span class="mi">172</span><span class="o">-</span><span class="mi">16</span><span class="o">-</span><span class="mi">72</span><span class="o">-</span><span class="mi">19</span> <span class="n">ftinstall</span><span class="o">.</span><span class="n">v3</span><span class="o">.</span><span class="mi">5</span><span class="o">-</span><span class="n">distributed</span><span class="p">]</span><span class="c1"># python producer04.py ms12131</span>
 <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="n">Sent</span> <span class="s1">&#39;anonymous.info&#39;</span><span class="p">:</span><span class="s1">&#39;Hello World!&#39;</span>
</pre></div>
</div>
<p>消费者</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">## 接收所有消息</span>
<span class="p">[</span><span class="n">root</span><span class="nd">@ftnode</span><span class="o">-</span><span class="mi">172</span><span class="o">-</span><span class="mi">16</span><span class="o">-</span><span class="mi">72</span><span class="o">-</span><span class="mi">19</span> <span class="n">ftinstall</span><span class="o">.</span><span class="n">v3</span><span class="o">.</span><span class="mi">5</span><span class="o">-</span><span class="n">distributed</span><span class="p">]</span><span class="c1"># python consumer04.py &quot;#&quot;</span>
 <span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Waiting</span> <span class="k">for</span> <span class="n">logs</span><span class="o">.</span> <span class="n">To</span> <span class="n">exit</span> <span class="n">press</span> <span class="n">CTRL</span><span class="o">+</span><span class="n">C</span>
 <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="s1">&#39;anonymous.info&#39;</span><span class="p">:</span><span class="s1">&#39;Hello World!&#39;</span>
 <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="s1">&#39;anonymous.info&#39;</span><span class="p">:</span><span class="s1">&#39;Hello World!&#39;</span>
</pre></div>
</div>
<ul class="simple">
<li><p>把error中，apache和mysql的分别或取出来</p></li>
</ul>
<p>生产者</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">root</span><span class="nd">@ftnode</span><span class="o">-</span><span class="mi">172</span><span class="o">-</span><span class="mi">16</span><span class="o">-</span><span class="mi">72</span><span class="o">-</span><span class="mi">19</span> <span class="n">ftinstall</span><span class="o">.</span><span class="n">v3</span><span class="o">.</span><span class="mi">5</span><span class="o">-</span><span class="n">distributed</span><span class="p">]</span><span class="c1"># python producer04.py aaa.error mysql.aaa</span>
 <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="n">Sent</span> <span class="s1">&#39;aaa.error&#39;</span><span class="p">:</span><span class="s1">&#39;mysql.aaa&#39;</span>
</pre></div>
</div>
<p>消费者</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">root</span><span class="nd">@ftnode</span><span class="o">-</span><span class="mi">172</span><span class="o">-</span><span class="mi">16</span><span class="o">-</span><span class="mi">72</span><span class="o">-</span><span class="mi">19</span> <span class="n">ftinstall</span><span class="o">.</span><span class="n">v3</span><span class="o">.</span><span class="mi">5</span><span class="o">-</span><span class="n">distributed</span><span class="p">]</span><span class="c1"># python consumer04.py *.error mysql.*</span>
 <span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Waiting</span> <span class="k">for</span> <span class="n">logs</span><span class="o">.</span> <span class="n">To</span> <span class="n">exit</span> <span class="n">press</span> <span class="n">CTRL</span><span class="o">+</span><span class="n">C</span>
 <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="s1">&#39;aaa.error&#39;</span><span class="p">:</span><span class="s1">&#39;mysql.aaa&#39;</span>
</pre></div>
</div>
</section>
<section id="rpc-remote-procedure-call">
<h3><a class="toc-backref" href="#id20">RPC(Remote procedure call)</a><a class="headerlink" href="#rpc-remote-procedure-call" title="Permalink to this headline">¶</a></h3>
<p>客户端发送一个任务到服务端，服务端把任务的执行结果再返回给客户端</p>
<img alt="../../_images/python_rabbitmq_rpc01.png" src="../../_images/python_rabbitmq_rpc01.png" />
<p>RPC_Server.py 消费端</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#_*_coding:utf-8_*_</span>
<span class="kn">import</span> <span class="nn">pika</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="c1"># 链接socket</span>
<span class="n">connection</span> <span class="o">=</span> <span class="n">pika</span><span class="o">.</span><span class="n">BlockingConnection</span><span class="p">(</span><span class="n">pika</span><span class="o">.</span><span class="n">ConnectionParameters</span><span class="p">(</span>
        <span class="n">host</span><span class="o">=</span><span class="s1">&#39;localhost&#39;</span><span class="p">))</span>
<span class="n">channel</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">channel</span><span class="p">()</span>

<span class="c1"># 生成rpc queue</span>
<span class="n">channel</span><span class="o">.</span><span class="n">queue_declare</span><span class="p">(</span><span class="n">queue</span><span class="o">=</span><span class="s1">&#39;rpc_queue&#39;</span><span class="p">)</span>

<span class="c1">#　斐波那契数列</span>
<span class="k">def</span> <span class="nf">fib</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">elif</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">fib</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">fib</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>


<span class="c1"># 收到消息就调用</span>
<span class="c1"># ch 管道内存对象地址</span>
<span class="c1"># method 消息发给哪个queue</span>
<span class="c1"># props 返回给消费的返回参数</span>
<span class="c1"># body数据对象</span>
<span class="k">def</span> <span class="nf">on_request</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">props</span><span class="p">,</span> <span class="n">body</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; [.] fib(</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">n</span><span class="p">)</span>
    <span class="c1"># 调用斐波那契函数 传入结果</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">fib</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

    <span class="n">ch</span><span class="o">.</span><span class="n">basic_publish</span><span class="p">(</span><span class="n">exchange</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                     <span class="c1"># 生产端随机生成的queue</span>
                     <span class="n">routing_key</span><span class="o">=</span><span class="n">props</span><span class="o">.</span><span class="n">reply_to</span><span class="p">,</span>
                     <span class="c1"># 获取UUID唯一 字符串数值</span>
                     <span class="n">properties</span><span class="o">=</span><span class="n">pika</span><span class="o">.</span><span class="n">BasicProperties</span><span class="p">(</span><span class="n">correlation_id</span> <span class="o">=</span> \
                                                   <span class="n">props</span><span class="o">.</span><span class="n">correlation_id</span><span class="p">),</span>
                     <span class="c1"># 消息返回给生产端</span>
                     <span class="n">body</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">response</span><span class="p">))</span>
    <span class="c1"># 确保任务完成</span>
    <span class="n">ch</span><span class="o">.</span><span class="n">basic_ack</span><span class="p">(</span><span class="n">delivery_tag</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="n">delivery_tag</span><span class="p">)</span>

<span class="c1"># rpc_queue收到消息:调用on_request回调函数</span>
<span class="c1"># queue=&#39;rpc_queue&#39;从rpc内收</span>
<span class="n">channel</span><span class="o">.</span><span class="n">basic_consume</span><span class="p">(</span><span class="n">on_request</span><span class="p">,</span> <span class="n">queue</span><span class="o">=</span><span class="s1">&#39;rpc_queue&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot; [x] Awaiting RPC requests&quot;</span><span class="p">)</span>
<span class="n">channel</span><span class="o">.</span><span class="n">start_consuming</span><span class="p">()</span>
</pre></div>
</div>
<p>RPC_Client.py 生产端</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># coding:utf-8</span>
<span class="kn">import</span> <span class="nn">pika</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">import</span> <span class="nn">time</span>


<span class="c1"># 斐波那契数列 前两个数相加依次排列</span>
<span class="k">class</span> <span class="nc">FibonacciRpcClient</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># 链接远程</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="n">pika</span><span class="o">.</span><span class="n">BlockingConnection</span><span class="p">(</span><span class="n">pika</span><span class="o">.</span><span class="n">ConnectionParameters</span><span class="p">(</span>
            <span class="n">host</span><span class="o">=</span><span class="s1">&#39;localhost&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">channel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">channel</span><span class="p">()</span>

        <span class="c1"># 生成随机queue</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">queue_declare</span><span class="p">(</span><span class="n">exclusive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># 随机取queue名字，发给消费端</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">callback_queue</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">method</span><span class="o">.</span><span class="n">queue</span>

        <span class="c1"># self.on_response 回调函数:只要收到消息就调用这个函数。</span>
        <span class="c1"># 声明收到消息后就 收queue=self.callback_queue内的消息</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">basic_consume</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_response</span><span class="p">,</span> <span class="n">no_ack</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">queue</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">callback_queue</span><span class="p">)</span>

    <span class="c1"># 收到消息就调用</span>
    <span class="c1"># ch 管道内存对象地址</span>
    <span class="c1"># method 消息发给哪个queue</span>
    <span class="c1"># body数据对象</span>
    <span class="k">def</span> <span class="nf">on_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">props</span><span class="p">,</span> <span class="n">body</span><span class="p">):</span>
        <span class="c1"># 判断本机生成的ID 与 生产端发过来的ID是否相等</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">corr_id</span> <span class="o">==</span> <span class="n">props</span><span class="o">.</span><span class="n">correlation_id</span><span class="p">:</span>
            <span class="c1"># 将body值 赋值给self.response</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">response</span> <span class="o">=</span> <span class="n">body</span>

    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="c1"># 赋值变量，一个循环值</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># 　随机一次唯一的字符串</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">corr_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>

        <span class="c1"># routing_key=&#39;rpc_queue&#39; 发一个消息到rpc_queue内</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">basic_publish</span><span class="p">(</span><span class="n">exchange</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                                   <span class="n">routing_key</span><span class="o">=</span><span class="s1">&#39;rpc_queue&#39;</span><span class="p">,</span>
                                   <span class="n">properties</span><span class="o">=</span><span class="n">pika</span><span class="o">.</span><span class="n">BasicProperties</span><span class="p">(</span>

                                       <span class="c1"># 执行命令之后结果返回给self.callaback_queue这个队列中</span>
                                       <span class="n">reply_to</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">callback_queue</span><span class="p">,</span>
                                       <span class="c1"># 生成UUID 发送给消费端</span>
                                       <span class="n">correlation_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">corr_id</span><span class="p">,</span>
                                   <span class="p">),</span>
                                   <span class="c1"># 发的消息，必须传入字符串，不能传数字</span>
                                   <span class="n">body</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
        <span class="c1"># 没有数据就循环收</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># 非阻塞版的start_consuming()</span>
            <span class="c1"># 没有消息不阻塞</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">process_data_events</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;no msg...&quot;</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="p">)</span>


<span class="c1"># 　实例化</span>
<span class="n">fibonacci_rpc</span> <span class="o">=</span> <span class="n">FibonacciRpcClient</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot; [x] Requesting fib(30)&quot;</span><span class="p">)</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">fibonacci_rpc</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot; [.] Got </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">response</span><span class="p">)</span>
</pre></div>
</div>
<p>参考相关资料： <a class="reference external" href="https://www.cnblogs.com/shenh/p/10497244.html">https://www.cnblogs.com/shenh/p/10497244.html</a></p>
<p><a class="reference external" href="https://www.jb51.net/article/158056.htm">https://www.jb51.net/article/158056.htm</a></p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="12.Python3%E8%AF%BB%E5%86%99Excel%E6%96%87%E4%BB%B6.html" class="btn btn-neutral float-left" title="14.12. Python3读写Excel文件" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="14.%E6%89%93%E5%8C%85%E5%92%8C%E5%8F%91%E5%B8%83.html" class="btn btn-neutral float-right" title="14.14. 打包和发布" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019, huxiaojian.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>