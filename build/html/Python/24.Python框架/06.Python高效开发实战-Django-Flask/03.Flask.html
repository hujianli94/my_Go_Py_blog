<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>23.6.3. Flask &mdash; 运维开发修炼之路</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="23.7. Python-Django-Web典型模块开发实战" href="../07.Python-Django-Web%E5%85%B8%E5%9E%8B%E6%A8%A1%E5%9D%97%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98/index.html" />
    <link rel="prev" title="23.6.2. 开发环境准备" href="02.%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> 小健_Python_go_Devops
            <img src="../../../_static/python_go.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                2.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../Go/index.html">Go语言学习</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Go_vs_Python/index.html">Go vs Python</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../index.html">Python全栈系列</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../01.Python%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/index.html">1. Python数据类型</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../02.Python%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6%E8%AF%AD%E5%8F%A5/index.html">2. Python流程控制语句</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../03.Python%E5%87%BD%E6%95%B0/index.html">3. Python函数</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../04.Python%E5%86%85%E5%BB%BA%E5%87%BD%E6%95%B0/index.html">4. Python内建函数</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../05.Python%E6%8E%A8%E5%AF%BC%E5%BC%8F%E5%AD%A6%E4%B9%A0/index.html">5. Python推导式学习</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../06.Python%E8%BF%AD%E4%BB%A3%E5%99%A8_%E7%94%9F%E6%88%90%E5%99%A8_%E8%A3%85%E9%A5%B0%E5%99%A8/index.html">6. Python生成器、迭代器、装饰器</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../07.Python%E9%9D%A2%E5%AF%B9%E5%AF%B9%E8%B1%A1%E8%AE%BE%E8%AE%A1_OOP/index.html">7. Python面对对象设计_OOP</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../08.Python%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86/index.html">8. Python异常处理</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../09.Python%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C/index.html">9. Python文件操作</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../10.Python%E4%B8%AD%E7%9A%84%E5%8C%85%E5%92%8C%E6%A8%A1%E5%9D%97/index.html">10. Python中包和模块</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../11.Python%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/index.html">11. Python正则表达式</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../12.Python%E6%A0%87%E5%87%86%E5%BA%93/index.html">12. Python 标准库学习</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../13.Python%E6%93%8D%E4%BD%9C%E6%95%B0%E6%8D%AE%E5%BA%93/index.html">13. Python对数据库的操作</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../14.Python%E4%B8%89%E6%96%B9%E5%BA%93/index.html">14. Python 三方库学习</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../15.Python%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/index.html">15. Python 网络编程</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../16.Python%E7%BA%BF%E7%A8%8B%E5%92%8C%E8%BF%9B%E7%A8%8B/index.html">16. Python 进程和线程</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../17.Python%E8%AF%AD%E8%A8%80%E7%9A%84%E6%89%A9%E5%B1%95%E4%B8%8E%E5%B5%8C%E5%85%A5/index.html">17. Python与C语言扩展</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../18.%E7%B3%BB%E7%BB%9F%E7%AE%A1%E7%90%86%E5%91%98%E7%9A%84Python%E8%84%9A%E6%9C%AC%E7%BC%96%E7%A8%8B%E6%8C%87%E5%8D%97-%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/index.html">18. 系统管理员的Python脚本编程指南-读书笔记</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../20.Python%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/index.html">19. Python自动化运维最佳实践</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../21.Python%E8%BF%9B%E9%98%B6%E5%AD%A6%E4%B9%A0/index.html">20. Python进阶学习</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../22.Python%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB/index.html">21. Python网络爬虫</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../23.%E5%89%8D%E7%AB%AF%E6%8A%80%E6%9C%AF/index.html">22. 前端基础知识</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html">23. Python框架</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../01.%E5%B8%B8%E7%94%A8%E7%9A%84GUI%E6%A1%86%E6%9E%B6/index.html">23.1. 常用的GUI框架</a></li>
<li class="toctree-l3"><a class="reference internal" href="../02.Flask/index.html">23.2. Flask</a></li>
<li class="toctree-l3"><a class="reference internal" href="../03.Scrapy/index.html">23.3. Scrapy</a></li>
<li class="toctree-l3"><a class="reference internal" href="../04.Django/index.html">23.4. Django</a></li>
<li class="toctree-l3"><a class="reference internal" href="../05.Tornado/index.html">23.5. Tornado</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="index.html">23.6. Python高效开发实战-Django、Flask</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="01.%E6%95%B0%E6%8D%AE%E5%BA%93%E5%8F%8AORM.html">23.6.1. 数据库及ORM</a></li>
<li class="toctree-l4"><a class="reference internal" href="02.%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87.html">23.6.2. 开发环境准备</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">23.6.3. Flask</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../07.Python-Django-Web%E5%85%B8%E5%9E%8B%E6%A8%A1%E5%9D%97%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98/index.html">23.7. Python-Django-Web典型模块开发实战</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../25.Python%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2/index.html">24. Python开发环境部署</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../26.%E6%88%91%E7%9A%84%E7%AC%AC%E4%B8%80%E6%9C%AC%E7%AE%97%E6%B3%95%E4%B9%A6/index.html">25. 我的第一本算法书</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../27.Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98/index.html">26. Python3网络爬虫开发实战</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../28.Python%E8%AE%A9%E7%B9%81%E7%90%90%E7%9A%84%E5%B7%A5%E4%BD%9C%E8%87%AA%E5%8A%A8%E5%8C%96/index.html">27. Python让繁琐的工作自动化</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../29.%E7%96%AF%E7%8B%82%E7%9A%84Python%E8%AE%B2%E4%B9%89/index.html">28. 疯狂的Python讲义</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../30.Django_Vue/index.html">29. Django_Vue</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../31.%E7%BC%96%E5%86%99Python%E7%9A%8490%E4%B8%AA%E6%9C%89%E6%95%88%E6%96%B9%E6%B3%95/index.html">30. 编写Python的90个有效方法</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../32.Vue3.0%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F/index.html">31. Vue3.0管理系统</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../Python%E6%B5%8B%E8%AF%95%E5%BC%80%E5%8F%91%E5%85%A5%E9%97%A8%E4%B8%8E%E5%AE%9E%E8%B7%B5/index.html">Python测试开发入门与实践</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Vue/index.html">Vue.js企业开发实战</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Vue_Node.js/index.html">Vue.js+Node.js开发实战</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">小健_Python_go_Devops</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../index.html">Python全栈系列</a> &raquo;</li>
          <li><a href="../index.html"><span class="section-number">23. </span>Python框架</a> &raquo;</li>
          <li><a href="index.html"><span class="section-number">23.6. </span>Python高效开发实战-Django、Flask</a> &raquo;</li>
      <li><span class="section-number">23.6.3. </span>Flask</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../_sources/Python/24.Python框架/06.Python高效开发实战-Django-Flask/03.Flask.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="contents topic" id="contents">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#flask" id="id54">Flask</a></p>
<ul>
<li><p><a class="reference internal" href="#id1" id="id55">1.Flask综述</a></p></li>
<li><p><a class="reference internal" href="#flask-api" id="id56">2.实战演练:开发Flask API视图</a></p>
<ul>
<li><p><a class="reference internal" href="#hello-world" id="id57">2.1 Hello World程序</a></p></li>
<li><p><a class="reference internal" href="#id2" id="id58">2.2 模板渲染</a></p></li>
<li><p><a class="reference internal" href="#id4" id="id59">2.3 Flask视图高级技术</a></p></li>
<li><p><a class="reference internal" href="#id6" id="id60">2.4 Flask装饰器</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id9" id="id61">3.路由详解</a></p>
<ul>
<li><p><a class="reference internal" href="#id10" id="id62">3.1在路径中添加变量</a></p></li>
<li><p><a class="reference internal" href="#id11" id="id63">3.2为变量指定类型</a></p></li>
<li><p><a class="reference internal" href="#http" id="id64">3.3HTTP方法绑定</a></p></li>
<li><p><a class="reference internal" href="#id12" id="id65">3.4路由地址反向生成</a></p></li>
<li><p><a class="reference internal" href="#id13" id="id66">3.5路由系统</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id14" id="id67">4.静态文件</a></p>
<ul>
<li><p><a class="reference internal" href="#favicon" id="id68">1.提供一个favicon 图标</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#jinja2" id="id69">5. Jinja2 模板引擎</a></p></li>
<li><p><a class="reference internal" href="#id15" id="id70">6.请求、重定向及会话</a></p>
<ul>
<li><p><a class="reference internal" href="#request" id="id71">1.请求对象 request</a></p></li>
<li><p><a class="reference internal" href="#redirect" id="id72">2.重定向对象 redirect</a></p></li>
<li><p><a class="reference internal" href="#session" id="id73">3.会话对象 session</a></p></li>
<li><p><a class="reference internal" href="#id16" id="id74">4.附录</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id17" id="id75">7.蓝图</a></p></li>
<li><p><a class="reference internal" href="#id18" id="id76">8.Flask数据交互</a></p>
<ul>
<li><p><a class="reference internal" href="#id19" id="id77">8.1 使用Flask处理表单</a></p></li>
<li><p><a class="reference internal" href="#id21" id="id78">8.2 使用Flask上传文件</a></p></li>
<li><p><a class="reference internal" href="#cookie" id="id79">8.3 Cookie的使用</a></p></li>
<li><p><a class="reference internal" href="#id26" id="id80">8.4 Session的使用</a></p></li>
<li><p><a class="reference internal" href="#id28" id="id81">8.5 钩子函数的使用</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id29" id="id82">9.访问数据库</a></p>
<ul>
<li><p><a class="reference internal" href="#mysql" id="id83">9.1 MySQL数据库安装</a></p></li>
<li><p><a class="reference internal" href="#pythonmysql-python" id="id84">9.2 Python数据库框架MySQL-Python</a></p></li>
<li><p><a class="reference internal" href="#flask-sqlalchemy" id="id85">9.3 初识Flask-SQLAlchemy</a></p></li>
<li><p><a class="reference internal" href="#id34" id="id86">9.4 创建一对一的关系表</a></p></li>
<li><p><a class="reference internal" href="#id35" id="id87">9.5 创建一对多的关系表</a></p></li>
<li><p><a class="reference internal" href="#id36" id="id88">9.6 创建多对多的关系表</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#flask-script" id="id89">10.Flask-Script工具的使用</a></p>
<ul>
<li><p><a class="reference internal" href="#id37" id="id90">10.1 安装Flask-Script并初始化</a></p></li>
<li><p><a class="reference internal" href="#command" id="id91">10.2 Command子类创建命令</a></p></li>
<li><p><a class="reference internal" href="#command-command" id="id92">10.3 使用Command实例的&#64;command修饰符</a></p></li>
<li><p><a class="reference internal" href="#command-option" id="id93">10.4 使用Command实例的&#64;option修饰符创建命令</a></p></li>
<li><p><a class="reference internal" href="#id38" id="id94">10.5 Flask循环引用</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#flask-migrate" id="id95">11. Flask-Migrate实现数据迁移</a></p>
<ul>
<li><p><a class="reference internal" href="#id39" id="id96">11.1 安装Flask-Migrate插件</a></p></li>
<li><p><a class="reference internal" href="#id40" id="id97">11.2 使用Flask-Migrate的步骤</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#python-flaskrestful-apis" id="id98">12.使用Python和 Flask设计RESTful APIs</a></p>
<ul>
<li><p><a class="reference internal" href="#restful-web-service" id="id99">12.1 什么是一个 RESTful 的 web service？</a></p></li>
<li><p><a class="reference internal" href="#web-service" id="id100">12.2 设计一个简单的 web service</a></p></li>
<li><p><a class="reference internal" href="#python-flaskrestful-services" id="id101">12.3 使用Python和 Flask实现RESTful services</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#flask-restfulrestful-api" id="id102">13.使用Flask-RESTful设计RESTful API</a></p>
<ul>
<li><p><a class="reference internal" href="#restful" id="id103">13.1 RESTful 服务器</a></p></li>
<li><p><a class="reference internal" href="#id44" id="id104">13.2 路由</a></p></li>
<li><p><a class="reference internal" href="#id45" id="id105">13.3 解析以及验证请求</a></p></li>
<li><p><a class="reference internal" href="#id46" id="id106">13.4 生成响应</a></p></li>
<li><p><a class="reference internal" href="#id47" id="id107">13.5 认证</a></p></li>
<li><p><a class="reference internal" href="#id48" id="id108">13.6 在flask-restful中添加日志</a></p></li>
<li><p><a class="reference internal" href="#id49" id="id109">13.7 使用 Flask 设计 RESTful 的认证</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#flask-pyjwt-jwt" id="id110">14.Flask + PyJWT 实现基于JWT的用户认证授权</a></p></li>
<li><p><a class="reference internal" href="#id50" id="id111">15.跨域访问</a></p>
<ul>
<li><p><a class="reference internal" href="#id51" id="id112">15.1 什么是跨域？</a></p></li>
<li><p><a class="reference internal" href="#cors" id="id113">15.2 CORS</a></p></li>
<li><p><a class="reference internal" href="#flaskcors" id="id114">15.3 Flask配置cors</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id52" id="id115">16.网站部署</a></p>
<ul>
<li><p><a class="reference internal" href="#id53" id="id116">16.1 服务器部署</a></p></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<section id="flask">
<h1><a class="toc-backref" href="#id54"><span class="section-number">23.6.3. </span>Flask</a><a class="headerlink" href="#flask" title="Permalink to this headline">¶</a></h1>
<section id="id1">
<h2><a class="toc-backref" href="#id55">1.Flask综述</a><a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p>相对于其他Python语言的Web框架而言，Flask的特点可以归结如下。</p>
<p>1．内置开发服务器和调试器</p>
<p>2．与Python单元测试功能无缝衔接</p>
<p>3．使用Jinja2模板</p>
<p>4．完全兼容WSGI 1.0标准</p>
<p>5．基于Unicode编码</p>
</section>
<section id="flask-api">
<h2><a class="toc-backref" href="#id56">2.实战演练:开发Flask API视图</a><a class="headerlink" href="#flask-api" title="Permalink to this headline">¶</a></h2>
<section id="hello-world">
<h3><a class="toc-backref" href="#id57">2.1 Hello World程序</a><a class="headerlink" href="#hello-world" title="Permalink to this headline">¶</a></h3>
<p>现在可以开始写第1个Flask程序了，一个最简单的Flask程序应该包括如下内容：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">hello_world</span><span class="p">():</span>  <span class="c1"># put application&#39;s code here</span>
    <span class="k">return</span> <span class="s1">&#39;Hello World!&#39;</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p>当确定系统可以接受来自外部的访问时，可以通过给run（）方法设置参数的方式来实现。同时，在run参数中可以传入要监听的端口，并且设置是否处于调试模式运行。如果将helloworld.py文件中的app.run()改为如下命令，则系统将会监听所有地址的80端口，并关闭调试模式：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s1">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="id2">
<h3><a class="toc-backref" href="#id58">2.2 模板渲染</a><a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<section id="render-template">
<h4>1.用render_template实现模板渲染<a class="headerlink" href="#render-template" title="Permalink to this headline">¶</a></h4>
<p>使用模板渲染的代码如下：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">render_template</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">hello_world</span><span class="p">():</span>  <span class="c1"># put application&#39;s code here</span>
    <span class="k">return</span> <span class="s1">&#39;Hello World!&#39;</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/hello&#39;</span><span class="p">)</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/hello/&lt;name&gt;&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">hello</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;hello.html&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s1">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>假设本例的Python代码被保存在app.py中，则本例的网站目录结构如下：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">app</span><span class="o">.</span><span class="n">py</span>
<span class="o">/</span><span class="n">templates</span>
  <span class="o">/</span><span class="n">hello</span><span class="o">.</span><span class="n">html</span>
</pre></div>
</div>
<p>下面是hello.html文件的内容：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>&lt;! doctype html&gt;
&lt;title&gt;Hello from Flask&lt;/title&gt;
{% if name %}                             &lt;! -判断name参数是否为空 →
    &lt;h1&gt;Hello {{ name }}! &lt;/h1&gt;                &lt;! -当name参数不为空时，本行生效 →
{% else %}
    &lt;h1&gt;Hello World! &lt;/h1&gt;                    &lt;! -当name参数为空时，本行生效 →
{% endif %}
</pre></div>
</div>
</section>
<section id="markup">
<h4>2.用Markup转换变量中的特殊字符<a class="headerlink" href="#markup" title="Permalink to this headline">¶</a></h4>
<p>向render_template传入的参数，不仅可以是单纯的字符串，还可以包含HTML特殊字符（比如&lt;、&gt;、空格、/等），这给模板参数提供了更好的灵活性。同时，因为这些特殊字符会被HTML客户端解释成特殊含义，所以会给网站程序带来一定程度的安全隐患。Flask允许程序员自己控制Jinja2是否需要解释这些特殊字符。</p>
<p>如果这些字符应该被解释成特殊含义，则将这些参数直接传给render_template即可；如果这些字符仅应该被解释成字符串，则应该通过Markup()函数将这些字符串做转义处理，然后传给render_template()函数。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/hello&#39;</span><span class="p">)</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/hello/&lt;name&gt;&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">hello</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Markup</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">Markup</span><span class="p">(</span><span class="s1">&#39;&lt;strong&gt;Hi </span><span class="si">%s</span><span class="s1">! &lt;/strong&gt;&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="s1">&#39;&lt;blink&gt;David&lt;/blink&gt;&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;hello.html&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
</pre></div>
</div>
<p>这段代码显示在浏览器中将会是一段粗体的“Hi
David!”。如果不进行Markup转义，则将会在浏览器上显示成闪烁着的粗体字“Hi
David!”。</p>
</section>
<section id="id3">
<h4>3.重定向和错误处理<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h4>
<p>重定向（Redirect）是指将一个网络请求重新指定URL并转到其他地址的技术。Flask的redirect()函数提供了这个功能。此外，如果仅仅想中止一个请求并返回错误，而不是重定向到其他地址，则可以使用abort()函数。</p>
<p>例如：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">abort</span><span class="p">,</span> <span class="n">redirect</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;/check&#39;</span><span class="p">)</span>  <span class="c1"># 重定向到/login页面</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/check&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">f_check</span><span class="p">():</span>
    <span class="n">abort</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span>  <span class="c1"># 立即向客户端返回400错误</span>
    <span class="c1"># dont_coding_here()                         #这里的代码不会被执行</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s1">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>本例中，当客户端访问根页面时，处理函数index()通过redirect()函数将请求重定向到了check页面。而check页面中目前没有实现其他逻辑，仅仅向客户端返回了400错误。</p>
<p><strong>说明：</strong> 400是一个HTTP的标准错误定义，其含义为请求无效。</p>
<p>HTTP 定义了标准的返回码错误代码表，其中大于等于400的代码被认为错误。</p>
<p>客户端的浏览器遇到错误返回时会显示默认的错误页面。如果网站程序需要定义自己的错误页面，则可以通过添加错误处理器来实现。</p>
<p>例如可以在程序中添加如下代码段：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">abort</span><span class="p">,</span> <span class="n">redirect</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">render_template</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;/check&#39;</span><span class="p">)</span>  <span class="c1"># 重定向到/login页面</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/check&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">f_check</span><span class="p">():</span>
    <span class="n">abort</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span>  <span class="c1"># 立即向客户端返回400错误</span>
    <span class="c1"># dont_coding_here()                         #这里的代码不会被执行</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">errorhandler</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">bad_request</span><span class="p">(</span><span class="n">error</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;bad_request.html&#39;</span><span class="p">),</span> <span class="mi">400</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s1">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>本例中用Flask的errorhandler装饰器添加了自定义的错误处理器。当程序中返回400错误时，系统会执行bad_request()函数。在该函数中向客户端返回400错误的同时，还传送了自定义的错误页面bad_request.html。</p>
</section>
</section>
<section id="id4">
<h3><a class="toc-backref" href="#id59">2.3 Flask视图高级技术</a><a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<section id="id5">
<h4>视图绑定<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h4>
<p>使用&#64;app.route装饰器</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span><span class="n">endpoint</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
<span class="c1">#底层其实是使用add_url_rule实现的</span>
<span class="k">def</span> <span class="nf">hello_world</span><span class="p">():</span>
    <span class="k">return</span> <span class="s1">&#39;Hello World!&#39;</span>
</pre></div>
</div>
<p>使用add_url_rule来绑定视图函数</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">my_test</span><span class="p">():</span>
  <span class="k">return</span> <span class="s1">&#39;这是测试页面!&#39;</span>

<span class="n">app</span><span class="o">.</span><span class="n">add_url_rule</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="s1">&#39;/test/&#39;</span><span class="p">,</span><span class="n">endpoint</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">,</span><span class="n">view_func</span><span class="o">=</span><span class="n">my_test</span><span class="p">)</span>

<span class="k">with</span> <span class="n">app</span><span class="o">.</span><span class="n">test_request_context</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">))</span>
</pre></div>
</div>
</section>
<section id="fbvcbv">
<h4>FBV与CBV<a class="headerlink" href="#fbvcbv" title="Permalink to this headline">¶</a></h4>
<section id="fbv">
<h5>FBV<a class="headerlink" href="#fbv" title="Permalink to this headline">¶</a></h5>
<p>FBV的定义、路由映射方法、装饰器添加方法，Flask中通常会用FBV；</p>
<p>Flask框架中不常用CBV；更多的是用FBV</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span><span class="n">views</span>


<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">inner</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;beforeFunc&#39;</span><span class="p">)</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span>
    <span class="k">return</span> <span class="n">inner</span>

<span class="c1"># FBV</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/index1&#39;</span><span class="p">,</span><span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@wrapper</span>
<span class="k">def</span> <span class="nf">index1</span><span class="p">():</span>
    <span class="k">return</span> <span class="s2">&quot;index1&quot;</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="cbv">
<h5>CBV<a class="headerlink" href="#cbv" title="Permalink to this headline">¶</a></h5>
<p>标准类视图</p>
<p>标准类视图的特点：</p>
<ul class="simple">
<li><p>必须继承flask.views.View。</p></li>
<li><p>必须实现dispatch_request方法，以后请求过来后，都会执行这个方法，这个方法的返回值相当于之前的视图函数，也必须返回Response或者子类的对象，或者是字符串、元祖。</p></li>
<li><p>必须通过app.add_url_rule(rule,endpoint,view_func)来做URL与视图的映射，view_func参数需要使用as_view类方法转换。</p></li>
<li><p>如果指定了endpoint，那么在使用url_for反转时就必须使用endpoint指定的那个值。如果没有指定endpoint，那么就可以使用as_view(视图名称)中指定的视图名称来作为反转。</p></li>
</ul>
<p>如果一个网站有首页、注册页和登录页面，每个页面要求放置一个同样的对联广告，使用类视图函数如何实现呢？</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span><span class="n">render_template</span><span class="p">,</span><span class="n">views</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Ads</span><span class="p">(</span><span class="n">views</span><span class="o">.</span><span class="n">View</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;ads&#39;</span><span class="p">:</span> <span class="s1">&#39;这是对联广告！&#39;</span>
        <span class="p">}</span>
<span class="k">class</span> <span class="nc">Index</span><span class="p">(</span><span class="n">Ads</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">dispatch_request</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;index.html&#39;</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Login</span><span class="p">(</span><span class="n">Ads</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">dispatch_request</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;login.html&#39;</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Register</span><span class="p">(</span><span class="n">Ads</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">dispatch_request</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;register.html&#39;</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

<span class="n">app</span><span class="o">.</span><span class="n">add_url_rule</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="n">view_func</span><span class="o">=</span><span class="n">Index</span><span class="o">.</span><span class="n">as_view</span><span class="p">(</span><span class="s1">&#39;Index&#39;</span><span class="p">))</span>
<span class="n">app</span><span class="o">.</span><span class="n">add_url_rule</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="s1">&#39;/login/&#39;</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="s1">&#39;login&#39;</span><span class="p">,</span> <span class="n">view_func</span><span class="o">=</span><span class="n">Login</span><span class="o">.</span><span class="n">as_view</span><span class="p">(</span><span class="s1">&#39;login&#39;</span><span class="p">))</span>
<span class="n">app</span><span class="o">.</span><span class="n">add_url_rule</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="s1">&#39;/register/&#39;</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="s1">&#39;register&#39;</span><span class="p">,</span> <span class="n">view_func</span><span class="o">=</span><span class="n">Register</span><span class="o">.</span><span class="n">as_view</span><span class="p">(</span><span class="s1">&#39;register&#39;</span><span class="p">))</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>基于方法的类视图</p>
<p>利用视图函数实现不同的请求执行不同的逻辑时比较复杂，需要在视图函数中进行判断，如果利用方法视图实现就比较简单。</p>
<p>Flask提供了另外一种类视图flask.views.MethodView，</p>
<p>对每个HTTP方法执行不同的函数（映射到对应方法的小写的同名方法上）。</p>
<p>在CBV中，路由信息只能通过<code class="docutils literal notranslate"><span class="pre">add_url_rule()</span></code>方法添加</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">views</span>


<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Login</span><span class="p">(</span><span class="n">views</span><span class="o">.</span><span class="n">MethodView</span><span class="p">):</span>
    <span class="n">methods</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="s1">&#39;GET&#39;</span><span class="p">]</span>
    <span class="c1"># 如果需要在CBV中加装饰器的话,括号里就是装饰器的内存地址，可以传多个</span>
    <span class="n">decorators</span> <span class="o">=</span> <span class="p">()</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;get 请求&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;login get&#39;</span>
    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;post 请求&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;login post&#39;</span>

<span class="n">app</span><span class="o">.</span><span class="n">add_url_rule</span><span class="p">(</span><span class="s1">&#39;/login&#39;</span><span class="p">,</span> <span class="n">view_func</span><span class="o">=</span><span class="n">Login</span><span class="o">.</span><span class="n">as_view</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;login&#39;</span><span class="p">))</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>基于方法视图的用户登录</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span><span class="n">render_template</span><span class="p">,</span><span class="n">request</span><span class="p">,</span><span class="n">views</span><span class="c1">#导入相应模块</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span><span class="c1">#Flask初始化</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="c1">#定义路由</span>
<span class="k">def</span> <span class="nf">hello_world</span><span class="p">():</span><span class="c1">#定义视图函数</span>
       <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;index.html&#39;</span><span class="p">)</span><span class="c1">#渲染模板</span>

<span class="k">class</span> <span class="nc">LoginView</span><span class="p">(</span><span class="n">views</span><span class="o">.</span><span class="n">MethodView</span><span class="p">):</span><span class="c1">#定义LoginView类</span>
       <span class="c1"># 当用户通过get方法进行访问的时候执行get方法</span>
       <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span><span class="c1">#定义get函数</span>
           <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s2">&quot;index.html&quot;</span><span class="p">)</span><span class="c1">#渲染模板</span>
       <span class="c1"># 当用户通过post方法进行访问的时候执行post方法</span>
       <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span><span class="c1">#定义post 函数</span>
           <span class="n">username</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;username&quot;</span><span class="p">)</span><span class="c1">#接收表单中传递过来的用户名</span>
           <span class="n">password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pwd&quot;</span><span class="p">)</span><span class="c1">#接收表单中传递过来的密码</span>
           <span class="k">if</span> <span class="n">username</span> <span class="o">==</span> <span class="s1">&#39;admin&#39;</span> <span class="ow">and</span> <span class="n">password</span> <span class="o">==</span> <span class="s1">&#39;admin&#39;</span><span class="p">:</span><span class="c1">#如果用户名和密码是否为admin</span>
               <span class="k">return</span> <span class="s2">&quot;用户名正确，可以登录！&quot;</span><span class="c1">#i f语句为真的话，返回可以登录信息</span>
           <span class="k">else</span><span class="p">:</span>
               <span class="k">return</span> <span class="s2">&quot;用户名或密码错误,不可以登录！&quot;</span><span class="c1">#否则，返回不可以登录信息</span>
   <span class="c1"># 通过add_url_rule添加类视图和url的映射关系</span>
<span class="n">app</span><span class="o">.</span><span class="n">add_url_rule</span><span class="p">(</span><span class="s1">&#39;/login&#39;</span><span class="p">,</span><span class="n">view_func</span><span class="o">=</span><span class="n">LoginView</span><span class="o">.</span><span class="n">as_view</span><span class="p">(</span><span class="s1">&#39;loginview&#39;</span><span class="p">))</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span> <span class="c1">#当模块被直接运行时，代码将被运行，当模块是被导入时，代码不被执行</span>
       <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="c1">#开启调试模式</span>
</pre></div>
</div>
</section>
</section>
</section>
<section id="id6">
<h3><a class="toc-backref" href="#id60">2.4 Flask装饰器</a><a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h3>
<p>装饰器本质上是一个Python函数，它可以让其他函数在不需要做任何代码变动的前提下增加额外的功能，装饰器的返回值也是一个函数对象。</p>
<p>装饰器经常用于有切面需求的场景，</p>
<p>比如插入日志、性能测试、事务处理、缓存和权限校验等场景。</p>
<p>装饰器是解决这类问题的绝佳设计，有了装饰器，可以抽离出大量与函数功能无关的雷同代码并继续重用。</p>
<section id="id7">
<h4>1.装饰器的定义和基本使用<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h4>
<p>在视图函数news()之前直接加&#64;user_login，就实现了装饰器的使用。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>  <span class="c1"># 导入Flask模块</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>  <span class="c1"># Flask初始化</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>  <span class="c1"># 定义路由</span>
<span class="k">def</span> <span class="nf">hello_world</span><span class="p">():</span>  <span class="c1"># 定义函数</span>
    <span class="k">return</span> <span class="s1">&#39;Hello World!&#39;</span>  <span class="c1"># 返回值</span>


<span class="k">def</span> <span class="nf">user_login</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>  <span class="c1"># 定义函数，使用func接收函数作为参数</span>
    <span class="k">def</span> <span class="nf">inner</span><span class="p">():</span>  <span class="c1"># 定义inner()函数</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;登录操作&#39;</span><span class="p">)</span>  <span class="c1"># 打印输出</span>
        <span class="n">func</span><span class="p">()</span>  <span class="c1"># 执行func函数</span>
    <span class="k">return</span> <span class="n">inner</span>  <span class="c1"># 返回inner函数，不是返回函数的结果</span>


<span class="nd">@user_login</span>  <span class="c1"># 使用了装饰器</span>
<span class="k">def</span> <span class="nf">news</span><span class="p">():</span>  <span class="c1"># 定义函数news</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;这是新闻详情页&#39;</span><span class="p">)</span>  <span class="c1"># 打印输出</span>


<span class="n">news</span><span class="p">()</span>  <span class="c1"># 调用news来执行</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="id8">
<h4>2.对带参数的函数使用装饰器<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h4>
<p>1.函数的可变参数</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>def func(*args,**kwargs):
    - *：代指元组，长度不限；
    - **：代表键值对，个数不限。

    - *args：代表元祖，长度不限制。
    - **kwargs：代表按键值对，个数不限。
</pre></div>
</div>
<p>2.对带参数的函数使用装饰器</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>  <span class="c1"># 导入Flask模块</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>  <span class="c1"># Flask初始化</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>  <span class="c1"># 定义路由</span>
<span class="k">def</span> <span class="nf">hello_world</span><span class="p">():</span>  <span class="c1"># 定义视图函数</span>
    <span class="k">return</span> <span class="s1">&#39;Hello World!&#39;</span>  <span class="c1"># 返回值</span>


<span class="k">def</span> <span class="nf">user_login</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>  <span class="c1"># 定义函数user_login</span>
    <span class="k">def</span> <span class="nf">inner</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>  <span class="c1"># 定义内部函数inner</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;登录操作!&#39;</span><span class="p">)</span>  <span class="c1"># 打印输出</span>
        <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">inner</span>  <span class="c1"># 返回inner</span>


<span class="nd">@user_login</span>  <span class="c1"># 使用装饰器</span>
<span class="k">def</span> <span class="nf">news</span><span class="p">():</span>  <span class="c1"># 定义函数news()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">news</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>  <span class="c1"># 打印输出此时的函数名称</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;这是新闻详情页!&#39;</span><span class="p">)</span>  <span class="c1"># 打印输出</span>


<span class="n">news</span><span class="p">()</span>


<span class="nd">@user_login</span>  <span class="c1"># 使用装饰器</span>
<span class="k">def</span> <span class="nf">news_list</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>  <span class="c1"># 定义函数news_list</span>
    <span class="n">page</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># 元祖args[0]赋值给page</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">news_list</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>  <span class="c1"># 打印输出函数名</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;这是新闻列表页的第&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;页！&#39;</span><span class="p">)</span>  <span class="c1"># 打印输出</span>


<span class="n">news_list</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>  <span class="c1"># 调用函数news_list</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>  <span class="c1"># 当模块被直接运行时，代码将被运行，当模块是被导入时，代码不被执行</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p>输出结果如下：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>登录操作!
inner
这是新闻详情页!
登录操作!
inner
这是新闻列表页的第5页！
</pre></div>
</div>
<p>以上代码还存在一点问题，在调用过程中会改变原来的名称，不管是news()函数还是news_list()函数，最终执行时被替换成了inner()函数。</p>
<p>为避免出现此种情况，可以使用functools.wraps在装饰器的函数上对传进来的函数进行包裹，这样就不会丢失原始函数了。</p>
<blockquote>
<div><p>注意：导入包wraps，使用命令为from functools import wraps。</p>
</div></blockquote>
<p>带参数的函数使用装饰器优化实例：app.py</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>  <span class="c1"># 导入Flask模块</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span>  <span class="c1"># 导入相应模块</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>  <span class="c1"># Flask初始化</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>  <span class="c1"># 定义路由</span>
<span class="k">def</span> <span class="nf">hello_world</span><span class="p">():</span>  <span class="c1"># 定义视图函数</span>
    <span class="k">return</span> <span class="s1">&#39;Hello World!&#39;</span>  <span class="c1"># 返回值</span>


<span class="k">def</span> <span class="nf">user_login</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>  <span class="c1"># 定义函数user_login</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>  <span class="c1"># 使用functools.wraps在装饰器的函数上，把传进来的函数进行包裹</span>
    <span class="k">def</span> <span class="nf">inner</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>  <span class="c1"># 定义内部函数inner</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;登录操作!&#39;</span><span class="p">)</span>  <span class="c1"># 打印输出</span>
        <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">inner</span>  <span class="c1"># 返回inner</span>


<span class="nd">@user_login</span>  <span class="c1"># 使用装饰器</span>
<span class="k">def</span> <span class="nf">news</span><span class="p">():</span>  <span class="c1"># 定义函数news()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">news</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>  <span class="c1"># 打印输出此时的函数名称</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;这是新闻详情页!&#39;</span><span class="p">)</span>  <span class="c1"># 打印输出</span>


<span class="n">news</span><span class="p">()</span>


<span class="nd">@user_login</span>  <span class="c1"># 使用装饰器</span>
<span class="k">def</span> <span class="nf">news_list</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>  <span class="c1"># 定义函数news_list</span>
    <span class="n">page</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># 元祖args[0]赋值给page</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">news_list</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>  <span class="c1"># 打印输出函数名</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;这是新闻列表页的第&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;页！&#39;</span><span class="p">)</span>  <span class="c1"># 打印输出</span>


<span class="n">news_list</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>  <span class="c1"># 调用函数news_list</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>  <span class="c1"># 当模块被直接运行时，代码将被运行，当模块是被导入时，代码不被执行</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
</section>
</section>
</section>
<section id="id9">
<h2><a class="toc-backref" href="#id61">3.路由详解</a><a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h2>
<section id="id10">
<h3><a class="toc-backref" href="#id62">3.1在路径中添加变量</a><a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/login/&lt;username&gt;&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">show_welcome</span><span class="p">(</span><span class="n">username</span><span class="p">):</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;Hi </span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s1">&#39;</span>
</pre></div>
</div>
<p>被添加的参数需要两次被声明：第1次是在route()装饰器的参数中，在需要使用变量的URL部分用方式声明变量；第2次是在所映射的函数（本例中为show_welcome）的参数中声明变量名，这样被声明的变量就可以在映射函数内使用了。</p>
<p>本例中username变量被作为欢迎语句的一部分回传给客户端。</p>
<blockquote>
<div><p>注意： 两次变量声明的变量名一定要一致。</p>
</div></blockquote>
</section>
<section id="id11">
<h3><a class="toc-backref" href="#id63">3.2为变量指定类型</a><a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h3>
<p>可以在声明变量时指定变量被映射的类型，比如：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/add/&lt;int:number&gt;&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">add_one</span><span class="p">(</span><span class="n">number</span><span class="p">):</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">number</span> <span class="o">+</span> <span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span>
</pre></div>
</div>
<p>Flask中允许有3种类型的变量映射，如表8.1所示。</p>
<p>表8.1　路由变量映射类型表</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 25%" />
<col style="width: 75%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>映射类型</p></th>
<th class="head"><p>说明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Int</p></td>
<td><p>接受整型数值变量</p></td>
</tr>
<tr class="row-odd"><td><p>Float</p></td>
<td><p>接受浮点型数值变量</p></td>
</tr>
<tr class="row-even"><td><p>Path</p></td>
<td><p>默认方式，接受路径字符串</p></td>
</tr>
</tbody>
</table>
<p><strong>3．路径最后的分隔符的作用</strong></p>
<p>在URL路径中，斜杠“/”被用作路径分隔符。当斜杠被写在URL路径的开头时，则表明本路径是一个绝对路径；当斜杠被写在路径中间时，它被用作隔离路径的层级。</p>
<p>那么，当它被写在最后时，它的作用是什么呢？</p>
<p>通过下面的例子可以理解斜杠分隔符被写在路径最后时的作用。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/school/&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">schools</span><span class="p">():</span>
    <span class="k">return</span> <span class="s1">&#39;The school page&#39;</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/school&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">schools</span><span class="p">():</span>
    <span class="k">return</span> <span class="s1">&#39;The school page&#39;</span>
</pre></div>
</div>
<p>是否带斜杠结尾的路径声明效果分析</p>
<img alt="../../../_images/image-20220905114643362.png" src="../../../_images/image-20220905114643362.png" />
</section>
<section id="http">
<h3><a class="toc-backref" href="#id64">3.3HTTP方法绑定</a><a class="headerlink" href="#http" title="Permalink to this headline">¶</a></h3>
<p>网站通过HTTP与浏览器或其他客户端进行交互，而HTTP访问一个URL时可以使用几种不同的访问方式，包括GET、POST、HEAD、DELETE等。在Flask中，路由默认设置使用GET方式进行路径访问。</p>
<p><strong>1.指定HTTP访问方式的方法</strong></p>
<p>通过修改route中的参数，可以配置其他访问方式。举例说明：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/SendMessage&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">Messaging</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">do_send</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">show_the_send_form</span><span class="p">()</span>
</pre></div>
</div>
<p>本例中，在route装饰器中显式地声明了两种HTTP访问方式：GET和POST。无论客户端使用哪种方式访问地址/SendMessage,
Flask都会定位到Messaging（）函数并执行。可以在函数中通过request.method属性获得本次HTTP请求的访问方式。</p>
<blockquote>
<div><p><strong>注意：</strong>
request是Flask框架的一个全局对象，可以获得很多HTTP请求的客户端相关的信息。</p>
</div></blockquote>
<p><strong>2.将同一个URL根据访问方式映射到不同的函数</strong></p>
<p>可以灵活地运用URL、访问方法、被映射函数的绑定关系。通过把不同的访问方式赋予相同的URL，可以对其绑定不同的映射函数。</p>
<p>【示例8-8】比如：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/Message&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">do_send</span><span class="p">():</span>
    <span class="k">return</span> <span class="s2">&quot;This is for POST methods&quot;</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/Message&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">show_the_send_form</span><span class="p">():</span>
    <span class="k">return</span> <span class="s2">&quot;This is for GET methods&quot;</span>
</pre></div>
</div>
</section>
<section id="id12">
<h3><a class="toc-backref" href="#id65">3.4路由地址反向生成</a><a class="headerlink" href="#id12" title="Permalink to this headline">¶</a></h3>
<p>通过前面的学习，读者已经掌握了将URL绑定到映射函数的方法。但有时，程序中需要通过函数名称获得与其绑定的URL地址。Flask通过url_for（）函数实现了这个功能。在使用前，需要先从Flask包中导入对url_for（）函数的引用。函数的第1个参数是需要获取URL的函数名，URL中如果有变量，则可以在url_for（）中添加参数来实现对变量的赋值。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">url_for</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">f_root</span><span class="p">():</span><span class="k">pass</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/industry&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">f_industry</span><span class="p">():</span><span class="k">pass</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/book/&lt;book_name&gt;&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">f_book</span><span class="p">(</span><span class="n">book_name</span><span class="p">):</span><span class="k">pass</span>

<span class="k">with</span> <span class="n">app</span><span class="o">.</span><span class="n">test_request_context</span><span class="p">():</span>
  <span class="nb">print</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;f_root&#39;</span><span class="p">))</span>                               <span class="c1">#例1，输出：/</span>
  <span class="nb">print</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;f_industry&#39;</span><span class="p">))</span>                          <span class="c1">#例2，输出：/industry</span>
  <span class="nb">print</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;f_industry&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;web&#39;</span><span class="p">))</span>               <span class="c1">#例3，输出：/industry? name=web</span>
  <span class="nb">print</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;f_book&#39;</span><span class="p">,</span> <span class="n">book_name</span><span class="o">=</span><span class="s1">&#39;Python Book&#39;</span><span class="p">))</span>      <span class="c1">#例4，输出：/book/Python%20Book</span>
</pre></div>
</div>
<blockquote>
<div><p>技巧：
Flask中test_request_context（）方法用于告诉解释器为在其作用域中的代码模拟一个HTTP请求上下文，使其好像被一个HTTP请求所调用。HTTP请求上下文是调用url_for所必需的环境。</p>
</div></blockquote>
<p>我们可以给这个装饰器再加上endpoint参数（给这个URL命名）</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span><span class="n">endpoint</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">hello_world</span><span class="p">():</span>
    <span class="k">return</span> <span class="s1">&#39;hello world&#39;</span>
</pre></div>
</div>
<p>一旦我们使用了endpoint参数，在使用url_for()反转时就不能使用视图函数名了，而是要用我们定义的URL名。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>在程序中需要使用url_for()函数的原因如下。</p>
<ul class="simple">
<li><p>反向解析比硬编码有更好的可读性和可维护性。比如，当需要更换路由函数中URL的地址时，无须再更改和调用url_for处的代码。</p></li>
<li><p>url_for会自动处理必需的特殊字符转换和Unicode编码转换。本节代码段中例4的空格就被自动解析为%20。</p></li>
</ul>
</section>
<section id="id13">
<h3><a class="toc-backref" href="#id66">3.5路由系统</a><a class="headerlink" href="#id13" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>&#64;app.route(‘/user/’)</p></li>
<li><p>&#64;app.route(‘/post/’)</p></li>
<li><p>&#64;app.route(‘/post/’)</p></li>
<li><p>&#64;app.route(‘/post/’)</p></li>
<li><p>&#64;app.route(‘/login’, methods=[‘GET’, ‘POST’])</p></li>
</ul>
<p>常用路由系统有以上五种，所有的路由系统都是基于一下对应关系来处理：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">DEFAULT_CONVERTERS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;default&#39;</span><span class="p">:</span>          <span class="n">UnicodeConverter</span><span class="p">,</span>
    <span class="s1">&#39;string&#39;</span><span class="p">:</span>           <span class="n">UnicodeConverter</span><span class="p">,</span>
    <span class="s1">&#39;any&#39;</span><span class="p">:</span>              <span class="n">AnyConverter</span><span class="p">,</span>
    <span class="s1">&#39;path&#39;</span><span class="p">:</span>             <span class="n">PathConverter</span><span class="p">,</span>
    <span class="s1">&#39;int&#39;</span><span class="p">:</span>              <span class="n">IntegerConverter</span><span class="p">,</span>
    <span class="s1">&#39;float&#39;</span><span class="p">:</span>            <span class="n">FloatConverter</span><span class="p">,</span>
    <span class="s1">&#39;uuid&#39;</span><span class="p">:</span>             <span class="n">UUIDConverter</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<section id="id14">
<h2><a class="toc-backref" href="#id67">4.静态文件</a><a class="headerlink" href="#id14" title="Permalink to this headline">¶</a></h2>
<p>静态文件，顾名思义，就是那些不会被改变的文件，比如图片，CSS 文件和
JavaScript 源码文件。默认情况下，Flask 在程序根目录中名为 static
的子目录中寻找静态文件。因此，我们一般在应用的包中创建一个叫 static
的文件夹，并在里面放置我们的静态文件。比如，我们可以按下面的结构组织我们的
app：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">app</span><span class="o">/</span>
    <span class="fm">__init__</span><span class="o">.</span><span class="n">py</span>
    <span class="n">static</span><span class="o">/</span>
        <span class="n">css</span><span class="o">/</span>
            <span class="n">style</span><span class="o">.</span><span class="n">css</span>
            <span class="n">home</span><span class="o">.</span><span class="n">css</span>
            <span class="n">admin</span><span class="o">.</span><span class="n">css</span>
        <span class="n">js</span><span class="o">/</span>
            <span class="n">home</span><span class="o">.</span><span class="n">js</span>
            <span class="n">admin</span><span class="o">.</span><span class="n">js</span>
        <span class="n">img</span><span class="o">/</span>
            <span class="n">favicon</span><span class="o">.</span><span class="n">co</span>
            <span class="n">logo</span><span class="o">.</span><span class="n">svg</span>
    <span class="n">templates</span><span class="o">/</span>
        <span class="n">index</span><span class="o">.</span><span class="n">html</span>
        <span class="n">home</span><span class="o">.</span><span class="n">html</span>
        <span class="n">admin</span><span class="o">.</span><span class="n">html</span>
    <span class="n">views</span><span class="o">/</span>
    <span class="n">models</span><span class="o">/</span>
<span class="n">run</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
<p>但是，我们有时还会应用到第三方库，比如 jQuery, Bootstrap
等，这时我们为了不跟自己的 Javascript 和 CSS
文件混起来，我们可以将这些第三方库放到 lib 文件夹或者 vendor
文件夹，比如下面这种：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">static</span><span class="o">/</span>
    <span class="n">css</span><span class="o">/</span>
        <span class="n">lib</span><span class="o">/</span>
            <span class="n">bootstrap</span><span class="o">.</span><span class="n">css</span>
        <span class="n">style</span><span class="o">.</span><span class="n">css</span>
        <span class="n">home</span><span class="o">.</span><span class="n">css</span>
        <span class="n">admin</span><span class="o">.</span><span class="n">css</span>
    <span class="n">js</span><span class="o">/</span>
        <span class="n">lib</span><span class="o">/</span>
            <span class="n">jquery</span><span class="o">.</span><span class="n">js</span>
            <span class="n">chart</span><span class="o">.</span><span class="n">js</span>
        <span class="n">home</span><span class="o">.</span><span class="n">js</span>
        <span class="n">admin</span><span class="o">.</span><span class="n">js</span>
    <span class="n">img</span><span class="o">/</span>
        <span class="n">logo</span><span class="o">.</span><span class="n">svg</span>
        <span class="n">favicon</span><span class="o">.</span><span class="n">ico</span>
</pre></div>
</div>
<section id="favicon">
<h3><a class="toc-backref" href="#id68">1.提供一个favicon 图标</a><a class="headerlink" href="#favicon" title="Permalink to this headline">¶</a></h3>
<p>favicon 是 favorites icon 的缩写，也被称为 website
icon（网页图标）、page icon（页面图标）等。通常而言，定义一个 favicon
的方法是将一个名为『favicon.ico』的文件置于 Web
服务器的根目录下。但是，正如我们在上面指出，我们一般将图片等静态资源放在一个单独的
static 文件夹中。为了解决这种不一致，我们可以在站点模板的 部分添加两个
link 组件，比如我们可以在 template/base.html 中定义 favicon 图标：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="o">%</span> <span class="n">block</span> <span class="n">head</span> <span class="o">%</span><span class="p">}</span>
<span class="p">{{</span> <span class="nb">super</span><span class="p">()</span> <span class="p">}}</span>
<span class="o">&lt;</span><span class="n">link</span> <span class="n">rel</span><span class="o">=</span><span class="s2">&quot;shortcut icon&quot;</span> <span class="n">href</span><span class="o">=</span><span class="s2">&quot;{{ url_for(&#39;static&#39;, filename = &#39;favicon.ico&#39;) }}&quot;</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;image/x-icon&quot;</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">link</span> <span class="n">rel</span><span class="o">=</span><span class="s2">&quot;icon&quot;</span> <span class="n">href</span><span class="o">=</span><span class="s2">&quot;{{ url_for(&#39;static&#39;, filename = &#39;favicon.ico&#39;) }}&quot;</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;image/x-icon&quot;</span><span class="o">&gt;</span>
<span class="p">{</span><span class="o">%</span> <span class="n">endblock</span> <span class="o">%</span><span class="p">}</span>
</pre></div>
</div>
<p>在上面的代码中，我们使用了 <code class="docutils literal notranslate"><span class="pre">super()</span></code>
来保留基模板中定义的块的原始内容，并添加了两个 link
组件声明图标位置，这两个 link 组件声明会插入到 head 块的末尾。</p>
</section>
</section>
<section id="jinja2">
<h2><a class="toc-backref" href="#id69">5. Jinja2 模板引擎</a><a class="headerlink" href="#jinja2" title="Permalink to this headline">¶</a></h2>
<p>了解即可，不用深入</p>
<p>目前flask主要用来写接口前后端分离，Jinja2多用于前后端不分离场景，暂时接触不多，部分可以阅读如下文章</p>
<p><a class="reference external" href="https://www.bookstack.cn/read/head-first-flask/chapter02-section2.04.md">https://www.bookstack.cn/read/head-first-flask/chapter02-section2.04.md</a></p>
</section>
<section id="id15">
<h2><a class="toc-backref" href="#id70">6.请求、重定向及会话</a><a class="headerlink" href="#id15" title="Permalink to this headline">¶</a></h2>
<p>Web 开发中经常需要处理 HTTP 请求、重定向和会话等诸多事务，相应地，Flask
也内建了一些常见的对象如 request, session, redirect 等对它们进行处理。</p>
<section id="request">
<h3><a class="toc-backref" href="#id71">1.请求对象 request</a><a class="headerlink" href="#request" title="Permalink to this headline">¶</a></h3>
<p>HTTP 请求方法有 GET、POST、PUT 等，request 对象也相应地提供了支持。</p>
<p>举个例子，假设现在我们开发一个功能：用户注册。如果 HTTP 请求方法是
POST，我们就注册该用户，如果是 GET
请求，我们就显示注册的字样。代码示例如下（注意，下面代码并不能直接运行，文末提供了完整的代码）：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/register&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="s1">&#39;GET&#39;</span><span class="p">]):</span>
<span class="k">def</span> <span class="nf">register</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;please register!&#39;</span>
    <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="n">user</span>
</pre></div>
</div>
</section>
<section id="redirect">
<h3><a class="toc-backref" href="#id72">2.重定向对象 redirect</a><a class="headerlink" href="#redirect" title="Permalink to this headline">¶</a></h3>
<p>当用户访问某些网页时，如果他还没登录，我们往往会把网页<strong>重定向</strong>到登录页面，Flask
提供了 redirect
对象对其进行处理，我们对上面的代码做一点简单的改造，如果用户注册了，我们将网页重定向到首页。代码示例如下：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">redirect</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/home&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">]):</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="k">return</span> <span class="s1">&#39;hello world!&#39;</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/register&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="s1">&#39;GET&#39;</span><span class="p">]):</span>
<span class="k">def</span> <span class="nf">register</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;please register!&#39;</span>
    <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;/home&#39;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="session">
<h3><a class="toc-backref" href="#id73">3.会话对象 session</a><a class="headerlink" href="#session" title="Permalink to this headline">¶</a></h3>
<p>程序可以把数据存储在<strong>用户会话</strong>中，用户会话是一种私有存储，默认情况下，它会保存在客户端
cookie 中。Flask 提供了 session 对象来操作用户会话，下面看一个示例：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">url_for</span><span class="p">,</span> <span class="n">render_template</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/home&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="k">return</span> <span class="s1">&#39;hello world!&#39;</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/register&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">register</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">user_name</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span>
        <span class="n">session</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_name</span>
        <span class="k">return</span> <span class="s1">&#39;hello, &#39;</span> <span class="o">+</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;user&#39;</span> <span class="ow">in</span> <span class="n">session</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;login.html&#39;</span><span class="p">)</span>

<span class="n">app</span><span class="o">.</span><span class="n">secret_key</span> <span class="o">=</span> <span class="s1">&#39;123456&#39;</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">5632</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>操作 <code class="docutils literal notranslate"><span class="pre">session</span></code> 就像操作 python 中的字典一样，我们可以使用
<code class="docutils literal notranslate"><span class="pre">session['user']</span></code> 获取值，也可以使用 <code class="docutils literal notranslate"><span class="pre">session.get('user')</span></code>
获取值。注意到，我们使用了 <code class="docutils literal notranslate"><span class="pre">url_for</span></code> 生成 URL，比如 <code class="docutils literal notranslate"><span class="pre">/home</span></code> 写成了
<code class="docutils literal notranslate"><span class="pre">url_for('index')</span></code>。</p>
<p><code class="docutils literal notranslate"><span class="pre">url_for()</span></code>
函数的第一个且唯一必须指定的参数是端点名，即路由的内部名字。默认情况下，路由的端点是相应视图函数的名字，因此
<code class="docutils literal notranslate"><span class="pre">/home</span></code> 应该写成 <code class="docutils literal notranslate"><span class="pre">url_for('index')</span></code>。</p>
<p>还有一点，使用<code class="docutils literal notranslate"><span class="pre">session</span></code> 时要设置一个密钥 <code class="docutils literal notranslate"><span class="pre">app.secret_key</span></code>。</p>
</section>
<section id="id16">
<h3><a class="toc-backref" href="#id74">4.附录</a><a class="headerlink" href="#id16" title="Permalink to this headline">¶</a></h3>
<p>本节完整的代码如下：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ tree .
.
├── flask-session.py
└── templates
    ├── layout.html
    └── login.html

$ cat flask-session.py
from flask import Flask, request, session, redirect, url_for, render_template
app = Flask(__name__)
@app.route(&#39;/&#39;)
def head():
    return redirect(url_for(&#39;register&#39;))
@app.route(&#39;/home&#39;, methods=[&#39;GET&#39;])
def index():
    return &#39;hello world!&#39;
@app.route(&#39;/register&#39;, methods=[&#39;GET&#39;, &#39;POST&#39;])
def register():
    if request.method == &#39;POST&#39;:
        user_name = request.form[&#39;user&#39;]
        session[&#39;user&#39;] = user_name
        return &#39;hello, &#39; + session[&#39;user&#39;]
    elif request.method == &#39;GET&#39;:
        if &#39;user&#39; in session:
            return redirect(url_for(&#39;index&#39;))
        else:
            return render_template(&#39;login.html&#39;)
app.secret_key = &#39;123456&#39;
if __name__ == &#39;__main__&#39;:
    app.run(host=&#39;127.0.0.1&#39;, port=5632, debug=True)


$ cat layout.html
&lt;!doctype html&gt;
&lt;title&gt;Hello Sample&lt;/title&gt;
&lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; href=&quot;{{ url_for(&#39;static&#39;, filename=&#39;style.css&#39;) }}&quot;&gt;
&lt;div class=&quot;page&quot;&gt;
    {% block body %}
    {% endblock %}
&lt;/div&gt;


$ cat login.html
{% extends &quot;layout.html&quot; %}
{% block body %}
&lt;form name=&quot;register&quot; action=&quot;{{ url_for(&#39;register&#39;) }}&quot; method=&quot;post&quot;&gt;
    Hello {{ title }}, please login by:
    &lt;input type=&quot;text&quot; name=&quot;user&quot; /&gt;
&lt;/form&gt;
{% endblock %}
</pre></div>
</div>
</section>
</section>
<section id="id17">
<h2><a class="toc-backref" href="#id75">7.蓝图</a><a class="headerlink" href="#id17" title="Permalink to this headline">¶</a></h2>
<p>一个程序执行文件中，如果功能代码过多，是不方便后期维护的。如何实现程序代码模块化，根据具体不同功能模块的实现，划分成不同的分类，降低各功能模块之间的耦合度呢？这时flask.Blueprint（蓝图）就派上用场了。</p>
<blockquote>
<div><p>注意：蓝图可以极大地简化大型应用，并为扩展提供集中的注册入口。</p>
<p>Blueprint对象与Flask应用对象的工作方式类似，但不是一个真正的应用。</p>
</div></blockquote>
<p>在PyCharm中新建工程，新建<code class="docutils literal notranslate"><span class="pre">app.py</span></code>、<code class="docutils literal notranslate"><span class="pre">news.py</span></code>、<code class="docutils literal notranslate"><span class="pre">produt.py</span></code>三个文件。</p>
<p>app.py文件内容如下：</p>
<p>蓝图使用实例：主路由视图函数app.py</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># -*- coding:utf-8 -*-</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>  <span class="c1"># 导入Flask模块</span>
<span class="kn">import</span> <span class="nn">news</span><span class="o">,</span> <span class="nn">products</span>  <span class="c1"># 导入相应模块</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>  <span class="c1"># 创建 Flask()对象： app</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>  <span class="c1"># 使用了蓝图，app.route() 这种模式就仍可以使用，注意路由重复的问题</span>
<span class="k">def</span> <span class="nf">hello_world</span><span class="p">():</span>  <span class="c1"># 定义函数</span>
    <span class="k">return</span> <span class="s1">&#39;hello my world !&#39;</span>  <span class="c1"># 返回值</span>


<span class="n">app</span><span class="o">.</span><span class="n">register_blueprint</span><span class="p">(</span><span class="n">news</span><span class="o">.</span><span class="n">new_list</span><span class="p">)</span>  <span class="c1"># 将news模块里的蓝图对象new_list注册到app</span>
<span class="n">app</span><span class="o">.</span><span class="n">register_blueprint</span><span class="p">(</span><span class="n">products</span><span class="o">.</span><span class="n">product_list</span><span class="p">)</span>  <span class="c1"># 将products模块里的蓝图对象product_list注册到app</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># 调试模式开 启动服务器 运行在默认的5000端口</span>
</pre></div>
</div>
<p>news.py文件内容如下：</p>
<p>蓝图使用实例：分路由视图函数news.py</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># -*- coding:utf-8 -*-</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Blueprint</span>  <span class="c1"># 导入Blueprint模块</span>

<span class="n">new_list</span> <span class="o">=</span> <span class="n">Blueprint</span><span class="p">(</span><span class="s1">&#39;news&#39;</span><span class="p">,</span> <span class="vm">__name__</span><span class="p">)</span>  <span class="c1"># 创建一个blueprint对象。第一个参数可看做该blueprint对象的姓名</span>


<span class="c1"># 在一个app里，姓名不能与其余的Blueprint对象姓名重复</span>
<span class="c1"># 第二个参数__name__用作初始化</span>
<span class="nd">@new_list</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/news&quot;</span><span class="p">)</span>  <span class="c1"># 将蓝图对象当做‘app’那样使用</span>
<span class="k">def</span> <span class="nf">new</span><span class="p">():</span>  <span class="c1"># 定义函数news()</span>
    <span class="k">return</span> <span class="s1">&#39;这是新闻模块！&#39;</span>
</pre></div>
</div>
<p>products.py文件内容如下：</p>
<p>蓝图使用实例：分路由视图函数products.py</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># -*- coding:utf-8 -*-</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Blueprint</span>  <span class="c1"># 导入Blueprint模块</span>

<span class="n">product_list</span> <span class="o">=</span> <span class="n">Blueprint</span><span class="p">(</span><span class="s1">&#39;products&#39;</span><span class="p">,</span> <span class="vm">__name__</span><span class="p">)</span>  <span class="c1"># 创建一个blueprint对象。第一个参数可看做该blueprint对象的名字</span>


<span class="c1"># 在一个app里，对象名不能与其余的Blueprint对象名重复</span>
<span class="c1"># 第二个参数__name__用作初始化</span>
<span class="nd">@product_list</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/products&quot;</span><span class="p">)</span>  <span class="c1"># 将蓝图对象当做‘app’那样使用</span>
<span class="k">def</span> <span class="nf">product</span><span class="p">():</span>
    <span class="k">return</span> <span class="s1">&#39;这是产品模块！&#39;</span>
</pre></div>
</div>
<p>查看蓝图设置是否生效:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ curl http://127.0.0.1:5000/
hello my world !

$ curl http://127.0.0.1:5000/news
这是新闻模块！

$ curl http://127.0.0.1:5000/products
这是产品模块！
</pre></div>
</div>
<p>蓝图的目的是实现各个模块的视图函数写在不同的py文件中。</p>
<p>在主视图中导入分路由视图的模块，并且注册蓝图对象。</p>
<blockquote>
<div><p><strong>注意：视图函数的名称不能和蓝图对称的名称一样。</strong></p>
</div></blockquote>
<p><a class="reference external" href="https://www.bookstack.cn/read/head-first-flask/chapter02-section2.06.md">https://www.bookstack.cn/read/head-first-flask/chapter02-section2.06.md</a></p>
</section>
<section id="id18">
<h2><a class="toc-backref" href="#id76">8.Flask数据交互</a><a class="headerlink" href="#id18" title="Permalink to this headline">¶</a></h2>
<section id="id19">
<h3><a class="toc-backref" href="#id77">8.1 使用Flask处理表单</a><a class="headerlink" href="#id19" title="Permalink to this headline">¶</a></h3>
<p>Form表单是Web应用中最基础的一部分。为了能处理Form表单，Flask-WTF扩展提供了良好的支持。</p>
<section id="id20">
<h4>1.使用Flask处理通用表单<a class="headerlink" href="#id20" title="Permalink to this headline">¶</a></h4>
<p>Flask请求对象包含客户端发出的所有请求信息。其中，request.form能获取POST请求中提交的表单数据。</p>
<p>尽管Flask的请求对象提供的信息足够用于处理Web表单，但有些任务很单调，而且需要重复操作。</p>
<p>使用Flask处理普通表单：app.py</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># encoding:utf-8#指定编码</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">render_template</span><span class="p">,</span> <span class="n">request</span>  <span class="c1"># 导入相应模块</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>  <span class="c1"># Flask初始化</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>  <span class="c1"># 定义路由</span>
<span class="k">def</span> <span class="nf">hello_world</span><span class="p">():</span>  <span class="c1"># 定义视图函数</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;index.html&#39;</span><span class="p">)</span>  <span class="c1"># 使用render_template函数渲染模板</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/login&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span>  <span class="c1"># 定义路由，指定访问方法</span>
<span class="k">def</span> <span class="nf">login</span><span class="p">():</span>  <span class="c1"># 定义视图函数</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span>  <span class="c1"># 如果访问方法为GET方法</span>
        <span class="k">return</span> <span class="s1">&#39;这是get请求&#39;</span>  <span class="c1"># 返回应答信息</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;这是POST请求&#39;</span>  <span class="c1"># 返回应答信息</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>  <span class="c1"># 当模块被直接运行时，代码将被运行，当模块是被导入时，代码不被运行。</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># 开启调试模式</span>
</pre></div>
</div>
<p>使用Flask处理普通表单：index.html</p>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span> <span class="na">lang</span><span class="o">=</span><span class="s">&quot;en&quot;</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">charset</span><span class="o">=</span><span class="s">&quot;UTF-8&quot;</span><span class="p">&gt;</span><span class="c">&lt;!--指定网页编码--&gt;</span>
    <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>Title<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span><span class="c">&lt;!--指定网页标题--&gt;</span>
<span class="p">&lt;</span><span class="nt">style</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text/css&quot;</span><span class="p">&gt;</span>
 <span class="p">.</span><span class="nc">div1</span> <span class="p">{</span>
    <span class="k">height</span><span class="p">:</span><span class="mi">180</span><span class="kt">px</span><span class="p">;</span>
    <span class="k">width</span><span class="p">:</span><span class="mi">380</span><span class="kt">px</span><span class="p">;</span>
     <span class="k">border</span><span class="p">:</span><span class="mi">1</span><span class="kt">px</span> <span class="kc">solid</span> <span class="mh">#8A8989</span><span class="p">;</span>
     <span class="k">margin</span><span class="p">:</span><span class="mi">0</span> <span class="kc">auto</span><span class="p">;</span>
        <span class="p">}</span>
<span class="p">.</span><span class="nc">input</span><span class="p">{</span>
    <span class="k">display</span><span class="p">:</span> <span class="kc">block</span><span class="p">;</span>
 <span class="k">width</span><span class="p">:</span> <span class="mi">350</span><span class="kt">px</span><span class="p">;</span>
 <span class="k">height</span><span class="p">:</span> <span class="mi">40</span><span class="kt">px</span><span class="p">;</span>
 <span class="k">margin</span><span class="p">:</span> <span class="mi">10</span><span class="kt">px</span> <span class="kc">auto</span><span class="p">;</span>
<span class="p">}</span>
 <span class="p">.</span><span class="nc">button</span>
 <span class="p">{</span>
     <span class="k">background</span><span class="p">:</span> <span class="mh">#2066C5</span><span class="p">;</span>
 <span class="k">color</span><span class="p">:</span> <span class="kc">white</span><span class="p">;</span>
 <span class="k">font-size</span><span class="p">:</span> <span class="mi">18</span><span class="kt">px</span><span class="p">;</span>
 <span class="k">font-weight</span><span class="p">:</span> <span class="kc">bold</span><span class="p">;</span>
 <span class="k">height</span><span class="p">:</span> <span class="mi">50</span><span class="kt">px</span><span class="p">;</span>
 <span class="k">border-radius</span><span class="p">:</span> <span class="mi">4</span><span class="kt">px</span><span class="p">;</span>
 <span class="p">}</span>
    <span class="p">&lt;/</span><span class="nt">style</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span><span class="c">&lt;!--head区域完毕--&gt;</span>
<span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span><span class="c">&lt;!--body区域开始--&gt;</span>
<span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;div1&quot;</span><span class="p">&gt;&lt;</span><span class="nt">form</span> <span class="na">action</span><span class="o">=</span><span class="s">&quot;login&quot;</span> <span class="na">method </span><span class="o">=</span> <span class="s">&quot;post&quot;</span><span class="p">&gt;</span><span class="c">&lt;!--定义表单开始--&gt;</span>
    <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text&quot;</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;input&quot;</span> <span class="na">placeholder</span><span class="o">=</span><span class="s">&quot;请输入用户名&quot;</span><span class="p">&gt;</span><span class="c">&lt;!--输入文本框--&gt;</span>
 <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;password&quot;</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;input&quot;</span> <span class="na">placeholder</span><span class="o">=</span><span class="s">&quot;请输入密码&quot;</span><span class="p">&gt;</span><span class="c">&lt;!--输入文本框--&gt;</span>
    <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;submit&quot;</span> <span class="na">value</span><span class="o">=</span><span class="s">&quot;登录&quot;</span>  <span class="na">class</span><span class="o">=</span><span class="s">&quot;input button&quot;</span><span class="p">&gt;</span><span class="c">&lt;!--定义登陆用button--&gt;</span>
<span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span> <span class="c">&lt;!--form表单结束--&gt;</span>
<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span><span class="c">&lt;!--body区域完毕--&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</pre></div>
</div>
<p>在上面的工程中，对表单没有进行必要的保护措施，很容易被人利用，控制用户在当前已登录的Web应用程序上执行非本意的操作。</p>
<p>因此，在实际部署服务器上的代码时，不建议使用这个方式处理表单，推荐使用Flask-WTF方式进行表单处理。</p>
</section>
<section id="flask-wtf">
<h4>2.使用Flask-WTF处理表单<a class="headerlink" href="#flask-wtf" title="Permalink to this headline">¶</a></h4>
<p>1．Flask-WIF的安装</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ pip install flask-wtf
</pre></div>
</div>
<p>2．启用CSRF保护</p>
<p>Flask-WTF提供了对所有Form表单免受跨站请求伪造（Cross-Site Request
Forgery，CSRF）攻击的技术支持（通过添加动态token令牌的方式）。</p>
<p>我们在Flask根目录下新增config.py配置文件，要启用CSRF保护，可以在config.py中定义两个变量：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CSRF_ENABLED</span><span class="o">=</span> <span class="kc">True</span>
<span class="n">SECRET_KEY</span><span class="o">=</span> <span class="s1">&#39;x1x2x3x4x5x6&#39;</span>
</pre></div>
</div>
<p>其中，SECRET_KEY用来建立加密的令牌，用于验证Form表单提交，在自己编写应用程序时，可以尽可能设置得复杂一些，这样恶意攻击者将很难猜到密钥值。</p>
<p>在app.py文件中添加如下代码：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#导入相应模块</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span><span class="n">flash</span>

<span class="c1">#导入相应模块</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">url_for</span><span class="p">,</span><span class="n">render_template</span>

<span class="c1">#导入CSRFProtect模块</span>
<span class="kn">from</span> <span class="nn">flask_wtf.csrf</span> <span class="kn">import</span> <span class="n">CSRFProtect</span>


<span class="c1">#导入定义的BaseLogin</span>
<span class="c1">#导入BaseLogin模块</span>
<span class="kn">from</span> <span class="nn">forms</span> <span class="kn">import</span> <span class="n">BaseLogin</span>

<span class="c1">#导入配置文件</span>
<span class="kn">import</span> <span class="nn">config</span>

<span class="c1">#Flask初始化</span>
<span class="n">app</span><span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="c1">#配置文件初始化</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">from_object</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<span class="c1">#CSRFProtect模块初始化</span>
<span class="n">CSRFProtect</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
</pre></div>
</div>
<p>也可以直接在config.py文件中启动CSRF模块。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CSRF_ENABLED</span><span class="o">=</span> <span class="kc">True</span>
</pre></div>
</div>
<p>最后，我们需要在响应的html模板的Form表单中加上如下语句：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{{</span><span class="n">form</span><span class="o">.</span><span class="n">csrf_token</span><span class="p">}}</span>
</pre></div>
</div>
<p>或者：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{{</span><span class="n">form</span><span class="o">.</span><span class="n">hidden_tag</span><span class="p">()}}</span>
</pre></div>
</div>
<p>其中的form是views.py中对应处理函数传递过来的Form对象名称，根据具体情况会有所变化。</p>
<p>通过上面的配置，我们就启动了CSRF保护。</p>
</section>
<section id="wtf">
<h4>3.WTF表单登录实例<a class="headerlink" href="#wtf" title="Permalink to this headline">¶</a></h4>
<p>使用Flask-WTF进行表单验证：config.py</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="n">SECRET_KEY</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">24</span><span class="p">)</span>
<span class="n">CSRF_ENABLED</span> <span class="o">=</span> <span class="kc">True</span>
</pre></div>
</div>
<p>使用Flask-WTF进行表单验证：form.py</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># -*- coding:utf-8 -*-</span>
<span class="c1"># 引入Form基类</span>
<span class="kn">from</span> <span class="nn">flask_wtf</span> <span class="kn">import</span> <span class="n">FlaskForm</span>
<span class="c1"># 引入Form元素父类</span>
<span class="kn">from</span> <span class="nn">wtforms</span> <span class="kn">import</span> <span class="n">StringField</span><span class="p">,</span> <span class="n">PasswordField</span><span class="p">,</span> <span class="n">validators</span>
<span class="c1"># 引入Form验证父类</span>
<span class="kn">from</span> <span class="nn">wtforms.validators</span> <span class="kn">import</span> <span class="n">DataRequired</span><span class="p">,</span> <span class="n">Length</span>
<span class="c1"># 登录表单类,继承与Form类</span>


<span class="k">class</span> <span class="nc">BaseLogin</span><span class="p">(</span><span class="n">FlaskForm</span><span class="p">):</span>
    <span class="c1"># 用户名</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">StringField</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">DataRequired</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s2">&quot;用户名不能为空&quot;</span><span class="p">),</span> <span class="n">Length</span><span class="p">(</span>
        <span class="mi">6</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s1">&#39;长度位于6~16之间&#39;</span><span class="p">)],</span> <span class="n">render_kw</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;placeholder&#39;</span><span class="p">:</span> <span class="s1">&#39;输入用户名&#39;</span><span class="p">})</span>
    <span class="c1"># 密码</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">PasswordField</span><span class="p">(</span><span class="s1">&#39;password&#39;</span><span class="p">,</span> <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">DataRequired</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s2">&quot;密码不能为空&quot;</span><span class="p">),</span> <span class="n">Length</span><span class="p">(</span>
        <span class="mi">6</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s1">&#39;长度位于6~16之间&#39;</span><span class="p">)],</span> <span class="n">render_kw</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;placeholder&#39;</span><span class="p">:</span> <span class="s1">&#39;输入密码&#39;</span><span class="p">})</span>
</pre></div>
</div>
<p>使用Flask-WTF进行表单验证：app.py</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">flash</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">url_for</span><span class="p">,</span> <span class="n">render_template</span>
<span class="c1"># from flask_wtf.csrf import CSRFProtect</span>
<span class="c1"># 导入定义的BaseLogin</span>
<span class="kn">from</span> <span class="nn">forms</span> <span class="kn">import</span> <span class="n">BaseLogin</span>
<span class="kn">import</span> <span class="nn">config</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">from_object</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<span class="c1"># CSRFProtect(app)</span>
<span class="c1"># 定义处理函数和路由规则，接收GET和POST请求</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/login&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="s1">&#39;GET&#39;</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">baselogin</span><span class="p">():</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">BaseLogin</span><span class="p">()</span>
    <span class="c1"># 判断是否是验证提交</span>
    <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">validate_on_submit</span><span class="p">():</span>
        <span class="c1"># 跳转</span>
        <span class="n">flash</span><span class="p">(</span><span class="n">form</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">data</span><span class="o">+</span><span class="s1">&#39;|&#39;</span><span class="o">+</span><span class="n">form</span><span class="o">.</span><span class="n">password</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;表单数据提交成功！&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># 渲染</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;login.html&#39;</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">)</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">hello_world</span><span class="p">():</span>
    <span class="k">return</span> <span class="s1">&#39;Hello World!&#39;</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>使用Flask-WTF进行表单验证：login.html</p>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span> <span class="cp">&lt;!DOCTYPE html&gt;</span>
  <span class="p">&lt;</span><span class="nt">html</span> <span class="na">lang</span><span class="o">=</span><span class="s">&quot;en&quot;</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">charset</span><span class="o">=</span><span class="s">&quot;UTF-8&quot;</span><span class="p">&gt;</span>
     <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>Flask_WTF<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">style</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text/css&quot;</span><span class="p">&gt;</span>
 <span class="p">.</span><span class="nc">div1</span> <span class="p">{</span>
       <span class="k">height</span><span class="p">:</span><span class="mi">180</span><span class="kt">px</span><span class="p">;</span>
       <span class="k">width</span><span class="p">:</span><span class="mi">380</span><span class="kt">px</span><span class="p">;</span>
      <span class="k">border</span><span class="p">:</span><span class="mi">1</span><span class="kt">px</span> <span class="kc">solid</span> <span class="mh">#8A8989</span><span class="p">;</span>
       <span class="k">margin</span><span class="p">:</span><span class="mi">0</span> <span class="kc">auto</span><span class="p">;</span>
         <span class="p">}</span>
<span class="p">.</span><span class="nc">input</span><span class="p">{</span>
     <span class="k">display</span><span class="p">:</span> <span class="kc">block</span><span class="p">;</span>
   <span class="k">width</span><span class="p">:</span> <span class="mi">350</span><span class="kt">px</span><span class="p">;</span>
   <span class="k">height</span><span class="p">:</span> <span class="mi">40</span><span class="kt">px</span><span class="p">;</span>
   <span class="k">margin</span><span class="p">:</span> <span class="mi">10</span><span class="kt">px</span> <span class="kc">auto</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="p">.</span><span class="nc">button</span>
   <span class="p">{</span>
      <span class="k">background</span><span class="p">:</span> <span class="mh">#2066C5</span><span class="p">;</span>
   <span class="k">color</span><span class="p">:</span> <span class="kc">white</span><span class="p">;</span>
   <span class="k">font-size</span><span class="p">:</span> <span class="mi">18</span><span class="kt">px</span><span class="p">;</span>
   <span class="k">font-weight</span><span class="p">:</span> <span class="kc">bold</span><span class="p">;</span>
   <span class="k">height</span><span class="p">:</span> <span class="mi">50</span><span class="kt">px</span><span class="p">;</span>
   <span class="k">border-radius</span><span class="p">:</span> <span class="mi">4</span><span class="kt">px</span><span class="p">;</span>
   <span class="p">}</span>
      <span class="p">&lt;/</span><span class="nt">style</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;div1&quot;</span><span class="p">&gt;&lt;</span><span class="nt">form</span> <span class="na">action</span><span class="o">=</span><span class="s">&quot;login&quot;</span> <span class="na">method </span><span class="o">=</span> <span class="s">&quot;post&quot;</span><span class="p">&gt;</span>
  <span class="c">&lt;!--启动CSRF--&gt;</span>
           {{form.hidden_tag()}}
      {{form.name(size=16,id=&#39;name&#39;,class=&#39;input&#39; )}}
      {%for e in form.name.errors%}
               <span class="p">&lt;</span><span class="nt">span</span> <span class="na">style</span><span class="o">=</span><span class="s">&quot;color: red&quot;</span><span class="p">&gt;</span>{{e}}<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
               {%endfor%}
   {{form.password(size=16,id=&#39;password&#39;,class=&#39;input&#39;)}}
  {%for e in form.password.errors%}
               <span class="p">&lt;</span><span class="nt">span</span> <span class="na">style</span><span class="o">=</span><span class="s">&quot;color: red&quot;</span><span class="p">&gt;</span>{{e}}<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
               {%endfor%}
      <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;submit&quot;</span> <span class="na">value</span><span class="o">=</span><span class="s">&quot;登录&quot;</span>  <span class="na">class</span><span class="o">=</span><span class="s">&quot;input button&quot;</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

  <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
 <span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</pre></div>
</div>
</section>
</section>
<section id="id21">
<h3><a class="toc-backref" href="#id78">8.2 使用Flask上传文件</a><a class="headerlink" href="#id21" title="Permalink to this headline">¶</a></h3>
<section id="id22">
<h4>1.使用Flask上传文件的简单实现<a class="headerlink" href="#id22" title="Permalink to this headline">¶</a></h4>
<p>Flask文件上传比较简单，需要注意以下3点要求：</p>
<ul class="simple">
<li><p>一个<code class="docutils literal notranslate"><span class="pre">&lt;form&gt;</span></code>标签被标记有<code class="docutils literal notranslate"><span class="pre">enctype=multipart/form-data</span></code>，并且在里面包含一个<code class="docutils literal notranslate"><span class="pre">&lt;input</span> <span class="pre">type=file&gt;</span></code>标签。</p></li>
<li><p>服务端应用通过请求对象上的files字典访问文件。</p></li>
<li><p>使用文件的save()方法将文件永久地保存在文件系统上的某处。</p></li>
</ul>
<blockquote>
<div><p>注意：表单中必须要有enctype=“multipart/form-data”，否则上传文件无效。</p>
<p>一般可以写成</p>
<form action=""method="post"enctype="multipart/form-data"><p>这种形式。</p>
</div></blockquote>
<p>给出一个Flask框架下实现文件上传的范例：</p>
<p>Flask文件上传：app.py</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">render_template</span><span class="p">,</span> <span class="n">request</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">werkzeug.utils</span> <span class="kn">import</span> <span class="n">secure_filename</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">hello_world</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;upload.html&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">]</span>
        <span class="n">basepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>  <span class="c1"># 当前文件所在路径</span>
        <span class="n">upload_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">basepath</span><span class="p">,</span> <span class="s1">&#39;static&#39;</span><span class="p">,</span> <span class="s1">&#39;uploads&#39;</span><span class="p">,</span> <span class="n">secure_filename</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">filename</span><span class="p">))</span>
        <span class="c1"># upload_path = os.path.join(basepath,,secure_filename(f.filename))</span>
        <span class="n">f</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">upload_path</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;上传文件成功！！&quot;</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>Flask文件上传：upload.html</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;en&quot;&gt;
&lt;head&gt;
    &lt;meta charset=&quot;UTF-8&quot;&gt;
    &lt;title&gt;文件上传&lt;/title&gt;
    &lt;style type=&quot;text/css&quot;&gt;
        .div1{
            height:180px;
        width:380px;
            border:1px solid #8A8989;
            margin:0 auto;
        }
        .a-upload {
            padding: 4px 10px;
            height: 20px;
            line-height: 20px;
            position: relative;
            cursor: pointer;
            color: #888;
            background: #fafafa;
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
            display: inline-block;
            *display: inline;
            *zoom: 1
        }
        .input{
      display: block;
    width: 250px;
    height: 30px;
    margin: 10px auto;
   }
   .button
    {
       background: #2066C5;
    color: white;
    font-size: 18px;
    font-weight: bold;
    height: 30px;
    border-radius: 4px;
    }
    &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;div class=&quot;div1&quot;&gt;


    &lt;form action=&quot;&quot; method = &quot;post&quot; enctype=&#39;multipart/form-data&#39;&gt;

        &lt;input type=&quot;file&quot; name=&quot;file&quot; class=&quot;input&quot;&gt;

         &lt;input type=&quot;submit&quot; value=&quot;上传&quot; class=&quot;input button&quot;&gt;
    &lt;/form&gt;

&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;
</pre></div>
</div>
<p>运行上面的程序之前，请先确保根目录下的static目录下已经创建好uploads目录，然后就可以运行本工程代码了。</p>
<p>本工程可以实现任意文件的上传，但是以中文命名的文件上传时，会出现中文名的丢失。</p>
</section>
<section id="id23">
<h4>2.改进上传功能<a class="headerlink" href="#id23" title="Permalink to this headline">¶</a></h4>
<p>之前实现了基本的文件上传功能，但是存在一些问题：</p>
<ul class="simple">
<li><p>文件没有进行重新命名，多个用户可能可能会存在上传同名文件的问题；</p></li>
<li><p>没有实现文件目录的自动创建，如果网站部署时忘记创建文件保存目录，则会出现文件保存失败问题，影响用户体验；</p></li>
<li><p>文件上传时，没有进行必要的文件格式检验，用户可以直接将可执行文件上传到服务器上，影响到服务器的数据安全性。</p></li>
</ul>
<p>Flask文件上传功能改进1：app.py</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">render_template</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">send_from_directory</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">path</span>
<span class="kn">from</span> <span class="nn">werkzeug.utils</span> <span class="kn">import</span> <span class="n">secure_filename</span>
<span class="kn">import</span> <span class="nn">platform</span>
<span class="kn">from</span> <span class="nn">form</span> <span class="kn">import</span> <span class="n">UploadForm</span>
<span class="kn">from</span> <span class="nn">werkzeug.datastructures</span> <span class="kn">import</span> <span class="n">CombinedMultiDict</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="k">if</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;Windows&quot;</span><span class="p">:</span>
    <span class="n">slash</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;Linux&quot;</span>
    <span class="n">slash</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span>
<span class="c1"># UPLOAD_PATH = os.path.curdir + os.path.sep + &#39;uploads&#39; + os.path.sep</span>
<span class="n">UPLOAD_PATH</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">curdir</span> <span class="o">+</span> <span class="n">slash</span> <span class="o">+</span> <span class="s1">&#39;uploads&#39;</span> <span class="o">+</span> <span class="n">slash</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">hello_world</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;upload.html&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">UPLOAD_PATH</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">UPLOAD_PATH</span><span class="p">)</span>  <span class="c1"># 没有目录则创建目录</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">UploadForm</span><span class="p">(</span><span class="n">CombinedMultiDict</span><span class="p">([</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">validate</span><span class="p">():</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">]</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">secure_filename</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>  <span class="c1"># 取得文件名字</span>
            <span class="n">ext</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># 获取文件后缀</span>
            <span class="n">unix_time</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
            <span class="n">new_filename</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">unix_time</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">ext</span>  <span class="c1"># 对文件进行重新命名</span>
            <span class="n">file_url</span> <span class="o">=</span> <span class="n">UPLOAD_PATH</span><span class="o">+</span><span class="n">new_filename</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">new_filename</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">UPLOAD_PATH</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">file_url</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">UPLOAD_PATH</span><span class="p">,</span> <span class="n">new_filename</span><span class="p">))</span>
            <span class="k">return</span> <span class="s2">&quot;上传文件成功！！&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;只支持jpg、png以及gif格式的文件！&quot;</span>
<span class="c1"># 访问上传的文件</span>
<span class="c1"># 浏览器访问：http://127.0.0.1:5000/images/xxx.jpg/  就可以查看文件了</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/images/&lt;filename&gt;/&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">get_image</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="c1"># 得到绝对路径，比如J:\python project\例5-3-2\uploads</span>
    <span class="n">dirpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">root_path</span><span class="p">,</span> <span class="s1">&#39;uploads&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">dirpath</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="c1"># return send_from_directory(dirpath,filename,as_attachment=True)#为下载方式</span>
    <span class="k">return</span> <span class="n">send_from_directory</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>  <span class="c1"># 为在线浏览方式</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="cookie">
<h3><a class="toc-backref" href="#id79">8.3 Cookie的使用</a><a class="headerlink" href="#cookie" title="Permalink to this headline">¶</a></h3>
<p>Cookie有时也记作Cookies，它现在经常被大家提到，那么到底什么是Cookies？它有什么作用呢？</p>
<p>Cookies是一种能够让网站服务器把少量数据储存到客户端的硬盘或内存，或是从客户端的硬盘读取数据的一种技术。当你再次浏览某网站时，浏览器将存放于本地的用户身份信息递交给服务器，服务器就可以识别用户的身份了。</p>
<section id="id24">
<h4>1.Cookie的基本使用<a class="headerlink" href="#id24" title="Permalink to this headline">¶</a></h4>
<p>下面通过一个综合的例子，说明Cookie的上述操作。</p>
<p>Cookie的基本操作：app.py</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">Response</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">set_cookie</span><span class="p">():</span>
    <span class="c1"># 先创建响应对象</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">Response</span><span class="p">(</span><span class="s2">&quot;设置Cookie!&quot;</span><span class="p">)</span>
    <span class="c1"># 设置cookie名为username,cookie名字为zhangsan,默认关闭浏览器失效</span>
    <span class="c1"># Cookie的作用时间7200秒</span>
    <span class="n">resp</span><span class="o">.</span><span class="n">set_cookie</span><span class="p">(</span><span class="s2">&quot;username&quot;</span><span class="p">,</span> <span class="s2">&quot;zhangsan&quot;</span><span class="p">,</span> <span class="n">max_age</span><span class="o">=</span><span class="mi">7200</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">resp</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/get_cookie&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_cookie</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">):</span>
        <span class="n">username</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">username</span> <span class="o">=</span> <span class="s2">&quot;Cookie不存在!&quot;</span>
    <span class="k">return</span> <span class="n">username</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/del_cookie&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">delete_cookie</span><span class="p">():</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">Response</span><span class="p">(</span><span class="s2">&quot;删除Cookie!&quot;</span><span class="p">)</span>
    <span class="n">resp</span><span class="o">.</span><span class="n">delete_cookie</span><span class="p">(</span><span class="s2">&quot;username&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">resp</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>通过浏览器访问进行验证</p>
<p>设置cookie</p>
<p><a class="reference external" href="http://127.0.0.1:5000/">http://127.0.0.1:5000/</a></p>
<p>获取cookie</p>
<p><a class="reference external" href="http://127.0.0.1:5000/get_cookie">http://127.0.0.1:5000/get_cookie</a></p>
<p>删除cookie</p>
<p><a class="reference external" href="http://127.0.0.1:5000/del_cookie">http://127.0.0.1:5000/del_cookie</a></p>
<p>再次验证cookie</p>
<p><a class="reference external" href="http://127.0.0.1:5000/get_cookie">http://127.0.0.1:5000/get_cookie</a></p>
</section>
<section id="id25">
<h4>2.设置Cookie的作用域<a class="headerlink" href="#id25" title="Permalink to this headline">¶</a></h4>
<p>Cookie默认只能在主域名下使用，如果想要在子域名下使用Cookie，该怎么办呢？</p>
<p>我们要在子域名下调用主域名的Cookie，首先需要创建一个子域名，如何创建子域名？</p>
<p>Cookie在子域名有效：app.py</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">Response</span>
<span class="kn">from</span> <span class="nn">blue_admin</span> <span class="kn">import</span> <span class="n">bp</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="c1"># 注册蓝图</span>
<span class="n">app</span><span class="o">.</span><span class="n">register_blueprint</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span>
<span class="c1"># SERVER_NAME设置为网站的域名</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;SERVER_NAME&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;baidu.com:5000&#39;</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">set_cookie</span><span class="p">():</span>
    <span class="c1"># 先创建响应对象</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">Response</span><span class="p">(</span><span class="s2">&quot;设置Cookie!&quot;</span><span class="p">)</span>
    <span class="c1"># 设置cookie名为username,cookie名字为zhangsan,cookie作用域名</span>
    <span class="n">resp</span><span class="o">.</span><span class="n">set_cookie</span><span class="p">(</span><span class="s2">&quot;username&quot;</span><span class="p">,</span> <span class="s2">&quot;zhangsan&quot;</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="s2">&quot;.baidu.com&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">resp</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>blue_admin.py</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># -*- coding:utf-8 -*-</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Blueprint</span><span class="p">,</span> <span class="n">request</span>
<span class="c1"># 在注册蓝图的时候，还需要添加一个名称为subdomain的参数</span>
<span class="n">bp</span> <span class="o">=</span> <span class="n">Blueprint</span><span class="p">(</span><span class="s2">&quot;admin_bp&quot;</span><span class="p">,</span> <span class="vm">__name__</span><span class="p">,</span> <span class="n">subdomain</span><span class="o">=</span><span class="s2">&quot;admin&quot;</span><span class="p">)</span>


<span class="nd">@bp</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_cookie</span><span class="p">():</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;username&quot;</span><span class="p">)</span>
    <span class="c1"># 如果有username这个key，则返回username对应的值，否则返回没有获取到username值</span>
    <span class="k">return</span> <span class="n">username</span> <span class="ow">or</span> <span class="s2">&quot;没有获取到name值&quot;</span>
</pre></div>
</div>
<p>使用子域名，需要在配置文件中配置SERVER_NAME，</p>
<p>比如：app.config[‘SERVER_NAME’]=‘baidu.com:5000’，在app.config[‘SERVER_NAME’]=‘baidu.com:5000’，在注册蓝图的时候，还需要添加一个名称为subdomain的参数。</p>
</section>
</section>
<section id="id26">
<h3><a class="toc-backref" href="#id80">8.4 Session的使用</a><a class="headerlink" href="#id26" title="Permalink to this headline">¶</a></h3>
<p>Session是基于Cookie实现的，保存在服务端的键值对（session[‘name’]=‘value’）中。</p>
<p>同时，在浏览器的Cookie中也对应一个相同的随机字符串，用来再次请求的时验证。</p>
<blockquote>
<div><p>注意：Session是储存在服务器中的，Cookies是储存在浏览器本地中，而Flask的Session是基于Cookies，Session是经过加密保存在Cookies中。</p>
</div></blockquote>
<section id="id27">
<h4>1.Session的基本配置<a class="headerlink" href="#id27" title="Permalink to this headline">¶</a></h4>
<p>因为Flask的Session是通过加密之后放到了Cookie中。有加密就有密钥用于解密，所以，用到了Flask的Session模块就一定要配置SECRET_KEY这个全局宏。一般将SECRET_KEY设置为24位的字符。我们可以自己设定一个随机字符串，例如：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;SECRET_KEY&#39;</span><span class="p">]</span><span class="o">=</span> <span class="s1">&#39;XXXXX&#39;</span>
</pre></div>
</div>
<p>我们也可以引入OS模块中，自动产生一个24位的随机字符串函数。</p>
<p>这种方法有个不足之处，就是服务器每次启动之后这个SECRET_KEY的值是不一样的，会造成Session验证失效，用户只有重新登录。</p>
<p>Session的基本操作：app.py</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">session</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">timedelta</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="c1"># 设置session</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;SECRET_KEY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">24</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;PERMANENT_SESSION_LIFETIME&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>  <span class="c1"># 配置7天有效</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">set_session</span><span class="p">():</span>
    <span class="n">session</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;zhangsan&#39;</span>
    <span class="n">session</span><span class="o">.</span><span class="n">permanent</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="s1">&#39;Session设置成功!&#39;</span>
<span class="c1"># 获取session</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/get_session&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_session</span><span class="p">():</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">username</span> <span class="ow">or</span> <span class="s1">&#39;Session为空！&#39;</span>
<span class="c1"># 清除sessin</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/del_session&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">del_session</span><span class="p">():</span>
    <span class="n">session</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">)</span>
    <span class="c1"># session.clear #清空Session</span>
    <span class="k">return</span> <span class="s1">&#39;Session被删除！&#39;</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p>通过浏览器访问进行验证</p>
<p>设置session</p>
<p><a class="reference external" href="http://127.0.0.1:5000/">http://127.0.0.1:5000/</a></p>
<p>获取session</p>
<p><a class="reference external" href="http://127.0.0.1:5000/get_session">http://127.0.0.1:5000/get_session</a></p>
<p>删除session</p>
<p><a class="reference external" href="http://127.0.0.1:5000/del_session">http://127.0.0.1:5000/del_session</a></p>
<p>再次验证session</p>
<p><a class="reference external" href="http://127.0.0.1:5000/get_session">http://127.0.0.1:5000/get_session</a></p>
</section>
</section>
<section id="id28">
<h3><a class="toc-backref" href="#id81">8.5 钩子函数的使用</a><a class="headerlink" href="#id28" title="Permalink to this headline">¶</a></h3>
<p>根据需要，有时候需要在正常执行代码的前、中、后时期，强行执行一段我们想要执行的功能代码，实现这种功能的函数，就称为钩子函数。钩子函数的实质就是用特定装饰器装饰的函数。下面对常用的几种钩子函数进行介绍。</p>
<p>请求钩子通过装饰器实现。Flask 支持以下 4 种钩子。</p>
<ul class="simple">
<li><p>before_first_request：注册一个函数，在处理第一个请求之前运行</p></li>
<li><p>before_request：注册一个函数，在处理每一个请求的时候运行</p></li>
<li><p>after_request：注册一个函数，如果没有未处理的异常抛出，在每次请求之后运行</p></li>
<li><p>teardown_request：注册一个函数，即使有未处理的异常抛出，也在每次请求之后运行</p></li>
</ul>
<p>在请求钩子函数和视图函数之间共享数据一般使用上下文全局变量g。例如，before_request
处理程序可以从数据库中加载已登录用户，并将其保存到g.user
中。随后调用视图函数时，视图函数再使用g.user 获取用户。</p>
<p>钩子函数的基本使用：app.py</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="c1"># before_first_request函数一般用来作一次初始化工作</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">before_first_request</span>
<span class="k">def</span> <span class="nf">before_first_request</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;这是before_first_request钩子函数&quot;</span><span class="p">)</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">before_request</span>
<span class="k">def</span> <span class="nf">before_request</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;这是before_request钩子函数&quot;</span><span class="p">)</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">after_request</span>
<span class="k">def</span> <span class="nf">after_request</span><span class="p">(</span><span class="n">response</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;这是after_request钩子函数&quot;</span><span class="p">)</span>
    <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;application/json&quot;</span>
    <span class="k">return</span> <span class="n">response</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">teardown_request</span>
<span class="k">def</span> <span class="nf">teardown_request</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;这是teardown_request钩子函数&quot;</span><span class="p">)</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">hello_world</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;您访问了首页！&quot;</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="k">return</span> <span class="s1">&#39;Hello World!&#39;</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p>上面的代码定义并使用了4个钩子函数，其中，</p>
<p>before_first_request()钩子函数会在第一次请求之前被执行，</p>
<p>before_reques()钩子函数对每次请求都会执行，</p>
<p>after_request()和teardown_request()会在每次请求之后执行。</p>
<p>在地址栏中输入如下地址：<a class="reference external" href="http://127.0.0.1:5000">http://127.0.0.1:5000</a>/然后回车，运行结果如下：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Press CTRL+C to quit
这是before_first_request钩子函数
这是before_request钩子函数
您访问了首页！
这是after_request钩子函数
这是teardown_request钩子函数

127.0.0.1 - - [07/Sep/2022 16:54:42] &quot;GET / HTTP/1.1&quot; 200 -
这是before_request钩子函数
您访问了首页！
这是after_request钩子函数
这是teardown_request钩子函数
</pre></div>
</div>
</section>
</section>
<section id="id29">
<h2><a class="toc-backref" href="#id82">9.访问数据库</a><a class="headerlink" href="#id29" title="Permalink to this headline">¶</a></h2>
<section id="mysql">
<h3><a class="toc-backref" href="#id83">9.1 MySQL数据库安装</a><a class="headerlink" href="#mysql" title="Permalink to this headline">¶</a></h3>
<p>软件自行安装,可参考</p>
<p><a class="reference external" href="https://www.runoob.com/mysql/mysql-install.html">https://www.runoob.com/mysql/mysql-install.html</a></p>
<p>docker部署MySQL 5.7 数据库</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ docker run --name mysql -d -e <span class="nv">MYSQL_RANDOM_ROOT_PASSWORD</span><span class="o">=</span>yes <span class="se">\</span>
-e <span class="nv">MYSQL_DATABASE</span><span class="o">=</span>flasky -e <span class="nv">MYSQL_USER</span><span class="o">=</span>flasky <span class="se">\</span>
-e <span class="nv">MYSQL_PASSWORD</span><span class="o">=</span>&lt;database-password&gt; <span class="se">\</span>
mysql/mysql-server:5.7
</pre></div>
</div>
<p>Docker Compose部署Mysql 5.7</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">version</span><span class="p">:</span> <span class="s2">&quot;3&quot;</span>
<span class="n">services</span><span class="p">:</span>
  <span class="n">mysql</span><span class="p">:</span>
    <span class="n">image</span><span class="p">:</span> <span class="n">mysql</span><span class="p">:</span><span class="mf">5.7</span>
    <span class="n">restart</span><span class="p">:</span> <span class="n">always</span>
    <span class="n">hostname</span><span class="p">:</span> <span class="n">mysql</span><span class="o">-</span><span class="n">master</span>
    <span class="n">container_name</span><span class="p">:</span> <span class="s2">&quot;mysql57-giteeci&quot;</span>
    <span class="n">ports</span><span class="p">:</span>
      <span class="o">-</span> <span class="mi">33006</span><span class="p">:</span><span class="mi">3306</span>
    <span class="n">environment</span><span class="p">:</span>
      <span class="n">TZ</span><span class="p">:</span> <span class="n">Asia</span><span class="o">/</span><span class="n">Shanghai</span>
      <span class="n">MYSQL_ROOT_PASSWORD</span><span class="p">:</span> <span class="n">oschina123</span>
      <span class="n">MYSQL_DATABASE</span><span class="p">:</span> <span class="n">gitlabhq_production</span>
      <span class="n">MYSQL_USER</span><span class="p">:</span> <span class="n">giteeci</span>
      <span class="n">MYSQL_PASSWORD</span><span class="p">:</span> <span class="mi">123456</span>
      <span class="n">MYSQL_HOST</span><span class="p">:</span> <span class="s2">&quot;%&quot;</span>
    <span class="n">volumes</span><span class="p">:</span>
      <span class="o">-</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">mysql57</span><span class="p">:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">mysql</span>
      <span class="o">-</span> <span class="o">./</span><span class="n">mysql</span><span class="o">.</span><span class="n">cnf</span><span class="p">:</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">mysql</span><span class="o">/</span><span class="n">conf</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">mysql</span><span class="o">.</span><span class="n">cnf</span>
    <span class="n">command</span><span class="p">:</span>
      <span class="o">--</span><span class="n">server_id</span><span class="o">=</span><span class="mi">100</span>
      <span class="o">--</span><span class="n">log</span><span class="o">-</span><span class="nb">bin</span><span class="o">=</span><span class="n">mysql</span><span class="o">-</span><span class="nb">bin</span>
      <span class="o">--</span><span class="n">sync_binlog</span><span class="o">=</span><span class="mi">1</span>
      <span class="o">--</span><span class="n">binlog</span><span class="o">-</span><span class="n">ignore</span><span class="o">-</span><span class="n">db</span><span class="o">=</span><span class="n">mysql</span>
      <span class="o">--</span><span class="n">binlog_format</span><span class="o">=</span><span class="n">mixed</span>
      <span class="o">--</span><span class="n">expire_logs_days</span><span class="o">=</span><span class="mi">7</span>
      <span class="o">--</span><span class="n">default</span><span class="o">-</span><span class="n">authentication</span><span class="o">-</span><span class="n">plugin</span><span class="o">=</span><span class="n">mysql_native_password</span>
      <span class="o">--</span><span class="n">character</span><span class="o">-</span><span class="nb">set</span><span class="o">-</span><span class="n">server</span><span class="o">=</span><span class="n">utf8mb4</span>
      <span class="o">--</span><span class="n">collation</span><span class="o">-</span><span class="n">server</span><span class="o">=</span><span class="n">utf8mb4_general_ci</span>
      <span class="o">--</span><span class="n">explicit_defaults_for_timestamp</span><span class="o">=</span><span class="n">true</span>
      <span class="o">--</span><span class="n">lower_case_table_names</span><span class="o">=</span><span class="mi">1</span>
      <span class="o">--</span><span class="n">sql_mode</span><span class="o">=</span><span class="n">NO_ENGINE_SUBSTITUTION</span><span class="p">,</span><span class="n">STRICT_TRANS_TABLES</span>
      <span class="c1">#--sql_mode=STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION</span>
</pre></div>
</div>
</section>
<section id="pythonmysql-python">
<h3><a class="toc-backref" href="#id84">9.2 Python数据库框架MySQL-Python</a><a class="headerlink" href="#pythonmysql-python" title="Permalink to this headline">¶</a></h3>
<p>注意：Python 2.x用MySQL-Python，从Python 3.x起，不再支持MySQL-Python。</p>
<p>在Python 3.x中要使用MySQLdb,可以使用PyMySQL，在Python
3.x中PyMySQL替代了MySQLdb。</p>
<p>安装PyMySQL可以使用下面命令：</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>（venv）$ pip install pyMySQL
</pre></div>
</div>
<p>此外，在数据库初始化代码中，需要配置编写下面代码：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pyMySQL</span>
<span class="c1">#手动指定将MySQLdb转给PyMySQL处理</span>
<span class="n">pyMySQL</span><span class="o">.</span><span class="n">install_as_MySQLdb</span><span class="p">()</span>
</pre></div>
</div>
<section id="python">
<h4>1.通过Python操作数据库对象<a class="headerlink" href="#python" title="Permalink to this headline">¶</a></h4>
<p>利用PyMySQL框架访问数据库：app.py</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
<span class="kn">import</span> <span class="nn">pymysql</span>
<span class="n">pymysql</span><span class="o">.</span><span class="n">install_as_MySQLdb</span><span class="p">()</span>  <span class="c1"># 手动指定将MySQLdb转给pymysql处理</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">conn</span> <span class="o">=</span> <span class="n">pymysql</span><span class="o">.</span><span class="n">Connect</span><span class="p">(</span>  <span class="c1"># 配置数据库连接</span>
    <span class="n">host</span><span class="o">=</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span>
    <span class="n">port</span><span class="o">=</span><span class="mi">3306</span><span class="p">,</span>
    <span class="n">user</span><span class="o">=</span><span class="s1">&#39;root&#39;</span><span class="p">,</span>
    <span class="n">passwd</span><span class="o">=</span><span class="s1">&#39;root&#39;</span><span class="p">,</span>
    <span class="n">db</span><span class="o">=</span><span class="s1">&#39;demo_01&#39;</span><span class="p">,</span>
    <span class="n">charset</span><span class="o">=</span><span class="s1">&#39;utf8&#39;</span>
<span class="p">)</span>
<span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;select * from user&quot;</span>
<span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
   <span class="c1"># 打印结果</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
<span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c1"># 关闭游标</span>
<span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c1"># 关闭连接</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">hello_world</span><span class="p">():</span>
    <span class="k">return</span> <span class="s1">&#39;Hello World!&#39;</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="pymysql">
<h4>2.通过PyMySQL进行更新数据操作<a class="headerlink" href="#pymysql" title="Permalink to this headline">¶</a></h4>
<p><strong>增加数据</strong></p>
<p>利用PyMySQL框架向数据库中添加数据：app.py</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># -*- coding: UTF-8 -*-</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
<span class="kn">import</span> <span class="nn">pymysql</span>  <span class="c1"># 引入mysql库：</span>
<span class="n">pymysql</span><span class="o">.</span><span class="n">install_as_MySQLdb</span><span class="p">()</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">conn</span> <span class="o">=</span> <span class="n">pymysql</span><span class="o">.</span><span class="n">Connect</span><span class="p">(</span>  <span class="c1"># 建立数据库连接</span>
    <span class="n">host</span><span class="o">=</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span>
    <span class="n">port</span><span class="o">=</span><span class="mi">3306</span><span class="p">,</span>
    <span class="n">user</span><span class="o">=</span><span class="s1">&#39;root&#39;</span><span class="p">,</span>
    <span class="n">passwd</span><span class="o">=</span><span class="s1">&#39;root&#39;</span><span class="p">,</span>
    <span class="n">db</span><span class="o">=</span><span class="s1">&#39;demo_01&#39;</span><span class="p">,</span>
    <span class="n">charset</span><span class="o">=</span><span class="s1">&#39;utf8&#39;</span>
<span class="p">)</span>
<span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>  <span class="c1"># 使用cursor()方法获取操作游标</span>
<span class="c1"># 使用try---except进行异常处理</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">sql_insert</span> <span class="o">=</span> <span class="s2">&quot;insert into user(username,email) values (&#39;yanghong1&#39;,&#39;22222@qq.com&#39;)&quot;</span>
    <span class="n">sql_insert1</span> <span class="o">=</span> <span class="s2">&quot;insert into user(username,email) values (&#39;caoxiao1&#39;,&#39;33333@qq.com&#39;)&quot;</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql_insert</span><span class="p">)</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql_insert1</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="c1"># print e</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>

<span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c1"># 关闭数据库连接</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">hello_world</span><span class="p">():</span>
    <span class="k">return</span> <span class="s1">&#39;Hello World!&#39;</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p>conn.commit()语句放在两条插入语句执行之后，并放在try语句块内，如果产生异常，可以使用：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">conn</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
</pre></div>
</div>
<p>该语句可以使事务回滚，退回到没有执行数据插入之前。</p>
<p>cursor.execute(“sql语句”)表示使用execute方法执行SQL语句。</p>
<p>所用的SQL操作都放在cursor.execute()方法中来执行。</p>
<p><strong>修改数据</strong></p>
<p>修改数据库中某条记录，同样是先建立数据库连接，然后获取游标对象，通过cursor.execute()来执行SQL语句，使用conn.commit()方法来提交事务，让修改数据操作真正生效。</p>
<p><strong>删除数据</strong></p>
<p>要删除数据库中的某条记录，同样是先建立数据库连接，然后获取游标对象，通过cursor.execute()来执行SQL语句，使用conn.commit()方法来提交事务，让删除数据操作真正生效。</p>
</section>
</section>
<section id="flask-sqlalchemy">
<h3><a class="toc-backref" href="#id85">9.3 初识Flask-SQLAlchemy</a><a class="headerlink" href="#flask-sqlalchemy" title="Permalink to this headline">¶</a></h3>
<p>SQLAlchemy是一个基于Python实现的ORM（Object Relational
Mapping，对象关系映射）框架。该框架建立在DB
API之上，使用关系对象映射进行数据库操作。</p>
<p>简言之便是将类和对象转换成SQL，然后使用数据API执行SQL并获取执行结果。</p>
<p>它的核心思想于在于将关系数据库表中的记录映射成为对象，以对象的形式展现，程序员可以把对数据库的操作转化为对对象的操作。</p>
<blockquote>
<div><p>注意：Flask-SQLAlchemy框架的实质在于以操作对象的方式对数据库操作。</p>
</div></blockquote>
<section id="sqlalchemy">
<h4>1.SQLAlchemy的安装<a class="headerlink" href="#sqlalchemy" title="Permalink to this headline">¶</a></h4>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>（venv）$ pip install flask-sqlalchemy
</pre></div>
</div>
<blockquote>
<div><p>注意：Python 2版本中需要安装MySQLdb，可以使用pip install
flask-MySQLdb命令来完成安装。 Python
3中不再支持MySQLdb，推荐使用PyMySQL。</p>
</div></blockquote>
</section>
<section id="orm">
<h4>2.为什么使用ORM<a class="headerlink" href="#orm" title="Permalink to this headline">¶</a></h4>
<p>当需要实现一个应用程序时（不使用O/R
Mapping），我们可能会写特别多的数据访问层的代码，从数据库保存、删除、读取对象信息，而这些代码都是重复的。</p>
<p>而使用ORM则会大大减少重复性代码。</p>
<p>对象关系映射（Object Relational
Mapping，ORM），主要实现程序对象到关系数据库数据的映射。</p>
<ul class="simple">
<li><p>简单：ORM以最基本的形式建模数据。比如ORM会将MySQL的一张表映射成一个类（模型），表的字段就是这个类的成员变量。</p></li>
<li><p>精确：ORM使所有的MySQL数据表都按照统一的标准精确地映射成一个类，使系统在代码层面保持准确统一。</p></li>
<li><p>易懂：ORM使数据库结构文档化，程序员可以把大部分精力用在Web功能的开发和实现上，而不需要花费时间和精力在底层数据库驱动上。</p></li>
<li><p>易用：ORM包含对持久类对象进行CRUD操作的API，例如create()、update()、save()、load()、find()、find_all()和where()等，也就是将SQL查询全部封装成了编程语言中的函数，通过函数的链式组合生成最终的SQL语句。通过这种封装避免了不规范、冗余、风格不统一的SQL语句，可以避免很多人为Bug，方便编码风格的统一和后期维护。</p></li>
</ul>
<p>综上所述，使用ORM框架的最大优点是解决了重复读取数据库的问题，使程序员高效开发成为可能。</p>
<p>最大的不足之处在于会牺牲程序的执行效率，特别是处理多表联查、where条件复杂之类的查询时，ORM的语法会变得复杂。</p>
</section>
<section id="id30">
<h4>3.Flask-SQLAlchemy初始化<a class="headerlink" href="#id30" title="Permalink to this headline">¶</a></h4>
<p>使用Flask-SQLAlchemy框架初始化实例：config.py</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">USERNAME</span> <span class="o">=</span> <span class="s1">&#39;root&#39;</span>
<span class="n">PASSWORD</span> <span class="o">=</span> <span class="s1">&#39;root&#39;</span>
<span class="n">HOST</span> <span class="o">=</span> <span class="s1">&#39;127.0.0.1&#39;</span>
<span class="n">PORT</span> <span class="o">=</span> <span class="s1">&#39;3306&#39;</span>
<span class="n">DATABASE</span> <span class="o">=</span> <span class="s1">&#39;db_demo1&#39;</span>
<span class="n">DB_URI</span> <span class="o">=</span> <span class="s1">&#39;mysql+pymysql://</span><span class="si">{}</span><span class="s1">:</span><span class="si">{}</span><span class="s1">@</span><span class="si">{}</span><span class="s1">:</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">?charset=utf8&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
    <span class="n">USERNAME</span><span class="p">,</span> <span class="n">PASSWORD</span><span class="p">,</span> <span class="n">HOST</span><span class="p">,</span> <span class="n">PORT</span><span class="p">,</span> <span class="n">DATABASE</span><span class="p">)</span>
<span class="n">SQLALCHEMY_DATABASE_URI</span> <span class="o">=</span> <span class="n">DB_URI</span>
<span class="c1"># 动态追踪修改设置，如未设置只会提示警告</span>
<span class="n">SQLALCHEMY_TRACK_MODIFICATIONS</span> <span class="o">=</span> <span class="kc">False</span>
<span class="c1"># 查询时会显示原始SQL语句</span>
<span class="n">SQLALCHEMY_ECHO</span> <span class="o">=</span> <span class="kc">True</span>
</pre></div>
</div>
<ul class="simple">
<li><p>注意：SQLALCHEMY_TRACK_MODIFICATIONS=False必须设置，可以为Flase或者True，表示动态追踪修改设置。如果没有设置，会给出警告信息。</p></li>
</ul>
<p>使用Flask-SQLAlchemy框架初始化实例：db_demo1.py</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># encoding:utf8</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
<span class="kn">from</span> <span class="nn">flask_sqlalchemy</span> <span class="kn">import</span> <span class="n">SQLAlchemy</span>
<span class="kn">import</span> <span class="nn">config</span>  <span class="c1"># 导入配置文件</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">from_object</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>  <span class="c1"># 配置文件实例化</span>
<span class="c1"># 初始化一个对象</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">SQLAlchemy</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
<span class="c1"># 测试数据库链接是否成功</span>
<span class="n">db</span><span class="o">.</span><span class="n">create_all</span><span class="p">()</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="k">return</span> <span class="s2">&quot;index&quot;</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>运行上述代码，如果没有报错，则说明配置成功。可以将DATABASE=’db_demo1’的内容修改为一个不存在的数据库，则可以看到有报错信息输出。</p>
</section>
<section id="id31">
<h4>4.模型与表映射方法1<a class="headerlink" href="#id31" title="Permalink to this headline">¶</a></h4>
<p>使用Flask-SQLAlchemy框架创建数据库表：app.py</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># encoding:utf8</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>  <span class="c1"># 导入Flask模块</span>
<span class="kn">from</span> <span class="nn">flask_sqlalchemy</span> <span class="kn">import</span> <span class="n">SQLAlchemy</span>  <span class="c1"># 导入SQLAlchemy模块</span>
<span class="kn">import</span> <span class="nn">config</span>  <span class="c1"># 导入配置文件</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>  <span class="c1"># 导入datetime模块</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>  <span class="c1"># Falsk初始化</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">from_object</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>  <span class="c1"># 配置文件实例化</span>
<span class="c1"># 初始化一个数据库连接对象</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">SQLAlchemy</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
<span class="c1"># 测试数据库链接是否成功</span>
<span class="c1"># 建立表</span>


<span class="k">class</span> <span class="nc">Book</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;book&#39;</span>  <span class="c1"># 表的别名</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">autoincrement</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># id号</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># 书名</span>
    <span class="n">publishing_office</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># 出版社</span>
    <span class="n">isbn</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># isbn号</span>
    <span class="n">storage_time</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">DateTime</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>  <span class="c1"># 入库时间</span>

<span class="n">db</span><span class="o">.</span><span class="n">create_all</span><span class="p">()</span>  <span class="c1"># 对象映射</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="k">return</span> <span class="s2">&quot;index&quot;</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>使用Flask-SQLAlchemy框架创建数据库表：config.py</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># encoding:utf8</span>
<span class="n">USERNAME</span> <span class="o">=</span> <span class="s1">&#39;root&#39;</span>
<span class="n">PASSWORD</span> <span class="o">=</span> <span class="s1">&#39;root&#39;</span>
<span class="n">HOST</span> <span class="o">=</span> <span class="s1">&#39;127.0.0.1&#39;</span>
<span class="n">PORT</span> <span class="o">=</span> <span class="s1">&#39;3306&#39;</span>
<span class="n">DATABASE</span> <span class="o">=</span> <span class="s1">&#39;db_demo1&#39;</span>
<span class="n">DB_URI</span> <span class="o">=</span> <span class="s1">&#39;mysql+pymysql://</span><span class="si">{}</span><span class="s1">:</span><span class="si">{}</span><span class="s1">@</span><span class="si">{}</span><span class="s1">:</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">?charset=utf8&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
    <span class="n">USERNAME</span><span class="p">,</span> <span class="n">PASSWORD</span><span class="p">,</span> <span class="n">HOST</span><span class="p">,</span> <span class="n">PORT</span><span class="p">,</span> <span class="n">DATABASE</span><span class="p">)</span>
<span class="n">SQLALCHEMY_DATABASE_URI</span> <span class="o">=</span> <span class="n">DB_URI</span>
<span class="c1"># 动态追踪修改设置，如未设置只会提示警告</span>
<span class="n">SQLALCHEMY_TRACK_MODIFICATIONS</span> <span class="o">=</span> <span class="kc">False</span>
<span class="c1"># 查询时会显示原始SQL语句</span>
<span class="n">SQLALCHEMY_ECHO</span> <span class="o">=</span> <span class="kc">True</span>
</pre></div>
</div>
<p>Python语言的3.x完全不向前兼容，导致在Python
2.x中可以正常使用的库到了Python 3中就不支持MySQLdb数据库驱动了。</p>
<p>给出的解决方法是，使用PyMySQL作为Python
3环境下MySQLdb的替代数据库驱动，可以进入命令行，使用pip安装PyMySQL。</p>
<p>安装完毕后，如果你继续要使用MySQLdb，那么请加上一句pyMySQL.install_as_MySQLdb()即可。</p>
<ul class="simple">
<li><p>注意：添加pyMySQL.install_as_MySQLdb();一般是主app对应的文件中。</p></li>
</ul>
<p><strong>最常用的SQLAlchemy列类型</strong></p>
<table class="docutils align-default">
<colgroup>
<col style="width: 21%" />
<col style="width: 30%" />
<col style="width: 48%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>类型名</p></th>
<th class="head"><p>Python类型</p></th>
<th class="head"><p>说明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Integer</p></td>
<td><p>int</p></td>
<td><p>普通整数，通常是 32 位</p></td>
</tr>
<tr class="row-odd"><td><p>SmallInteger</p></td>
<td><p>int</p></td>
<td><p>取值范围小的整数，通常是 16 位</p></td>
</tr>
<tr class="row-even"><td><p>BigInteger</p></td>
<td><p>int 或 long</p></td>
<td><p>不限制精度的整数</p></td>
</tr>
<tr class="row-odd"><td><p>Float</p></td>
<td><p>float</p></td>
<td><p>浮点数</p></td>
</tr>
<tr class="row-even"><td><p>Numeric</p></td>
<td><p>decimal.Decimal</p></td>
<td><p>定点数</p></td>
</tr>
<tr class="row-odd"><td><p>String</p></td>
<td><p>str</p></td>
<td><p>变长字符串</p></td>
</tr>
<tr class="row-even"><td><p>Text</p></td>
<td><p>str</p></td>
<td><p>变长字符串，对
较长或不限长度的字符串做了优化</p></td>
</tr>
<tr class="row-odd"><td><p>Unicode</p></td>
<td><p>unicode</p></td>
<td><p>变长 Unicode 字符串</p></td>
</tr>
<tr class="row-even"><td><p>UnicodeText</p></td>
<td><p>unicode</p></td>
<td><p>变长 Unicode
字符串，对
较长或不限长度的字符串做了优化</p></td>
</tr>
<tr class="row-odd"><td><p>Boolean</p></td>
<td><p>bool</p></td>
<td><p>布尔值</p></td>
</tr>
<tr class="row-even"><td><p>Date</p></td>
<td><p>datetime.date</p></td>
<td><p>日期</p></td>
</tr>
<tr class="row-odd"><td><p>Time</p></td>
<td><p>datetime.time</p></td>
<td><p>时间</p></td>
</tr>
<tr class="row-even"><td><p>DateTime</p></td>
<td><p>datetime.datetime</p></td>
<td><p>日期和时间</p></td>
</tr>
<tr class="row-odd"><td><p>Interval</p></td>
<td><p>datetime.timedelta</p></td>
<td><p>时间间隔</p></td>
</tr>
<tr class="row-even"><td><p>Enum</p></td>
<td><p>str</p></td>
<td><p>一组字符串</p></td>
</tr>
<tr class="row-odd"><td><p>PickleType</p></td>
<td><p>任何 Python 对象</p></td>
<td><p>自动使用 Pickle 序列化</p></td>
</tr>
<tr class="row-even"><td><p>LargeBinary</p></td>
<td><p>str</p></td>
<td><p>二进制 blob</p></td>
</tr>
</tbody>
</table>
<p><strong>最常用的SQLAlchemy列选项</strong></p>
<table class="docutils align-default">
<colgroup>
<col style="width: 22%" />
<col style="width: 78%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>选项名</p></th>
<th class="head"><p>说明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>primary_key</p></td>
<td><p>如果设为 True，列为表的主键</p></td>
</tr>
<tr class="row-odd"><td><p>unique</p></td>
<td><p>如果设为 True，列不允许出现重复的值</p></td>
</tr>
<tr class="row-even"><td><p>index</p></td>
<td><p>如果设为 True，为列创建索引，提升查询效率</p></td>
</tr>
<tr class="row-odd"><td><p>nullable</p></td>
<td><p>如果设为 True，列允许使用空值；如果设为
False，列不允许使用空值</p></td>
</tr>
<tr class="row-even"><td><p>autoincrement</p></td>
<td><p>如果设为 True，主键设置自增长</p></td>
</tr>
<tr class="row-odd"><td><p>default</p></td>
<td><p>为列定义默认值</p></td>
</tr>
</tbody>
</table>
<p>模型定义示例</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Members</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;jq_member&#39;</span>
    <span class="n">uid</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">autoincrement</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># 用户名不能为空,而且必须是唯一的</span>
    <span class="n">_password</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># 密码不能为空</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># 用户邮箱不能为空，而且必须是唯一的</span>
    <span class="n">vatar</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">80</span><span class="p">),</span><span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="c1">#用户头像</span>
    <span class="n">nickname</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span><span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="c1">#用户昵称</span>
    <span class="n">sex</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># 性别</span>
    <span class="n">telephone</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">11</span><span class="p">))</span>  <span class="c1"># 电话</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">)</span>  <span class="c1"># 状态</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">username</span><span class="p">,</span><span class="n">password</span><span class="p">,</span><span class="n">email</span><span class="p">):</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="o">=</span><span class="n">username</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="o">=</span><span class="n">password</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">email</span><span class="o">=</span><span class="n">email</span>
    <span class="c1">#获取密码</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">password</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
         <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_password</span>
    <span class="c1">#设置密码</span>
    <span class="nd">@password</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">password</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">raw_password</span><span class="p">):</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_password</span><span class="o">=</span><span class="n">generate_password_hash</span><span class="p">(</span><span class="n">raw_password</span><span class="p">)</span><span class="c1">#密码加密</span>
    <span class="c1">#检查密码</span>
    <span class="k">def</span> <span class="nf">check_password</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">raw_password</span><span class="p">):</span>
         <span class="n">result</span><span class="o">=</span><span class="n">check_password_hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="p">,</span><span class="n">raw_password</span><span class="p">)</span><span class="c1">#</span>
         <span class="k">return</span> <span class="n">result</span>
</pre></div>
</div>
<p>新增一条记录，可以使用下面的方法。在执行下面的方法之前先把db.create_all()这行注释掉。注释以后变为：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># db.create_all()  # 对象映射</span>
<span class="n">book1</span> <span class="o">=</span> <span class="n">Book</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s1">&#39;001&#39;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;人工智慧&#39;</span><span class="p">,</span> <span class="n">publishing_office</span><span class="o">=</span><span class="s1">&#39;高等教育&#39;</span><span class="p">,</span> <span class="n">isbn</span><span class="o">=</span><span class="s1">&#39;123333&#39;</span><span class="p">)</span>

<span class="c1"># 通过db.session.add(book1)把对象添加到会话中</span>
<span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">book1</span><span class="p">)</span>

<span class="c1"># 通过db.session.commit()完成事务的提交。</span>
<span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</pre></div>
</div>
<p>使用Flask-SQLAlchemy框架添加数据实例：app.py</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>  <span class="c1"># 导入Flask模块</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>  <span class="c1"># 导入datetime模块</span>
<span class="kn">import</span> <span class="nn">config</span>  <span class="c1"># 导入配置文件</span>
<span class="kn">from</span> <span class="nn">flask_sqlalchemy</span> <span class="kn">import</span> <span class="n">SQLAlchemy</span>  <span class="c1"># 导入SQLAlchemy模块</span>
<span class="kn">import</span> <span class="nn">pymysql</span>  <span class="c1"># 导入pymysql</span>
<span class="n">pymysql</span><span class="o">.</span><span class="n">install_as_MySQLdb</span><span class="p">()</span>  <span class="c1"># pymysql替代MySQLdb</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">from_object</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">SQLAlchemy</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>  <span class="c1"># 读取配置参数，将和数据库相关的配置加载到SQLAlchemy对象中</span>
<span class="n">db</span><span class="o">.</span><span class="n">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>  <span class="c1"># 初始化数据库连接文件</span>


<span class="c1"># 建立表</span>
<span class="k">class</span> <span class="nc">Book</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;book&#39;</span>  <span class="c1"># 表的别名</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">autoincrement</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># 书名</span>
    <span class="n">publishing_office</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># 出版社</span>
    <span class="n">isbn</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># isbn号</span>
    <span class="n">storage_time</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">DateTime</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>  <span class="c1"># 入库时间</span>


<span class="n">db</span><span class="o">.</span><span class="n">create_all</span><span class="p">()</span>  <span class="c1"># 对象映射</span>
<span class="c1"># 以上代码同样创建了一个表，下面试着增加一条记录，再增加下面代码：</span>
<span class="n">book1</span> <span class="o">=</span> <span class="n">Book</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s1">&#39;005&#39;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;人工智能导论&#39;</span><span class="p">,</span>
             <span class="n">publishing_office</span><span class="o">=</span><span class="s1">&#39;高等教育出版社&#39;</span><span class="p">,</span> <span class="n">isbn</span><span class="o">=</span><span class="s1">&#39;9787040479843&#39;</span><span class="p">)</span>
<span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">book1</span><span class="p">)</span>  <span class="c1"># 把对象添加到会话中</span>
<span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>  <span class="c1"># 提交事务</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">hello_world</span><span class="p">():</span>
    <span class="k">return</span> <span class="s1">&#39;Hello World!&#39;</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p>运行app.py文件，会在数据库中创建一条记录。</p>
</section>
<section id="id32">
<h4>5. 模型与表映射方法2<a class="headerlink" href="#id32" title="Permalink to this headline">¶</a></h4>
<p>这里底层驱动使用了PyMySQL，使用Flask-SQLAlchemy创建数据库，并成功地向数据库中增加了数据。</p>
<p>使用Flask-SQLAlchemy框架添加数据实例：app.py</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
<span class="kn">from</span> <span class="nn">flask_sqlalchemy</span> <span class="kn">import</span> <span class="n">SQLAlchemy</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">config</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">from_object</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">SQLAlchemy</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Book</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;book&#39;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">autoincrement</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">publishing_office</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">price</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">30</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">isbn</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">storage_time</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">DateTime</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>  <span class="c1"># 入库时间</span>
<span class="c1"># db.create_all()#如果没有创建表，请先执行db.create_all（）方法创建表</span>
<span class="c1"># 添加数据的路由</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/add&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">():</span>
    <span class="n">book1</span> <span class="o">=</span> <span class="n">Book</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Python基础教程1（第3版）&#39;</span><span class="p">,</span> <span class="n">publishing_office</span><span class="o">=</span><span class="s1">&#39;人民邮电出版社&#39;</span><span class="p">,</span>
                 <span class="n">price</span><span class="o">=</span><span class="s1">&#39;68.30&#39;</span><span class="p">,</span> <span class="n">isbn</span><span class="o">=</span><span class="s1">&#39;9787115474889&#39;</span><span class="p">)</span>
    <span class="c1"># book2 = Book(title=&#39;Python游戏编程快速上手 第4版&#39;, publishing_office=&#39;人民邮电出版社&#39;, price=&#39;54.50&#39;, isbn=&#39;9787115466419&#39;)</span>
    <span class="c1"># book3 = Book(title=&#39;JSP+Servlet+Tomcat应用开发从零开始学&#39;, publishing_office=&#39;清华大学出版社&#39;, price=&#39;68.30&#39;,isbn=&#39;9787302384496&#39;)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">book1</span><span class="p">)</span>
    <span class="c1"># db.session.add(book2)</span>
    <span class="c1"># db.session.add(book3)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">return</span> <span class="s1">&#39;添加数据成功！&#39;</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">hello_world</span><span class="p">():</span>
    <span class="k">return</span> <span class="s1">&#39;Hello World!&#39;</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>保存并执行app.py文件，然后进入数据库查看数据是否插入成功。</p>
</section>
<section id="id33">
<h4>6.数据的增、删、改、查<a class="headerlink" href="#id33" title="Permalink to this headline">¶</a></h4>
<p>数据的增、删、改、查等操作，必须确保数据库已经实现建立好，然后使用db.session.add(对象名称)方法，就可以实现数据的插入操作。</p>
<p>使用Flask-SQLAlchemy框架添加多条数据实例：app.py</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
<span class="kn">from</span> <span class="nn">flask_sqlalchemy</span> <span class="kn">import</span> <span class="n">SQLAlchemy</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">config</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">from_object</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">SQLAlchemy</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Book</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;book&#39;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">autoincrement</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">publishing_office</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">price</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">30</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">isbn</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">storage_time</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">DateTime</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>  <span class="c1"># 入库时间</span>


<span class="n">db</span><span class="o">.</span><span class="n">create_all</span><span class="p">()</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/add&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">():</span>
    <span class="n">book1</span> <span class="o">=</span> <span class="n">Book</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Python基础教程（第3版）&#39;</span><span class="p">,</span> <span class="n">publishing_office</span><span class="o">=</span><span class="s1">&#39;人民邮电出版社&#39;</span><span class="p">,</span>
                 <span class="n">price</span><span class="o">=</span><span class="s1">&#39;68.30&#39;</span><span class="p">,</span> <span class="n">isbn</span><span class="o">=</span><span class="s1">&#39;9787115474889&#39;</span><span class="p">)</span>
    <span class="n">book2</span> <span class="o">=</span> <span class="n">Book</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Python游戏编程快速上手 第4版&#39;</span><span class="p">,</span> <span class="n">publishing_office</span><span class="o">=</span><span class="s1">&#39;人民邮电出版社&#39;</span><span class="p">,</span>
                 <span class="n">price</span><span class="o">=</span><span class="s1">&#39;54.50&#39;</span><span class="p">,</span> <span class="n">isbn</span><span class="o">=</span><span class="s1">&#39;9787115466419&#39;</span><span class="p">)</span>
    <span class="n">book3</span> <span class="o">=</span> <span class="n">Book</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;JSP+Servlet+Tomcat应用开发从零开始学&#39;</span><span class="p">,</span>
                 <span class="n">publishing_office</span><span class="o">=</span><span class="s1">&#39;清华大学出版社&#39;</span><span class="p">,</span> <span class="n">price</span><span class="o">=</span><span class="s1">&#39;68.30&#39;</span><span class="p">,</span> <span class="n">isbn</span><span class="o">=</span><span class="s1">&#39;9787302384496&#39;</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">book1</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">book2</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">book3</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">return</span> <span class="s1">&#39;添加数据成功！&#39;</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/select&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">select</span><span class="p">():</span>
    <span class="c1"># result=Book.query.filter(Book.id==&#39;1&#39;).first()</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">publishing_office</span> <span class="o">==</span> <span class="s1">&#39;人民邮电出版社&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">books</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">books</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="n">books</span><span class="o">.</span><span class="n">publishing_office</span><span class="p">)</span>
    <span class="k">return</span> <span class="s2">&quot;查询数据成功！&quot;</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/edit&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">edit</span><span class="p">():</span>
    <span class="n">book1</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="s1">&#39;2&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>  <span class="c1"># 查询出id=2的记录</span>
    <span class="n">book1</span><span class="o">.</span><span class="n">price</span> <span class="o">=</span> <span class="mi">168</span>  <span class="c1"># 修改价格</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">return</span> <span class="s2">&quot;修改数据成功！&quot;</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/delete&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">delete</span><span class="p">():</span>
    <span class="n">book1</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="s1">&#39;9&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">book1</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">return</span> <span class="s1">&#39;删除数据成功&#39;</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">hello_world</span><span class="p">():</span>
    <span class="k">return</span> <span class="s1">&#39;Hello World!&#39;</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>创建cofing.py文件，该文件为数据库连接配置文件</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#encoding:utf-8</span>
<span class="n">HOST</span> <span class="o">=</span> <span class="s1">&#39;127.0.0.1&#39;</span>
<span class="n">PORT</span> <span class="o">=</span> <span class="s1">&#39;3306&#39;</span>
<span class="n">USERNAME</span> <span class="o">=</span> <span class="s1">&#39;root&#39;</span>
<span class="n">PASSWORD</span> <span class="o">=</span> <span class="s1">&#39;root&#39;</span>
<span class="n">DATABASE</span> <span class="o">=</span> <span class="s1">&#39;books_01&#39;</span>
<span class="n">DB_URI</span> <span class="o">=</span> <span class="s1">&#39;mysql+pymysql://</span><span class="si">{username}</span><span class="s1">:</span><span class="si">{password}</span><span class="s1">@</span><span class="si">{host}</span><span class="s1">:</span><span class="si">{port}</span><span class="s1">/</span><span class="si">{db}</span><span class="s1">?charset-utf8&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">USERNAME</span><span class="p">,</span>
                                                                                        <span class="n">password</span><span class="o">=</span><span class="n">PASSWORD</span><span class="p">,</span>
                                                                                        <span class="n">host</span><span class="o">=</span><span class="n">HOST</span><span class="p">,</span>
                                                                                        <span class="n">port</span><span class="o">=</span><span class="n">PORT</span><span class="p">,</span>
                                                                                        <span class="n">db</span><span class="o">=</span><span class="n">DATABASE</span><span class="p">)</span>
<span class="n">SQLALCHEMY_DATABASE_URI</span> <span class="o">=</span> <span class="n">DB_URI</span>
<span class="n">SQLALCHEMY_TRACK_MODIFICATIONS</span> <span class="o">=</span> <span class="kc">False</span>
</pre></div>
</div>
</section>
</section>
<section id="id34">
<h3><a class="toc-backref" href="#id86">9.4 创建一对一的关系表</a><a class="headerlink" href="#id34" title="Permalink to this headline">¶</a></h3>
<p>数据库实体间有3种关联关系：一对一、一对多，以及多对多。</p>
<ul class="simple">
<li><p>一个学生只有一个身份证号码，构成了一对一关系；</p></li>
<li><p>一个班级有多名学生，构成了一对多的关系；</p></li>
<li><p>课程和学生的关系就构成了多对多关系，一个学生可以选修多门课程，一门课程对应多个学生。</p></li>
</ul>
<p>比如人和身份证的一对一关系，图书管理系统中的学生和借书证的一对一关系、学生和具体借到的某一本书也是一对一关系等。</p>
<p>一对一关系主要在relationship方法中，使用uselist=False来约束，如果查询得到的是一个列表，那么就使用uselist=False禁用列表，这样最终查询到的结果就是唯一的，就构成了一对一关系。</p>
<blockquote>
<div><p>注意：uselist=False表示不使用列表，使用标量值。</p>
</div></blockquote>
<p>下面主要图书管理系统中的用户和借书证构成了一对一关系为例进行讲解。</p>
<p>主要文件为：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">config</span><span class="o">.</span><span class="n">py</span>
<span class="n">app</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
<p>使用Flask-SQLAlchemy创建一对一关系实例：app.py</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
<span class="kn">from</span> <span class="nn">flask_sqlalchemy</span> <span class="kn">import</span> <span class="n">SQLAlchemy</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">config</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">from_object</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">SQLAlchemy</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
<span class="c1"># 定义用户表</span>


<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;user&#39;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">autoincrement</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># 用户名</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># 密码</span>
    <span class="n">phone</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">11</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># 电话</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">30</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># 邮箱</span>
    <span class="n">reg_time</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">DateTime</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>  <span class="c1"># 注册时间</span>

<span class="c1"># 定义借书证表</span>


<span class="k">class</span> <span class="nc">Lib_card</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;lib_card&#39;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">autoincrement</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">card_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># 借书证id</span>
    <span class="n">papers_type</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># 何种证件办理</span>
    <span class="n">borrow_reg_time</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">DateTime</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>  <span class="c1"># 证件办理时间</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;user.id&#39;</span><span class="p">))</span>
    <span class="n">users</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span><span class="s1">&#39;User&#39;</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">backref</span><span class="p">(</span><span class="s1">&#39;cards&#39;</span><span class="p">),</span> <span class="n">uselist</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="n">db</span><span class="o">.</span><span class="n">create_all</span><span class="p">()</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/add&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">():</span>
    <span class="c1"># 添加两条用户数据</span>
    <span class="n">user1</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s2">&quot;张三&quot;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s2">&quot;111111&quot;</span><span class="p">,</span>
                 <span class="n">phone</span><span class="o">=</span><span class="s2">&quot;13888888888&quot;</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s2">&quot;10086@qq.com&quot;</span><span class="p">)</span>
    <span class="n">user2</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s2">&quot;李四&quot;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s2">&quot;123456&quot;</span><span class="p">,</span>
                 <span class="n">phone</span><span class="o">=</span><span class="s2">&quot;13777777777&quot;</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s2">&quot;10000@qq.com&quot;</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user1</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user2</span><span class="p">)</span>
    <span class="c1"># 添加两条借书证信息</span>
    <span class="n">card1</span> <span class="o">=</span> <span class="n">Lib_card</span><span class="p">(</span><span class="n">card_id</span><span class="o">=</span><span class="s1">&#39;18001&#39;</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="n">papers_type</span><span class="o">=</span><span class="s1">&#39;身份证&#39;</span><span class="p">)</span>
    <span class="n">card2</span> <span class="o">=</span> <span class="n">Lib_card</span><span class="p">(</span><span class="n">card_id</span><span class="o">=</span><span class="s1">&#39;18002&#39;</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="n">papers_type</span><span class="o">=</span><span class="s1">&#39;身份证&#39;</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">card1</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">card2</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">return</span> <span class="s1">&#39;添加数据成功！&#39;</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/select&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">select</span><span class="p">():</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="s1">&#39;张三&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="n">art</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">cards</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">art</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">card_id</span><span class="p">)</span>
    <span class="n">card</span> <span class="o">=</span> <span class="n">Lib_card</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Lib_card</span><span class="o">.</span><span class="n">card_id</span> <span class="o">==</span> <span class="s1">&#39;18001&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">users</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
    <span class="k">return</span> <span class="s2">&quot;查询数据成功！&quot;</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">hello_world</span><span class="p">():</span>
    <span class="k">return</span> <span class="s1">&#39;Hello World!&#39;</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>config.py</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># encoding:utf-8</span>
<span class="n">HOST</span> <span class="o">=</span> <span class="s1">&#39;127.0.0.1&#39;</span>
<span class="n">PORT</span> <span class="o">=</span> <span class="s1">&#39;3306&#39;</span>
<span class="n">USERNAME</span> <span class="o">=</span> <span class="s1">&#39;root&#39;</span>
<span class="n">PASSWORD</span> <span class="o">=</span> <span class="s1">&#39;123456&#39;</span>
<span class="n">DATABASE</span> <span class="o">=</span> <span class="s1">&#39;library&#39;</span>
<span class="n">DB_URI</span> <span class="o">=</span> <span class="s1">&#39;mysql+pymysql://</span><span class="si">{username}</span><span class="s1">:</span><span class="si">{password}</span><span class="s1">@</span><span class="si">{host}</span><span class="s1">:</span><span class="si">{port}</span><span class="s1">/</span><span class="si">{db}</span><span class="s1">?charset-utf8&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">USERNAME</span><span class="p">,</span>
                                                                                        <span class="n">password</span><span class="o">=</span><span class="n">PASSWORD</span><span class="p">,</span>
                                                                                        <span class="n">host</span><span class="o">=</span><span class="n">HOST</span><span class="p">,</span>
                                                                                        <span class="n">port</span><span class="o">=</span><span class="n">PORT</span><span class="p">,</span>
                                                                                        <span class="n">db</span><span class="o">=</span><span class="n">DATABASE</span><span class="p">)</span>
<span class="n">SQLALCHEMY_DATABASE_URI</span> <span class="o">=</span> <span class="n">DB_URI</span>
<span class="n">SQLALCHEMY_TRACK_MODIFICATIONS</span> <span class="o">=</span> <span class="kc">False</span>
</pre></div>
</div>
<ul class="simple">
<li><p>注意：一个表（模型）的定义必须要定义一个主键，这个主键一般为id。</p></li>
</ul>
<p>在定义了Lib_card类后，申明了一个外键，并且在relationship方法中使用uselist=False来约束其关系。</p>
<p>user_id=db.Column(db.Integer,db.ForeignKey(‘user.id’))表示创建一个外键，类型要跟主表一样，通过db.ForeignKey(“user.id”)与主表绑定users=db.relationship(‘User’，backref=db.backref(‘cards’)；</p>
<p>uselist=False表示user可以根据Lib_card中的借书证查找到用户表中的信息</p>
<p>backref=“cards”表示用户表可以直接通过cards查找到该用户下的借书证号码。</p>
</section>
<section id="id35">
<h3><a class="toc-backref" href="#id87">9.5 创建一对多的关系表</a><a class="headerlink" href="#id35" title="Permalink to this headline">¶</a></h3>
<p>生活中典型的一对多关系有哪些？一个年级对应多个平行班级，一个网购用户对应多个订单，一个家庭对应多个家庭成员等，这些是典型的一对多关系。</p>
<p>下面以一个典型的一对多关系为例，即一个作者可以编著多本图书的一对多关系为例，来揭晓用flask-sqlalchemy是如何实现一对多关系的。</p>
<p>使用Flask-SQLAlchemy创建一对多关系实例：app.py</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
<span class="kn">from</span> <span class="nn">flask_sqlalchemy</span> <span class="kn">import</span> <span class="n">SQLAlchemy</span>
<span class="kn">import</span> <span class="nn">config</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">from_object</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">SQLAlchemy</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>


<span class="c1"># 定义用户表</span>
<span class="c1"># 定义模型类-作者类</span>
<span class="k">class</span> <span class="nc">Writer</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;writer&#39;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="c1"># 设置relationship属性方法，建立模型关系，第一个参数为多方模型的类名，添加backref可以实现多对一的反向查询</span>
    <span class="n">books</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span><span class="s1">&#39;Book&#39;</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s1">&#39;writers&#39;</span><span class="p">)</span>


<span class="c1"># 定义模型类-图书类</span>
<span class="k">class</span> <span class="nc">Book</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;books&#39;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">publishing_office</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">isbn</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="c1"># 设置外键指向一方的主键，建立关联关系</span>
    <span class="n">writer_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;writer.id&#39;</span><span class="p">))</span>


<span class="n">db</span><span class="o">.</span><span class="n">create_all</span><span class="p">()</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/add&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">():</span>
    <span class="c1"># 添加两条作者数据</span>
    <span class="n">user1</span> <span class="o">=</span> <span class="n">Writer</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;李兴华&quot;</span><span class="p">)</span>
    <span class="n">user2</span> <span class="o">=</span> <span class="n">Writer</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Sweigart&quot;</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user1</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user2</span><span class="p">)</span>
    <span class="c1"># 添加两条图书信息</span>
    <span class="n">book1</span> <span class="o">=</span> <span class="n">Book</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;名师讲坛——Java开发实战经典（第2版）&#39;</span><span class="p">,</span>
                 <span class="n">publishing_office</span><span class="o">=</span><span class="s1">&#39;清华大学出版社&#39;</span><span class="p">,</span> <span class="n">isbn</span><span class="o">=</span><span class="s1">&#39;9787302483663&#39;</span><span class="p">,</span> <span class="n">writer_id</span><span class="o">=</span><span class="s1">&#39;1&#39;</span><span class="p">)</span>
    <span class="n">book2</span> <span class="o">=</span> <span class="n">Book</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;android开发实战&#39;</span><span class="p">,</span> <span class="n">publishing_office</span><span class="o">=</span><span class="s1">&#39;清华大学出版社&#39;</span><span class="p">,</span>
                 <span class="n">isbn</span><span class="o">=</span><span class="s1">&#39;9787302281559&#39;</span><span class="p">,</span> <span class="n">writer_id</span><span class="o">=</span><span class="s1">&#39;1&#39;</span><span class="p">)</span>
    <span class="n">book3</span> <span class="o">=</span> <span class="n">Book</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Python游戏编程快速上手&#39;</span><span class="p">,</span> <span class="n">publishing_office</span><span class="o">=</span><span class="s1">&#39;人民邮电大学出版社&#39;</span><span class="p">,</span>
                 <span class="n">isbn</span><span class="o">=</span><span class="s1">&#39;9787115466419&#39;</span><span class="p">,</span> <span class="n">writer_id</span><span class="o">=</span><span class="s1">&#39;2&#39;</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">book1</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">book2</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">book3</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">return</span> <span class="s1">&#39;添加数据成功！&#39;</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/select&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">select</span><span class="p">():</span>
    <span class="n">writer</span> <span class="o">=</span> <span class="n">Writer</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Writer</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="s1">&#39;1&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="n">book</span> <span class="o">=</span> <span class="n">writer</span><span class="o">.</span><span class="n">books</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">book</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>
    <span class="n">book</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="s1">&#39;1&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="n">writer</span> <span class="o">=</span> <span class="n">book</span><span class="o">.</span><span class="n">writers</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">writer</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">return</span> <span class="s2">&quot;查询数据成功！&quot;</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">hello_world</span><span class="p">():</span>
    <span class="k">return</span> <span class="s1">&#39;Hello World!&#39;</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p>主要是通过设置外键指向一方的主键，让作者和图书建立关联关系。</p>
<p>通过创建一个外键，类型要与想要关联的表的数据类型一样，这里通过db.ForeignKey(‘writer.id’)来实现。</p>
</section>
<section id="id36">
<h3><a class="toc-backref" href="#id88">9.6 创建多对多的关系表</a><a class="headerlink" href="#id36" title="Permalink to this headline">¶</a></h3>
<p>生活中典型的多对多关系比较多，一个班级对应多个老师，一个老师对应多个班级。</p>
<p>又比如，一个学生对应多门课程，一门课程对应多个学生等，这些是典型的多对多关系。</p>
<p>下面以一个典型的多对多关系为例讲解，即图书和图书标签（上架建议标签）的数据库。</p>
<p>很显然，图书可能对应着多个标签，不能再使用外键来描述其关系了。</p>
<p>同样，也不能在标签表中加入一个指向图书的外键，因为一个标签可以对应着多本图书，两侧都需要一组外键。</p>
<p>处理多对多表问题时，解决方法是添加第3张表，这个表称为关联表或中间表。</p>
<p>数据库中的多对多关联关系一般需采用中间表的方式处理，将多对多转化为两个一对多。</p>
<blockquote>
<div><p>注意：关联表或中间表不要定义成类，不要使用class，在使用db.Table()方法定义时，应该使用两个以上的外键。</p>
</div></blockquote>
<p>使用Flask-SQLAlchemy创建多对多关系实例：app.py</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
<span class="kn">from</span> <span class="nn">flask_sqlalchemy</span> <span class="kn">import</span> <span class="n">SQLAlchemy</span>
<span class="kn">import</span> <span class="nn">config</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">from_object</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">SQLAlchemy</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
<span class="n">book_tag</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="s1">&#39;book_tag&#39;</span><span class="p">,</span>
                    <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;book_id&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span>
                        <span class="s1">&#39;book.id&#39;</span><span class="p">),</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                    <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;tag_id&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span>
                        <span class="s1">&#39;shelfing.id&#39;</span><span class="p">),</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="p">)</span>


<span class="c1"># 定义模型类-图书类</span>
<span class="k">class</span> <span class="nc">Book</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;book&#39;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">autoincrement</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="c1"># 设置relationship属性方法，建立模型关系，第一个参数为多方模型的类名，secondary代表中间表</span>
    <span class="c1"># 第三个参数表示反向引用</span>
    <span class="n">tags</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span><span class="s1">&#39;Shelfing&#39;</span><span class="p">,</span> <span class="n">secondary</span><span class="o">=</span><span class="n">book_tag</span><span class="p">,</span>
                           <span class="n">backref</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">backref</span><span class="p">(</span><span class="s1">&#39;books&#39;</span><span class="p">))</span>


<span class="c1"># 定义模型类-图书上架建议（标签）类</span>
<span class="k">class</span> <span class="nc">Shelfing</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;shelfing&#39;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">tag</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="n">db</span><span class="o">.</span><span class="n">create_all</span><span class="p">()</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/add&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">():</span>
    <span class="n">book1</span> <span class="o">=</span> <span class="n">Book</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Java开发&#39;</span><span class="p">)</span>
    <span class="n">book2</span> <span class="o">=</span> <span class="n">Book</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Python游戏编程快速上手&#39;</span><span class="p">)</span>
    <span class="n">book3</span> <span class="o">=</span> <span class="n">Book</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;文艺范&#39;</span><span class="p">)</span>
    <span class="n">tag1</span> <span class="o">=</span> <span class="n">Shelfing</span><span class="p">(</span><span class="n">tag</span><span class="o">=</span><span class="s1">&#39;文艺&#39;</span><span class="p">)</span>
    <span class="n">tag2</span> <span class="o">=</span> <span class="n">Shelfing</span><span class="p">(</span><span class="n">tag</span><span class="o">=</span><span class="s1">&#39;计算机&#39;</span><span class="p">)</span>
    <span class="n">tag3</span> <span class="o">=</span> <span class="n">Shelfing</span><span class="p">(</span><span class="n">tag</span><span class="o">=</span><span class="s1">&#39;技术&#39;</span><span class="p">)</span>
    <span class="n">book1</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tag2</span><span class="p">)</span>
    <span class="n">book1</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tag3</span><span class="p">)</span>
    <span class="n">book2</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tag3</span><span class="p">)</span>
    <span class="n">book3</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tag1</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add_all</span><span class="p">([</span><span class="n">book1</span><span class="p">,</span> <span class="n">book2</span><span class="p">,</span> <span class="n">book3</span><span class="p">,</span> <span class="n">tag1</span><span class="p">,</span> <span class="n">tag2</span><span class="p">,</span> <span class="n">tag3</span><span class="p">])</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">return</span> <span class="s1">&#39;数据添加成功！&#39;</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/select&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">select</span><span class="p">():</span>
    <span class="c1"># 查询Java开发这本书的上架标签</span>
    <span class="n">book</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Java开发&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="n">tag</span> <span class="o">=</span> <span class="n">book</span><span class="o">.</span><span class="n">tags</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">tag</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">tag</span><span class="p">)</span>
    <span class="c1"># 查询标签=技术的所有图书</span>
    <span class="n">tag</span> <span class="o">=</span> <span class="n">Shelfing</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Shelfing</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;技术&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="n">book</span> <span class="o">=</span> <span class="n">tag</span><span class="o">.</span><span class="n">books</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">book</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">return</span> <span class="s1">&#39;查询成功！&#39;</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">hello_world</span><span class="p">():</span>
    <span class="k">return</span> <span class="s1">&#39;Hello World!&#39;</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p>使用http://127.0.0.1:5000/地址访问，</p>
<p>在数据中新增表，使用http://127.0.0.1:5000/add新增测试数据，</p>
<p>使用http://127.0.0.1:5000/selcet进行测试数据的查询。</p>
<p>db.session.add_all()表示批量作insert操作，在插入单条数据的时候使用db.session.add()，</p>
<p>在插入多条数据的时候使用db.session.add_all()。</p>
<blockquote>
<div><p>注意：使用http://127.0.0.1:5000/add新增测试数据时，刷新一次网页，会增加一次数据。</p>
</div></blockquote>
<p>多对多关系仍使用定义一对多关系的db.relationship()方法进行定义。</p>
<p>在Book类中，我们使用了tags=db.relationship(‘Shelfing’,secondary=book_tag,backref=db.backref(‘books’))来定义。db.relationship()一共给出了3个参数；</p>
<ul class="simple">
<li><p>第1个参数Shelfing为多方模型的类名；</p></li>
<li><p>第2个参数secondary表示在多对多关系中；必须把secondary参数设为关联表book_tag；</p></li>
<li><p>第3个参数backref表示反向引用的名称。</p></li>
</ul>
<p>假如拿到了一个标签tag，怎么拿到标签下的所有图书呢？这时用books，表示反向引用。多对多关系可以在任何一个类中定义，backref参数会处理好关系的另一侧。</p>
<p>关联表就是一个简单的表，不是模型，不要定义为类，SQLAlchemy会自动接管这个表。</p>
</section>
</section>
<section id="flask-script">
<h2><a class="toc-backref" href="#id89">10.Flask-Script工具的使用</a><a class="headerlink" href="#flask-script" title="Permalink to this headline">¶</a></h2>
<p>Flask-Script的作用是可以通过命令行的形式来操作Flask。例如，通过命令跑一个开发版本的服务器、设置数据库，定时任务等。</p>
<section id="id37">
<h3><a class="toc-backref" href="#id90">10.1 安装Flask-Script并初始化</a><a class="headerlink" href="#id37" title="Permalink to this headline">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>（venv）$ pip install Flask-Script
</pre></div>
</div>
<p>首先，创建一个Python模板运行命令脚本，可起名为manager.py。</p>
<p>在该文件中必须有一个Manager实例，Manager类追踪所有在命令行中调用的命令和处理过程的调用与运行情况；Manager只有一个参数——Flask实例，也可以是一个函数或其他的返回Flask实例；</p>
<p>创建Manager实例时需要用到Flask对象。</p>
<p>调用manager.run()启动Manager实例接收命令行中的命令。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span> <span class="c1"># 导入Manager模块</span>
<span class="kn">from</span> <span class="nn">flask_script</span> <span class="kn">import</span> <span class="n">Manager</span>

<span class="c1"># Flask初始化</span>
<span class="n">app</span><span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># 这里一般是设置你的app操作</span>
<span class="n">manager</span><span class="o">=</span> <span class="n">Manager</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span><span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="c1"># 创建Manager的实例manager</span>
    <span class="n">manager</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="command">
<h3><a class="toc-backref" href="#id91">10.2 Command子类创建命令</a><a class="headerlink" href="#command" title="Permalink to this headline">¶</a></h3>
<p>定义一个子类继承自Command类，然后在manager.add_command()方法中可以将这个类定义成一些命令，此时的命令应该用单引号或双引号引起来。具体用法如下：</p>
<p>Flask-Scrip工具使用实例：manager.py</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># -*- coding:utf-8 -*-</span>
<span class="kn">from</span> <span class="nn">flask_script</span> <span class="kn">import</span> <span class="n">Manager</span><span class="p">,</span> <span class="n">Server</span>  <span class="c1"># 导入相应模块</span>
<span class="kn">from</span> <span class="nn">flask_script</span> <span class="kn">import</span> <span class="n">Command</span>  <span class="c1"># 导入Command模块</span>
<span class="kn">from</span> <span class="nn">app</span> <span class="kn">import</span> <span class="n">app</span>  <span class="c1"># 导入app</span>
<span class="n">manager</span> <span class="o">=</span> <span class="n">Manager</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>  <span class="c1"># 创建Manager的实例manager</span>


<span class="k">class</span> <span class="nc">Hello</span><span class="p">(</span><span class="n">Command</span><span class="p">):</span>  <span class="c1"># 定义Hello类</span>
    <span class="s1">&#39;hello world&#39;</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># 定义函数run</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;hello world&#39;</span><span class="p">)</span>  <span class="c1"># 打印输出</span>


    <span class="c1"># 自定义命令一：</span>
<span class="n">manager</span><span class="o">.</span><span class="n">add_command</span><span class="p">(</span><span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="n">Hello</span><span class="p">())</span>  <span class="c1"># 把Hello()子类定义为命令hello</span>
<span class="c1"># 自定义命令二：</span>
<span class="n">manager</span><span class="o">.</span><span class="n">add_command</span><span class="p">(</span><span class="s2">&quot;runserver&quot;</span><span class="p">,</span> <span class="n">Server</span><span class="p">())</span>  <span class="c1"># 命令是runserver</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">manager</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p>Python flask flask_script 报错：ModuleNotFoundError: No module named
‘flask._compat‘解决方法</p>
<p><strong>原因：</strong></p>
<p>可能是更新了<a class="reference external" href="https://so.csdn.net/so/search?q=Flask&amp;spm=1001.2101.3001.7020">Flask</a>版本问题，导致<code class="docutils literal notranslate"><span class="pre">Flask._compat</span></code>的目录发生变化。</p>
<p><strong>解决方法：</strong></p>
<p>使用如下命令降级；</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ python -m pip uninstall flask
$ python -m pip install <span class="nv">flask</span><span class="o">==</span><span class="m">1</span>.1.4
$ python -m pip install <span class="nv">markupsafe</span><span class="o">==</span><span class="m">2</span>.0.1
</pre></div>
</div>
<p>或者</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">不降级则可以尝试修改一下</span>
<span class="n">flask_script</span><span class="o">/</span><span class="fm">__init__</span><span class="o">.</span><span class="n">py文件中</span>
<span class="kn">from</span> <span class="nn">._compat</span> <span class="kn">import</span> <span class="n">text_type</span>
<span class="n">改成</span>
<span class="kn">from</span> <span class="nn">flask_script._compat</span> <span class="kn">import</span> <span class="n">text_type</span>
</pre></div>
</div>
<blockquote>
<div><p>注意：这里定义的命令hello和runserver使用单引号或双引号均可。</p>
</div></blockquote>
<p>执行如下命令：</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ python manager.py
usage: manager.py <span class="o">[</span>-?<span class="o">]</span> <span class="o">{</span>hello,runserver,shell<span class="o">}</span> ...

positional arguments:
  <span class="o">{</span>hello,runserver,shell<span class="o">}</span>
    hello               hello world
    runserver           Runs the Flask development server i.e. app.run<span class="o">()</span>
    shell               Runs a Python shell inside Flask application context.

optional arguments:
  -?, --help            show this <span class="nb">help</span> message and <span class="nb">exit</span>

$ python manager.py hello
hello world


$ python manager.py runserver
 * Serving Flask app <span class="s1">&#39;app&#39;</span>
 * Debug mode: off
WARNING: This is a development server. Do not use it <span class="k">in</span> a production deployment. Use a production WSGI server instead.
 * Running on http://127.0.0.1:5000
Press CTRL+C to quit
</pre></div>
</div>
</section>
<section id="command-command">
<h3><a class="toc-backref" href="#id92">10.3 使用Command实例的&#64;command修饰符</a><a class="headerlink" href="#command-command" title="Permalink to this headline">¶</a></h3>
<p>&#64;command添加命令使用实例：manager.py</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># -*- coding:utf-8 -*-</span>
<span class="kn">from</span> <span class="nn">flask_script</span> <span class="kn">import</span> <span class="n">Manager</span><span class="p">,</span> <span class="n">Server</span>  <span class="c1"># 导入相应模块</span>
<span class="kn">from</span> <span class="nn">flask_script</span> <span class="kn">import</span> <span class="n">Command</span>  <span class="c1"># 导入Command模块</span>
<span class="kn">from</span> <span class="nn">app</span> <span class="kn">import</span> <span class="n">app</span>  <span class="c1"># 导入app</span>
<span class="n">manager</span> <span class="o">=</span> <span class="n">Manager</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>  <span class="c1"># 创建Manager的实例manager</span>


<span class="nd">@manager</span><span class="o">.</span><span class="n">command</span>  <span class="c1"># 使用装饰器</span>
<span class="k">def</span> <span class="nf">hello</span><span class="p">():</span>  <span class="c1"># 定义函数hello()</span>
    <span class="s1">&#39;hello world&#39;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;hello world&#39;</span><span class="p">)</span>  <span class="c1"># 打印输出</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">manager</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p>使用Command实例的&#64;command修饰符方法来创建命令和Command类创建命令的运行方式相同。</p>
<p>在命令行输入以下命令，结果如下：</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ python manager.py hello
hello world
</pre></div>
</div>
</section>
<section id="command-option">
<h3><a class="toc-backref" href="#id93">10.4 使用Command实例的&#64;option修饰符创建命令</a><a class="headerlink" href="#command-option" title="Permalink to this headline">¶</a></h3>
<p>如果想要添加多个命令，建议使用&#64;option修饰符创建命令，可以有多个&#64;option选项参数。</p>
<p>&#64;option修饰符创建命令使用实例：app.py</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># -*-coding:utf8-*-</span>
<span class="kn">from</span> <span class="nn">flask_script</span> <span class="kn">import</span> <span class="n">Manager</span>  <span class="c1"># 导入Manager模块</span>
<span class="kn">from</span> <span class="nn">app</span> <span class="kn">import</span> <span class="n">app</span>  <span class="c1"># 导入app</span>
<span class="n">manager</span> <span class="o">=</span> <span class="n">Manager</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>  <span class="c1"># 创建Manager的实例manager</span>


<span class="c1"># 创建命令</span>
<span class="nd">@manager</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;-n&#39;</span><span class="p">,</span> <span class="s1">&#39;--name&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Your name&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;world&#39;</span><span class="p">)</span>
<span class="nd">@manager</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;-u&#39;</span><span class="p">,</span> <span class="s1">&#39;--url&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;url&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;www.csdn.com&#39;</span><span class="p">)</span>  <span class="c1"># 创建命令</span>
<span class="k">def</span> <span class="nf">hello</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>  <span class="c1"># 定义函数hello &#39;hello world or hello &lt;setting name&gt;&#39;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>  <span class="c1"># 打印输出</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>  <span class="c1"># 打印输出</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">manager</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p>输入python manager.py hello，运行结果如下：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="n">manager</span><span class="o">.</span><span class="n">py</span> <span class="n">hello</span>
<span class="o">&gt;</span><span class="n">hello</span> <span class="n">world</span>
<span class="o">&gt;</span><span class="n">www</span><span class="o">.</span><span class="n">csdn</span><span class="o">.</span><span class="n">com</span>
</pre></div>
</div>
<p>再输入python manager.py hello-n sissiy-u www.google.com，运行结果如下：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="n">manager</span><span class="o">.</span><span class="n">py</span> <span class="n">hello</span><span class="o">-</span><span class="n">n</span> <span class="n">sissiy</span><span class="o">-</span><span class="n">u</span> <span class="n">www</span><span class="o">.</span><span class="n">google</span><span class="o">.</span><span class="n">com</span>
<span class="o">&gt;</span> <span class="n">hello</span> <span class="n">sissiy</span>
<span class="o">&gt;</span> <span class="n">www</span><span class="o">.</span><span class="n">google</span><span class="o">.</span><span class="n">com</span>
</pre></div>
</div>
</section>
<section id="id38">
<h3><a class="toc-backref" href="#id94">10.5 Flask循环引用</a><a class="headerlink" href="#id38" title="Permalink to this headline">¶</a></h3>
<p>将数据库的model单独写在一个文件中，model类需要继承db.Model，而主文件中需要注册数据库，这样会导致在主文件中引用model，在model中引用主文件的db，造成循环引用。</p>
<p>基本的文件结构如下：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">app</span><span class="o">.</span><span class="n">py</span>
<span class="n">models</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
<p>循环引用问题的出现实例：app.py</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># encoding:utf-8</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>  <span class="c1"># 导入Flask模块</span>
<span class="kn">from</span> <span class="nn">models</span> <span class="kn">import</span> <span class="n">User</span>  <span class="c1"># 导入user模块</span>
<span class="kn">from</span> <span class="nn">flask_sqlalchemy</span> <span class="kn">import</span> <span class="n">SQLAlchemy</span>  <span class="c1"># 导入SQLAlchemy模块</span>
<span class="kn">import</span> <span class="nn">config</span>  <span class="c1"># 导入配置文件</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>  <span class="c1"># Flask初始化</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">from_object</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>  <span class="c1"># 初始化配置文件</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">SQLAlchemy</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>  <span class="c1"># 获取配置参数，将和数据库相关的配置加载到SQLAlchemy对象中</span>
<span class="c1"># 创建表和字段</span>
<span class="n">db</span><span class="o">.</span><span class="n">create_all</span><span class="p">()</span>  <span class="c1"># 关系映射</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>  <span class="c1"># 定义路由</span>
<span class="k">def</span> <span class="nf">hello_world</span><span class="p">():</span>  <span class="c1"># 定义hello_world函数</span>
    <span class="k">return</span> <span class="s1">&#39;Hello World!&#39;</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p>循环引用问题的出现实例：models.py</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># -*- coding:utf-8 -*-</span>
<span class="kn">from</span> <span class="nn">app</span> <span class="kn">import</span> <span class="n">db</span>  <span class="c1"># 导入db 对象</span>


<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>  <span class="c1"># 定义User类</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;user&#39;</span>  <span class="c1"># 表的别名</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">autoincrement</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># 定义id字段</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># 定义username字段</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># 定义password字段</span>
    <span class="n">telephone</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">11</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># 定义telephone字段</span>
</pre></div>
</div>
<p>但此时会出现循环引用的错误，也就是你需要我的，我需要你的。解决办法是把db单独写在一个文件中，</p>
<p>然后主文件中引用db并注册，model也引用db，这样就不会造成了循环引用问题。</p>
<blockquote>
<div><p>注意：出现循环引用的问题往往意味着代码的布局有问题，可以把需要import的资源提取到一个第三方文件中。</p>
</div></blockquote>
<p>新建一个external.py文件结构如下：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">app</span><span class="o">.</span><span class="n">py</span>
<span class="n">models</span><span class="o">.</span><span class="n">py</span>
<span class="n">external</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
<p>循环引用问题的解决方法实例：external.py</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># encoding:utf-8</span>
<span class="kn">from</span> <span class="nn">flask_sqlalchemy</span> <span class="kn">import</span> <span class="n">SQLAlchemy</span>  <span class="c1"># 导入SQLAlchemy模块</span>

<span class="c1"># 此时先不传入app</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">SQLAlchemy</span><span class="p">()</span>
<span class="n">HOST</span> <span class="o">=</span> <span class="s1">&#39;127.0.0.1&#39;</span>
<span class="n">PORT</span> <span class="o">=</span> <span class="s1">&#39;3306&#39;</span>
<span class="n">USERNAME</span> <span class="o">=</span> <span class="s1">&#39;root&#39;</span>
<span class="n">PASSWORD</span> <span class="o">=</span> <span class="s1">&#39;root&#39;</span>
<span class="n">DATABASE</span> <span class="o">=</span> <span class="s1">&#39;library&#39;</span>
<span class="n">DB_URI</span> <span class="o">=</span> <span class="s1">&#39;mysql+pymysql://</span><span class="si">{username}</span><span class="s1">:</span><span class="si">{password}</span><span class="s1">@</span><span class="si">{host}</span><span class="s1">:</span><span class="si">{port}</span><span class="s1">/</span><span class="si">{db}</span><span class="s1">?charset-utf8&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">USERNAME</span><span class="p">,</span>
                                                                                        <span class="n">password</span><span class="o">=</span><span class="n">PASSWORD</span><span class="p">,</span>
                                                                                        <span class="n">host</span><span class="o">=</span><span class="n">HOST</span><span class="p">,</span>
                                                                                        <span class="n">port</span><span class="o">=</span><span class="n">PORT</span><span class="p">,</span>
                                                                                        <span class="n">db</span><span class="o">=</span><span class="n">DATABASE</span><span class="p">)</span>

<span class="c1"># 行数据库连接的实例化</span>
<span class="n">SQLALCHEMY_DATABASE_URI</span> <span class="o">=</span> <span class="n">DB_URI</span>
<span class="c1"># 关闭动态跟踪</span>
<span class="n">SQLALCHEMY_TRACK_MODIFICATIONS</span> <span class="o">=</span> <span class="kc">False</span>
</pre></div>
</div>
<p>修改后的app.py文件代码如下：</p>
<p>循环引用问题的解决方法实例：app.py</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># encoding:utf-8#设定编码</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>  <span class="c1"># 导入Flask模块</span>
<span class="kn">from</span> <span class="nn">models</span> <span class="kn">import</span> <span class="n">User</span>  <span class="c1"># 导入User模块</span>
<span class="kn">from</span> <span class="nn">external</span> <span class="kn">import</span> <span class="n">db</span>  <span class="c1"># 导入db模块</span>
<span class="kn">import</span> <span class="nn">external</span>  <span class="c1"># 导入extenal模块</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>  <span class="c1"># Flask初始化</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">from_object</span><span class="p">(</span><span class="n">external</span><span class="p">)</span>  <span class="c1"># 配置文件初始化</span>
<span class="n">db</span><span class="o">.</span><span class="n">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>  <span class="c1"># 初始化数据库连接</span>

<span class="c1"># 开始创建表和各个字段</span>
<span class="k">with</span> <span class="n">app</span><span class="o">.</span><span class="n">app_context</span><span class="p">():</span>  <span class="c1"># 手动创建应用上下文</span>
    <span class="n">db</span><span class="o">.</span><span class="n">create_all</span><span class="p">()</span>  <span class="c1"># 建立映射</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>  <span class="c1"># 定义路由</span>
<span class="k">def</span> <span class="nf">hello_world</span><span class="p">():</span>  <span class="c1"># 定义视图函数</span>
    <span class="k">return</span> <span class="s1">&#39;Hello World!&#39;</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>循环引用问题的解决方法实例：models.py</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">app</span> <span class="kn">import</span> <span class="n">db</span>  <span class="c1"># 导入db 对象</span>


<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>  <span class="c1"># 定义User类</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;user&#39;</span>  <span class="c1"># 表的别名</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">autoincrement</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># 定义id字段</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># 定义username字段</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># 定义password字段</span>
    <span class="n">telephone</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">11</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># 定义telephone字段</span>
</pre></div>
</div>
</section>
</section>
<section id="flask-migrate">
<h2><a class="toc-backref" href="#id95">11. Flask-Migrate实现数据迁移</a><a class="headerlink" href="#flask-migrate" title="Permalink to this headline">¶</a></h2>
<p>我们在系统开发过程中，经常碰到需要更新数据库中的表或修改字段等操作。如果通过手工编写alter
SQL脚本进行处理，经常会发现遗漏，而且修改起来不太方便。</p>
<p>同时，由于在Python中采用db.create_all修改字段时，不会自动将更改写入数据库的表中，只有数据表不存在时，Flask_SQLAlchemy才会创建数据库，所以必须删除数据库相关表，然后重新运行db.create_all才会重新生成表，这肯定与实际情况不符合。</p>
<p>现在我们可以使用Flask-Migrate迁移框架来解决这个问题。使用Flask-Migrate数据库迁移框架，可以保证数据库结构在发生变化时，改变数据库结构不至于丢失数据库的数据。</p>
<section id="id39">
<h3><a class="toc-backref" href="#id96">11.1 安装Flask-Migrate插件</a><a class="headerlink" href="#id39" title="Permalink to this headline">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">(</span>venv<span class="o">)</span> $ pip install flask-migrate
</pre></div>
</div>
</section>
<section id="id40">
<h3><a class="toc-backref" href="#id97">11.2 使用Flask-Migrate的步骤</a><a class="headerlink" href="#id40" title="Permalink to this headline">¶</a></h3>
<p>（1）修改Flask app部分的代码，以增加与Migrate相关的Command。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">app</span> <span class="kn">import</span> <span class="n">app</span><span class="p">,</span><span class="n">db</span>
<span class="kn">from</span> <span class="nn">model</span> <span class="kn">import</span> <span class="n">User</span>

<span class="c1">#传入两个对象，一个是Flask的app对象，一个是SQLAlchemy</span>
<span class="n">migrate</span><span class="o">=</span> <span class="n">Migrate</span><span class="p">(</span><span class="n">app</span><span class="p">,</span><span class="n">db</span><span class="p">)</span>

<span class="c1">#实例化Manager类</span>
<span class="n">manager</span><span class="o">=</span> <span class="n">Manager</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>

<span class="c1">#给manager添加一个db命令且传入一个MigrateCommand的类</span>
<span class="n">manager</span><span class="o">.</span><span class="n">add_command</span><span class="p">(</span><span class="s1">&#39;db&#39;</span><span class="p">,</span><span class="n">MigrateCommand</span><span class="p">)</span>
</pre></div>
</div>
<p>（2）准备好数据模型。</p>
<p>（3）初始化和更新迁移数据库操作：</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1">#用于初始化一个迁移脚本的环境</span>
$ python manager.py db init

<span class="c1">#表示创建迁移仓库</span>
$ python manage.py db migrate

<span class="c1">#更新数据库</span>
$ python mange.py db upgrade
</pre></div>
</div>
<p>Flsak-Migrate数据库迁移实例：model.py</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#encoding:utf8</span>
<span class="kn">from</span> <span class="nn">flask_sqlalchemy</span> <span class="kn">import</span> <span class="n">SQLAlchemy</span>
<span class="kn">from</span> <span class="nn">app</span> <span class="kn">import</span> <span class="n">db</span>
<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">user_name</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">60</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">user_password</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">30</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<p>新建文件app.py，内容如下：</p>
<p>Flsak-Migrate数据库迁移实例：app.py</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># encoding:utf-8</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
<span class="kn">from</span> <span class="nn">flask_sqlalchemy</span> <span class="kn">import</span> <span class="n">SQLAlchemy</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;SQLALCHEMY_DATABASE_URI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;mysql+pymysql://root:123456@127.0.0.1:3306/db_6_14&#39;</span>
<span class="c1"># &#39;mysql+pymysql://root:root@127.0.0.1:3306/&#39;</span>
<span class="c1"># 如果设置成 True (默认情况)，Flask-SQLAlchemy 将会追踪对象的修改并且发送信号。这需要额外的内存， 如果不必要的可以禁用它。</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;SQLALCHEMY_TRACK_MODIFICATIONS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">SQLAlchemy</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">hello_world</span><span class="p">():</span>
    <span class="k">return</span> <span class="s1">&#39;Hello World!&#39;</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p>Flsak-Migrate数据库迁移实例：manager.py</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># encoding:utf8</span>
<span class="kn">from</span> <span class="nn">flask_script</span> <span class="kn">import</span> <span class="n">Manager</span>  <span class="c1"># flask 脚本</span>
<span class="kn">from</span> <span class="nn">flask_migrate</span> <span class="kn">import</span> <span class="n">Migrate</span><span class="p">,</span> <span class="n">MigrateCommand</span>  <span class="c1"># flask 迁移数据</span>
<span class="kn">from</span> <span class="nn">app</span> <span class="kn">import</span> <span class="n">app</span><span class="p">,</span> <span class="n">db</span>
<span class="kn">from</span> <span class="nn">model</span> <span class="kn">import</span> <span class="n">User</span>

<span class="n">migrate</span> <span class="o">=</span> <span class="n">Migrate</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">db</span><span class="p">)</span>  <span class="c1"># 传入2个对象一个是flask的app对象，一个是SQLAlchemy</span>
<span class="n">manager</span> <span class="o">=</span> <span class="n">Manager</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
<span class="c1"># 给manager添加一个db命令并且传入一个MigrateCommand的类</span>
<span class="n">manager</span><span class="o">.</span><span class="n">add_command</span><span class="p">(</span><span class="s1">&#39;db&#39;</span><span class="p">,</span> <span class="n">MigrateCommand</span><span class="p">)</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">manager</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p>requirements.txt</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alembic</span><span class="o">==</span><span class="mf">1.8</span><span class="o">.</span><span class="mi">1</span>
<span class="n">click</span><span class="o">==</span><span class="mf">7.1</span><span class="o">.</span><span class="mi">2</span>
<span class="n">colorama</span><span class="o">==</span><span class="mf">0.4</span><span class="o">.</span><span class="mi">5</span>
<span class="n">Flask</span><span class="o">==</span><span class="mf">1.1</span><span class="o">.</span><span class="mi">4</span>
<span class="n">Flask</span><span class="o">-</span><span class="n">Migrate</span><span class="o">==</span><span class="mf">2.7</span><span class="o">.</span><span class="mi">0</span>
<span class="n">Flask</span><span class="o">-</span><span class="n">Script</span><span class="o">==</span><span class="mf">2.0</span><span class="o">.</span><span class="mi">6</span>
<span class="n">Flask</span><span class="o">-</span><span class="n">SQLAlchemy</span><span class="o">==</span><span class="mf">2.5</span><span class="o">.</span><span class="mi">1</span>
<span class="n">greenlet</span><span class="o">==</span><span class="mf">1.1</span><span class="o">.</span><span class="mi">3</span>
<span class="n">importlib</span><span class="o">-</span><span class="n">metadata</span><span class="o">==</span><span class="mf">4.12</span><span class="o">.</span><span class="mi">0</span>
<span class="n">importlib</span><span class="o">-</span><span class="n">resources</span><span class="o">==</span><span class="mf">5.9</span><span class="o">.</span><span class="mi">0</span>
<span class="n">itsdangerous</span><span class="o">==</span><span class="mf">1.1</span><span class="o">.</span><span class="mi">0</span>
<span class="n">Jinja2</span><span class="o">==</span><span class="mf">2.11</span><span class="o">.</span><span class="mi">3</span>
<span class="n">Mako</span><span class="o">==</span><span class="mf">1.2</span><span class="o">.</span><span class="mi">2</span>
<span class="n">MarkupSafe</span><span class="o">==</span><span class="mf">2.0</span><span class="o">.</span><span class="mi">1</span>
<span class="n">PyMySQL</span><span class="o">==</span><span class="mf">1.0</span><span class="o">.</span><span class="mi">2</span>
<span class="n">SQLAlchemy</span><span class="o">==</span><span class="mf">1.4</span><span class="o">.</span><span class="mi">41</span>
<span class="n">Werkzeug</span><span class="o">==</span><span class="mf">1.0</span><span class="o">.</span><span class="mi">1</span>
<span class="n">zipp</span><span class="o">==</span><span class="mf">3.8</span><span class="o">.</span><span class="mi">1</span>
</pre></div>
</div>
<p>接下来就可以进行初始化了，使用命令</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ python manager.py db init
</pre></div>
</div>
<p>该命令用于初始化一个迁移脚本的环境。这个命令中的’db’是在manager.add_command(‘db’,MigrateComand)这行代码中我们声明的命令行对象名称；</p>
<p>init是Migrate命令，表示初始化迁移数据库仓库，运行完成之后，会在当前工程目录下创建一个migrations文件夹，用于进行迁移的数据库脚本都放在这里。</p>
<p>接着使用命令便可以完成数据库的创建。</p>
<p>如果是对数据库中的表进行更新，同样也是使用下面的两条命令：</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ python manager.py db migrate
$ python manager.py db upgrade
</pre></div>
</div>
<p>在数据库中可以看到数据库已经成功创建了。</p>
<p>不使用<code class="docutils literal notranslate"><span class="pre">Flask-Script</span></code>，使用<code class="docutils literal notranslate"><span class="pre">flask</span></code>命令如下：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>初始化数据库：flask db init
迁移新更改：flask db migrate
升级：flask db upgrade
</pre></div>
</div>
<blockquote>
<div><p>注意：第一次迁移实际上相当于调用db.create_all()，但在后续迁移中，upgrade命令对表实施更新操作但不会影响表中的内容。</p>
</div></blockquote>
</section>
</section>
<section id="python-flaskrestful-apis">
<h2><a class="toc-backref" href="#id98">12.使用Python和 Flask设计RESTful APIs</a><a class="headerlink" href="#python-flaskrestful-apis" title="Permalink to this headline">¶</a></h2>
<p>近些年来 REST (REpresentational State Transfer) 已经变成了 web services
和 web APIs 的标配。</p>
<p>在本文中我将向你展示如何简单地使用 Python 和 Flask 框架来创建一个
RESTful 的 web service。</p>
<p><strong>什么是 REST？</strong></p>
<p>六条设计规范定义了一个 REST 系统的特点:</p>
<ul class="simple">
<li><p><strong>客户端-服务器</strong>:
客户端和服务器之间隔离，服务器提供服务，客户端进行消费。</p></li>
<li><p><strong>无状态</strong>:
从客户端到服务器的每个请求都必须包含理解请求所必需的信息。换句话说，
服务器不会存储客户端上一次请求的信息用来给下一次使用。</p></li>
<li><p><strong>可缓存</strong>: 服务器必须明示客户端请求能否缓存。</p></li>
<li><p><strong>分层系统</strong>:
客户端和服务器之间的通信应该以一种标准的方式，就是中间层代替服务器做出响应的时候，客户端不需要做任何变动。</p></li>
<li><p><strong>统一的接口</strong>: 服务器和客户端的通信方法必须是统一的。</p></li>
<li><p><strong>按需编码</strong>:
服务器可以提供可执行代码或脚本，为客户端在它们的环境中执行。这个约束是唯一一个是可选的。</p></li>
</ul>
<section id="restful-web-service">
<h3><a class="toc-backref" href="#id99">12.1 什么是一个 RESTful 的 web service？</a><a class="headerlink" href="#restful-web-service" title="Permalink to this headline">¶</a></h3>
<p>REST 架构的最初目的是适应万维网的 HTTP 协议。</p>
<p>RESTful web services 概念的核心就是“资源”。 资源可以用
<a class="reference external" href="https://en.wikipedia.org/wiki/Uniform_resource_identifier">URI</a>
来表示。客户端使用 HTTP 协议定义的方法来发送请求到这些
URIs，当然可能会导致这些被访问的”资源“状态的改变。</p>
<p>HTTP 标准的方法有如下:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">==========</span>  <span class="o">=====================</span>  <span class="o">==================================</span>
<span class="n">HTTP</span> <span class="n">方法</span>   <span class="n">行为</span>                   <span class="n">示例</span>
<span class="o">==========</span>  <span class="o">=====================</span>  <span class="o">==================================</span>
<span class="n">GET</span>         <span class="n">获取资源的信息</span>         <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">orders</span>
<span class="n">GET</span>         <span class="n">获取某个特定资源的信息</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">orders</span><span class="o">/</span><span class="mi">123</span>
<span class="n">POST</span>        <span class="n">创建新资源</span>             <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">orders</span>
<span class="n">PUT</span>         <span class="n">更新资源</span>               <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">orders</span><span class="o">/</span><span class="mi">123</span>
<span class="n">DELETE</span>      <span class="n">删除资源</span>               <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">orders</span><span class="o">/</span><span class="mi">123</span>
<span class="o">==========</span>  <span class="o">======================</span> <span class="o">==================================</span>
</pre></div>
</div>
<p>REST 设计不需要特定的数据格式。在请求中数据可以以
<a class="reference external" href="http://en.wikipedia.org/wiki/JSON">JSON</a> 形式, 或者有时候作为 url
中查询参数项。</p>
</section>
<section id="web-service">
<h3><a class="toc-backref" href="#id100">12.2 设计一个简单的 web service</a><a class="headerlink" href="#web-service" title="Permalink to this headline">¶</a></h3>
<p>坚持 REST 的准则设计一个 web service 或者 API
的任务就变成一个标识资源被展示出来以及它们是怎样受不同的请求方法影响的练习。</p>
<p>比如说，我们要编写一个待办事项应用程序而且我们想要为它设计一个 web
service。要做的第一件事情就是决定用什么样的根 URL
来访问该服务。例如，我们可以通过这个来访问:</p>
<p><code class="docutils literal notranslate"><span class="pre">http://[hostname]/todo/api/v1.0/</span></code></p>
<p>在这里我已经决定在 URL 中包含应用的名称以及 API 的版本号。在 URL
中包含应用名称有助于提供一个命名空间以便区分同一系统上的其它服务。在 URL
中包含版本号能够帮助以后的更新，如果新版本中存在新的和潜在不兼容的功能，可以不影响依赖于较旧的功能的应用程序。</p>
<p>下一步骤就是选择将由该服务暴露(展示)的资源。这是一个十分简单地应用，我们只有任务，因此在我们待办事项中唯一的资源就是任务。</p>
<p>我们的任务资源将要使用 HTTP 方法如下:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">==========</span>  <span class="o">===============================================</span>  <span class="o">=============================</span>
<span class="n">HTTP</span> <span class="n">方法</span>   <span class="n">URL</span>                                              <span class="n">动作</span>
<span class="o">==========</span>  <span class="o">===============================================</span>  <span class="o">==============================</span>
<span class="n">GET</span>         <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="p">[</span><span class="n">hostname</span><span class="p">]</span><span class="o">/</span><span class="n">todo</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">v1</span><span class="o">.</span><span class="mi">0</span><span class="o">/</span><span class="n">tasks</span>            <span class="n">检索任务列表</span>
<span class="n">GET</span>         <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="p">[</span><span class="n">hostname</span><span class="p">]</span><span class="o">/</span><span class="n">todo</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">v1</span><span class="o">.</span><span class="mi">0</span><span class="o">/</span><span class="n">tasks</span><span class="o">/</span><span class="p">[</span><span class="n">task_id</span><span class="p">]</span>  <span class="n">检索某个任务</span>
<span class="n">POST</span>        <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="p">[</span><span class="n">hostname</span><span class="p">]</span><span class="o">/</span><span class="n">todo</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">v1</span><span class="o">.</span><span class="mi">0</span><span class="o">/</span><span class="n">tasks</span>            <span class="n">创建新任务</span>
<span class="n">PUT</span>         <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="p">[</span><span class="n">hostname</span><span class="p">]</span><span class="o">/</span><span class="n">todo</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">v1</span><span class="o">.</span><span class="mi">0</span><span class="o">/</span><span class="n">tasks</span><span class="o">/</span><span class="p">[</span><span class="n">task_id</span><span class="p">]</span>  <span class="n">更新任务</span>
<span class="n">DELETE</span>      <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="p">[</span><span class="n">hostname</span><span class="p">]</span><span class="o">/</span><span class="n">todo</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">v1</span><span class="o">.</span><span class="mi">0</span><span class="o">/</span><span class="n">tasks</span><span class="o">/</span><span class="p">[</span><span class="n">task_id</span><span class="p">]</span>  <span class="n">删除任务</span>
<span class="o">==========</span>  <span class="o">================================================</span> <span class="o">=============================</span>
</pre></div>
</div>
<p>我们定义的任务有如下一些属性:</p>
<ul class="simple">
<li><p><strong>id</strong>: 任务的唯一标识符。数字类型。</p></li>
<li><p><strong>title</strong>: 简短的任务描述。字符串类型。</p></li>
<li><p><strong>description</strong>: 具体的任务描述。文本类型。</p></li>
<li><p><strong>done</strong>: 任务完成的状态。布尔值。</p></li>
</ul>
<p>目前为止关于我们的 web service 的设计基本完成。剩下的事情就是实现它！</p>
<p>创建flask项目，<code class="docutils literal notranslate"><span class="pre">flaskapp1</span></code></p>
<p>使用pychrm创建</p>
<img alt="../../../_images/image-20220905111439111.png" src="../../../_images/image-20220905111439111.png" />
<p>使用命令行创建</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ mkdir flaskapp1
$ <span class="nb">cd</span> flaskapp1
$ virtualenv flask
New python executable <span class="k">in</span> flask/bin/python
Installing setuptools............................done.
Installing pip...................done.

$ flask/bin/pip install flask
</pre></div>
</div>
<p>既然已经安装了 Flask，现在开始创建一个简单地网页应用，我们把它放在一个叫
app.py 的文件中:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!flask/bin/python</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="k">return</span> <span class="s2">&quot;Hello, World!&quot;</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>为了运行这个程序我们必须执行 app.py:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ chmod a+x app.py
$ ./app.py
 * Running on http://127.0.0.1:5000/
 * Restarting with reloader
</pre></div>
</div>
<p>现在你可以启动你的网页浏览器，输入
<a class="reference external" href="http://localhost:5000/">http://localhost:5000</a>
看看这个小应用程序的效果。</p>
<p>简单吧？现在我们将这个应用程序转换成我们的 RESTful service！</p>
</section>
<section id="python-flaskrestful-services">
<h3><a class="toc-backref" href="#id101">12.3 使用Python和 Flask实现RESTful services</a><a class="headerlink" href="#python-flaskrestful-services" title="Permalink to this headline">¶</a></h3>
<p>在 Flask 中有许多扩展来帮助我们构建 RESTful
services，但是在我看来这个任务十分简单，没有必要使用 Flask 扩展。</p>
<section id="get">
<h4>1.Get<a class="headerlink" href="#get" title="Permalink to this headline">¶</a></h4>
<p>我们现在来实现 web service 的第一个入口:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!flask/bin/python</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">jsonify</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;Buy groceries&#39;</span><span class="p">,</span>
        <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;Milk, Cheese, Pizza, Fruit, Tylenol&#39;</span><span class="p">,</span>
        <span class="s1">&#39;done&#39;</span><span class="p">:</span> <span class="kc">False</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;Learn Python&#39;</span><span class="p">,</span>
        <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;Need to find a good Python tutorial on the web&#39;</span><span class="p">,</span>
        <span class="s1">&#39;done&#39;</span><span class="p">:</span> <span class="kc">False</span>
    <span class="p">}</span>
<span class="p">]</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/todo/api/v1.0/tasks&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">get_tasks</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;tasks&#39;</span><span class="p">:</span> <span class="n">tasks</span><span class="p">})</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>正如你所见，没有多大的变化。我们创建一个任务的内存数据库，这里无非就是一个字典和数组。数组中的每一个元素都具有上述定义的任务的属性。</p>
<p>取代了首页，我们现在拥有一个 get_tasks 的函数，访问的 URI 为
/todo/api/v1.0/tasks，并且只允许 GET 的 HTTP 方法。</p>
<p>这个函数的响应不是文本，我们使用 JSON 数据格式来响应，Flask 的 jsonify
函数从我们的数据结构中生成。</p>
<p>使用网页浏览器来测试我们的 web service
不是一个最好的注意，因为网页浏览器上不能轻易地模拟所有的 HTTP
请求的方法。相反，我们会使用 curl。如果你还没有安装 curl
的话，请立即安装它。</p>
<p>通过执行 app.py，启动 web
service。接着打开一个新的控制台窗口，运行以下命令:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ curl -i http://localhost:5000/todo/api/v1.0/tasks
HTTP/1.1 200 OK
Server: Werkzeug/2.2.2 Python/3.8.8
Date: Mon, 05 Sep 2022 06:51:12 GMT
Content-Type: application/json
Content-Length: 310
Connection: close

{
  &quot;tasks&quot;: [
    {
      &quot;description&quot;: &quot;Milk, Cheese, Pizza, Fruit, Tylenol&quot;,
      &quot;done&quot;: false,
      &quot;id&quot;: 1,
      &quot;title&quot;: &quot;Buy groceries&quot;
    },
    {
      &quot;description&quot;: &quot;Need to find a good Python tutorial on the web&quot;,
      &quot;done&quot;: false,
      &quot;id&quot;: 2,
      &quot;title&quot;: &quot;Learn Python&quot;
    }
  ]
}
</pre></div>
</div>
<p>我们已经成功地调用我们的 RESTful service 的一个函数！</p>
<p>现在我们开始编写 GET
方法请求我们的任务资源的第二个版本。这是一个用来返回单独一个任务的函数:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">abort</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/todo/api/v1.0/tasks/&lt;int:task_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">get_task</span><span class="p">(</span><span class="n">task_id</span><span class="p">):</span>
    <span class="n">task</span> <span class="o">=</span> <span class="p">[</span><span class="n">task</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasks</span> <span class="k">if</span> <span class="n">task</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">task_id</span><span class="p">]</span>
    <span class="c1"># task = list(filter(lambda t: t[&#39;id&#39;] == task_id, tasks))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">task</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">abort</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;task&#39;</span><span class="p">:</span> <span class="n">task</span><span class="p">[</span><span class="mi">0</span><span class="p">]})</span>
</pre></div>
</div>
<p>第二个函数有些意思。这里我们得到了 URL 中任务的 id，接着 Flask
把它转换成 函数中的 task_id 的参数。</p>
<p>我们用这个参数来搜索我们的任务数组。如果我们的数据库中不存在搜索的
id，我们将会返回一个类似 404 的错误，根据 HTTP 规范的意思是
“资源未找到”。</p>
<p>如果我们找到相应的任务，那么我们只需将它用 jsonify 打包成 JSON
格式并将其发送作为响应，就像我们以前那样处理整个任务集合。</p>
<p>调用 curl 请求的结果如下:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ curl -i http://localhost:5000/todo/api/v1.0/tasks/1
HTTP/1.1 200 OK
Server: Werkzeug/2.2.2 Python/3.8.8
Date: Mon, 05 Sep 2022 06:53:30 GMT
Content-Type: application/json
Content-Length: 139
Connection: close

{
  &quot;task&quot;: {
    &quot;description&quot;: &quot;Milk, Cheese, Pizza, Fruit, Tylenol&quot;,
    &quot;done&quot;: false,
    &quot;id&quot;: 1,
    &quot;title&quot;: &quot;Buy groceries&quot;
  }
}

18793@DESKTOP-8LI950S ~
$ curl -i http://localhost:5000/todo/api/v1.0/tasks/2
HTTP/1.1 200 OK
Server: Werkzeug/2.2.2 Python/3.8.8
Date: Mon, 05 Sep 2022 06:53:36 GMT
Content-Type: application/json
Content-Length: 149
Connection: close

{
  &quot;task&quot;: {
    &quot;description&quot;: &quot;Need to find a good Python tutorial on the web&quot;,
    &quot;done&quot;: false,
    &quot;id&quot;: 2,
    &quot;title&quot;: &quot;Learn Python&quot;
  }
}

18793@DESKTOP-8LI950S ~
$ curl -i http://localhost:5000/todo/api/v1.0/tasks/3
HTTP/1.1 404 NOT FOUND
Server: Werkzeug/2.2.2 Python/3.8.8
Date: Mon, 05 Sep 2022 06:53:38 GMT
Content-Type: text/html; charset=utf-8
Content-Length: 207
Connection: close

&lt;!doctype html&gt;
&lt;html lang=en&gt;
&lt;title&gt;404 Not Found&lt;/title&gt;
&lt;h1&gt;Not Found&lt;/h1&gt;
&lt;p&gt;The requested URL was not found on the server. If you entered the URL manually please check your spelling and try again.&lt;/p&gt;
</pre></div>
</div>
<p>当我们请求 id #2 的资源时候，我们获取到了，但是当我们请求 #3
的时候返回了 404 错误。有关错误奇怪的是返回的是 HTML 信息而不是
JSON，这是因为 Flask 按照默认方式生成 404 响应。</p>
<p>由于这是一个 Web service 客户端希望我们总是以 JSON
格式回应，所以我们需要改善我们的 404 错误处理程序:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">make_response</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">errorhandler</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">not_found</span><span class="p">(</span><span class="n">error</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Not found&#39;</span><span class="p">}),</span> <span class="mi">404</span><span class="p">)</span>
</pre></div>
</div>
<p>我们会得到一个友好的错误提示:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ curl -i http://localhost:5000/todo/api/v1.0/tasks/3
HTTP/1.1 404 NOT FOUND
Server: Werkzeug/2.2.2 Python/3.8.8
Date: Mon, 05 Sep 2022 06:57:35 GMT
Content-Type: application/json
Content-Length: 27
Connection: close

{
  &quot;error&quot;: &quot;Not found&quot;
}
</pre></div>
</div>
</section>
<section id="post">
<h4>2.Post<a class="headerlink" href="#post" title="Permalink to this headline">¶</a></h4>
<p>接下来就是 POST 方法，我们用来在我们的任务数据库中插入一个新的任务:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">request</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/todo/api/v1.0/tasks&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">create_task</span><span class="p">():</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span> <span class="ow">or</span> <span class="ow">not</span> <span class="s1">&#39;title&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">:</span>
        <span class="n">abort</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span>
    <span class="n">task</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">tasks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">],</span>
        <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
        <span class="s1">&#39;done&#39;</span><span class="p">:</span> <span class="kc">False</span>
    <span class="p">}</span>
    <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;task&#39;</span><span class="p">:</span> <span class="n">task</span><span class="p">}),</span> <span class="mi">201</span>
</pre></div>
</div>
<p>添加一个新的任务也是相当容易地。只有当请求以 JSON 格式形式，request.json
才会有请求的数据。如果没有数据，或者存在数据但是缺少 title
项，我们将会返回 400，这是表示请求无效。</p>
<p>接着我们会创建一个新的任务字典，使用最后一个任务的 id + 1 作为该任务的
id。我们允许 description 字段缺失，并且假设 done 字段设置成 False。</p>
<p>我们把新的任务添加到我们的任务数组中，并且把新添加的任务和状态 201
响应给客户端。</p>
<p>使用如下的 curl 命令来测试这个新的函数:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ curl -i -H <span class="s2">&quot;Content-Type: application/json&quot;</span> -X POST -d <span class="s1">&#39;{&quot;title&quot;:&quot;Read a book&quot;}&#39;</span> http://localhost:5000/todo/api/v1.0/tasks
HTTP/1.1 <span class="m">201</span> CREATED
Server: Werkzeug/2.2.2 Python/3.8.8
Date: Mon, <span class="m">05</span> Sep <span class="m">2022</span> <span class="m">06</span>:59:27 GMT
Content-Type: application/json
Content-Length: <span class="m">102</span>
Connection: close

<span class="o">{</span>
  <span class="s2">&quot;task&quot;</span>: <span class="o">{</span>
    <span class="s2">&quot;description&quot;</span>: <span class="s2">&quot;&quot;</span>,
    <span class="s2">&quot;done&quot;</span>: false,
    <span class="s2">&quot;id&quot;</span>: <span class="m">3</span>,
    <span class="s2">&quot;title&quot;</span>: <span class="s2">&quot;Read a book&quot;</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="m">18793</span>@DESKTOP-8LI950S ~
$ curl -i http://localhost:5000/todo/api/v1.0/tasks/3
HTTP/1.1 <span class="m">200</span> OK
Server: Werkzeug/2.2.2 Python/3.8.8
Date: Mon, <span class="m">05</span> Sep <span class="m">2022</span> <span class="m">06</span>:59:33 GMT
Content-Type: application/json
Content-Length: <span class="m">102</span>
Connection: close

<span class="o">{</span>
  <span class="s2">&quot;task&quot;</span>: <span class="o">{</span>
    <span class="s2">&quot;description&quot;</span>: <span class="s2">&quot;&quot;</span>,
    <span class="s2">&quot;done&quot;</span>: false,
    <span class="s2">&quot;id&quot;</span>: <span class="m">3</span>,
    <span class="s2">&quot;title&quot;</span>: <span class="s2">&quot;Read a book&quot;</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>注意：如果你在 Windows 上并且运行 Cygwin 版本的
curl，上面的命令不会有任何问题。然而，如果你使用原生的
curl，命令会有些不同:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ curl -i -H <span class="s2">&quot;Content-Type: application/json&quot;</span> -X POST -d <span class="s2">&quot;{&quot;&quot;&quot;</span>title<span class="s2">&quot;&quot;&quot;:&quot;&quot;&quot;</span>Read a book<span class="s2">&quot;&quot;&quot;}&quot;</span> http://localhost:5000/todo/api/v1.0/tasks
</pre></div>
</div>
<p>当然在完成这个请求后，我们可以得到任务的更新列表:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ curl -i http://localhost:5000/todo/api/v1.0/tasks
HTTP/1.1 <span class="m">200</span> OK
Server: Werkzeug/2.2.2 Python/3.8.8
Date: Mon, <span class="m">05</span> Sep <span class="m">2022</span> <span class="m">07</span>:02:22 GMT
Content-Type: application/json
Content-Length: <span class="m">516</span>
Connection: close

<span class="o">{</span>
  <span class="s2">&quot;tasks&quot;</span>: <span class="o">[</span>
    <span class="o">{</span>
      <span class="s2">&quot;description&quot;</span>: <span class="s2">&quot;Milk, Cheese, Pizza, Fruit, Tylenol&quot;</span>,
      <span class="s2">&quot;done&quot;</span>: false,
      <span class="s2">&quot;id&quot;</span>: <span class="m">1</span>,
      <span class="s2">&quot;title&quot;</span>: <span class="s2">&quot;Buy groceries&quot;</span>
    <span class="o">}</span>,
    <span class="o">{</span>
      <span class="s2">&quot;description&quot;</span>: <span class="s2">&quot;Need to find a good Python tutorial on the web&quot;</span>,
      <span class="s2">&quot;done&quot;</span>: false,
      <span class="s2">&quot;id&quot;</span>: <span class="m">2</span>,
      <span class="s2">&quot;title&quot;</span>: <span class="s2">&quot;Learn Python&quot;</span>
    <span class="o">}</span>,
    <span class="o">{</span>
      <span class="s2">&quot;description&quot;</span>: <span class="s2">&quot;&quot;</span>,
      <span class="s2">&quot;done&quot;</span>: false,
      <span class="s2">&quot;id&quot;</span>: <span class="m">3</span>,
      <span class="s2">&quot;title&quot;</span>: <span class="s2">&quot;Read a book&quot;</span>
    <span class="o">}</span>,
    <span class="o">{</span>
      <span class="s2">&quot;description&quot;</span>: <span class="s2">&quot;&quot;</span>,
      <span class="s2">&quot;done&quot;</span>: false,
      <span class="s2">&quot;id&quot;</span>: <span class="m">4</span>,
      <span class="s2">&quot;title&quot;</span>: <span class="s2">&quot;Read a book&quot;</span>
    <span class="o">}</span>
  <span class="o">]</span>
<span class="o">}</span>
</pre></div>
</div>
</section>
<section id="putdelete">
<h4>3.PUT、Delete<a class="headerlink" href="#putdelete" title="Permalink to this headline">¶</a></h4>
<p>剩下的两个函数如下所示:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/todo/api/v1.0/tasks/&lt;int:task_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;PUT&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">update_task</span><span class="p">(</span><span class="n">task_id</span><span class="p">):</span>
    <span class="n">task</span> <span class="o">=</span> <span class="p">[</span><span class="n">task</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasks</span> <span class="k">if</span> <span class="n">task</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">task_id</span><span class="p">]</span>
    <span class="c1"># task = list(filter(lambda t: t[&#39;id&#39;] == task_id, tasks))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">task</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">abort</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">:</span>
        <span class="n">abort</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;title&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">])</span> <span class="o">!=</span> <span class="s2">&quot;unicode&quot;</span><span class="p">:</span>
        <span class="n">abort</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;description&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">])</span> <span class="o">!=</span> <span class="s2">&quot;unicode&quot;</span><span class="p">:</span>
        <span class="n">abort</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;done&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s1">&#39;done&#39;</span><span class="p">])</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">abort</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span>
    <span class="n">task</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="n">task</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;title&#39;</span><span class="p">])</span>
    <span class="n">task</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="n">task</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;description&#39;</span><span class="p">])</span>
    <span class="n">task</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;done&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;done&#39;</span><span class="p">,</span> <span class="n">task</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;done&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;task&#39;</span><span class="p">:</span> <span class="n">task</span><span class="p">[</span><span class="mi">0</span><span class="p">]})</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/todo/api/v1.0/tasks/&lt;int:task_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;DELETE&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">delete_task</span><span class="p">(</span><span class="n">task_id</span><span class="p">):</span>
    <span class="n">task</span> <span class="o">=</span> <span class="p">[</span><span class="n">task</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasks</span> <span class="k">if</span> <span class="n">task</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">task_id</span><span class="p">]</span>
    <span class="c1"># task = list(filter(lambda t: t[&#39;id&#39;] == task_id, tasks))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">task</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">abort</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
    <span class="n">tasks</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">task</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
</pre></div>
</div>
<p>delete_task 函数没有什么特别的。</p>
<p>对于 update_task 函数，我们需要严格地检查输入的参数以防止可能的问题。</p>
<p>我们需要确保在我们把它更新到数据库之前，任何客户端提供我们的是预期的格式。</p>
<p>更新任务 #2 的函数调用如下所示:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ curl -i -H <span class="s2">&quot;Content-Type: application/json&quot;</span> -X PUT -d <span class="s1">&#39;{&quot;done&quot;:true}&#39;</span> http://localhost:5000/todo/api/v1.0/tasks/2
HTTP/1.0 <span class="m">200</span> OK
Content-Type: application/json
Content-Length: <span class="m">170</span>
Server: Werkzeug/0.8.3 Python/2.7.3
Date: Mon, <span class="m">20</span> May <span class="m">2013</span> <span class="m">07</span>:10:16 GMT

<span class="o">{</span>
  <span class="s2">&quot;task&quot;</span>: <span class="o">[</span>
    <span class="o">{</span>
      <span class="s2">&quot;description&quot;</span>: <span class="s2">&quot;Need to find a good Python tutorial on the web&quot;</span>,
      <span class="s2">&quot;done&quot;</span>: true,
      <span class="s2">&quot;id&quot;</span>: <span class="m">2</span>,
      <span class="s2">&quot;title&quot;</span>: <span class="s2">&quot;Learn Python&quot;</span>
    <span class="o">}</span>
  <span class="o">]</span>
<span class="o">}</span>
</pre></div>
</div>
</section>
<section id="id41">
<h4>4.优化web service接口<a class="headerlink" href="#id41" title="Permalink to this headline">¶</a></h4>
<p>当前我们还有一个问题，客户端有可能需要从返回的JSON中重新构造URI，如果将来加入新的特性时，可能需要修改客户端。（例如新增版本。）</p>
<p>我们可以返回整个URI的路径给客户端，而不是任务的id。为了这个功能，创建一个小函数生成一个“public”版本的任务URI返回：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">url_for</span>


<span class="k">def</span> <span class="nf">make_public_task</span><span class="p">(</span><span class="n">task</span><span class="p">):</span>
    <span class="n">new_task</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">task</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">field</span> <span class="o">==</span> <span class="s1">&#39;id&#39;</span><span class="p">:</span>
            <span class="n">new_task</span><span class="p">[</span><span class="s1">&#39;uri&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;get_task&#39;</span><span class="p">,</span> <span class="n">task_id</span><span class="o">=</span><span class="n">task</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">_external</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_task</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">task</span><span class="p">[</span><span class="n">field</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">new_task</span>
</pre></div>
</div>
<p>这里所有做的事情就是从我们数据库中取出任务并且创建一个新的任务，这个任务的
id 字段被替换成通过 Flask 的 url_for 生成的 uri 字段。</p>
<p>当我们返回所有的任务列表的时候，在发送到客户端之前通过这个函数进行处理:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/todo/api/v1.0/tasks&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">get_tasks</span><span class="p">():</span>
    <span class="c1"># return jsonify({&#39;tasks&#39;: list(map(make_public_task, tasks))})</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;tasks&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">make_public_task</span><span class="p">(</span><span class="n">task</span><span class="p">)</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">]})</span>
</pre></div>
</div>
<p>这里就是客户端获取任务列表的时候得到的数据:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ curl -i http://localhost:5000/todo/api/v1.0/tasks
HTTP/1.1 <span class="m">200</span> OK
Server: Werkzeug/2.2.2 Python/3.8.8
Date: Mon, <span class="m">05</span> Sep <span class="m">2022</span> <span class="m">07</span>:26:33 GMT
Content-Type: application/json
Content-Length: <span class="m">400</span>
Connection: close

<span class="o">{</span>
  <span class="s2">&quot;tasks&quot;</span>: <span class="o">[</span>
    <span class="o">{</span>
      <span class="s2">&quot;description&quot;</span>: <span class="s2">&quot;Milk, Cheese, Pizza, Fruit, Tylenol&quot;</span>,
      <span class="s2">&quot;done&quot;</span>: false,
      <span class="s2">&quot;title&quot;</span>: <span class="s2">&quot;Buy groceries&quot;</span>,
      <span class="s2">&quot;uri&quot;</span>: <span class="s2">&quot;http://localhost:5000/todo/api/v1.0/tasks/1&quot;</span>
    <span class="o">}</span>,
    <span class="o">{</span>
      <span class="s2">&quot;description&quot;</span>: <span class="s2">&quot;Need to find a good Python tutorial on the web&quot;</span>,
      <span class="s2">&quot;done&quot;</span>: false,
      <span class="s2">&quot;title&quot;</span>: <span class="s2">&quot;Learn Python&quot;</span>,
      <span class="s2">&quot;uri&quot;</span>: <span class="s2">&quot;http://localhost:5000/todo/api/v1.0/tasks/2&quot;</span>
    <span class="o">}</span>
  <span class="o">]</span>
<span class="o">}</span>
</pre></div>
</div>
<p>这种办法避免了与其它功能的兼容，拿到的是完整uri而不是一个id。</p>
</section>
<section id="id42">
<h4>5.加强 RESTful web service 的安全性<a class="headerlink" href="#id42" title="Permalink to this headline">¶</a></h4>
<p>我们已经完成了我们 web service 的大部分功能，但是仍然有一个问题。我们的
web service 对任何人都是公开的，这并不是一个好主意。</p>
<p>我们有一个可以管理我们的待办事项完整的 web service，但在当前状态下的 web
service 是开放给所有的客户端。 如果一个陌生人弄清我们的 API
是如何工作的，他或她可以编写一个客户端访问我们的 web service
并且毁坏我们的数据。</p>
<p>大部分初级的教程会忽略这个问题并且到此为止。在我看来这是一个很严重的问题，我必须指出。</p>
<p>确保我们的 web service
安全服务的最简单的方法是要求客户端提供一个用户名和密码。在常规的 web
应用程序会提供一个登录的表单用来认证，并且服务器会创建一个会话为登录的用户以后的操作使用，会话的
id 以 cookie 形式存储在客户端浏览器中。然而 REST 的规则之一就是
“无状态”， 因此我们必须要求客户端在每一次请求中提供认证的信息。</p>
<p>我们一直试着尽可能地坚持 HTTP 标准协议。既然我们需要实现认证我们需要在
HTTP 上下文中去完成，HTTP 协议提供了两种认证机制: <a class="reference external" href="http://www.ietf.org/rfc/rfc2617.txt">Basic 和
Digest</a>。</p>
<p>有一个小的 Flask 扩展能够帮助我们，我们可以先安装 Flask-HTTPAuth:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ flask/bin/pip install flask-httpauth
</pre></div>
</div>
<p>比方说，我们希望我们的 web service 只让访问用户名 miguel 和密码 python
的客户端访问。 我们可以设置一个基本的 HTTP 验证如下:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask_httpauth</span> <span class="kn">import</span> <span class="n">HTTPBasicAuth</span>
<span class="n">auth</span> <span class="o">=</span> <span class="n">HTTPBasicAuth</span><span class="p">()</span>


<span class="nd">@auth</span><span class="o">.</span><span class="n">get_password</span>
<span class="k">def</span> <span class="nf">get_password</span><span class="p">(</span><span class="n">username</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">username</span> <span class="o">==</span> <span class="s1">&#39;admin&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;python&#39;</span>
    <span class="k">return</span> <span class="kc">None</span>


<span class="nd">@auth</span><span class="o">.</span><span class="n">error_handler</span>
<span class="k">def</span> <span class="nf">unauthorized</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Unauthorized access&#39;</span><span class="p">}),</span> <span class="mi">401</span><span class="p">)</span>
</pre></div>
</div>
<p>get_password 函数是一个回调函数，Flask-HTTPAuth
使用它来获取给定用户的密码。在一个更复杂的系统中，这个函数是需要检查一个用户数据库，但是在我们的例子中只有单一的用户因此没有必要。</p>
<p>error_handler
回调函数是用于给客户端发送未授权错误代码。像我们处理其它的错误代码，这里我们定制一个包含
JSON 数据格式而不是 HTML 的响应。</p>
<p>随着认证系统的建立，所剩下的就是把需要认证的函数添加
&#64;auth.login_required 装饰器。例如:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/todo/api/v1.0/tasks&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="nd">@auth</span><span class="o">.</span><span class="n">login_required</span>
<span class="k">def</span> <span class="nf">get_tasks</span><span class="p">():</span>
    <span class="c1"># return jsonify({&#39;tasks&#39;: list(map(make_public_task, tasks))})</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;tasks&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">make_public_task</span><span class="p">(</span><span class="n">task</span><span class="p">)</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">]})</span>
</pre></div>
</div>
<p>如果现在要尝试使用 curl 调用这个函数我们会得到:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ curl -i http://localhost:5000/todo/api/v1.0/tasks
HTTP/1.1 <span class="m">401</span> UNAUTHORIZED
Server: Werkzeug/2.2.2 Python/3.8.8
Date: Mon, <span class="m">05</span> Sep <span class="m">2022</span> <span class="m">07</span>:33:51 GMT
Content-Type: application/json
Content-Length: <span class="m">37</span>
WWW-Authenticate: Basic <span class="nv">realm</span><span class="o">=</span><span class="s2">&quot;Authentication Required&quot;</span>
Connection: close

<span class="o">{</span>
  <span class="s2">&quot;error&quot;</span>: <span class="s2">&quot;Unauthorized access&quot;</span>
<span class="o">}</span>
</pre></div>
</div>
<p>为了能够调用这个函数我们必须发送我们的认证凭据:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ curl -u admin:python -i http://localhost:5000/todo/api/v1.0/tasks
HTTP/1.1 <span class="m">200</span> OK
Server: Werkzeug/2.2.2 Python/3.8.8
Date: Mon, <span class="m">05</span> Sep <span class="m">2022</span> <span class="m">07</span>:34:16 GMT
Content-Type: application/json
Content-Length: <span class="m">400</span>
Connection: close

<span class="o">{</span>
  <span class="s2">&quot;tasks&quot;</span>: <span class="o">[</span>
    <span class="o">{</span>
      <span class="s2">&quot;description&quot;</span>: <span class="s2">&quot;Milk, Cheese, Pizza, Fruit, Tylenol&quot;</span>,
      <span class="s2">&quot;done&quot;</span>: false,
      <span class="s2">&quot;title&quot;</span>: <span class="s2">&quot;Buy groceries&quot;</span>,
      <span class="s2">&quot;uri&quot;</span>: <span class="s2">&quot;http://localhost:5000/todo/api/v1.0/tasks/1&quot;</span>
    <span class="o">}</span>,
    <span class="o">{</span>
      <span class="s2">&quot;description&quot;</span>: <span class="s2">&quot;Need to find a good Python tutorial on the web&quot;</span>,
      <span class="s2">&quot;done&quot;</span>: false,
      <span class="s2">&quot;title&quot;</span>: <span class="s2">&quot;Learn Python&quot;</span>,
      <span class="s2">&quot;uri&quot;</span>: <span class="s2">&quot;http://localhost:5000/todo/api/v1.0/tasks/2&quot;</span>
    <span class="o">}</span>
  <span class="o">]</span>
<span class="o">}</span>
</pre></div>
</div>
<p>认证扩展给予我们很大的自由选择哪些函数需要保护，哪些函数需要公开。</p>
<p>为了确保登录信息的安全应该使用 HTTP 安全服务器(例如:
<a class="reference external" href="https:">https://</a>…)，这样客户端和服务器之间的通信都是加密的，以防止传输过程中第三方看到认证的凭据。</p>
<p>让人不舒服的是当请求收到一个 401
的错误，网页浏览都会跳出一个丑陋的登录框，即使请求是在后台发生的。因此如果我们要实现一个完美的
web
服务器的话，我们就需要禁止跳转到浏览器显示身份验证对话框，让我们的客户端应用程序自己处理登录。</p>
<p>一个简单的方式就是不返回 401 错误。403 错误是一个令人青睐的替代，403
错误表示 “禁止” 的错误:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@auth</span><span class="o">.</span><span class="n">error_handler</span>
<span class="k">def</span> <span class="nf">unauthorized</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Unauthorized access&#39;</span><span class="p">}),</span> <span class="mi">403</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="id43">
<h4>6.可能的改进<a class="headerlink" href="#id43" title="Permalink to this headline">¶</a></h4>
<p>我们编写的小型的 web service 还可以在不少的方面进行改进。</p>
<p>对于初学者来说，一个真正的 web service
需要一个真实的数据库进行支撑。我们现在使用的内存数据结构会有很多限制不应该被用于真正的应用。</p>
<p>另外一个可以提高的领域就是处理多用户。如果系统支持多用户的话，不同的客户端可以发送不同的认证凭证获取相应用户的任务列表。在这样一个系统中的话，我们需要第二个资源就是用户。</p>
<p>在用户资源上的 POST 的请求代表注册换一个新用户。</p>
<p>一个 GET 请求表示客户端获取一个用户的信息。</p>
<p>一个 PUT 请求表示更新用户信息，比如可能是更新邮箱地址。</p>
<p>一个 DELETE 请求表示删除用户账号。</p>
<p>GET
检索任务列表请求可以在几个方面进行扩展。首先可以携带一个可选的页的参数，以便客户端请求任务的一部分。另外，这种扩展更加有用：允许按照一定的标准筛选。</p>
<p>比如，用户只想要看到完成的任务，或者只想看到任务的标题以 A
字母开头。所有的这些都可以作为 URL 的一个参数项。</p>
<p>参考文献：</p>
<p><a class="reference external" href="https://blog.miguelgrinberg.com/post/designing-a-restful-api-with-python-and-flask">Designing a RESTful API with Python and
Flask</a></p>
<p><a class="reference external" href="https://www.cnblogs.com/vovlie/p/4178077.html">https://www.cnblogs.com/vovlie/p/4178077.html</a></p>
<p><a class="reference external" href="http://www.pythondoc.com/flask-restful/first.html">http://www.pythondoc.com/flask-restful/first.html</a></p>
<p><a class="reference external" href="https://www.bookstack.cn/read/flask-restful/spilt.8.3b3bb30c584b4b80.md">https://www.bookstack.cn/read/flask-restful/spilt.8.3b3bb30c584b4b80.md</a></p>
</section>
</section>
</section>
<section id="flask-restfulrestful-api">
<h2><a class="toc-backref" href="#id102">13.使用Flask-RESTful设计RESTful API</a><a class="headerlink" href="#flask-restfulrestful-api" title="Permalink to this headline">¶</a></h2>
<p>前面我已经用 Flask 实现了一个 RESTful 服务器。今天我们将会使用
Flask-RESTful 来实现同一个 RESTful 服务器，Flask-RESTful 是一个可以简化
APIs 的构建的 Flask 扩展。</p>
<section id="restful">
<h3><a class="toc-backref" href="#id103">13.1 RESTful 服务器</a><a class="headerlink" href="#restful" title="Permalink to this headline">¶</a></h3>
<p>作为一个提醒， 这里就是待完成事项列表 web service 所提供的方法的定义:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">==========</span>  <span class="o">===============================================</span>  <span class="o">=============================</span>
<span class="n">HTTP</span> <span class="n">方法</span>   <span class="n">URL</span>                                              <span class="n">动作</span>
<span class="o">==========</span>  <span class="o">===============================================</span>  <span class="o">==============================</span>
<span class="n">GET</span>         <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="p">[</span><span class="n">hostname</span><span class="p">]</span><span class="o">/</span><span class="n">todo</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">v1</span><span class="o">.</span><span class="mi">0</span><span class="o">/</span><span class="n">tasks</span>            <span class="n">检索任务列表</span>
<span class="n">GET</span>         <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="p">[</span><span class="n">hostname</span><span class="p">]</span><span class="o">/</span><span class="n">todo</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">v1</span><span class="o">.</span><span class="mi">0</span><span class="o">/</span><span class="n">tasks</span><span class="o">/</span><span class="p">[</span><span class="n">task_id</span><span class="p">]</span>  <span class="n">检索某个任务</span>
<span class="n">POST</span>        <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="p">[</span><span class="n">hostname</span><span class="p">]</span><span class="o">/</span><span class="n">todo</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">v1</span><span class="o">.</span><span class="mi">0</span><span class="o">/</span><span class="n">tasks</span>            <span class="n">创建新任务</span>
<span class="n">PUT</span>         <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="p">[</span><span class="n">hostname</span><span class="p">]</span><span class="o">/</span><span class="n">todo</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">v1</span><span class="o">.</span><span class="mi">0</span><span class="o">/</span><span class="n">tasks</span><span class="o">/</span><span class="p">[</span><span class="n">task_id</span><span class="p">]</span>  <span class="n">更新任务</span>
<span class="n">DELETE</span>      <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="p">[</span><span class="n">hostname</span><span class="p">]</span><span class="o">/</span><span class="n">todo</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">v1</span><span class="o">.</span><span class="mi">0</span><span class="o">/</span><span class="n">tasks</span><span class="o">/</span><span class="p">[</span><span class="n">task_id</span><span class="p">]</span>  <span class="n">删除任务</span>
<span class="o">==========</span>  <span class="o">================================================</span> <span class="o">=============================</span>
</pre></div>
</div>
<p>这个服务唯一的资源叫做“任务”，它有如下一些属性:</p>
<ul class="simple">
<li><p><strong>id</strong>: 任务的唯一标识符。数字类型。</p></li>
<li><p><strong>title</strong>: 简短的任务描述。字符串类型。</p></li>
<li><p><strong>description</strong>: 具体的任务描述。文本类型。</p></li>
<li><p><strong>done</strong>: 任务完成的状态。布尔值。</p></li>
</ul>
<section id="flask-restful">
<h4>1. 安装flask-restful<a class="headerlink" href="#flask-restful" title="Permalink to this headline">¶</a></h4>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ pip install flask_restful
</pre></div>
</div>
<p>安装完成后就可以引入</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask_restful</span> <span class="kn">import</span> <span class="n">Api</span><span class="p">,</span> <span class="n">Resource</span><span class="p">,</span> <span class="n">reqparse</span><span class="p">,</span> <span class="n">abort</span>
</pre></div>
</div>
</section>
</section>
<section id="id44">
<h3><a class="toc-backref" href="#id104">13.2 路由</a><a class="headerlink" href="#id44" title="Permalink to this headline">¶</a></h3>
<p>在上一遍文章中，我使用了 Flask 的视图函数来定义所有的路由。</p>
<p>Flask-RESTful 提供了一个 Resource 基础类，它能够定义一个给定 URL
的一个或者多个 HTTP 方法。</p>
<p>例如，定义一个可以使用 HTTP 的 GET, PUT 以及 DELETE 方法的 User
资源，你的代码可以如下:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
<span class="kn">from</span> <span class="nn">flask_restful</span> <span class="kn">import</span> <span class="n">Api</span><span class="p">,</span> <span class="n">Resource</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">api</span> <span class="o">=</span> <span class="n">Api</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">UserAPI</span><span class="p">(</span><span class="n">Resource</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
        <span class="k">pass</span>


<span class="n">api</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span><span class="n">UserAPI</span><span class="p">,</span> <span class="s1">&#39;/users/&lt;int:id&gt;&#39;</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="s1">&#39;user&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>add_resource 函数使用指定的 endpoint 注册路由到框架上。</p>
<p>如果没有指定 endpoint，Flask-RESTful
会根据类名生成一个，但是有时候有些函数比如 url_for 需要
endpoint，因此我会明确给 endpoint 赋值。</p>
<p>我的待办事项 API 定义两个 URLs：</p>
<ul class="simple">
<li><p>/todo/api/v1.0/tasks（获取所有任务列表）</p></li>
<li><p>/todo/api/v1.0/tasks/（获取单个任务）。</p></li>
</ul>
<p>我们现在需要两个资源:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
<span class="kn">from</span> <span class="nn">flask_restful</span> <span class="kn">import</span> <span class="n">Api</span><span class="p">,</span> <span class="n">Resource</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">api</span> <span class="o">=</span> <span class="n">Api</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">TaskListAPI</span><span class="p">(</span><span class="n">Resource</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>


<span class="k">class</span> <span class="nc">TaskAPI</span><span class="p">(</span><span class="n">Resource</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
        <span class="k">pass</span>


<span class="n">api</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span><span class="n">TaskListAPI</span><span class="p">,</span> <span class="s1">&#39;/todo/api/v1.0/tasks&#39;</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="s1">&#39;tasks&#39;</span><span class="p">)</span>
<span class="n">api</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span><span class="n">TaskAPI</span><span class="p">,</span> <span class="s1">&#39;/todo/api/v1.0/tasks/&lt;int:id&gt;&#39;</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="s1">&#39;task&#39;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="id45">
<h3><a class="toc-backref" href="#id105">13.3 解析以及验证请求</a><a class="headerlink" href="#id45" title="Permalink to this headline">¶</a></h3>
<p>当我在以前的文章中实现此服务器的时候，我自己对请求的数据进行验证。例如，在之前版本中如何处理
PUT 的:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/todo/api/v1.0/tasks/&lt;int:task_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;PUT&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">update_task</span><span class="p">(</span><span class="n">task_id</span><span class="p">):</span>
    <span class="n">task</span> <span class="o">=</span> <span class="p">[</span><span class="n">task</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasks</span> <span class="k">if</span> <span class="n">task</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">task_id</span><span class="p">]</span>
    <span class="c1"># task = list(filter(lambda t: t[&#39;id&#39;] == task_id, tasks))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">task</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">abort</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">:</span>
        <span class="n">abort</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;title&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">])</span> <span class="o">!=</span> <span class="s2">&quot;unicode&quot;</span><span class="p">:</span>
        <span class="n">abort</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;description&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">])</span> <span class="o">!=</span> <span class="s2">&quot;unicode&quot;</span><span class="p">:</span>
        <span class="n">abort</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;done&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s1">&#39;done&#39;</span><span class="p">])</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">abort</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span>
    <span class="n">task</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="n">task</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;title&#39;</span><span class="p">])</span>
    <span class="n">task</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="n">task</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;description&#39;</span><span class="p">])</span>
    <span class="n">task</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;done&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;done&#39;</span><span class="p">,</span> <span class="n">task</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;done&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;task&#39;</span><span class="p">:</span> <span class="n">task</span><span class="p">[</span><span class="mi">0</span><span class="p">]})</span>
</pre></div>
</div>
<p>在这里,
我必须确保请求中给出的数据在使用之前是有效，这样使得函数变得又臭又长。</p>
<p>Flask-RESTful 提供了一个更好的方式来处理数据验证，它叫做 RequestParser
类。</p>
<p>这个类工作方式类似命令行解析工具 argparse。</p>
<p>首先，对于每一个资源需要定义参数以及怎样验证它们:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">jsonify</span><span class="p">,</span> <span class="n">abort</span>
<span class="kn">from</span> <span class="nn">flask_restful</span> <span class="kn">import</span> <span class="n">Api</span><span class="p">,</span> <span class="n">Resource</span><span class="p">,</span> <span class="n">reqparse</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">api</span> <span class="o">=</span> <span class="n">Api</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>

<span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;Buy groceries&#39;</span><span class="p">,</span>
        <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;Milk, Cheese, Pizza, Fruit, Tylenol&#39;</span><span class="p">,</span>
        <span class="s1">&#39;done&#39;</span><span class="p">:</span> <span class="kc">False</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;Learn Python&#39;</span><span class="p">,</span>
        <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;Need to find a good Python tutorial on the web&#39;</span><span class="p">,</span>
        <span class="s1">&#39;done&#39;</span><span class="p">:</span> <span class="kc">False</span>
    <span class="p">}</span>
<span class="p">]</span>

<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">url_for</span>


<span class="k">def</span> <span class="nf">make_public_task</span><span class="p">(</span><span class="n">task</span><span class="p">):</span>
    <span class="n">new_task</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">task</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">field</span> <span class="o">==</span> <span class="s1">&#39;id&#39;</span><span class="p">:</span>
            <span class="n">new_task</span><span class="p">[</span><span class="s1">&#39;uri&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;get_task&#39;</span><span class="p">,</span> <span class="n">task_id</span><span class="o">=</span><span class="n">task</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">_external</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_task</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">task</span><span class="p">[</span><span class="n">field</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">new_task</span>


<span class="k">class</span> <span class="nc">TaskListAPI</span><span class="p">(</span><span class="n">Resource</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reqparse</span> <span class="o">=</span> <span class="n">reqparse</span><span class="o">.</span><span class="n">RequestParser</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reqparse</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">help</span><span class="o">=</span><span class="s1">&#39;No task title provided&#39;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="s1">&#39;json&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reqparse</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="s1">&#39;json&#39;</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TaskListAPI</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

    <span class="c1"># 检索任务列表</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="c1"># 创建新任务</span>
    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>


<span class="k">class</span> <span class="nc">TaskAPI</span><span class="p">(</span><span class="n">Resource</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reqparse</span> <span class="o">=</span> <span class="n">reqparse</span><span class="o">.</span><span class="n">RequestParser</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reqparse</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="s1">&#39;json&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reqparse</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="s1">&#39;json&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reqparse</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;done&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="s1">&#39;json&#39;</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TaskAPI</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

    <span class="c1"># 检索某个任务</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="c1"># 更新任务</span>
    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="c1"># 删除任务</span>
    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
        <span class="k">pass</span>


<span class="n">api</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span><span class="n">TaskListAPI</span><span class="p">,</span> <span class="s1">&#39;/todo/api/v1.0/tasks&#39;</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="s1">&#39;tasks&#39;</span><span class="p">)</span>
<span class="n">api</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span><span class="n">TaskAPI</span><span class="p">,</span> <span class="s1">&#39;/todo/api/v1.0/tasks/&lt;int:id&gt;&#39;</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="s1">&#39;task&#39;</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s2">&quot;0.0.0.0&quot;</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>在 TaskListAPI 资源中，POST
方法是唯一接收参数的。参数“标题”是必须的，因此我定义一个缺少“标题”的错误信息。当客户端缺少这个参数的时候，Flask-RESTful
将会把这个错误信息作为响应发送给客户端。</p>
<p>“描述”字段是可选的，当缺少这个字段的时候，默认的空字符串将会被使用。</p>
<p>一个有趣的方面就是 RequestParser 类默认情况下在 request.values
中查找参数，因此 location 可选参数必须被设置以表明请求过来的参数是
request.json 格式的。</p>
<p>TaskAPI 资源的参数处理是同样的方式，但是有少许不同。PUT
方法需要解析参数，并且这个方法的所有参数都是可选的。</p>
<p>使用 Flask-RESTful 来处理验证的另一个好处就是没有必要单独地处理类似 HTTP
400 错误，Flask-RESTful 会来处理这些。</p>
</section>
<section id="id46">
<h3><a class="toc-backref" href="#id106">13.4 生成响应</a><a class="headerlink" href="#id46" title="Permalink to this headline">¶</a></h3>
<p>原来设计的 REST 服务器使用 Flask 的 jsonify 函数来生成响应。</p>
<p>Flask-RESTful 会自动地处理转换成 JSON 数据格式，因此下面的代码需要替换:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;tasks&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">make_public_task</span><span class="p">(</span><span class="n">task</span><span class="p">)</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">]})</span>
</pre></div>
</div>
<p>现在需要写成这样:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">return</span> <span class="p">{</span><span class="s1">&#39;task&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">make_public_task</span><span class="p">(</span><span class="n">task</span><span class="p">)</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">]}</span>
</pre></div>
</div>
<p>Flask-RESTful 也支持自定义状态码，如果有必要的话:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">return</span> <span class="p">{</span><span class="s1">&#39;task&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">make_public_task</span><span class="p">(</span><span class="n">task</span><span class="p">)</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">]},</span> <span class="mi">201</span>
</pre></div>
</div>
<p>Flask-RESTful 还有更多的功能。make_public_task
能够把来自原始服务器上的任务从内部形式包装成客户端想要的外部形式。</p>
<p>最典型的就是把任务的 id 转成 uri。</p>
<p>Flask-RESTful 就提供一个辅助函数能够很优雅地做到这样的转换，不仅仅能够把
id 转成 uri 并且能够转换其他的参数:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask.ext.restful</span> <span class="kn">import</span> <span class="n">fields</span><span class="p">,</span> <span class="n">marshal</span>

<span class="n">task_fields</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">fields</span><span class="o">.</span><span class="n">String</span><span class="p">,</span>
    <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">fields</span><span class="o">.</span><span class="n">String</span><span class="p">,</span>
    <span class="s1">&#39;done&#39;</span><span class="p">:</span> <span class="n">fields</span><span class="o">.</span><span class="n">Boolean</span><span class="p">,</span>
    <span class="s1">&#39;uri&#39;</span><span class="p">:</span> <span class="n">fields</span><span class="o">.</span><span class="n">Url</span><span class="p">(</span><span class="s1">&#39;task&#39;</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">class</span> <span class="nc">TaskAPI</span><span class="p">(</span><span class="n">Resource</span><span class="p">):</span>
    <span class="c1"># ...</span>

    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
        <span class="c1"># ...</span>
        <span class="k">return</span> <span class="p">{</span> <span class="s1">&#39;task&#39;</span><span class="p">:</span> <span class="n">marshal</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">task_fields</span><span class="p">)</span> <span class="p">}</span>
</pre></div>
</div>
<p>task_fields 结构用于作为 marshal 函数的模板。fields.Uri
是一个用于生成一个 URL 的特定的参数。</p>
<p>它需要的参数是 endpoint。</p>
<p>完整代码如下：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">abort</span>
<span class="kn">from</span> <span class="nn">flask_restful</span> <span class="kn">import</span> <span class="n">Api</span><span class="p">,</span> <span class="n">Resource</span><span class="p">,</span> <span class="n">reqparse</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">marshal</span>
<span class="kn">from</span> <span class="nn">flask_httpauth</span> <span class="kn">import</span> <span class="n">HTTPBasicAuth</span>

<span class="n">auth</span> <span class="o">=</span> <span class="n">HTTPBasicAuth</span><span class="p">()</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">api</span> <span class="o">=</span> <span class="n">Api</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>

<span class="n">task_fields</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">fields</span><span class="o">.</span><span class="n">String</span><span class="p">,</span>
    <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">fields</span><span class="o">.</span><span class="n">String</span><span class="p">,</span>
    <span class="s1">&#39;done&#39;</span><span class="p">:</span> <span class="n">fields</span><span class="o">.</span><span class="n">Boolean</span><span class="p">,</span>
    <span class="s1">&#39;uri&#39;</span><span class="p">:</span> <span class="n">fields</span><span class="o">.</span><span class="n">Url</span><span class="p">(</span><span class="s1">&#39;task&#39;</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;Buy groceries&#39;</span><span class="p">,</span>
        <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;Milk, Cheese, Pizza, Fruit, Tylenol&#39;</span><span class="p">,</span>
        <span class="s1">&#39;done&#39;</span><span class="p">:</span> <span class="kc">False</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;Learn Python&#39;</span><span class="p">,</span>
        <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;Need to find a good Python tutorial on the web&#39;</span><span class="p">,</span>
        <span class="s1">&#39;done&#39;</span><span class="p">:</span> <span class="kc">False</span>
    <span class="p">}</span>
<span class="p">]</span>


<span class="k">class</span> <span class="nc">TaskListAPI</span><span class="p">(</span><span class="n">Resource</span><span class="p">):</span>
    <span class="c1"># HTTP 基本身份验</span>
    <span class="c1"># decorators = [auth.login_required]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reqparse</span> <span class="o">=</span> <span class="n">reqparse</span><span class="o">.</span><span class="n">RequestParser</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reqparse</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">help</span><span class="o">=</span><span class="s1">&#39;No task title provided&#39;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="s1">&#39;json&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reqparse</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="s1">&#39;json&#39;</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TaskListAPI</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

    <span class="c1"># 检索任务列表</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># return jsonify({&#39;tasks&#39;: [make_public_task(task) for task in tasks]})</span>

        <span class="c1"># 自定义状态码</span>
        <span class="c1"># return {&#39;task&#39;: marshal(tasks, task_fields)}, 201</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;task&#39;</span><span class="p">:</span> <span class="n">marshal</span><span class="p">(</span><span class="n">tasks</span><span class="p">,</span> <span class="n">task_fields</span><span class="p">)}</span>

    <span class="c1"># 创建新任务</span>
    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span> <span class="ow">or</span> <span class="ow">not</span> <span class="s1">&#39;title&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">:</span>
            <span class="n">abort</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span>
        <span class="n">task</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">tasks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">],</span>
            <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
            <span class="s1">&#39;done&#39;</span><span class="p">:</span> <span class="kc">False</span>
        <span class="p">}</span>
        <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;task&#39;</span><span class="p">:</span> <span class="n">marshal</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">task_fields</span><span class="p">)}</span>


<span class="k">class</span> <span class="nc">TaskAPI</span><span class="p">(</span><span class="n">Resource</span><span class="p">):</span>
    <span class="c1"># HTTP 基本身份验</span>
    <span class="c1"># decorators = [auth.login_required]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reqparse</span> <span class="o">=</span> <span class="n">reqparse</span><span class="o">.</span><span class="n">RequestParser</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reqparse</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="s1">&#39;json&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reqparse</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="s1">&#39;json&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reqparse</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;done&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="s1">&#39;json&#39;</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TaskAPI</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

    <span class="c1"># 检索某个任务</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
        <span class="n">task</span> <span class="o">=</span> <span class="p">[</span><span class="n">task</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasks</span> <span class="k">if</span> <span class="n">task</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="nb">id</span><span class="p">]</span>
        <span class="c1"># task = list(filter(lambda t: t[&#39;id&#39;] == task_id, tasks))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">task</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">abort</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;task&#39;</span><span class="p">:</span> <span class="n">marshal</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">task_fields</span><span class="p">)}</span>

    <span class="c1"># 更新任务</span>
    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
        <span class="n">task</span> <span class="o">=</span> <span class="p">[</span><span class="n">task</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasks</span> <span class="k">if</span> <span class="n">task</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="nb">id</span><span class="p">]</span>
        <span class="c1"># task = list(filter(lambda t: t[&#39;id&#39;] == id, tasks))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">task</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">abort</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">task</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># print(task)</span>
        <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reqparse</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">task</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;task&#39;</span><span class="p">:</span> <span class="n">marshal</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">task_fields</span><span class="p">)}</span>
        <span class="c1"># return jsonify({&#39;task&#39;: make_public_task(task)})</span>

    <span class="c1"># 删除任务</span>
    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
        <span class="n">task</span> <span class="o">=</span> <span class="p">[</span><span class="n">task</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasks</span> <span class="k">if</span> <span class="n">task</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="nb">id</span><span class="p">]</span>
        <span class="c1"># task = list(filter(lambda t: t[&#39;id&#39;] == id, tasks))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">task</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">abort</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
        <span class="n">tasks</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">task</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>


<span class="n">api</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span><span class="n">TaskListAPI</span><span class="p">,</span> <span class="s1">&#39;/todo/api/v1.0/tasks&#39;</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="s1">&#39;tasks&#39;</span><span class="p">)</span>
<span class="n">api</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span><span class="n">TaskAPI</span><span class="p">,</span> <span class="s1">&#39;/todo/api/v1.0/tasks/&lt;int:id&gt;&#39;</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="s1">&#39;task&#39;</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s2">&quot;0.0.0.0&quot;</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>调用 curl 请求的结果如下:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># 检索任务列表</span>
$ curl -i http://localhost:5000/todo/api/v1.0/tasks
HTTP/1.1 <span class="m">200</span> OK
Server: Werkzeug/2.2.2 Python/3.8.8
Date: Mon, <span class="m">05</span> Sep <span class="m">2022</span> <span class="m">08</span>:56:25 GMT
Content-Type: application/json
Content-Length: <span class="m">425</span>
Connection: close

<span class="o">{</span>
    <span class="s2">&quot;task&quot;</span>: <span class="o">[</span>
        <span class="o">{</span>
            <span class="s2">&quot;title&quot;</span>: <span class="s2">&quot;Buy groceries&quot;</span>,
            <span class="s2">&quot;description&quot;</span>: <span class="s2">&quot;Milk, Cheese, Pizza, Fruit, Tylenol&quot;</span>,
            <span class="s2">&quot;done&quot;</span>: false,
            <span class="s2">&quot;uri&quot;</span>: <span class="s2">&quot;/todo/api/v1.0/tasks/1&quot;</span>
        <span class="o">}</span>,
        <span class="o">{</span>
            <span class="s2">&quot;title&quot;</span>: <span class="s2">&quot;Learn Python&quot;</span>,
            <span class="s2">&quot;description&quot;</span>: <span class="s2">&quot;Need to find a good Python tutorial on the web&quot;</span>,
            <span class="s2">&quot;done&quot;</span>: false,
            <span class="s2">&quot;uri&quot;</span>: <span class="s2">&quot;/todo/api/v1.0/tasks/2&quot;</span>
        <span class="o">}</span>
    <span class="o">]</span>
<span class="o">}</span>



<span class="c1"># 创建新任务</span>
$ curl -i -H <span class="s2">&quot;Content-Type: application/json&quot;</span> -X POST -d <span class="s1">&#39;{&quot;title&quot;:&quot;Read a book&quot;}&#39;</span> http://localhost:5000/todo/api/v1.0/tasks
HTTP/1.1 <span class="m">200</span> OK
Server: Werkzeug/2.2.2 Python/3.8.8
Date: Mon, <span class="m">05</span> Sep <span class="m">2022</span> <span class="m">08</span>:56:44 GMT
Content-Type: application/json
Content-Length: <span class="m">146</span>
Connection: close

<span class="o">{</span>
    <span class="s2">&quot;task&quot;</span>: <span class="o">{</span>
        <span class="s2">&quot;title&quot;</span>: <span class="s2">&quot;Read a book&quot;</span>,
        <span class="s2">&quot;description&quot;</span>: <span class="s2">&quot;&quot;</span>,
        <span class="s2">&quot;done&quot;</span>: false,
        <span class="s2">&quot;uri&quot;</span>: <span class="s2">&quot;/todo/api/v1.0/tasks/3&quot;</span>
    <span class="o">}</span>
<span class="o">}</span>



<span class="c1"># 检索某个任务</span>
$ curl -i http://localhost:5000/todo/api/v1.0/tasks/1
HTTP/1.1 <span class="m">200</span> OK
Server: Werkzeug/2.2.2 Python/3.8.8
Date: Mon, <span class="m">05</span> Sep <span class="m">2022</span> <span class="m">08</span>:57:03 GMT
Content-Type: application/json
Content-Length: <span class="m">219</span>
Connection: close

<span class="o">{</span>
    <span class="s2">&quot;task&quot;</span>: <span class="o">[</span>
        <span class="o">{</span>
            <span class="s2">&quot;title&quot;</span>: <span class="s2">&quot;Buy groceries&quot;</span>,
            <span class="s2">&quot;description&quot;</span>: <span class="s2">&quot;Milk, Cheese, Pizza, Fruit, Tylenol&quot;</span>,
            <span class="s2">&quot;done&quot;</span>: false,
            <span class="s2">&quot;uri&quot;</span>: <span class="s2">&quot;/todo/api/v1.0/tasks/1&quot;</span>
        <span class="o">}</span>
    <span class="o">]</span>
<span class="o">}</span>

<span class="c1"># 更新任务</span>
$ curl -i -H <span class="s2">&quot;Content-Type: application/json&quot;</span> -X PUT -d <span class="s1">&#39;{&quot;done&quot;:true}&#39;</span> http://localhost:5000/todo/api/v1.0/tasks/2
HTTP/1.1 <span class="m">200</span> OK
Server: Werkzeug/2.2.2 Python/3.8.8
Date: Mon, <span class="m">05</span> Sep <span class="m">2022</span> <span class="m">09</span>:15:12 GMT
Content-Type: application/json
Content-Length: <span class="m">192</span>
Connection: close

<span class="o">{</span>
    <span class="s2">&quot;task&quot;</span>: <span class="o">{</span>
        <span class="s2">&quot;title&quot;</span>: <span class="s2">&quot;Learn Python&quot;</span>,
        <span class="s2">&quot;description&quot;</span>: <span class="s2">&quot;Need to find a good Python tutorial on the web&quot;</span>,
        <span class="s2">&quot;done&quot;</span>: true,
        <span class="s2">&quot;uri&quot;</span>: <span class="s2">&quot;/todo/api/v1.0/tasks/2&quot;</span>
    <span class="o">}</span>
<span class="o">}</span>


<span class="c1"># 删除任务</span>
$ curl -i -X DELETE http://localhost:5000/todo/api/v1.0/tasks/3
HTTP/1.1 <span class="m">200</span> OK
Server: Werkzeug/2.2.2 Python/3.8.8
Date: Mon, <span class="m">05</span> Sep <span class="m">2022</span> <span class="m">09</span>:17:30 GMT
Content-Type: application/json
Content-Length: <span class="m">23</span>
Connection: close

<span class="o">{</span>
    <span class="s2">&quot;result&quot;</span>: <span class="nb">true</span>
<span class="o">}</span>
</pre></div>
</div>
</section>
<section id="id47">
<h3><a class="toc-backref" href="#id107">13.5 认证</a><a class="headerlink" href="#id47" title="Permalink to this headline">¶</a></h3>
<p>在 REST 服务器中的路由都是由 HTTP
基本身份验证保护着。在最初的那个服务器是通过使用 Flask-HTTPAuth
扩展来实现的。</p>
<p>因为 Resouce 类是继承自 Flask 的 MethodView，它能够通过定义 decorators
变量并且把装饰器赋予给它:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask.ext.httpauth</span> <span class="kn">import</span> <span class="n">HTTPBasicAuth</span>
<span class="c1"># ...</span>
<span class="n">auth</span> <span class="o">=</span> <span class="n">HTTPBasicAuth</span><span class="p">()</span>
<span class="c1"># ...</span>

<span class="k">class</span> <span class="nc">TaskAPI</span><span class="p">(</span><span class="n">Resource</span><span class="p">):</span>
    <span class="c1"># HTTP 基本身份验</span>
    <span class="n">decorators</span> <span class="o">=</span> <span class="p">[</span><span class="n">auth</span><span class="o">.</span><span class="n">login_required</span><span class="p">]</span>
    <span class="c1"># ...</span>

<span class="k">class</span> <span class="nc">TaskAPI</span><span class="p">(</span><span class="n">Resource</span><span class="p">):</span>
    <span class="c1"># HTTP 基本身份验</span>
    <span class="n">decorators</span> <span class="o">=</span> <span class="p">[</span><span class="n">auth</span><span class="o">.</span><span class="n">login_required</span><span class="p">]</span>
    <span class="c1"># ...</span>
</pre></div>
</div>
</section>
<section id="id48">
<h3><a class="toc-backref" href="#id108">13.6 在flask-restful中添加日志</a><a class="headerlink" href="#id48" title="Permalink to this headline">¶</a></h3>
<p>在<code class="docutils literal notranslate"><span class="pre">flask-restful</span></code>中，<code class="docutils literal notranslate"><span class="pre">logger</span></code>的使用有更优雅的方式，来看示例</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">abort</span>
<span class="kn">from</span> <span class="nn">flask_restful</span> <span class="kn">import</span> <span class="n">Api</span><span class="p">,</span> <span class="n">Resource</span><span class="p">,</span> <span class="n">reqparse</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">marshal</span>
<span class="kn">from</span> <span class="nn">flask_httpauth</span> <span class="kn">import</span> <span class="n">HTTPBasicAuth</span>
<span class="kn">import</span> <span class="nn">logging.config</span>

<span class="n">logging</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">dictConfig</span><span class="p">(</span>
    <span class="p">{</span>
        <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s2">&quot;disable_existing_loggers&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;formatters&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;simple&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;format&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">%(asctime)s</span><span class="s2"> - </span><span class="si">%(name)s</span><span class="s2"> - </span><span class="si">%(levelname)s</span><span class="s2"> - </span><span class="si">%(message)s</span><span class="s2">&quot;</span><span class="p">}</span>
        <span class="p">},</span>
        <span class="s2">&quot;handlers&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;console&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;class&quot;</span><span class="p">:</span> <span class="s2">&quot;logging.StreamHandler&quot;</span><span class="p">,</span>
                <span class="s2">&quot;level&quot;</span><span class="p">:</span> <span class="s2">&quot;DEBUG&quot;</span><span class="p">,</span>
                <span class="s2">&quot;formatter&quot;</span><span class="p">:</span> <span class="s2">&quot;simple&quot;</span><span class="p">,</span>
                <span class="s2">&quot;stream&quot;</span><span class="p">:</span> <span class="s2">&quot;ext://sys.stdout&quot;</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s2">&quot;info_file_handler&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;class&quot;</span><span class="p">:</span> <span class="s2">&quot;logging.handlers.RotatingFileHandler&quot;</span><span class="p">,</span>
                <span class="s2">&quot;level&quot;</span><span class="p">:</span> <span class="s2">&quot;INFO&quot;</span><span class="p">,</span>
                <span class="s2">&quot;formatter&quot;</span><span class="p">:</span> <span class="s2">&quot;simple&quot;</span><span class="p">,</span>
                <span class="s2">&quot;filename&quot;</span><span class="p">:</span> <span class="s2">&quot;info.log&quot;</span><span class="p">,</span>
                <span class="s2">&quot;maxBytes&quot;</span><span class="p">:</span> <span class="mi">10485760</span><span class="p">,</span>
                <span class="s2">&quot;backupCount&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
                <span class="s2">&quot;encoding&quot;</span><span class="p">:</span> <span class="s2">&quot;utf8&quot;</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s2">&quot;error_file_handler&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;class&quot;</span><span class="p">:</span> <span class="s2">&quot;logging.handlers.RotatingFileHandler&quot;</span><span class="p">,</span>
                <span class="s2">&quot;level&quot;</span><span class="p">:</span> <span class="s2">&quot;ERROR&quot;</span><span class="p">,</span>
                <span class="s2">&quot;formatter&quot;</span><span class="p">:</span> <span class="s2">&quot;simple&quot;</span><span class="p">,</span>
                <span class="s2">&quot;filename&quot;</span><span class="p">:</span> <span class="s2">&quot;errors.log&quot;</span><span class="p">,</span>
                <span class="s2">&quot;maxBytes&quot;</span><span class="p">:</span> <span class="mi">10485760</span><span class="p">,</span>
                <span class="s2">&quot;backupCount&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
                <span class="s2">&quot;encoding&quot;</span><span class="p">:</span> <span class="s2">&quot;utf8&quot;</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s2">&quot;debug_file_handler&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;class&quot;</span><span class="p">:</span> <span class="s2">&quot;logging.handlers.RotatingFileHandler&quot;</span><span class="p">,</span>
                <span class="s2">&quot;level&quot;</span><span class="p">:</span> <span class="s2">&quot;DEBUG&quot;</span><span class="p">,</span>
                <span class="s2">&quot;formatter&quot;</span><span class="p">:</span> <span class="s2">&quot;simple&quot;</span><span class="p">,</span>
                <span class="s2">&quot;filename&quot;</span><span class="p">:</span> <span class="s2">&quot;debug.log&quot;</span><span class="p">,</span>
                <span class="s2">&quot;maxBytes&quot;</span><span class="p">:</span> <span class="mi">10485760</span><span class="p">,</span>
                <span class="s2">&quot;backupCount&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
                <span class="s2">&quot;encoding&quot;</span><span class="p">:</span> <span class="s2">&quot;utf8&quot;</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">},</span>
        <span class="s2">&quot;loggers&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;my_module&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;level&quot;</span><span class="p">:</span> <span class="s2">&quot;ERROR&quot;</span><span class="p">,</span> <span class="s2">&quot;handlers&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;console&quot;</span><span class="p">],</span> <span class="s2">&quot;propagate&quot;</span><span class="p">:</span> <span class="s2">&quot;no&quot;</span><span class="p">}</span>
        <span class="p">},</span>
        <span class="s2">&quot;root&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;level&quot;</span><span class="p">:</span> <span class="s2">&quot;DEBUG&quot;</span><span class="p">,</span>
            <span class="s2">&quot;handlers&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;error_file_handler&quot;</span><span class="p">,</span> <span class="s2">&quot;debug_file_handler&quot;</span><span class="p">],</span>
        <span class="p">},</span>
    <span class="p">}</span>
<span class="p">)</span>

<span class="n">auth</span> <span class="o">=</span> <span class="n">HTTPBasicAuth</span><span class="p">()</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">api</span> <span class="o">=</span> <span class="n">Api</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">default_mediatype</span><span class="o">=</span><span class="s2">&quot;application/json&quot;</span><span class="p">)</span>

<span class="n">task_fields</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">fields</span><span class="o">.</span><span class="n">String</span><span class="p">,</span>
    <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">fields</span><span class="o">.</span><span class="n">String</span><span class="p">,</span>
    <span class="s1">&#39;done&#39;</span><span class="p">:</span> <span class="n">fields</span><span class="o">.</span><span class="n">Boolean</span><span class="p">,</span>
    <span class="s1">&#39;uri&#39;</span><span class="p">:</span> <span class="n">fields</span><span class="o">.</span><span class="n">Url</span><span class="p">(</span><span class="s1">&#39;task&#39;</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;Buy groceries&#39;</span><span class="p">,</span>
        <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;Milk, Cheese, Pizza, Fruit, Tylenol&#39;</span><span class="p">,</span>
        <span class="s1">&#39;done&#39;</span><span class="p">:</span> <span class="kc">False</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;Learn Python&#39;</span><span class="p">,</span>
        <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;Need to find a good Python tutorial on the web&#39;</span><span class="p">,</span>
        <span class="s1">&#39;done&#39;</span><span class="p">:</span> <span class="kc">False</span>
    <span class="p">}</span>
<span class="p">]</span>


<span class="k">class</span> <span class="nc">TaskListAPI</span><span class="p">(</span><span class="n">Resource</span><span class="p">):</span>
    <span class="c1"># HTTP 基本身份验</span>
    <span class="c1"># decorators = [auth.login_required]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">kargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;logger&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reqparse</span> <span class="o">=</span> <span class="n">reqparse</span><span class="o">.</span><span class="n">RequestParser</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reqparse</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;No task title provided&#39;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="s1">&#39;json&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reqparse</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="s1">&#39;json&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reqparse</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TaskListAPI</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

    <span class="c1"># 检索任务列表</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># return jsonify({&#39;tasks&#39;: [make_public_task(task) for task in tasks]})</span>

        <span class="c1"># 自定义状态码</span>
        <span class="c1"># return {&#39;task&#39;: marshal(tasks, task_fields)}, 201</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;task&#39;</span><span class="p">:</span> <span class="n">marshal</span><span class="p">(</span><span class="n">tasks</span><span class="p">,</span> <span class="n">task_fields</span><span class="p">)}</span>

    <span class="c1"># 创建新任务</span>
    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span> <span class="ow">or</span> <span class="ow">not</span> <span class="s1">&#39;title&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">:</span>
            <span class="n">abort</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span>
        <span class="n">task</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">tasks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">],</span>
            <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
            <span class="s1">&#39;done&#39;</span><span class="p">:</span> <span class="kc">False</span>
        <span class="p">}</span>
        <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;task&#39;</span><span class="p">:</span> <span class="n">marshal</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">task_fields</span><span class="p">)}</span>


<span class="k">class</span> <span class="nc">TaskAPI</span><span class="p">(</span><span class="n">Resource</span><span class="p">):</span>
    <span class="c1"># HTTP 基本身份验</span>
    <span class="c1"># decorators = [auth.login_required]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">kargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;logger&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reqparse</span> <span class="o">=</span> <span class="n">reqparse</span><span class="o">.</span><span class="n">RequestParser</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reqparse</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="s1">&#39;json&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reqparse</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="s1">&#39;json&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reqparse</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;done&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="s1">&#39;json&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reqparse</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TaskAPI</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

    <span class="c1"># 检索某个任务</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
        <span class="n">task</span> <span class="o">=</span> <span class="p">[</span><span class="n">task</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasks</span> <span class="k">if</span> <span class="n">task</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="nb">id</span><span class="p">]</span>
        <span class="c1"># task = list(filter(lambda t: t[&#39;id&#39;] == task_id, tasks))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">task</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">abort</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;task&#39;</span><span class="p">:</span> <span class="n">marshal</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">task_fields</span><span class="p">)}</span>

    <span class="c1"># 更新任务</span>
    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
        <span class="n">task</span> <span class="o">=</span> <span class="p">[</span><span class="n">task</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasks</span> <span class="k">if</span> <span class="n">task</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="nb">id</span><span class="p">]</span>
        <span class="c1"># task = list(filter(lambda t: t[&#39;id&#39;] == id, tasks))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">task</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">abort</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">task</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># print(task)</span>
        <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reqparse</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">task</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;task&#39;</span><span class="p">:</span> <span class="n">marshal</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">task_fields</span><span class="p">)}</span>
        <span class="c1"># return jsonify({&#39;task&#39;: make_public_task(task)})</span>

    <span class="c1"># 删除任务</span>
    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
        <span class="n">task</span> <span class="o">=</span> <span class="p">[</span><span class="n">task</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasks</span> <span class="k">if</span> <span class="n">task</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="nb">id</span><span class="p">]</span>
        <span class="c1"># task = list(filter(lambda t: t[&#39;id&#39;] == id, tasks))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">task</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">abort</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
        <span class="n">tasks</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">task</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>


<span class="n">api</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span><span class="n">TaskListAPI</span><span class="p">,</span> <span class="s1">&#39;/todo/api/v1.0/tasks&#39;</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="s1">&#39;tasks&#39;</span><span class="p">,</span>
                 <span class="n">resource_class_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;logger&quot;</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;/TaskListAPI&#39;</span><span class="p">)})</span>

<span class="n">api</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span><span class="n">TaskAPI</span><span class="p">,</span> <span class="s1">&#39;/todo/api/v1.0/tasks/&lt;int:id&gt;&#39;</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="s1">&#39;task&#39;</span><span class="p">,</span>
                 <span class="n">resource_class_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;logger&quot;</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;/TaskAPI&#39;</span><span class="p">)})</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s1">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span> <span class="n">use_reloader</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>我们使用上次用到的<code class="docutils literal notranslate"><span class="pre">dictConfig</span></code>，</p>
<p>主要的区别在于<code class="docutils literal notranslate"><span class="pre">api.add_resource()</span></code>方法中，使用了参数<code class="docutils literal notranslate"><span class="pre">resource_class_kwargs</span></code>，然后在<code class="docutils literal notranslate"><span class="pre">Resource</span></code>子类中的构造函数<code class="docutils literal notranslate"><span class="pre">__init__</span></code>，将日志记录器获取到，后面就可以在各个处理方法中使用了。</p>
<p>再次使用<code class="docutils literal notranslate"><span class="pre">postman</span></code>发起<code class="docutils literal notranslate"><span class="pre">POST</span></code>请求，可以看到<code class="docutils literal notranslate"><span class="pre">debug.log</span></code>是这个样子的</p>
<img alt="../../../_images/image-20220905175349613.png" src="../../../_images/image-20220905175349613.png" />
<p>参考文献：</p>
<p><a class="reference external" href="https://www.yuque.com/keep_running/python/hyegx6#iiVXa">https://www.yuque.com/keep_running/python/hyegx6#iiVXa</a></p>
<p><a class="reference external" href="https://blog.csdn.net/djstavaV/article/details/112261872">https://blog.csdn.net/djstavaV/article/details/112261872</a></p>
</section>
<section id="id49">
<h3><a class="toc-backref" href="#id109">13.7 使用 Flask 设计 RESTful 的认证</a><a class="headerlink" href="#id49" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="http://www.pythondoc.com/flask-restful/third.html">http://www.pythondoc.com/flask-restful/third.html</a></p>
<p>使用Flask设计带认证token的RESTful API接口</p>
<p><a class="reference external" href="https://www.cnblogs.com/vovlie/p/4182814.html">https://www.cnblogs.com/vovlie/p/4182814.html</a></p>
<p>参考demo</p>
<p><a class="reference external" href="https://www.bookstack.cn/read/flask-restful/spilt.1.dc04892e18a3e9e6.md">https://www.bookstack.cn/read/flask-restful/spilt.1.dc04892e18a3e9e6.md</a></p>
<p><a class="reference external" href="https://gitee.com/hujianli94net/flask-rest-auth-demo">https://gitee.com/hujianli94net/flask-rest-auth-demo</a></p>
</section>
</section>
<section id="flask-pyjwt-jwt">
<h2><a class="toc-backref" href="#id110">14.Flask + PyJWT 实现基于JWT的用户认证授权</a><a class="headerlink" href="#flask-pyjwt-jwt" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://blog.csdn.net/yilovexing/article/details/104010890">https://blog.csdn.net/yilovexing/article/details/104010890</a></p>
<p><a class="reference external" href="https://www.yuque.com/keep_running/python/fnlswf">https://www.yuque.com/keep_running/python/fnlswf</a></p>
</section>
<section id="id50">
<h2><a class="toc-backref" href="#id111">15.跨域访问</a><a class="headerlink" href="#id50" title="Permalink to this headline">¶</a></h2>
<section id="id51">
<h3><a class="toc-backref" href="#id112">15.1 什么是跨域？</a><a class="headerlink" href="#id51" title="Permalink to this headline">¶</a></h3>
<p>跨域是指，浏览器从服务器<code class="docutils literal notranslate"><span class="pre">A</span></code>获取的静态资源，包括<code class="docutils literal notranslate"><span class="pre">html</span></code>、<code class="docutils literal notranslate"><span class="pre">css</span></code>、<code class="docutils literal notranslate"><span class="pre">javascript</span></code>，然后在<code class="docutils literal notranslate"><span class="pre">javascript</span></code>中通过<code class="docutils literal notranslate"><span class="pre">ajax</span></code>访问服务器<code class="docutils literal notranslate"><span class="pre">B</span></code>的静态资源或请求。</p>
</section>
<section id="cors">
<h3><a class="toc-backref" href="#id113">15.2 CORS</a><a class="headerlink" href="#cors" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">w3c</span></code>组织制定了
<code class="docutils literal notranslate"><span class="pre">[Cross</span> <span class="pre">Origin</span> <span class="pre">Resource</span> <span class="pre">Sharing](https://www.w3.org/TR/cors/)</span></code>
的规范，简写为<code class="docutils literal notranslate"><span class="pre">CORS</span></code>，现在这个规范已经被大多数浏览器支持。</p>
<p>使用上面的示例</p>
<p>前端页面<code class="docutils literal notranslate"><span class="pre">index.html</span></code></p>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">button</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;button&quot;</span> <span class="na">onclick</span><span class="o">=</span><span class="s">&quot;jump()&quot;</span><span class="p">&gt;</span>Click Me!<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
    <span class="kd">function</span> <span class="nx">jump</span><span class="p">(){</span>
        <span class="kd">let</span> <span class="nx">xhr</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">();</span>
        <span class="nx">xhr</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s2">&quot;http://172.16.3.134:5000/todo/api/v1.0/tasks&quot;</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
        <span class="nx">xhr</span><span class="p">.</span><span class="nx">send</span><span class="p">();</span>
        <span class="nx">xhr</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="nx">processRequest</span><span class="p">;</span>
        <span class="kd">function</span> <span class="nx">processRequest</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">==</span> <span class="mf">4</span> <span class="o">&amp;&amp;</span> <span class="nx">xhr</span><span class="p">.</span><span class="nx">status</span> <span class="o">==</span> <span class="mf">200</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">let</span> <span class="nx">response</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">responseText</span><span class="p">);</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</pre></div>
</div>
<p>我们将<code class="docutils literal notranslate"><span class="pre">index.html</span></code>部署在一台机器上(172.16.3.134)，<code class="docutils literal notranslate"><span class="pre">flask</span></code>应用部署在另一台机器上(172.16.3.134)，然后在浏览器中访问<code class="docutils literal notranslate"><span class="pre">index.html</span></code>，点击页面中的按钮，这时候就会报错了</p>
<img alt="../../../_images/image-20220905175806809.png" src="../../../_images/image-20220905175806809.png" />
</section>
<section id="flaskcors">
<h3><a class="toc-backref" href="#id114">15.3 Flask配置cors</a><a class="headerlink" href="#flaskcors" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">CORS</span></code>需要在后端应用中进行配置。在<code class="docutils literal notranslate"><span class="pre">flask</span></code>中，可以使用扩展<code class="docutils literal notranslate"><span class="pre">flask-cors</span></code>，首先安装</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ pip install flask-cors
</pre></div>
</div>
<p>接下来来到<code class="docutils literal notranslate"><span class="pre">app.py</span></code>，导入模块，并将<code class="docutils literal notranslate"><span class="pre">flask</span></code>应用包括起来就可以了，如下</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask_cors</span> <span class="kn">import</span> <span class="n">CORS</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">CORS</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
</pre></div>
</div>
<p>重新启动应用，再次访问<code class="docutils literal notranslate"><span class="pre">index.html</span></code>，这时候，返回的结果就正常了</p>
<img alt="../../../_images/image-20220905180049136.png" src="../../../_images/image-20220905180049136.png" />
</section>
</section>
<section id="id52">
<h2><a class="toc-backref" href="#id115">16.网站部署</a><a class="headerlink" href="#id52" title="Permalink to this headline">¶</a></h2>
<p>Flask自带的Web服务器是轻量级服务器，以方便程序员开发和调试。但是在实际部署的时候，却不能直接用Flask发布应用，因为Flask自带的Web服务器还不够强壮，无法在生产环境中使用，还需要Web服务和WSGI（Web服务网关接口）。</p>
<p>本章主要涉及的知识点有：</p>
<ul class="simple">
<li><p>Nginx+Gunicorn+Flask服务器的部署方法。</p></li>
<li><p>需求文件requirements.txt的创建和使用方法。</p></li>
</ul>
<section id="id53">
<h3><a class="toc-backref" href="#id116">16.1 服务器部署</a><a class="headerlink" href="#id53" title="Permalink to this headline">¶</a></h3>
<p>服务器部署方案主要有Nginx+Gunicorn+Flask或Nginx+uwsgi+Flask两种方案。</p>
<p>由于Nginx+uwsgi+Flask方案可能存在内存泄漏（内存占用无限增加）以及uwsgi中设置配置文件比较烦琐等问题，因此推荐使用Nginx+Gunicorn+Flask方案。</p>
<p>这里使用Gunicorn作为应用服务器，Nginx作为反向代理服务器。</p>
<p>常用的WSGI容器有Gunicorn和uWSGI，但Gunicorn直接用命令启动，不需要编写配置文件，相对uWSGI要容易很多，所以这里推荐使用Gunicorn作为容器。</p>
<p>参考文献</p>
<p><a class="reference external" href="https://www.cnblogs.com/Ray-liang/p/4837850.html">https://www.cnblogs.com/Ray-liang/p/4837850.html</a></p>
<p><a class="reference external" href="https://www.vuln.cn/8832">https://www.vuln.cn/8832</a></p>
<p>How To Serve Flask Applications with Gunicorn and Nginx on Ubuntu 20.04</p>
<p><a class="reference external" href="https://www.digitalocean.com/community/tutorials/how-to-serve-flask-applications-with-gunicorn-and-nginx-on-ubuntu-20-04">https://www.digitalocean.com/community/tutorials/how-to-serve-flask-applications-with-gunicorn-and-nginx-on-ubuntu-20-04</a></p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="02.%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87.html" class="btn btn-neutral float-left" title="23.6.2. 开发环境准备" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../07.Python-Django-Web%E5%85%B8%E5%9E%8B%E6%A8%A1%E5%9D%97%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98/index.html" class="btn btn-neutral float-right" title="23.7. Python-Django-Web典型模块开发实战" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019, huxiaojian.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>