<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>23.6.3. Flask &mdash; 运维开发修炼之路</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="23.7. Python-Django-Web典型模块开发实战" href="../07.Python-Django-Web%E5%85%B8%E5%9E%8B%E6%A8%A1%E5%9D%97%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98/index.html" />
    <link rel="prev" title="23.6.2. 开发环境准备" href="02.%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> 小健_Python_go_Devops
            <img src="../../../_static/python_go.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                2.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../Go/index.html">Go语言学习</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Go_vs_Python/index.html">Go vs Python</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../index.html">Python全栈系列</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../01.Python%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/index.html">1. Python数据类型</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../02.Python%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6%E8%AF%AD%E5%8F%A5/index.html">2. Python流程控制语句</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../03.Python%E5%87%BD%E6%95%B0/index.html">3. Python函数</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../04.Python%E5%86%85%E5%BB%BA%E5%87%BD%E6%95%B0/index.html">4. Python内建函数</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../05.Python%E6%8E%A8%E5%AF%BC%E5%BC%8F%E5%AD%A6%E4%B9%A0/index.html">5. Python推导式学习</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../06.Python%E8%BF%AD%E4%BB%A3%E5%99%A8_%E7%94%9F%E6%88%90%E5%99%A8_%E8%A3%85%E9%A5%B0%E5%99%A8/index.html">6. Python生成器、迭代器、装饰器</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../07.Python%E9%9D%A2%E5%AF%B9%E5%AF%B9%E8%B1%A1%E8%AE%BE%E8%AE%A1_OOP/index.html">7. Python面对对象设计_OOP</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../08.Python%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86/index.html">8. Python异常处理</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../09.Python%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C/index.html">9. Python文件操作</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../10.Python%E4%B8%AD%E7%9A%84%E5%8C%85%E5%92%8C%E6%A8%A1%E5%9D%97/index.html">10. Python中包和模块</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../11.Python%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/index.html">11. Python正则表达式</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../12.Python%E6%A0%87%E5%87%86%E5%BA%93/index.html">12. Python 标准库学习</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../13.Python%E6%93%8D%E4%BD%9C%E6%95%B0%E6%8D%AE%E5%BA%93/index.html">13. Python对数据库的操作</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../14.Python%E4%B8%89%E6%96%B9%E5%BA%93/index.html">14. Python 三方库学习</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../15.Python%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/index.html">15. Python 网络编程</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../16.Python%E7%BA%BF%E7%A8%8B%E5%92%8C%E8%BF%9B%E7%A8%8B/index.html">16. Python 进程和线程</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../17.Python%E8%AF%AD%E8%A8%80%E7%9A%84%E6%89%A9%E5%B1%95%E4%B8%8E%E5%B5%8C%E5%85%A5/index.html">17. Python与C语言扩展</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../18.%E7%B3%BB%E7%BB%9F%E7%AE%A1%E7%90%86%E5%91%98%E7%9A%84Python%E8%84%9A%E6%9C%AC%E7%BC%96%E7%A8%8B%E6%8C%87%E5%8D%97-%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/index.html">18. 系统管理员的Python脚本编程指南-读书笔记</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../20.Python%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/index.html">19. Python自动化运维最佳实践</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../21.Python%E8%BF%9B%E9%98%B6%E5%AD%A6%E4%B9%A0/index.html">20. Python进阶学习</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../22.Python%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB/index.html">21. Python网络爬虫</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../23.%E5%89%8D%E7%AB%AF%E6%8A%80%E6%9C%AF/index.html">22. 前端基础知识</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html">23. Python框架</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../01.%E5%B8%B8%E7%94%A8%E7%9A%84GUI%E6%A1%86%E6%9E%B6/index.html">23.1. 常用的GUI框架</a></li>
<li class="toctree-l3"><a class="reference internal" href="../02.Flask/index.html">23.2. Flask</a></li>
<li class="toctree-l3"><a class="reference internal" href="../03.Scrapy/index.html">23.3. Scrapy</a></li>
<li class="toctree-l3"><a class="reference internal" href="../04.Django/index.html">23.4. Django</a></li>
<li class="toctree-l3"><a class="reference internal" href="../05.Tornado/index.html">23.5. Tornado</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="index.html">23.6. Python高效开发实战-Django、Flask</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="01.%E6%95%B0%E6%8D%AE%E5%BA%93%E5%8F%8AORM.html">23.6.1. 数据库及ORM</a></li>
<li class="toctree-l4"><a class="reference internal" href="02.%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87.html">23.6.2. 开发环境准备</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">23.6.3. Flask</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../07.Python-Django-Web%E5%85%B8%E5%9E%8B%E6%A8%A1%E5%9D%97%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98/index.html">23.7. Python-Django-Web典型模块开发实战</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../25.Python%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2/index.html">24. Python开发环境部署</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../26.%E6%88%91%E7%9A%84%E7%AC%AC%E4%B8%80%E6%9C%AC%E7%AE%97%E6%B3%95%E4%B9%A6/index.html">25. 我的第一本算法书</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../27.Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98/index.html">26. Python3网络爬虫开发实战</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../28.Python%E8%AE%A9%E7%B9%81%E7%90%90%E7%9A%84%E5%B7%A5%E4%BD%9C%E8%87%AA%E5%8A%A8%E5%8C%96/index.html">27. Python让繁琐的工作自动化</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../29.%E7%96%AF%E7%8B%82%E7%9A%84Python%E8%AE%B2%E4%B9%89/index.html">28. 疯狂的Python讲义</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../30.Django_Vue/index.html">29. Django_Vue</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../31.%E7%BC%96%E5%86%99Python%E7%9A%8490%E4%B8%AA%E6%9C%89%E6%95%88%E6%96%B9%E6%B3%95/index.html">30. 编写Python的90个有效方法</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../32.Vue3.0%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F/index.html">31. Vue3.0管理系统</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../Python%E6%B5%8B%E8%AF%95%E5%BC%80%E5%8F%91%E5%85%A5%E9%97%A8%E4%B8%8E%E5%AE%9E%E8%B7%B5/index.html">Python测试开发入门与实践</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Vue/index.html">Vue.js企业开发实战</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Vue_Node.js/index.html">Vue.js+Node.js开发实战</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">小健_Python_go_Devops</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../index.html">Python全栈系列</a> &raquo;</li>
          <li><a href="../index.html"><span class="section-number">23. </span>Python框架</a> &raquo;</li>
          <li><a href="index.html"><span class="section-number">23.6. </span>Python高效开发实战-Django、Flask</a> &raquo;</li>
      <li><span class="section-number">23.6.3. </span>Flask</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../_sources/Python/24.Python框架/06.Python高效开发实战-Django-Flask/03.Flask.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="contents topic" id="contents">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#flask" id="id24">Flask</a></p>
<ul>
<li><p><a class="reference internal" href="#id1" id="id25">1.Flask综述</a></p></li>
<li><p><a class="reference internal" href="#flask-api" id="id26">2.实战演练:开发Flask API视图</a></p>
<ul>
<li><p><a class="reference internal" href="#hello-world" id="id27">1.Hello World程序</a></p></li>
<li><p><a class="reference internal" href="#id2" id="id28">2.模板渲染</a></p></li>
<li><p><a class="reference internal" href="#fbvcbv" id="id29">4. FBV与CBV</a></p></li>
<li><p><a class="reference internal" href="#id4" id="id30">3.路由详解</a></p></li>
<li><p><a class="reference internal" href="#id9" id="id31">4.静态文件</a></p></li>
<li><p><a class="reference internal" href="#jinja2" id="id32">5.使用 Jinja2 模板引擎</a></p></li>
<li><p><a class="reference internal" href="#id10" id="id33">6.请求、重定向及会话</a></p></li>
<li><p><a class="reference internal" href="#id12" id="id34">7.蓝图</a></p></li>
<li><p><a class="reference internal" href="#cookie" id="id35">8.cookie</a></p></li>
<li><p><a class="reference internal" href="#id13" id="id36">9.session</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#python-flaskrestful-apis" id="id37">3.使用Python和 Flask设计RESTful APIs</a></p>
<ul>
<li><p><a class="reference internal" href="#restful-web-service" id="id38">1.什么是一个 RESTful 的 web service？</a></p></li>
<li><p><a class="reference internal" href="#web-service" id="id39">2.设计一个简单的 web service</a></p></li>
<li><p><a class="reference internal" href="#python-flaskrestful-services" id="id40">3.使用Python和 Flask实现RESTful services</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#flask-restfulrestful-api" id="id41">4.使用Flask-RESTful设计RESTful API</a></p>
<ul>
<li><p><a class="reference internal" href="#restful" id="id42">1.RESTful 服务器</a></p></li>
<li><p><a class="reference internal" href="#id17" id="id43">2.路由</a></p></li>
<li><p><a class="reference internal" href="#id18" id="id44">3.解析以及验证请求</a></p></li>
<li><p><a class="reference internal" href="#id19" id="id45">4.生成响应</a></p></li>
<li><p><a class="reference internal" href="#id20" id="id46">5.认证</a></p></li>
<li><p><a class="reference internal" href="#id21" id="id47">6.在flask-restful中添加日志</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id22" id="id48">5. 跨域访问</a></p>
<ul>
<li><p><a class="reference internal" href="#id23" id="id49">什么是跨域？</a></p></li>
<li><p><a class="reference internal" href="#cors" id="id50">CORS</a></p></li>
<li><p><a class="reference internal" href="#flaskcors" id="id51">Flask配置cors</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#model" id="id52">6.模型 Model</a></p></li>
<li><p><a class="reference internal" href="#flaskrestful" id="id53">使用 Flask设计RESTful 的认证</a></p>
<ul>
<li><p><a class="reference internal" href="#flask-jwt-extended" id="id54">1. flask-jwt-extended</a></p></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<section id="flask">
<h1><a class="toc-backref" href="#id24"><span class="section-number">23.6.3. </span>Flask</a><a class="headerlink" href="#flask" title="Permalink to this headline">¶</a></h1>
<section id="id1">
<h2><a class="toc-backref" href="#id25">1.Flask综述</a><a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p>相对于其他Python语言的Web框架而言，Flask的特点可以归结如下。</p>
<p>1．内置开发服务器和调试器</p>
<p>2．与Python单元测试功能无缝衔接</p>
<p>3．使用Jinja2模板</p>
<p>4．完全兼容WSGI 1.0标准</p>
<p>5．基于Unicode编码</p>
</section>
<section id="flask-api">
<h2><a class="toc-backref" href="#id26">2.实战演练:开发Flask API视图</a><a class="headerlink" href="#flask-api" title="Permalink to this headline">¶</a></h2>
<section id="hello-world">
<h3><a class="toc-backref" href="#id27">1.Hello World程序</a><a class="headerlink" href="#hello-world" title="Permalink to this headline">¶</a></h3>
<p>现在可以开始写第1个Flask程序了，一个最简单的Flask程序应该包括如下内容：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">hello_world</span><span class="p">():</span>  <span class="c1"># put application&#39;s code here</span>
    <span class="k">return</span> <span class="s1">&#39;Hello World!&#39;</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p>当确定系统可以接受来自外部的访问时，可以通过给run（）方法设置参数的方式来实现。同时，在run参数中可以传入要监听的端口，并且设置是否处于调试模式运行。如果将helloworld.py文件中的app.run()改为如下命令，则系统将会监听所有地址的80端口，并关闭调试模式：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s1">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="id2">
<h3><a class="toc-backref" href="#id28">2.模板渲染</a><a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<section id="render-template">
<h4>1.用render_template实现模板渲染<a class="headerlink" href="#render-template" title="Permalink to this headline">¶</a></h4>
<p>使用模板渲染的代码如下：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">render_template</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">hello_world</span><span class="p">():</span>  <span class="c1"># put application&#39;s code here</span>
    <span class="k">return</span> <span class="s1">&#39;Hello World!&#39;</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/hello&#39;</span><span class="p">)</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/hello/&lt;name&gt;&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">hello</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;hello.html&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s1">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>假设本例的Python代码被保存在app.py中，则本例的网站目录结构如下：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">app</span><span class="o">.</span><span class="n">py</span>
<span class="o">/</span><span class="n">templates</span>
  <span class="o">/</span><span class="n">hello</span><span class="o">.</span><span class="n">html</span>
</pre></div>
</div>
<p>下面是hello.html文件的内容：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>&lt;! doctype html&gt;
&lt;title&gt;Hello from Flask&lt;/title&gt;
{% if name %}                             &lt;! -判断name参数是否为空 →
    &lt;h1&gt;Hello {{ name }}! &lt;/h1&gt;                &lt;! -当name参数不为空时，本行生效 →
{% else %}
    &lt;h1&gt;Hello World! &lt;/h1&gt;                    &lt;! -当name参数为空时，本行生效 →
{% endif %}
</pre></div>
</div>
</section>
<section id="markup">
<h4>2.用Markup转换变量中的特殊字符<a class="headerlink" href="#markup" title="Permalink to this headline">¶</a></h4>
<p>向render_template传入的参数，不仅可以是单纯的字符串，还可以包含HTML特殊字符（比如&lt;、&gt;、空格、/等），这给模板参数提供了更好的灵活性。同时，因为这些特殊字符会被HTML客户端解释成特殊含义，所以会给网站程序带来一定程度的安全隐患。Flask允许程序员自己控制Jinja2是否需要解释这些特殊字符。</p>
<p>如果这些字符应该被解释成特殊含义，则将这些参数直接传给render_template即可；如果这些字符仅应该被解释成字符串，则应该通过Markup()函数将这些字符串做转义处理，然后传给render_template()函数。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/hello&#39;</span><span class="p">)</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/hello/&lt;name&gt;&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">hello</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Markup</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">Markup</span><span class="p">(</span><span class="s1">&#39;&lt;strong&gt;Hi </span><span class="si">%s</span><span class="s1">! &lt;/strong&gt;&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="s1">&#39;&lt;blink&gt;David&lt;/blink&gt;&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;hello.html&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
</pre></div>
</div>
<p>这段代码显示在浏览器中将会是一段粗体的“Hi
David!”。如果不进行Markup转义，则将会在浏览器上显示成闪烁着的粗体字“Hi
David!”。</p>
</section>
<section id="id3">
<h4>3.重定向和错误处理<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h4>
<p>重定向（Redirect）是指将一个网络请求重新指定URL并转到其他地址的技术。Flask的redirect()函数提供了这个功能。此外，如果仅仅想中止一个请求并返回错误，而不是重定向到其他地址，则可以使用abort()函数。</p>
<p>例如：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">abort</span><span class="p">,</span> <span class="n">redirect</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;/check&#39;</span><span class="p">)</span>  <span class="c1"># 重定向到/login页面</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/check&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">f_check</span><span class="p">():</span>
    <span class="n">abort</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span>  <span class="c1"># 立即向客户端返回400错误</span>
    <span class="c1"># dont_coding_here()                         #这里的代码不会被执行</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s1">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>本例中，当客户端访问根页面时，处理函数index()通过redirect()函数将请求重定向到了check页面。而check页面中目前没有实现其他逻辑，仅仅向客户端返回了400错误。</p>
<p><strong>说明：</strong> 400是一个HTTP的标准错误定义，其含义为请求无效。</p>
<p>HTTP 定义了标准的返回码错误代码表，其中大于等于400的代码被认为错误。</p>
<p>客户端的浏览器遇到错误返回时会显示默认的错误页面。如果网站程序需要定义自己的错误页面，则可以通过添加错误处理器来实现。</p>
<p>例如可以在程序中添加如下代码段：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">abort</span><span class="p">,</span> <span class="n">redirect</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">render_template</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;/check&#39;</span><span class="p">)</span>  <span class="c1"># 重定向到/login页面</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/check&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">f_check</span><span class="p">():</span>
    <span class="n">abort</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span>  <span class="c1"># 立即向客户端返回400错误</span>
    <span class="c1"># dont_coding_here()                         #这里的代码不会被执行</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">errorhandler</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">bad_request</span><span class="p">(</span><span class="n">error</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;bad_request.html&#39;</span><span class="p">),</span> <span class="mi">400</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s1">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>本例中用Flask的errorhandler装饰器添加了自定义的错误处理器。当程序中返回400错误时，系统会执行bad_request()函数。在该函数中向客户端返回400错误的同时，还传送了自定义的错误页面bad_request.html。</p>
</section>
</section>
<section id="fbvcbv">
<h3><a class="toc-backref" href="#id29">4. FBV与CBV</a><a class="headerlink" href="#fbvcbv" title="Permalink to this headline">¶</a></h3>
<section id="fbv">
<h4>1.FBV<a class="headerlink" href="#fbv" title="Permalink to this headline">¶</a></h4>
<p>FBV的定义、路由映射方法、装饰器添加方法，Flask中通常会用FBV；Flask框架中不常用CBV；更多的是用FBV</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span><span class="n">views</span>


<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">inner</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;beforeFunc&#39;</span><span class="p">)</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span>
    <span class="k">return</span> <span class="n">inner</span>
<span class="c1"># FBV</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/index1&#39;</span><span class="p">,</span><span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@wrapper</span>
<span class="k">def</span> <span class="nf">index1</span><span class="p">():</span>
    <span class="k">return</span> <span class="s2">&quot;index1&quot;</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="cbv">
<h4>2.CBV<a class="headerlink" href="#cbv" title="Permalink to this headline">¶</a></h4>
<p>在CBV中，路由信息只能通过<code class="docutils literal notranslate"><span class="pre">add_url_rule()</span></code>方法添加</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">views</span>


<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Login</span><span class="p">(</span><span class="n">views</span><span class="o">.</span><span class="n">MethodView</span><span class="p">):</span>
    <span class="n">methods</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="s1">&#39;GET&#39;</span><span class="p">]</span>
    <span class="c1"># 如果需要在CBV中加装饰器的话,括号里就是装饰器的内存地址，可以传多个</span>
    <span class="n">decorators</span> <span class="o">=</span> <span class="p">()</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;get 请求&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;login get&#39;</span>
    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;post 请求&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;login post&#39;</span>

<span class="n">app</span><span class="o">.</span><span class="n">add_url_rule</span><span class="p">(</span><span class="s1">&#39;/login&#39;</span><span class="p">,</span> <span class="n">view_func</span><span class="o">=</span><span class="n">Login</span><span class="o">.</span><span class="n">as_view</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;login&#39;</span><span class="p">))</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="id4">
<h3><a class="toc-backref" href="#id30">3.路由详解</a><a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<section id="id5">
<h4>1.在路径中添加变量<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/login/&lt;username&gt;&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">show_welcome</span><span class="p">(</span><span class="n">username</span><span class="p">):</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;Hi </span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s1">&#39;</span>  <span class="c1"># show welcome</span>
</pre></div>
</div>
<p>被添加的参数需要两次被声明：第1次是在route()装饰器的参数中，在需要使用变量的URL部分用方式声明变量；第2次是在所映射的函数（本例中为show_welcome）的参数中声明变量名，这样被声明的变量就可以在映射函数内使用了。</p>
<p>本例中username变量被作为欢迎语句的一部分回传给客户端。</p>
<blockquote>
<div><p>注意： 两次变量声明的变量名一定要一致。</p>
</div></blockquote>
</section>
<section id="id6">
<h4>2.为变量指定类型<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h4>
<p>可以在声明变量时指定变量被映射的类型，比如：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/add/&lt;int:number&gt;&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">add_one</span><span class="p">(</span><span class="n">number</span><span class="p">):</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">number</span> <span class="o">+</span> <span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span>
</pre></div>
</div>
<p>Flask中允许有3种类型的变量映射，如表8.1所示。</p>
<p>表8.1　路由变量映射类型表</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 25%" />
<col style="width: 75%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>映射类型</p></th>
<th class="head"><p>说明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Int</p></td>
<td><p>接受整型数值变量</p></td>
</tr>
<tr class="row-odd"><td><p>Float</p></td>
<td><p>接受浮点型数值变量</p></td>
</tr>
<tr class="row-even"><td><p>Path</p></td>
<td><p>默认方式，接受路径字符串</p></td>
</tr>
</tbody>
</table>
<p><strong>3．路径最后的分隔符的作用</strong></p>
<p>在URL路径中，斜杠“/”被用作路径分隔符。当斜杠被写在URL路径的开头时，则表明本路径是一个绝对路径；当斜杠被写在路径中间时，它被用作隔离路径的层级。</p>
<p>那么，当它被写在最后时，它的作用是什么呢？</p>
<p>通过下面的例子可以理解斜杠分隔符被写在路径最后时的作用。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/school/&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">schools</span><span class="p">():</span>
    <span class="k">return</span> <span class="s1">&#39;The school page&#39;</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/school&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">schools</span><span class="p">():</span>
    <span class="k">return</span> <span class="s1">&#39;The school page&#39;</span>
</pre></div>
</div>
<p>是否带斜杠结尾的路径声明效果分析</p>
<img alt="../../../_images/image-20220905114643362.png" src="../../../_images/image-20220905114643362.png" />
</section>
<section id="http">
<h4>3.HTTP方法绑定<a class="headerlink" href="#http" title="Permalink to this headline">¶</a></h4>
<p>网站通过HTTP与浏览器或其他客户端进行交互，而HTTP访问一个URL时可以使用几种不同的访问方式，包括GET、POST、HEAD、DELETE等。在Flask中，路由默认设置使用GET方式进行路径访问。</p>
<p><strong>1.指定HTTP访问方式的方法</strong></p>
<p>通过修改route中的参数，可以配置其他访问方式。举例说明：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/SendMessage&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">Messaging</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">do_send</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">show_the_send_form</span><span class="p">()</span>
</pre></div>
</div>
<p>本例中，在route装饰器中显式地声明了两种HTTP访问方式：GET和POST。无论客户端使用哪种方式访问地址/SendMessage,
Flask都会定位到Messaging（）函数并执行。可以在函数中通过request.method属性获得本次HTTP请求的访问方式。</p>
<blockquote>
<div><p><strong>注意：</strong>
request是Flask框架的一个全局对象，可以获得很多HTTP请求的客户端相关的信息。</p>
</div></blockquote>
<p><strong>2.将同一个URL根据访问方式映射到不同的函数</strong></p>
<p>可以灵活地运用URL、访问方法、被映射函数的绑定关系。通过把不同的访问方式赋予相同的URL，可以对其绑定不同的映射函数。</p>
<p>【示例8-8】比如：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/Message&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">do_send</span><span class="p">():</span>
    <span class="k">return</span> <span class="s2">&quot;This is for POST methods&quot;</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/Message&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">show_the_send_form</span><span class="p">():</span>
    <span class="k">return</span> <span class="s2">&quot;This is for GET methods&quot;</span>
</pre></div>
</div>
</section>
<section id="id7">
<h4>4.路由地址反向生成<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h4>
<p>通过前面的学习，读者已经掌握了将URL绑定到映射函数的方法。但有时，程序中需要通过函数名称获得与其绑定的URL地址。Flask通过url_for（）函数实现了这个功能。在使用前，需要先从Flask包中导入对url_for（）函数的引用。函数的第1个参数是需要获取URL的函数名，URL中如果有变量，则可以在url_for（）中添加参数来实现对变量的赋值。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">url_for</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">f_root</span><span class="p">():</span><span class="k">pass</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/industry&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">f_industry</span><span class="p">():</span><span class="k">pass</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/book/&lt;book_name&gt;&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">f_book</span><span class="p">(</span><span class="n">book_name</span><span class="p">):</span><span class="k">pass</span>

<span class="k">with</span> <span class="n">app</span><span class="o">.</span><span class="n">test_request_context</span><span class="p">():</span>
  <span class="nb">print</span> <span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;f_root&#39;</span><span class="p">)</span>                               <span class="c1">#例1，输出：/</span>
  <span class="nb">print</span> <span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;f_industry&#39;</span><span class="p">)</span>                           <span class="c1">#例2，输出：/industry</span>
  <span class="nb">print</span> <span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;f_industry&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;web&#39;</span><span class="p">)</span>               <span class="c1">#例3，输出：/industry? name=web</span>
  <span class="nb">print</span> <span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;f_book&#39;</span><span class="p">,</span> <span class="n">book_name</span><span class="o">=</span><span class="s1">&#39;Python Book&#39;</span><span class="p">)</span>      <span class="c1">#例4，输出：/book/Python%20Book</span>
</pre></div>
</div>
<blockquote>
<div><p>技巧：
Flask中test_request_context（）方法用于告诉解释器为在其作用域中的代码模拟一个HTTP请求上下文，使其好像被一个HTTP请求所调用。HTTP请求上下文是调用url_for所必需的环境。</p>
</div></blockquote>
<p>在程序中需要使用url_for（）函数的原因如下。</p>
<ul class="simple">
<li><p>反向解析比硬编码有更好的可读性和可维护性。比如，当需要更换路由函数中URL的地址时，无须再更改和调用url_for处的代码。</p></li>
<li><p>url_for会自动处理必需的特殊字符转换和Unicode编码转换。本节代码段中例4的空格就被自动解析为%20。</p></li>
</ul>
</section>
<section id="id8">
<h4>5.路由系统<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><p>&#64;app.route(‘/user/’)</p></li>
<li><p>&#64;app.route(‘/post/’)</p></li>
<li><p>&#64;app.route(‘/post/’)</p></li>
<li><p>&#64;app.route(‘/post/’)</p></li>
<li><p>&#64;app.route(‘/login’, methods=[‘GET’, ‘POST’])</p></li>
</ul>
<p>常用路由系统有以上五种，所有的路由系统都是基于一下对应关系来处理：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">DEFAULT_CONVERTERS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;default&#39;</span><span class="p">:</span>          <span class="n">UnicodeConverter</span><span class="p">,</span>
    <span class="s1">&#39;string&#39;</span><span class="p">:</span>           <span class="n">UnicodeConverter</span><span class="p">,</span>
    <span class="s1">&#39;any&#39;</span><span class="p">:</span>              <span class="n">AnyConverter</span><span class="p">,</span>
    <span class="s1">&#39;path&#39;</span><span class="p">:</span>             <span class="n">PathConverter</span><span class="p">,</span>
    <span class="s1">&#39;int&#39;</span><span class="p">:</span>              <span class="n">IntegerConverter</span><span class="p">,</span>
    <span class="s1">&#39;float&#39;</span><span class="p">:</span>            <span class="n">FloatConverter</span><span class="p">,</span>
    <span class="s1">&#39;uuid&#39;</span><span class="p">:</span>             <span class="n">UUIDConverter</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<section id="id9">
<h3><a class="toc-backref" href="#id31">4.静态文件</a><a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h3>
<p>静态文件，顾名思义，就是那些不会被改变的文件，比如图片，CSS 文件和
JavaScript 源码文件。默认情况下，Flask 在程序根目录中名为 static
的子目录中寻找静态文件。因此，我们一般在应用的包中创建一个叫 static
的文件夹，并在里面放置我们的静态文件。比如，我们可以按下面的结构组织我们的
app：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">app</span><span class="o">/</span>
    <span class="fm">__init__</span><span class="o">.</span><span class="n">py</span>
    <span class="n">static</span><span class="o">/</span>
        <span class="n">css</span><span class="o">/</span>
            <span class="n">style</span><span class="o">.</span><span class="n">css</span>
            <span class="n">home</span><span class="o">.</span><span class="n">css</span>
            <span class="n">admin</span><span class="o">.</span><span class="n">css</span>
        <span class="n">js</span><span class="o">/</span>
            <span class="n">home</span><span class="o">.</span><span class="n">js</span>
            <span class="n">admin</span><span class="o">.</span><span class="n">js</span>
        <span class="n">img</span><span class="o">/</span>
            <span class="n">favicon</span><span class="o">.</span><span class="n">co</span>
            <span class="n">logo</span><span class="o">.</span><span class="n">svg</span>
    <span class="n">templates</span><span class="o">/</span>
        <span class="n">index</span><span class="o">.</span><span class="n">html</span>
        <span class="n">home</span><span class="o">.</span><span class="n">html</span>
        <span class="n">admin</span><span class="o">.</span><span class="n">html</span>
    <span class="n">views</span><span class="o">/</span>
    <span class="n">models</span><span class="o">/</span>
<span class="n">run</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
<p>但是，我们有时还会应用到第三方库，比如 jQuery, Bootstrap
等，这时我们为了不跟自己的 Javascript 和 CSS
文件混起来，我们可以将这些第三方库放到 lib 文件夹或者 vendor
文件夹，比如下面这种：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">static</span><span class="o">/</span>
    <span class="n">css</span><span class="o">/</span>
        <span class="n">lib</span><span class="o">/</span>
            <span class="n">bootstrap</span><span class="o">.</span><span class="n">css</span>
        <span class="n">style</span><span class="o">.</span><span class="n">css</span>
        <span class="n">home</span><span class="o">.</span><span class="n">css</span>
        <span class="n">admin</span><span class="o">.</span><span class="n">css</span>
    <span class="n">js</span><span class="o">/</span>
        <span class="n">lib</span><span class="o">/</span>
            <span class="n">jquery</span><span class="o">.</span><span class="n">js</span>
            <span class="n">chart</span><span class="o">.</span><span class="n">js</span>
        <span class="n">home</span><span class="o">.</span><span class="n">js</span>
        <span class="n">admin</span><span class="o">.</span><span class="n">js</span>
    <span class="n">img</span><span class="o">/</span>
        <span class="n">logo</span><span class="o">.</span><span class="n">svg</span>
        <span class="n">favicon</span><span class="o">.</span><span class="n">ico</span>
</pre></div>
</div>
<section id="favicon">
<h4>1. 提供一个 favicon 图标<a class="headerlink" href="#favicon" title="Permalink to this headline">¶</a></h4>
<p>favicon 是 favorites icon 的缩写，也被称为 website
icon（网页图标）、page icon（页面图标）等。通常而言，定义一个 favicon
的方法是将一个名为『favicon.ico』的文件置于 Web
服务器的根目录下。但是，正如我们在上面指出，我们一般将图片等静态资源放在一个单独的
static 文件夹中。为了解决这种不一致，我们可以在站点模板的 部分添加两个
link 组件，比如我们可以在 template/base.html 中定义 favicon 图标：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="o">%</span> <span class="n">block</span> <span class="n">head</span> <span class="o">%</span><span class="p">}</span>
<span class="p">{{</span> <span class="nb">super</span><span class="p">()</span> <span class="p">}}</span>
<span class="o">&lt;</span><span class="n">link</span> <span class="n">rel</span><span class="o">=</span><span class="s2">&quot;shortcut icon&quot;</span> <span class="n">href</span><span class="o">=</span><span class="s2">&quot;{{ url_for(&#39;static&#39;, filename = &#39;favicon.ico&#39;) }}&quot;</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;image/x-icon&quot;</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">link</span> <span class="n">rel</span><span class="o">=</span><span class="s2">&quot;icon&quot;</span> <span class="n">href</span><span class="o">=</span><span class="s2">&quot;{{ url_for(&#39;static&#39;, filename = &#39;favicon.ico&#39;) }}&quot;</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;image/x-icon&quot;</span><span class="o">&gt;</span>
<span class="p">{</span><span class="o">%</span> <span class="n">endblock</span> <span class="o">%</span><span class="p">}</span>
</pre></div>
</div>
<p>在上面的代码中，我们使用了 <code class="docutils literal notranslate"><span class="pre">super()</span></code>
来保留基模板中定义的块的原始内容，并添加了两个 link
组件声明图标位置，这两个 link 组件声明会插入到 head 块的末尾。</p>
</section>
</section>
<section id="jinja2">
<h3><a class="toc-backref" href="#id32">5.使用 Jinja2 模板引擎</a><a class="headerlink" href="#jinja2" title="Permalink to this headline">¶</a></h3>
<p>了解即可，不用深入</p>
<p>目前flask主要用来写接口前后端分离，Jinja2多用于前后端不分离场景，暂时接触不多，部分可以阅读如下文章</p>
<p><a class="reference external" href="https://www.bookstack.cn/read/head-first-flask/chapter02-section2.04.md">https://www.bookstack.cn/read/head-first-flask/chapter02-section2.04.md</a></p>
</section>
<section id="id10">
<h3><a class="toc-backref" href="#id33">6.请求、重定向及会话</a><a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h3>
<p>Web 开发中经常需要处理 HTTP 请求、重定向和会话等诸多事务，相应地，Flask
也内建了一些常见的对象如 request, session, redirect 等对它们进行处理。</p>
<section id="request">
<h4>1.请求对象 request<a class="headerlink" href="#request" title="Permalink to this headline">¶</a></h4>
<p>HTTP 请求方法有 GET、POST、PUT 等，request 对象也相应地提供了支持。</p>
<p>举个例子，假设现在我们开发一个功能：用户注册。如果 HTTP 请求方法是
POST，我们就注册该用户，如果是 GET
请求，我们就显示注册的字样。代码示例如下（注意，下面代码并不能直接运行，文末提供了完整的代码）：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/register&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="s1">&#39;GET&#39;</span><span class="p">]):</span>
<span class="k">def</span> <span class="nf">register</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;please register!&#39;</span>
    <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="n">user</span>
</pre></div>
</div>
</section>
<section id="redirect">
<h4>2.重定向对象 redirect<a class="headerlink" href="#redirect" title="Permalink to this headline">¶</a></h4>
<p>当用户访问某些网页时，如果他还没登录，我们往往会把网页<strong>重定向</strong>到登录页面，Flask
提供了 redirect
对象对其进行处理，我们对上面的代码做一点简单的改造，如果用户注册了，我们将网页重定向到首页。代码示例如下：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">redirect</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/home&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">]):</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="k">return</span> <span class="s1">&#39;hello world!&#39;</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/register&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="s1">&#39;GET&#39;</span><span class="p">]):</span>
<span class="k">def</span> <span class="nf">register</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;please register!&#39;</span>
    <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;/home&#39;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="session">
<h4>3.会话对象session<a class="headerlink" href="#session" title="Permalink to this headline">¶</a></h4>
<p>程序可以把数据存储在<strong>用户会话</strong>中，用户会话是一种私有存储，默认情况下，它会保存在客户端
cookie 中。Flask 提供了 session 对象来操作用户会话，下面看一个示例：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">url_for</span><span class="p">,</span> <span class="n">render_template</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/home&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="k">return</span> <span class="s1">&#39;hello world!&#39;</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/register&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">register</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">user_name</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span>
        <span class="n">session</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_name</span>
        <span class="k">return</span> <span class="s1">&#39;hello, &#39;</span> <span class="o">+</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;user&#39;</span> <span class="ow">in</span> <span class="n">session</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;login.html&#39;</span><span class="p">)</span>

<span class="n">app</span><span class="o">.</span><span class="n">secret_key</span> <span class="o">=</span> <span class="s1">&#39;123456&#39;</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">5632</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>操作 <code class="docutils literal notranslate"><span class="pre">session</span></code> 就像操作 python 中的字典一样，我们可以使用
<code class="docutils literal notranslate"><span class="pre">session['user']</span></code> 获取值，也可以使用 <code class="docutils literal notranslate"><span class="pre">session.get('user')</span></code>
获取值。注意到，我们使用了 <code class="docutils literal notranslate"><span class="pre">url_for</span></code> 生成 URL，比如 <code class="docutils literal notranslate"><span class="pre">/home</span></code> 写成了
<code class="docutils literal notranslate"><span class="pre">url_for('index')</span></code>。</p>
<p><code class="docutils literal notranslate"><span class="pre">url_for()</span></code>
函数的第一个且唯一必须指定的参数是端点名，即路由的内部名字。默认情况下，路由的端点是相应视图函数的名字，因此
<code class="docutils literal notranslate"><span class="pre">/home</span></code> 应该写成 <code class="docutils literal notranslate"><span class="pre">url_for('index')</span></code>。</p>
<p>还有一点，使用<code class="docutils literal notranslate"><span class="pre">session</span></code> 时要设置一个密钥 <code class="docutils literal notranslate"><span class="pre">app.secret_key</span></code>。</p>
</section>
<section id="id11">
<h4>4.附录<a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h4>
<p>本节完整的代码如下：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ tree .
.
├── flask-session.py
└── templates
    ├── layout.html
    └── login.html

$ cat flask-session.py
from flask import Flask, request, session, redirect, url_for, render_template
app = Flask(__name__)
@app.route(&#39;/&#39;)
def head():
    return redirect(url_for(&#39;register&#39;))
@app.route(&#39;/home&#39;, methods=[&#39;GET&#39;])
def index():
    return &#39;hello world!&#39;
@app.route(&#39;/register&#39;, methods=[&#39;GET&#39;, &#39;POST&#39;])
def register():
    if request.method == &#39;POST&#39;:
        user_name = request.form[&#39;user&#39;]
        session[&#39;user&#39;] = user_name
        return &#39;hello, &#39; + session[&#39;user&#39;]
    elif request.method == &#39;GET&#39;:
        if &#39;user&#39; in session:
            return redirect(url_for(&#39;index&#39;))
        else:
            return render_template(&#39;login.html&#39;)
app.secret_key = &#39;123456&#39;
if __name__ == &#39;__main__&#39;:
    app.run(host=&#39;127.0.0.1&#39;, port=5632, debug=True)


$ cat layout.html
&lt;!doctype html&gt;
&lt;title&gt;Hello Sample&lt;/title&gt;
&lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; href=&quot;{{ url_for(&#39;static&#39;, filename=&#39;style.css&#39;) }}&quot;&gt;
&lt;div class=&quot;page&quot;&gt;
    {% block body %}
    {% endblock %}
&lt;/div&gt;


$ cat login.html
{% extends &quot;layout.html&quot; %}
{% block body %}
&lt;form name=&quot;register&quot; action=&quot;{{ url_for(&#39;register&#39;) }}&quot; method=&quot;post&quot;&gt;
    Hello {{ title }}, please login by:
    &lt;input type=&quot;text&quot; name=&quot;user&quot; /&gt;
&lt;/form&gt;
{% endblock %}
</pre></div>
</div>
</section>
</section>
<section id="id12">
<h3><a class="toc-backref" href="#id34">7.蓝图</a><a class="headerlink" href="#id12" title="Permalink to this headline">¶</a></h3>
<p>了解即可，不用深入</p>
<p><a class="reference external" href="https://www.bookstack.cn/read/head-first-flask/chapter02-section2.06.md">https://www.bookstack.cn/read/head-first-flask/chapter02-section2.06.md</a></p>
</section>
<section id="cookie">
<h3><a class="toc-backref" href="#id35">8.cookie</a><a class="headerlink" href="#cookie" title="Permalink to this headline">¶</a></h3>
<p>了解即可，不用深入</p>
<p><a class="reference external" href="https://www.yuque.com/keep_running/python/uoq7e4">https://www.yuque.com/keep_running/python/uoq7e4</a></p>
</section>
<section id="id13">
<h3><a class="toc-backref" href="#id36">9.session</a><a class="headerlink" href="#id13" title="Permalink to this headline">¶</a></h3>
<p>了解即可，不用深入</p>
<p><a class="reference external" href="https://www.yuque.com/keep_running/python/ziysy6">https://www.yuque.com/keep_running/python/ziysy6</a></p>
</section>
</section>
<section id="python-flaskrestful-apis">
<h2><a class="toc-backref" href="#id37">3.使用Python和 Flask设计RESTful APIs</a><a class="headerlink" href="#python-flaskrestful-apis" title="Permalink to this headline">¶</a></h2>
<p>近些年来 REST (REpresentational State Transfer) 已经变成了 web services
和 web APIs 的标配。</p>
<p>在本文中我将向你展示如何简单地使用 Python 和 Flask 框架来创建一个
RESTful 的 web service。</p>
<p><strong>什么是 REST？</strong></p>
<p>六条设计规范定义了一个 REST 系统的特点:</p>
<ul class="simple">
<li><p><strong>客户端-服务器</strong>:
客户端和服务器之间隔离，服务器提供服务，客户端进行消费。</p></li>
<li><p><strong>无状态</strong>:
从客户端到服务器的每个请求都必须包含理解请求所必需的信息。换句话说，
服务器不会存储客户端上一次请求的信息用来给下一次使用。</p></li>
<li><p><strong>可缓存</strong>: 服务器必须明示客户端请求能否缓存。</p></li>
<li><p><strong>分层系统</strong>:
客户端和服务器之间的通信应该以一种标准的方式，就是中间层代替服务器做出响应的时候，客户端不需要做任何变动。</p></li>
<li><p><strong>统一的接口</strong>: 服务器和客户端的通信方法必须是统一的。</p></li>
<li><p><strong>按需编码</strong>:
服务器可以提供可执行代码或脚本，为客户端在它们的环境中执行。这个约束是唯一一个是可选的。</p></li>
</ul>
<section id="restful-web-service">
<h3><a class="toc-backref" href="#id38">1.什么是一个 RESTful 的 web service？</a><a class="headerlink" href="#restful-web-service" title="Permalink to this headline">¶</a></h3>
<p>REST 架构的最初目的是适应万维网的 HTTP 协议。</p>
<p>RESTful web services 概念的核心就是“资源”。 资源可以用
<a class="reference external" href="https://en.wikipedia.org/wiki/Uniform_resource_identifier">URI</a>
来表示。客户端使用 HTTP 协议定义的方法来发送请求到这些
URIs，当然可能会导致这些被访问的”资源“状态的改变。</p>
<p>HTTP 标准的方法有如下:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">==========</span>  <span class="o">=====================</span>  <span class="o">==================================</span>
<span class="n">HTTP</span> <span class="n">方法</span>   <span class="n">行为</span>                   <span class="n">示例</span>
<span class="o">==========</span>  <span class="o">=====================</span>  <span class="o">==================================</span>
<span class="n">GET</span>         <span class="n">获取资源的信息</span>         <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">orders</span>
<span class="n">GET</span>         <span class="n">获取某个特定资源的信息</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">orders</span><span class="o">/</span><span class="mi">123</span>
<span class="n">POST</span>        <span class="n">创建新资源</span>             <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">orders</span>
<span class="n">PUT</span>         <span class="n">更新资源</span>               <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">orders</span><span class="o">/</span><span class="mi">123</span>
<span class="n">DELETE</span>      <span class="n">删除资源</span>               <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">orders</span><span class="o">/</span><span class="mi">123</span>
<span class="o">==========</span>  <span class="o">======================</span> <span class="o">==================================</span>
</pre></div>
</div>
<p>REST 设计不需要特定的数据格式。在请求中数据可以以
<a class="reference external" href="http://en.wikipedia.org/wiki/JSON">JSON</a> 形式, 或者有时候作为 url
中查询参数项。</p>
</section>
<section id="web-service">
<h3><a class="toc-backref" href="#id39">2.设计一个简单的 web service</a><a class="headerlink" href="#web-service" title="Permalink to this headline">¶</a></h3>
<p>坚持 REST 的准则设计一个 web service 或者 API
的任务就变成一个标识资源被展示出来以及它们是怎样受不同的请求方法影响的练习。</p>
<p>比如说，我们要编写一个待办事项应用程序而且我们想要为它设计一个 web
service。要做的第一件事情就是决定用什么样的根 URL
来访问该服务。例如，我们可以通过这个来访问:</p>
<p><code class="docutils literal notranslate"><span class="pre">http://[hostname]/todo/api/v1.0/</span></code></p>
<p>在这里我已经决定在 URL 中包含应用的名称以及 API 的版本号。在 URL
中包含应用名称有助于提供一个命名空间以便区分同一系统上的其它服务。在 URL
中包含版本号能够帮助以后的更新，如果新版本中存在新的和潜在不兼容的功能，可以不影响依赖于较旧的功能的应用程序。</p>
<p>下一步骤就是选择将由该服务暴露(展示)的资源。这是一个十分简单地应用，我们只有任务，因此在我们待办事项中唯一的资源就是任务。</p>
<p>我们的任务资源将要使用 HTTP 方法如下:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">==========</span>  <span class="o">===============================================</span>  <span class="o">=============================</span>
<span class="n">HTTP</span> <span class="n">方法</span>   <span class="n">URL</span>                                              <span class="n">动作</span>
<span class="o">==========</span>  <span class="o">===============================================</span>  <span class="o">==============================</span>
<span class="n">GET</span>         <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="p">[</span><span class="n">hostname</span><span class="p">]</span><span class="o">/</span><span class="n">todo</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">v1</span><span class="o">.</span><span class="mi">0</span><span class="o">/</span><span class="n">tasks</span>            <span class="n">检索任务列表</span>
<span class="n">GET</span>         <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="p">[</span><span class="n">hostname</span><span class="p">]</span><span class="o">/</span><span class="n">todo</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">v1</span><span class="o">.</span><span class="mi">0</span><span class="o">/</span><span class="n">tasks</span><span class="o">/</span><span class="p">[</span><span class="n">task_id</span><span class="p">]</span>  <span class="n">检索某个任务</span>
<span class="n">POST</span>        <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="p">[</span><span class="n">hostname</span><span class="p">]</span><span class="o">/</span><span class="n">todo</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">v1</span><span class="o">.</span><span class="mi">0</span><span class="o">/</span><span class="n">tasks</span>            <span class="n">创建新任务</span>
<span class="n">PUT</span>         <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="p">[</span><span class="n">hostname</span><span class="p">]</span><span class="o">/</span><span class="n">todo</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">v1</span><span class="o">.</span><span class="mi">0</span><span class="o">/</span><span class="n">tasks</span><span class="o">/</span><span class="p">[</span><span class="n">task_id</span><span class="p">]</span>  <span class="n">更新任务</span>
<span class="n">DELETE</span>      <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="p">[</span><span class="n">hostname</span><span class="p">]</span><span class="o">/</span><span class="n">todo</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">v1</span><span class="o">.</span><span class="mi">0</span><span class="o">/</span><span class="n">tasks</span><span class="o">/</span><span class="p">[</span><span class="n">task_id</span><span class="p">]</span>  <span class="n">删除任务</span>
<span class="o">==========</span>  <span class="o">================================================</span> <span class="o">=============================</span>
</pre></div>
</div>
<p>我们定义的任务有如下一些属性:</p>
<ul class="simple">
<li><p><strong>id</strong>: 任务的唯一标识符。数字类型。</p></li>
<li><p><strong>title</strong>: 简短的任务描述。字符串类型。</p></li>
<li><p><strong>description</strong>: 具体的任务描述。文本类型。</p></li>
<li><p><strong>done</strong>: 任务完成的状态。布尔值。</p></li>
</ul>
<p>目前为止关于我们的 web service 的设计基本完成。剩下的事情就是实现它！</p>
<p>创建flask项目，<code class="docutils literal notranslate"><span class="pre">flaskapp1</span></code></p>
<p>使用pychrm创建</p>
<img alt="../../../_images/image-20220905111439111.png" src="../../../_images/image-20220905111439111.png" />
<p>使用命令行创建</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ mkdir flaskapp1
$ <span class="nb">cd</span> flaskapp1
$ virtualenv flask
New python executable <span class="k">in</span> flask/bin/python
Installing setuptools............................done.
Installing pip...................done.

$ flask/bin/pip install flask
</pre></div>
</div>
<p>既然已经安装了 Flask，现在开始创建一个简单地网页应用，我们把它放在一个叫
app.py 的文件中:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!flask/bin/python</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="k">return</span> <span class="s2">&quot;Hello, World!&quot;</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>为了运行这个程序我们必须执行 app.py:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ chmod a+x app.py
$ ./app.py
 * Running on http://127.0.0.1:5000/
 * Restarting with reloader
</pre></div>
</div>
<p>现在你可以启动你的网页浏览器，输入
<a class="reference external" href="http://localhost:5000/">http://localhost:5000</a>
看看这个小应用程序的效果。</p>
<p>简单吧？现在我们将这个应用程序转换成我们的 RESTful service！</p>
</section>
<section id="python-flaskrestful-services">
<h3><a class="toc-backref" href="#id40">3.使用Python和 Flask实现RESTful services</a><a class="headerlink" href="#python-flaskrestful-services" title="Permalink to this headline">¶</a></h3>
<p>在 Flask 中有许多扩展来帮助我们构建 RESTful
services，但是在我看来这个任务十分简单，没有必要使用 Flask 扩展。</p>
<section id="get">
<h4>1.Get<a class="headerlink" href="#get" title="Permalink to this headline">¶</a></h4>
<p>我们现在来实现 web service 的第一个入口:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!flask/bin/python</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">jsonify</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;Buy groceries&#39;</span><span class="p">,</span>
        <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;Milk, Cheese, Pizza, Fruit, Tylenol&#39;</span><span class="p">,</span>
        <span class="s1">&#39;done&#39;</span><span class="p">:</span> <span class="kc">False</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;Learn Python&#39;</span><span class="p">,</span>
        <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;Need to find a good Python tutorial on the web&#39;</span><span class="p">,</span>
        <span class="s1">&#39;done&#39;</span><span class="p">:</span> <span class="kc">False</span>
    <span class="p">}</span>
<span class="p">]</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/todo/api/v1.0/tasks&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">get_tasks</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;tasks&#39;</span><span class="p">:</span> <span class="n">tasks</span><span class="p">})</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>正如你所见，没有多大的变化。我们创建一个任务的内存数据库，这里无非就是一个字典和数组。数组中的每一个元素都具有上述定义的任务的属性。</p>
<p>取代了首页，我们现在拥有一个 get_tasks 的函数，访问的 URI 为
/todo/api/v1.0/tasks，并且只允许 GET 的 HTTP 方法。</p>
<p>这个函数的响应不是文本，我们使用 JSON 数据格式来响应，Flask 的 jsonify
函数从我们的数据结构中生成。</p>
<p>使用网页浏览器来测试我们的 web service
不是一个最好的注意，因为网页浏览器上不能轻易地模拟所有的 HTTP
请求的方法。相反，我们会使用 curl。如果你还没有安装 curl
的话，请立即安装它。</p>
<p>通过执行 app.py，启动 web
service。接着打开一个新的控制台窗口，运行以下命令:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ curl -i http://localhost:5000/todo/api/v1.0/tasks
HTTP/1.1 200 OK
Server: Werkzeug/2.2.2 Python/3.8.8
Date: Mon, 05 Sep 2022 06:51:12 GMT
Content-Type: application/json
Content-Length: 310
Connection: close

{
  &quot;tasks&quot;: [
    {
      &quot;description&quot;: &quot;Milk, Cheese, Pizza, Fruit, Tylenol&quot;,
      &quot;done&quot;: false,
      &quot;id&quot;: 1,
      &quot;title&quot;: &quot;Buy groceries&quot;
    },
    {
      &quot;description&quot;: &quot;Need to find a good Python tutorial on the web&quot;,
      &quot;done&quot;: false,
      &quot;id&quot;: 2,
      &quot;title&quot;: &quot;Learn Python&quot;
    }
  ]
}
</pre></div>
</div>
<p>我们已经成功地调用我们的 RESTful service 的一个函数！</p>
<p>现在我们开始编写 GET
方法请求我们的任务资源的第二个版本。这是一个用来返回单独一个任务的函数:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">abort</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/todo/api/v1.0/tasks/&lt;int:task_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">get_task</span><span class="p">(</span><span class="n">task_id</span><span class="p">):</span>
    <span class="n">task</span> <span class="o">=</span> <span class="p">[</span><span class="n">task</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasks</span> <span class="k">if</span> <span class="n">task</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">task_id</span><span class="p">]</span>
    <span class="c1"># task = list(filter(lambda t: t[&#39;id&#39;] == task_id, tasks))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">task</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">abort</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;task&#39;</span><span class="p">:</span> <span class="n">task</span><span class="p">[</span><span class="mi">0</span><span class="p">]})</span>
</pre></div>
</div>
<p>第二个函数有些意思。这里我们得到了 URL 中任务的 id，接着 Flask
把它转换成 函数中的 task_id 的参数。</p>
<p>我们用这个参数来搜索我们的任务数组。如果我们的数据库中不存在搜索的
id，我们将会返回一个类似 404 的错误，根据 HTTP 规范的意思是
“资源未找到”。</p>
<p>如果我们找到相应的任务，那么我们只需将它用 jsonify 打包成 JSON
格式并将其发送作为响应，就像我们以前那样处理整个任务集合。</p>
<p>调用 curl 请求的结果如下:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ curl -i http://localhost:5000/todo/api/v1.0/tasks/1
HTTP/1.1 200 OK
Server: Werkzeug/2.2.2 Python/3.8.8
Date: Mon, 05 Sep 2022 06:53:30 GMT
Content-Type: application/json
Content-Length: 139
Connection: close

{
  &quot;task&quot;: {
    &quot;description&quot;: &quot;Milk, Cheese, Pizza, Fruit, Tylenol&quot;,
    &quot;done&quot;: false,
    &quot;id&quot;: 1,
    &quot;title&quot;: &quot;Buy groceries&quot;
  }
}

18793@DESKTOP-8LI950S ~
$ curl -i http://localhost:5000/todo/api/v1.0/tasks/2
HTTP/1.1 200 OK
Server: Werkzeug/2.2.2 Python/3.8.8
Date: Mon, 05 Sep 2022 06:53:36 GMT
Content-Type: application/json
Content-Length: 149
Connection: close

{
  &quot;task&quot;: {
    &quot;description&quot;: &quot;Need to find a good Python tutorial on the web&quot;,
    &quot;done&quot;: false,
    &quot;id&quot;: 2,
    &quot;title&quot;: &quot;Learn Python&quot;
  }
}

18793@DESKTOP-8LI950S ~
$ curl -i http://localhost:5000/todo/api/v1.0/tasks/3
HTTP/1.1 404 NOT FOUND
Server: Werkzeug/2.2.2 Python/3.8.8
Date: Mon, 05 Sep 2022 06:53:38 GMT
Content-Type: text/html; charset=utf-8
Content-Length: 207
Connection: close

&lt;!doctype html&gt;
&lt;html lang=en&gt;
&lt;title&gt;404 Not Found&lt;/title&gt;
&lt;h1&gt;Not Found&lt;/h1&gt;
&lt;p&gt;The requested URL was not found on the server. If you entered the URL manually please check your spelling and try again.&lt;/p&gt;
</pre></div>
</div>
<p>当我们请求 id #2 的资源时候，我们获取到了，但是当我们请求 #3
的时候返回了 404 错误。有关错误奇怪的是返回的是 HTML 信息而不是
JSON，这是因为 Flask 按照默认方式生成 404 响应。</p>
<p>由于这是一个 Web service 客户端希望我们总是以 JSON
格式回应，所以我们需要改善我们的 404 错误处理程序:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">make_response</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">errorhandler</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">not_found</span><span class="p">(</span><span class="n">error</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Not found&#39;</span><span class="p">}),</span> <span class="mi">404</span><span class="p">)</span>
</pre></div>
</div>
<p>我们会得到一个友好的错误提示:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ curl -i http://localhost:5000/todo/api/v1.0/tasks/3
HTTP/1.1 404 NOT FOUND
Server: Werkzeug/2.2.2 Python/3.8.8
Date: Mon, 05 Sep 2022 06:57:35 GMT
Content-Type: application/json
Content-Length: 27
Connection: close

{
  &quot;error&quot;: &quot;Not found&quot;
}
</pre></div>
</div>
</section>
<section id="post">
<h4>2.Post<a class="headerlink" href="#post" title="Permalink to this headline">¶</a></h4>
<p>接下来就是 POST 方法，我们用来在我们的任务数据库中插入一个新的任务:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">request</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/todo/api/v1.0/tasks&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">create_task</span><span class="p">():</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span> <span class="ow">or</span> <span class="ow">not</span> <span class="s1">&#39;title&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">:</span>
        <span class="n">abort</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span>
    <span class="n">task</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">tasks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">],</span>
        <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
        <span class="s1">&#39;done&#39;</span><span class="p">:</span> <span class="kc">False</span>
    <span class="p">}</span>
    <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;task&#39;</span><span class="p">:</span> <span class="n">task</span><span class="p">}),</span> <span class="mi">201</span>
</pre></div>
</div>
<p>添加一个新的任务也是相当容易地。只有当请求以 JSON 格式形式，request.json
才会有请求的数据。如果没有数据，或者存在数据但是缺少 title
项，我们将会返回 400，这是表示请求无效。</p>
<p>接着我们会创建一个新的任务字典，使用最后一个任务的 id + 1 作为该任务的
id。我们允许 description 字段缺失，并且假设 done 字段设置成 False。</p>
<p>我们把新的任务添加到我们的任务数组中，并且把新添加的任务和状态 201
响应给客户端。</p>
<p>使用如下的 curl 命令来测试这个新的函数:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ curl -i -H <span class="s2">&quot;Content-Type: application/json&quot;</span> -X POST -d <span class="s1">&#39;{&quot;title&quot;:&quot;Read a book&quot;}&#39;</span> http://localhost:5000/todo/api/v1.0/tasks
HTTP/1.1 <span class="m">201</span> CREATED
Server: Werkzeug/2.2.2 Python/3.8.8
Date: Mon, <span class="m">05</span> Sep <span class="m">2022</span> <span class="m">06</span>:59:27 GMT
Content-Type: application/json
Content-Length: <span class="m">102</span>
Connection: close

<span class="o">{</span>
  <span class="s2">&quot;task&quot;</span>: <span class="o">{</span>
    <span class="s2">&quot;description&quot;</span>: <span class="s2">&quot;&quot;</span>,
    <span class="s2">&quot;done&quot;</span>: false,
    <span class="s2">&quot;id&quot;</span>: <span class="m">3</span>,
    <span class="s2">&quot;title&quot;</span>: <span class="s2">&quot;Read a book&quot;</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="m">18793</span>@DESKTOP-8LI950S ~
$ curl -i http://localhost:5000/todo/api/v1.0/tasks/3
HTTP/1.1 <span class="m">200</span> OK
Server: Werkzeug/2.2.2 Python/3.8.8
Date: Mon, <span class="m">05</span> Sep <span class="m">2022</span> <span class="m">06</span>:59:33 GMT
Content-Type: application/json
Content-Length: <span class="m">102</span>
Connection: close

<span class="o">{</span>
  <span class="s2">&quot;task&quot;</span>: <span class="o">{</span>
    <span class="s2">&quot;description&quot;</span>: <span class="s2">&quot;&quot;</span>,
    <span class="s2">&quot;done&quot;</span>: false,
    <span class="s2">&quot;id&quot;</span>: <span class="m">3</span>,
    <span class="s2">&quot;title&quot;</span>: <span class="s2">&quot;Read a book&quot;</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>注意：如果你在 Windows 上并且运行 Cygwin 版本的
curl，上面的命令不会有任何问题。然而，如果你使用原生的
curl，命令会有些不同:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ curl -i -H <span class="s2">&quot;Content-Type: application/json&quot;</span> -X POST -d <span class="s2">&quot;{&quot;&quot;&quot;</span>title<span class="s2">&quot;&quot;&quot;:&quot;&quot;&quot;</span>Read a book<span class="s2">&quot;&quot;&quot;}&quot;</span> http://localhost:5000/todo/api/v1.0/tasks
</pre></div>
</div>
<p>当然在完成这个请求后，我们可以得到任务的更新列表:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ curl -i http://localhost:5000/todo/api/v1.0/tasks
HTTP/1.1 <span class="m">200</span> OK
Server: Werkzeug/2.2.2 Python/3.8.8
Date: Mon, <span class="m">05</span> Sep <span class="m">2022</span> <span class="m">07</span>:02:22 GMT
Content-Type: application/json
Content-Length: <span class="m">516</span>
Connection: close

<span class="o">{</span>
  <span class="s2">&quot;tasks&quot;</span>: <span class="o">[</span>
    <span class="o">{</span>
      <span class="s2">&quot;description&quot;</span>: <span class="s2">&quot;Milk, Cheese, Pizza, Fruit, Tylenol&quot;</span>,
      <span class="s2">&quot;done&quot;</span>: false,
      <span class="s2">&quot;id&quot;</span>: <span class="m">1</span>,
      <span class="s2">&quot;title&quot;</span>: <span class="s2">&quot;Buy groceries&quot;</span>
    <span class="o">}</span>,
    <span class="o">{</span>
      <span class="s2">&quot;description&quot;</span>: <span class="s2">&quot;Need to find a good Python tutorial on the web&quot;</span>,
      <span class="s2">&quot;done&quot;</span>: false,
      <span class="s2">&quot;id&quot;</span>: <span class="m">2</span>,
      <span class="s2">&quot;title&quot;</span>: <span class="s2">&quot;Learn Python&quot;</span>
    <span class="o">}</span>,
    <span class="o">{</span>
      <span class="s2">&quot;description&quot;</span>: <span class="s2">&quot;&quot;</span>,
      <span class="s2">&quot;done&quot;</span>: false,
      <span class="s2">&quot;id&quot;</span>: <span class="m">3</span>,
      <span class="s2">&quot;title&quot;</span>: <span class="s2">&quot;Read a book&quot;</span>
    <span class="o">}</span>,
    <span class="o">{</span>
      <span class="s2">&quot;description&quot;</span>: <span class="s2">&quot;&quot;</span>,
      <span class="s2">&quot;done&quot;</span>: false,
      <span class="s2">&quot;id&quot;</span>: <span class="m">4</span>,
      <span class="s2">&quot;title&quot;</span>: <span class="s2">&quot;Read a book&quot;</span>
    <span class="o">}</span>
  <span class="o">]</span>
<span class="o">}</span>
</pre></div>
</div>
</section>
<section id="putdelete">
<h4>3.PUT、Delete<a class="headerlink" href="#putdelete" title="Permalink to this headline">¶</a></h4>
<p>剩下的两个函数如下所示:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/todo/api/v1.0/tasks/&lt;int:task_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;PUT&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">update_task</span><span class="p">(</span><span class="n">task_id</span><span class="p">):</span>
    <span class="n">task</span> <span class="o">=</span> <span class="p">[</span><span class="n">task</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasks</span> <span class="k">if</span> <span class="n">task</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">task_id</span><span class="p">]</span>
    <span class="c1"># task = list(filter(lambda t: t[&#39;id&#39;] == task_id, tasks))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">task</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">abort</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">:</span>
        <span class="n">abort</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;title&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">])</span> <span class="o">!=</span> <span class="s2">&quot;unicode&quot;</span><span class="p">:</span>
        <span class="n">abort</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;description&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">])</span> <span class="o">!=</span> <span class="s2">&quot;unicode&quot;</span><span class="p">:</span>
        <span class="n">abort</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;done&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s1">&#39;done&#39;</span><span class="p">])</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">abort</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span>
    <span class="n">task</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="n">task</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;title&#39;</span><span class="p">])</span>
    <span class="n">task</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="n">task</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;description&#39;</span><span class="p">])</span>
    <span class="n">task</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;done&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;done&#39;</span><span class="p">,</span> <span class="n">task</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;done&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;task&#39;</span><span class="p">:</span> <span class="n">task</span><span class="p">[</span><span class="mi">0</span><span class="p">]})</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/todo/api/v1.0/tasks/&lt;int:task_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;DELETE&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">delete_task</span><span class="p">(</span><span class="n">task_id</span><span class="p">):</span>
    <span class="n">task</span> <span class="o">=</span> <span class="p">[</span><span class="n">task</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasks</span> <span class="k">if</span> <span class="n">task</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">task_id</span><span class="p">]</span>
    <span class="c1"># task = list(filter(lambda t: t[&#39;id&#39;] == task_id, tasks))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">task</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">abort</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
    <span class="n">tasks</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">task</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
</pre></div>
</div>
<p>delete_task 函数没有什么特别的。</p>
<p>对于 update_task 函数，我们需要严格地检查输入的参数以防止可能的问题。</p>
<p>我们需要确保在我们把它更新到数据库之前，任何客户端提供我们的是预期的格式。</p>
<p>更新任务 #2 的函数调用如下所示:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ curl -i -H <span class="s2">&quot;Content-Type: application/json&quot;</span> -X PUT -d <span class="s1">&#39;{&quot;done&quot;:true}&#39;</span> http://localhost:5000/todo/api/v1.0/tasks/2
HTTP/1.0 <span class="m">200</span> OK
Content-Type: application/json
Content-Length: <span class="m">170</span>
Server: Werkzeug/0.8.3 Python/2.7.3
Date: Mon, <span class="m">20</span> May <span class="m">2013</span> <span class="m">07</span>:10:16 GMT

<span class="o">{</span>
  <span class="s2">&quot;task&quot;</span>: <span class="o">[</span>
    <span class="o">{</span>
      <span class="s2">&quot;description&quot;</span>: <span class="s2">&quot;Need to find a good Python tutorial on the web&quot;</span>,
      <span class="s2">&quot;done&quot;</span>: true,
      <span class="s2">&quot;id&quot;</span>: <span class="m">2</span>,
      <span class="s2">&quot;title&quot;</span>: <span class="s2">&quot;Learn Python&quot;</span>
    <span class="o">}</span>
  <span class="o">]</span>
<span class="o">}</span>
</pre></div>
</div>
</section>
<section id="id14">
<h4>4.优化web service接口<a class="headerlink" href="#id14" title="Permalink to this headline">¶</a></h4>
<p>当前我们还有一个问题，客户端有可能需要从返回的JSON中重新构造URI，如果将来加入新的特性时，可能需要修改客户端。（例如新增版本。）</p>
<p>我们可以返回整个URI的路径给客户端，而不是任务的id。为了这个功能，创建一个小函数生成一个“public”版本的任务URI返回：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">url_for</span>


<span class="k">def</span> <span class="nf">make_public_task</span><span class="p">(</span><span class="n">task</span><span class="p">):</span>
    <span class="n">new_task</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">task</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">field</span> <span class="o">==</span> <span class="s1">&#39;id&#39;</span><span class="p">:</span>
            <span class="n">new_task</span><span class="p">[</span><span class="s1">&#39;uri&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;get_task&#39;</span><span class="p">,</span> <span class="n">task_id</span><span class="o">=</span><span class="n">task</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">_external</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_task</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">task</span><span class="p">[</span><span class="n">field</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">new_task</span>
</pre></div>
</div>
<p>这里所有做的事情就是从我们数据库中取出任务并且创建一个新的任务，这个任务的
id 字段被替换成通过 Flask 的 url_for 生成的 uri 字段。</p>
<p>当我们返回所有的任务列表的时候，在发送到客户端之前通过这个函数进行处理:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/todo/api/v1.0/tasks&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">get_tasks</span><span class="p">():</span>
    <span class="c1"># return jsonify({&#39;tasks&#39;: list(map(make_public_task, tasks))})</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;tasks&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">make_public_task</span><span class="p">(</span><span class="n">task</span><span class="p">)</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">]})</span>
</pre></div>
</div>
<p>这里就是客户端获取任务列表的时候得到的数据:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ curl -i http://localhost:5000/todo/api/v1.0/tasks
HTTP/1.1 <span class="m">200</span> OK
Server: Werkzeug/2.2.2 Python/3.8.8
Date: Mon, <span class="m">05</span> Sep <span class="m">2022</span> <span class="m">07</span>:26:33 GMT
Content-Type: application/json
Content-Length: <span class="m">400</span>
Connection: close

<span class="o">{</span>
  <span class="s2">&quot;tasks&quot;</span>: <span class="o">[</span>
    <span class="o">{</span>
      <span class="s2">&quot;description&quot;</span>: <span class="s2">&quot;Milk, Cheese, Pizza, Fruit, Tylenol&quot;</span>,
      <span class="s2">&quot;done&quot;</span>: false,
      <span class="s2">&quot;title&quot;</span>: <span class="s2">&quot;Buy groceries&quot;</span>,
      <span class="s2">&quot;uri&quot;</span>: <span class="s2">&quot;http://localhost:5000/todo/api/v1.0/tasks/1&quot;</span>
    <span class="o">}</span>,
    <span class="o">{</span>
      <span class="s2">&quot;description&quot;</span>: <span class="s2">&quot;Need to find a good Python tutorial on the web&quot;</span>,
      <span class="s2">&quot;done&quot;</span>: false,
      <span class="s2">&quot;title&quot;</span>: <span class="s2">&quot;Learn Python&quot;</span>,
      <span class="s2">&quot;uri&quot;</span>: <span class="s2">&quot;http://localhost:5000/todo/api/v1.0/tasks/2&quot;</span>
    <span class="o">}</span>
  <span class="o">]</span>
<span class="o">}</span>
</pre></div>
</div>
<p>这种办法避免了与其它功能的兼容，拿到的是完整uri而不是一个id。</p>
</section>
<section id="id15">
<h4>5.加强 RESTful web service 的安全性<a class="headerlink" href="#id15" title="Permalink to this headline">¶</a></h4>
<p>我们已经完成了我们 web service 的大部分功能，但是仍然有一个问题。我们的
web service 对任何人都是公开的，这并不是一个好主意。</p>
<p>我们有一个可以管理我们的待办事项完整的 web service，但在当前状态下的 web
service 是开放给所有的客户端。 如果一个陌生人弄清我们的 API
是如何工作的，他或她可以编写一个客户端访问我们的 web service
并且毁坏我们的数据。</p>
<p>大部分初级的教程会忽略这个问题并且到此为止。在我看来这是一个很严重的问题，我必须指出。</p>
<p>确保我们的 web service
安全服务的最简单的方法是要求客户端提供一个用户名和密码。在常规的 web
应用程序会提供一个登录的表单用来认证，并且服务器会创建一个会话为登录的用户以后的操作使用，会话的
id 以 cookie 形式存储在客户端浏览器中。然而 REST 的规则之一就是
“无状态”， 因此我们必须要求客户端在每一次请求中提供认证的信息。</p>
<p>我们一直试着尽可能地坚持 HTTP 标准协议。既然我们需要实现认证我们需要在
HTTP 上下文中去完成，HTTP 协议提供了两种认证机制: <a class="reference external" href="http://www.ietf.org/rfc/rfc2617.txt">Basic 和
Digest</a>。</p>
<p>有一个小的 Flask 扩展能够帮助我们，我们可以先安装 Flask-HTTPAuth:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ flask/bin/pip install flask-httpauth
</pre></div>
</div>
<p>比方说，我们希望我们的 web service 只让访问用户名 miguel 和密码 python
的客户端访问。 我们可以设置一个基本的 HTTP 验证如下:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask_httpauth</span> <span class="kn">import</span> <span class="n">HTTPBasicAuth</span>
<span class="n">auth</span> <span class="o">=</span> <span class="n">HTTPBasicAuth</span><span class="p">()</span>


<span class="nd">@auth</span><span class="o">.</span><span class="n">get_password</span>
<span class="k">def</span> <span class="nf">get_password</span><span class="p">(</span><span class="n">username</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">username</span> <span class="o">==</span> <span class="s1">&#39;admin&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;python&#39;</span>
    <span class="k">return</span> <span class="kc">None</span>


<span class="nd">@auth</span><span class="o">.</span><span class="n">error_handler</span>
<span class="k">def</span> <span class="nf">unauthorized</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Unauthorized access&#39;</span><span class="p">}),</span> <span class="mi">401</span><span class="p">)</span>
</pre></div>
</div>
<p>get_password 函数是一个回调函数，Flask-HTTPAuth
使用它来获取给定用户的密码。在一个更复杂的系统中，这个函数是需要检查一个用户数据库，但是在我们的例子中只有单一的用户因此没有必要。</p>
<p>error_handler
回调函数是用于给客户端发送未授权错误代码。像我们处理其它的错误代码，这里我们定制一个包含
JSON 数据格式而不是 HTML 的响应。</p>
<p>随着认证系统的建立，所剩下的就是把需要认证的函数添加
&#64;auth.login_required 装饰器。例如:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/todo/api/v1.0/tasks&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="nd">@auth</span><span class="o">.</span><span class="n">login_required</span>
<span class="k">def</span> <span class="nf">get_tasks</span><span class="p">():</span>
    <span class="c1"># return jsonify({&#39;tasks&#39;: list(map(make_public_task, tasks))})</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;tasks&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">make_public_task</span><span class="p">(</span><span class="n">task</span><span class="p">)</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">]})</span>
</pre></div>
</div>
<p>如果现在要尝试使用 curl 调用这个函数我们会得到:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ curl -i http://localhost:5000/todo/api/v1.0/tasks
HTTP/1.1 <span class="m">401</span> UNAUTHORIZED
Server: Werkzeug/2.2.2 Python/3.8.8
Date: Mon, <span class="m">05</span> Sep <span class="m">2022</span> <span class="m">07</span>:33:51 GMT
Content-Type: application/json
Content-Length: <span class="m">37</span>
WWW-Authenticate: Basic <span class="nv">realm</span><span class="o">=</span><span class="s2">&quot;Authentication Required&quot;</span>
Connection: close

<span class="o">{</span>
  <span class="s2">&quot;error&quot;</span>: <span class="s2">&quot;Unauthorized access&quot;</span>
<span class="o">}</span>
</pre></div>
</div>
<p>为了能够调用这个函数我们必须发送我们的认证凭据:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ curl -u admin:python -i http://localhost:5000/todo/api/v1.0/tasks
HTTP/1.1 <span class="m">200</span> OK
Server: Werkzeug/2.2.2 Python/3.8.8
Date: Mon, <span class="m">05</span> Sep <span class="m">2022</span> <span class="m">07</span>:34:16 GMT
Content-Type: application/json
Content-Length: <span class="m">400</span>
Connection: close

<span class="o">{</span>
  <span class="s2">&quot;tasks&quot;</span>: <span class="o">[</span>
    <span class="o">{</span>
      <span class="s2">&quot;description&quot;</span>: <span class="s2">&quot;Milk, Cheese, Pizza, Fruit, Tylenol&quot;</span>,
      <span class="s2">&quot;done&quot;</span>: false,
      <span class="s2">&quot;title&quot;</span>: <span class="s2">&quot;Buy groceries&quot;</span>,
      <span class="s2">&quot;uri&quot;</span>: <span class="s2">&quot;http://localhost:5000/todo/api/v1.0/tasks/1&quot;</span>
    <span class="o">}</span>,
    <span class="o">{</span>
      <span class="s2">&quot;description&quot;</span>: <span class="s2">&quot;Need to find a good Python tutorial on the web&quot;</span>,
      <span class="s2">&quot;done&quot;</span>: false,
      <span class="s2">&quot;title&quot;</span>: <span class="s2">&quot;Learn Python&quot;</span>,
      <span class="s2">&quot;uri&quot;</span>: <span class="s2">&quot;http://localhost:5000/todo/api/v1.0/tasks/2&quot;</span>
    <span class="o">}</span>
  <span class="o">]</span>
<span class="o">}</span>
</pre></div>
</div>
<p>认证扩展给予我们很大的自由选择哪些函数需要保护，哪些函数需要公开。</p>
<p>为了确保登录信息的安全应该使用 HTTP 安全服务器(例如:
<a class="reference external" href="https:">https://</a>…)，这样客户端和服务器之间的通信都是加密的，以防止传输过程中第三方看到认证的凭据。</p>
<p>让人不舒服的是当请求收到一个 401
的错误，网页浏览都会跳出一个丑陋的登录框，即使请求是在后台发生的。因此如果我们要实现一个完美的
web
服务器的话，我们就需要禁止跳转到浏览器显示身份验证对话框，让我们的客户端应用程序自己处理登录。</p>
<p>一个简单的方式就是不返回 401 错误。403 错误是一个令人青睐的替代，403
错误表示 “禁止” 的错误:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@auth</span><span class="o">.</span><span class="n">error_handler</span>
<span class="k">def</span> <span class="nf">unauthorized</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Unauthorized access&#39;</span><span class="p">}),</span> <span class="mi">403</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="id16">
<h4>6.可能的改进<a class="headerlink" href="#id16" title="Permalink to this headline">¶</a></h4>
<p>我们编写的小型的 web service 还可以在不少的方面进行改进。</p>
<p>对于初学者来说，一个真正的 web service
需要一个真实的数据库进行支撑。我们现在使用的内存数据结构会有很多限制不应该被用于真正的应用。</p>
<p>另外一个可以提高的领域就是处理多用户。如果系统支持多用户的话，不同的客户端可以发送不同的认证凭证获取相应用户的任务列表。在这样一个系统中的话，我们需要第二个资源就是用户。</p>
<p>在用户资源上的 POST 的请求代表注册换一个新用户。</p>
<p>一个 GET 请求表示客户端获取一个用户的信息。</p>
<p>一个 PUT 请求表示更新用户信息，比如可能是更新邮箱地址。</p>
<p>一个 DELETE 请求表示删除用户账号。</p>
<p>GET
检索任务列表请求可以在几个方面进行扩展。首先可以携带一个可选的页的参数，以便客户端请求任务的一部分。另外，这种扩展更加有用：允许按照一定的标准筛选。</p>
<p>比如，用户只想要看到完成的任务，或者只想看到任务的标题以 A
字母开头。所有的这些都可以作为 URL 的一个参数项。</p>
<p>参考文献：</p>
<p><a class="reference external" href="https://blog.miguelgrinberg.com/post/designing-a-restful-api-with-python-and-flask">Designing a RESTful API with Python and
Flask</a></p>
<p><a class="reference external" href="https://www.cnblogs.com/vovlie/p/4178077.html">https://www.cnblogs.com/vovlie/p/4178077.html</a></p>
<p><a class="reference external" href="http://www.pythondoc.com/flask-restful/first.html">http://www.pythondoc.com/flask-restful/first.html</a></p>
<p><a class="reference external" href="https://www.bookstack.cn/read/flask-restful/spilt.8.3b3bb30c584b4b80.md">https://www.bookstack.cn/read/flask-restful/spilt.8.3b3bb30c584b4b80.md</a></p>
</section>
</section>
</section>
<section id="flask-restfulrestful-api">
<h2><a class="toc-backref" href="#id41">4.使用Flask-RESTful设计RESTful API</a><a class="headerlink" href="#flask-restfulrestful-api" title="Permalink to this headline">¶</a></h2>
<p>前面我已经用 Flask 实现了一个 RESTful 服务器。今天我们将会使用
Flask-RESTful 来实现同一个 RESTful 服务器，Flask-RESTful 是一个可以简化
APIs 的构建的 Flask 扩展。</p>
<section id="restful">
<h3><a class="toc-backref" href="#id42">1.RESTful 服务器</a><a class="headerlink" href="#restful" title="Permalink to this headline">¶</a></h3>
<p>作为一个提醒， 这里就是待完成事项列表 web service 所提供的方法的定义:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">==========</span>  <span class="o">===============================================</span>  <span class="o">=============================</span>
<span class="n">HTTP</span> <span class="n">方法</span>   <span class="n">URL</span>                                              <span class="n">动作</span>
<span class="o">==========</span>  <span class="o">===============================================</span>  <span class="o">==============================</span>
<span class="n">GET</span>         <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="p">[</span><span class="n">hostname</span><span class="p">]</span><span class="o">/</span><span class="n">todo</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">v1</span><span class="o">.</span><span class="mi">0</span><span class="o">/</span><span class="n">tasks</span>            <span class="n">检索任务列表</span>
<span class="n">GET</span>         <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="p">[</span><span class="n">hostname</span><span class="p">]</span><span class="o">/</span><span class="n">todo</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">v1</span><span class="o">.</span><span class="mi">0</span><span class="o">/</span><span class="n">tasks</span><span class="o">/</span><span class="p">[</span><span class="n">task_id</span><span class="p">]</span>  <span class="n">检索某个任务</span>
<span class="n">POST</span>        <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="p">[</span><span class="n">hostname</span><span class="p">]</span><span class="o">/</span><span class="n">todo</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">v1</span><span class="o">.</span><span class="mi">0</span><span class="o">/</span><span class="n">tasks</span>            <span class="n">创建新任务</span>
<span class="n">PUT</span>         <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="p">[</span><span class="n">hostname</span><span class="p">]</span><span class="o">/</span><span class="n">todo</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">v1</span><span class="o">.</span><span class="mi">0</span><span class="o">/</span><span class="n">tasks</span><span class="o">/</span><span class="p">[</span><span class="n">task_id</span><span class="p">]</span>  <span class="n">更新任务</span>
<span class="n">DELETE</span>      <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="p">[</span><span class="n">hostname</span><span class="p">]</span><span class="o">/</span><span class="n">todo</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">v1</span><span class="o">.</span><span class="mi">0</span><span class="o">/</span><span class="n">tasks</span><span class="o">/</span><span class="p">[</span><span class="n">task_id</span><span class="p">]</span>  <span class="n">删除任务</span>
<span class="o">==========</span>  <span class="o">================================================</span> <span class="o">=============================</span>
</pre></div>
</div>
<p>这个服务唯一的资源叫做“任务”，它有如下一些属性:</p>
<ul class="simple">
<li><p><strong>id</strong>: 任务的唯一标识符。数字类型。</p></li>
<li><p><strong>title</strong>: 简短的任务描述。字符串类型。</p></li>
<li><p><strong>description</strong>: 具体的任务描述。文本类型。</p></li>
<li><p><strong>done</strong>: 任务完成的状态。布尔值。</p></li>
</ul>
<section id="flask-restful">
<h4>1. 安装flask-restful<a class="headerlink" href="#flask-restful" title="Permalink to this headline">¶</a></h4>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ pip install flask_restful
</pre></div>
</div>
<p>安装完成后就可以引入</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask_restful</span> <span class="kn">import</span> <span class="n">Api</span><span class="p">,</span> <span class="n">Resource</span><span class="p">,</span> <span class="n">reqparse</span><span class="p">,</span> <span class="n">abort</span>
</pre></div>
</div>
</section>
</section>
<section id="id17">
<h3><a class="toc-backref" href="#id43">2.路由</a><a class="headerlink" href="#id17" title="Permalink to this headline">¶</a></h3>
<p>在上一遍文章中，我使用了 Flask 的视图函数来定义所有的路由。</p>
<p>Flask-RESTful 提供了一个 Resource 基础类，它能够定义一个给定 URL
的一个或者多个 HTTP 方法。</p>
<p>例如，定义一个可以使用 HTTP 的 GET, PUT 以及 DELETE 方法的 User
资源，你的代码可以如下:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
<span class="kn">from</span> <span class="nn">flask_restful</span> <span class="kn">import</span> <span class="n">Api</span><span class="p">,</span> <span class="n">Resource</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">api</span> <span class="o">=</span> <span class="n">Api</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">UserAPI</span><span class="p">(</span><span class="n">Resource</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
        <span class="k">pass</span>


<span class="n">api</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span><span class="n">UserAPI</span><span class="p">,</span> <span class="s1">&#39;/users/&lt;int:id&gt;&#39;</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="s1">&#39;user&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>add_resource 函数使用指定的 endpoint 注册路由到框架上。</p>
<p>如果没有指定 endpoint，Flask-RESTful
会根据类名生成一个，但是有时候有些函数比如 url_for 需要
endpoint，因此我会明确给 endpoint 赋值。</p>
<p>我的待办事项 API 定义两个 URLs：</p>
<ul class="simple">
<li><p>/todo/api/v1.0/tasks（获取所有任务列表）</p></li>
<li><p>/todo/api/v1.0/tasks/（获取单个任务）。</p></li>
</ul>
<p>我们现在需要两个资源:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
<span class="kn">from</span> <span class="nn">flask_restful</span> <span class="kn">import</span> <span class="n">Api</span><span class="p">,</span> <span class="n">Resource</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">api</span> <span class="o">=</span> <span class="n">Api</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">TaskListAPI</span><span class="p">(</span><span class="n">Resource</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>


<span class="k">class</span> <span class="nc">TaskAPI</span><span class="p">(</span><span class="n">Resource</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
        <span class="k">pass</span>


<span class="n">api</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span><span class="n">TaskListAPI</span><span class="p">,</span> <span class="s1">&#39;/todo/api/v1.0/tasks&#39;</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="s1">&#39;tasks&#39;</span><span class="p">)</span>
<span class="n">api</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span><span class="n">TaskAPI</span><span class="p">,</span> <span class="s1">&#39;/todo/api/v1.0/tasks/&lt;int:id&gt;&#39;</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="s1">&#39;task&#39;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="id18">
<h3><a class="toc-backref" href="#id44">3.解析以及验证请求</a><a class="headerlink" href="#id18" title="Permalink to this headline">¶</a></h3>
<p>当我在以前的文章中实现此服务器的时候，我自己对请求的数据进行验证。例如，在之前版本中如何处理
PUT 的:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/todo/api/v1.0/tasks/&lt;int:task_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;PUT&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">update_task</span><span class="p">(</span><span class="n">task_id</span><span class="p">):</span>
    <span class="n">task</span> <span class="o">=</span> <span class="p">[</span><span class="n">task</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasks</span> <span class="k">if</span> <span class="n">task</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">task_id</span><span class="p">]</span>
    <span class="c1"># task = list(filter(lambda t: t[&#39;id&#39;] == task_id, tasks))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">task</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">abort</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">:</span>
        <span class="n">abort</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;title&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">])</span> <span class="o">!=</span> <span class="s2">&quot;unicode&quot;</span><span class="p">:</span>
        <span class="n">abort</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;description&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">])</span> <span class="o">!=</span> <span class="s2">&quot;unicode&quot;</span><span class="p">:</span>
        <span class="n">abort</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;done&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s1">&#39;done&#39;</span><span class="p">])</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">abort</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span>
    <span class="n">task</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="n">task</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;title&#39;</span><span class="p">])</span>
    <span class="n">task</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="n">task</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;description&#39;</span><span class="p">])</span>
    <span class="n">task</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;done&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;done&#39;</span><span class="p">,</span> <span class="n">task</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;done&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;task&#39;</span><span class="p">:</span> <span class="n">task</span><span class="p">[</span><span class="mi">0</span><span class="p">]})</span>
</pre></div>
</div>
<p>在这里,
我必须确保请求中给出的数据在使用之前是有效，这样使得函数变得又臭又长。</p>
<p>Flask-RESTful 提供了一个更好的方式来处理数据验证，它叫做 RequestParser
类。</p>
<p>这个类工作方式类似命令行解析工具 argparse。</p>
<p>首先，对于每一个资源需要定义参数以及怎样验证它们:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">jsonify</span><span class="p">,</span> <span class="n">abort</span>
<span class="kn">from</span> <span class="nn">flask_restful</span> <span class="kn">import</span> <span class="n">Api</span><span class="p">,</span> <span class="n">Resource</span><span class="p">,</span> <span class="n">reqparse</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">api</span> <span class="o">=</span> <span class="n">Api</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>

<span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;Buy groceries&#39;</span><span class="p">,</span>
        <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;Milk, Cheese, Pizza, Fruit, Tylenol&#39;</span><span class="p">,</span>
        <span class="s1">&#39;done&#39;</span><span class="p">:</span> <span class="kc">False</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;Learn Python&#39;</span><span class="p">,</span>
        <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;Need to find a good Python tutorial on the web&#39;</span><span class="p">,</span>
        <span class="s1">&#39;done&#39;</span><span class="p">:</span> <span class="kc">False</span>
    <span class="p">}</span>
<span class="p">]</span>

<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">url_for</span>


<span class="k">def</span> <span class="nf">make_public_task</span><span class="p">(</span><span class="n">task</span><span class="p">):</span>
    <span class="n">new_task</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">task</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">field</span> <span class="o">==</span> <span class="s1">&#39;id&#39;</span><span class="p">:</span>
            <span class="n">new_task</span><span class="p">[</span><span class="s1">&#39;uri&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;get_task&#39;</span><span class="p">,</span> <span class="n">task_id</span><span class="o">=</span><span class="n">task</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">_external</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_task</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">task</span><span class="p">[</span><span class="n">field</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">new_task</span>


<span class="k">class</span> <span class="nc">TaskListAPI</span><span class="p">(</span><span class="n">Resource</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reqparse</span> <span class="o">=</span> <span class="n">reqparse</span><span class="o">.</span><span class="n">RequestParser</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reqparse</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">help</span><span class="o">=</span><span class="s1">&#39;No task title provided&#39;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="s1">&#39;json&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reqparse</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="s1">&#39;json&#39;</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TaskListAPI</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

    <span class="c1"># 检索任务列表</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="c1"># 创建新任务</span>
    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>


<span class="k">class</span> <span class="nc">TaskAPI</span><span class="p">(</span><span class="n">Resource</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reqparse</span> <span class="o">=</span> <span class="n">reqparse</span><span class="o">.</span><span class="n">RequestParser</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reqparse</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="s1">&#39;json&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reqparse</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="s1">&#39;json&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reqparse</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;done&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="s1">&#39;json&#39;</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TaskAPI</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

    <span class="c1"># 检索某个任务</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="c1"># 更新任务</span>
    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="c1"># 删除任务</span>
    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
        <span class="k">pass</span>


<span class="n">api</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span><span class="n">TaskListAPI</span><span class="p">,</span> <span class="s1">&#39;/todo/api/v1.0/tasks&#39;</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="s1">&#39;tasks&#39;</span><span class="p">)</span>
<span class="n">api</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span><span class="n">TaskAPI</span><span class="p">,</span> <span class="s1">&#39;/todo/api/v1.0/tasks/&lt;int:id&gt;&#39;</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="s1">&#39;task&#39;</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s2">&quot;0.0.0.0&quot;</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>在 TaskListAPI 资源中，POST
方法是唯一接收参数的。参数“标题”是必须的，因此我定义一个缺少“标题”的错误信息。当客户端缺少这个参数的时候，Flask-RESTful
将会把这个错误信息作为响应发送给客户端。</p>
<p>“描述”字段是可选的，当缺少这个字段的时候，默认的空字符串将会被使用。</p>
<p>一个有趣的方面就是 RequestParser 类默认情况下在 request.values
中查找参数，因此 location 可选参数必须被设置以表明请求过来的参数是
request.json 格式的。</p>
<p>TaskAPI 资源的参数处理是同样的方式，但是有少许不同。PUT
方法需要解析参数，并且这个方法的所有参数都是可选的。</p>
<p>使用 Flask-RESTful 来处理验证的另一个好处就是没有必要单独地处理类似 HTTP
400 错误，Flask-RESTful 会来处理这些。</p>
</section>
<section id="id19">
<h3><a class="toc-backref" href="#id45">4.生成响应</a><a class="headerlink" href="#id19" title="Permalink to this headline">¶</a></h3>
<p>原来设计的 REST 服务器使用 Flask 的 jsonify 函数来生成响应。</p>
<p>Flask-RESTful 会自动地处理转换成 JSON 数据格式，因此下面的代码需要替换:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;tasks&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">make_public_task</span><span class="p">(</span><span class="n">task</span><span class="p">)</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">]})</span>
</pre></div>
</div>
<p>现在需要写成这样:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">return</span> <span class="p">{</span><span class="s1">&#39;task&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">make_public_task</span><span class="p">(</span><span class="n">task</span><span class="p">)</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">]}</span>
</pre></div>
</div>
<p>Flask-RESTful 也支持自定义状态码，如果有必要的话:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">return</span> <span class="p">{</span><span class="s1">&#39;task&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">make_public_task</span><span class="p">(</span><span class="n">task</span><span class="p">)</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">]},</span> <span class="mi">201</span>
</pre></div>
</div>
<p>Flask-RESTful 还有更多的功能。make_public_task
能够把来自原始服务器上的任务从内部形式包装成客户端想要的外部形式。</p>
<p>最典型的就是把任务的 id 转成 uri。</p>
<p>Flask-RESTful 就提供一个辅助函数能够很优雅地做到这样的转换，不仅仅能够把
id 转成 uri 并且能够转换其他的参数:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask.ext.restful</span> <span class="kn">import</span> <span class="n">fields</span><span class="p">,</span> <span class="n">marshal</span>

<span class="n">task_fields</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">fields</span><span class="o">.</span><span class="n">String</span><span class="p">,</span>
    <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">fields</span><span class="o">.</span><span class="n">String</span><span class="p">,</span>
    <span class="s1">&#39;done&#39;</span><span class="p">:</span> <span class="n">fields</span><span class="o">.</span><span class="n">Boolean</span><span class="p">,</span>
    <span class="s1">&#39;uri&#39;</span><span class="p">:</span> <span class="n">fields</span><span class="o">.</span><span class="n">Url</span><span class="p">(</span><span class="s1">&#39;task&#39;</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">class</span> <span class="nc">TaskAPI</span><span class="p">(</span><span class="n">Resource</span><span class="p">):</span>
    <span class="c1"># ...</span>

    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
        <span class="c1"># ...</span>
        <span class="k">return</span> <span class="p">{</span> <span class="s1">&#39;task&#39;</span><span class="p">:</span> <span class="n">marshal</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">task_fields</span><span class="p">)</span> <span class="p">}</span>
</pre></div>
</div>
<p>task_fields 结构用于作为 marshal 函数的模板。fields.Uri
是一个用于生成一个 URL 的特定的参数。</p>
<p>它需要的参数是 endpoint。</p>
<p>完整代码如下：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">abort</span>
<span class="kn">from</span> <span class="nn">flask_restful</span> <span class="kn">import</span> <span class="n">Api</span><span class="p">,</span> <span class="n">Resource</span><span class="p">,</span> <span class="n">reqparse</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">marshal</span>
<span class="kn">from</span> <span class="nn">flask_httpauth</span> <span class="kn">import</span> <span class="n">HTTPBasicAuth</span>

<span class="n">auth</span> <span class="o">=</span> <span class="n">HTTPBasicAuth</span><span class="p">()</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">api</span> <span class="o">=</span> <span class="n">Api</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>

<span class="n">task_fields</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">fields</span><span class="o">.</span><span class="n">String</span><span class="p">,</span>
    <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">fields</span><span class="o">.</span><span class="n">String</span><span class="p">,</span>
    <span class="s1">&#39;done&#39;</span><span class="p">:</span> <span class="n">fields</span><span class="o">.</span><span class="n">Boolean</span><span class="p">,</span>
    <span class="s1">&#39;uri&#39;</span><span class="p">:</span> <span class="n">fields</span><span class="o">.</span><span class="n">Url</span><span class="p">(</span><span class="s1">&#39;task&#39;</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;Buy groceries&#39;</span><span class="p">,</span>
        <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;Milk, Cheese, Pizza, Fruit, Tylenol&#39;</span><span class="p">,</span>
        <span class="s1">&#39;done&#39;</span><span class="p">:</span> <span class="kc">False</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;Learn Python&#39;</span><span class="p">,</span>
        <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;Need to find a good Python tutorial on the web&#39;</span><span class="p">,</span>
        <span class="s1">&#39;done&#39;</span><span class="p">:</span> <span class="kc">False</span>
    <span class="p">}</span>
<span class="p">]</span>


<span class="k">class</span> <span class="nc">TaskListAPI</span><span class="p">(</span><span class="n">Resource</span><span class="p">):</span>
    <span class="c1"># HTTP 基本身份验</span>
    <span class="c1"># decorators = [auth.login_required]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reqparse</span> <span class="o">=</span> <span class="n">reqparse</span><span class="o">.</span><span class="n">RequestParser</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reqparse</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">help</span><span class="o">=</span><span class="s1">&#39;No task title provided&#39;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="s1">&#39;json&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reqparse</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="s1">&#39;json&#39;</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TaskListAPI</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

    <span class="c1"># 检索任务列表</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># return jsonify({&#39;tasks&#39;: [make_public_task(task) for task in tasks]})</span>

        <span class="c1"># 自定义状态码</span>
        <span class="c1"># return {&#39;task&#39;: marshal(tasks, task_fields)}, 201</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;task&#39;</span><span class="p">:</span> <span class="n">marshal</span><span class="p">(</span><span class="n">tasks</span><span class="p">,</span> <span class="n">task_fields</span><span class="p">)}</span>

    <span class="c1"># 创建新任务</span>
    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span> <span class="ow">or</span> <span class="ow">not</span> <span class="s1">&#39;title&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">:</span>
            <span class="n">abort</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span>
        <span class="n">task</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">tasks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">],</span>
            <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
            <span class="s1">&#39;done&#39;</span><span class="p">:</span> <span class="kc">False</span>
        <span class="p">}</span>
        <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;task&#39;</span><span class="p">:</span> <span class="n">marshal</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">task_fields</span><span class="p">)}</span>


<span class="k">class</span> <span class="nc">TaskAPI</span><span class="p">(</span><span class="n">Resource</span><span class="p">):</span>
    <span class="c1"># HTTP 基本身份验</span>
    <span class="c1"># decorators = [auth.login_required]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reqparse</span> <span class="o">=</span> <span class="n">reqparse</span><span class="o">.</span><span class="n">RequestParser</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reqparse</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="s1">&#39;json&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reqparse</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="s1">&#39;json&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reqparse</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;done&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="s1">&#39;json&#39;</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TaskAPI</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

    <span class="c1"># 检索某个任务</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
        <span class="n">task</span> <span class="o">=</span> <span class="p">[</span><span class="n">task</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasks</span> <span class="k">if</span> <span class="n">task</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="nb">id</span><span class="p">]</span>
        <span class="c1"># task = list(filter(lambda t: t[&#39;id&#39;] == task_id, tasks))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">task</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">abort</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;task&#39;</span><span class="p">:</span> <span class="n">marshal</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">task_fields</span><span class="p">)}</span>

    <span class="c1"># 更新任务</span>
    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
        <span class="n">task</span> <span class="o">=</span> <span class="p">[</span><span class="n">task</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasks</span> <span class="k">if</span> <span class="n">task</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="nb">id</span><span class="p">]</span>
        <span class="c1"># task = list(filter(lambda t: t[&#39;id&#39;] == id, tasks))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">task</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">abort</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">task</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># print(task)</span>
        <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reqparse</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">task</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;task&#39;</span><span class="p">:</span> <span class="n">marshal</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">task_fields</span><span class="p">)}</span>
        <span class="c1"># return jsonify({&#39;task&#39;: make_public_task(task)})</span>

    <span class="c1"># 删除任务</span>
    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
        <span class="n">task</span> <span class="o">=</span> <span class="p">[</span><span class="n">task</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasks</span> <span class="k">if</span> <span class="n">task</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="nb">id</span><span class="p">]</span>
        <span class="c1"># task = list(filter(lambda t: t[&#39;id&#39;] == id, tasks))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">task</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">abort</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
        <span class="n">tasks</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">task</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>


<span class="n">api</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span><span class="n">TaskListAPI</span><span class="p">,</span> <span class="s1">&#39;/todo/api/v1.0/tasks&#39;</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="s1">&#39;tasks&#39;</span><span class="p">)</span>
<span class="n">api</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span><span class="n">TaskAPI</span><span class="p">,</span> <span class="s1">&#39;/todo/api/v1.0/tasks/&lt;int:id&gt;&#39;</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="s1">&#39;task&#39;</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s2">&quot;0.0.0.0&quot;</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>调用 curl 请求的结果如下:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># 检索任务列表</span>
$ curl -i http://localhost:5000/todo/api/v1.0/tasks
HTTP/1.1 <span class="m">200</span> OK
Server: Werkzeug/2.2.2 Python/3.8.8
Date: Mon, <span class="m">05</span> Sep <span class="m">2022</span> <span class="m">08</span>:56:25 GMT
Content-Type: application/json
Content-Length: <span class="m">425</span>
Connection: close

<span class="o">{</span>
    <span class="s2">&quot;task&quot;</span>: <span class="o">[</span>
        <span class="o">{</span>
            <span class="s2">&quot;title&quot;</span>: <span class="s2">&quot;Buy groceries&quot;</span>,
            <span class="s2">&quot;description&quot;</span>: <span class="s2">&quot;Milk, Cheese, Pizza, Fruit, Tylenol&quot;</span>,
            <span class="s2">&quot;done&quot;</span>: false,
            <span class="s2">&quot;uri&quot;</span>: <span class="s2">&quot;/todo/api/v1.0/tasks/1&quot;</span>
        <span class="o">}</span>,
        <span class="o">{</span>
            <span class="s2">&quot;title&quot;</span>: <span class="s2">&quot;Learn Python&quot;</span>,
            <span class="s2">&quot;description&quot;</span>: <span class="s2">&quot;Need to find a good Python tutorial on the web&quot;</span>,
            <span class="s2">&quot;done&quot;</span>: false,
            <span class="s2">&quot;uri&quot;</span>: <span class="s2">&quot;/todo/api/v1.0/tasks/2&quot;</span>
        <span class="o">}</span>
    <span class="o">]</span>
<span class="o">}</span>



<span class="c1"># 创建新任务</span>
$ curl -i -H <span class="s2">&quot;Content-Type: application/json&quot;</span> -X POST -d <span class="s1">&#39;{&quot;title&quot;:&quot;Read a book&quot;}&#39;</span> http://localhost:5000/todo/api/v1.0/tasks
HTTP/1.1 <span class="m">200</span> OK
Server: Werkzeug/2.2.2 Python/3.8.8
Date: Mon, <span class="m">05</span> Sep <span class="m">2022</span> <span class="m">08</span>:56:44 GMT
Content-Type: application/json
Content-Length: <span class="m">146</span>
Connection: close

<span class="o">{</span>
    <span class="s2">&quot;task&quot;</span>: <span class="o">{</span>
        <span class="s2">&quot;title&quot;</span>: <span class="s2">&quot;Read a book&quot;</span>,
        <span class="s2">&quot;description&quot;</span>: <span class="s2">&quot;&quot;</span>,
        <span class="s2">&quot;done&quot;</span>: false,
        <span class="s2">&quot;uri&quot;</span>: <span class="s2">&quot;/todo/api/v1.0/tasks/3&quot;</span>
    <span class="o">}</span>
<span class="o">}</span>



<span class="c1"># 检索某个任务</span>
$ curl -i http://localhost:5000/todo/api/v1.0/tasks/1
HTTP/1.1 <span class="m">200</span> OK
Server: Werkzeug/2.2.2 Python/3.8.8
Date: Mon, <span class="m">05</span> Sep <span class="m">2022</span> <span class="m">08</span>:57:03 GMT
Content-Type: application/json
Content-Length: <span class="m">219</span>
Connection: close

<span class="o">{</span>
    <span class="s2">&quot;task&quot;</span>: <span class="o">[</span>
        <span class="o">{</span>
            <span class="s2">&quot;title&quot;</span>: <span class="s2">&quot;Buy groceries&quot;</span>,
            <span class="s2">&quot;description&quot;</span>: <span class="s2">&quot;Milk, Cheese, Pizza, Fruit, Tylenol&quot;</span>,
            <span class="s2">&quot;done&quot;</span>: false,
            <span class="s2">&quot;uri&quot;</span>: <span class="s2">&quot;/todo/api/v1.0/tasks/1&quot;</span>
        <span class="o">}</span>
    <span class="o">]</span>
<span class="o">}</span>

<span class="c1"># 更新任务</span>
$ curl -i -H <span class="s2">&quot;Content-Type: application/json&quot;</span> -X PUT -d <span class="s1">&#39;{&quot;done&quot;:true}&#39;</span> http://localhost:5000/todo/api/v1.0/tasks/2
HTTP/1.1 <span class="m">200</span> OK
Server: Werkzeug/2.2.2 Python/3.8.8
Date: Mon, <span class="m">05</span> Sep <span class="m">2022</span> <span class="m">09</span>:15:12 GMT
Content-Type: application/json
Content-Length: <span class="m">192</span>
Connection: close

<span class="o">{</span>
    <span class="s2">&quot;task&quot;</span>: <span class="o">{</span>
        <span class="s2">&quot;title&quot;</span>: <span class="s2">&quot;Learn Python&quot;</span>,
        <span class="s2">&quot;description&quot;</span>: <span class="s2">&quot;Need to find a good Python tutorial on the web&quot;</span>,
        <span class="s2">&quot;done&quot;</span>: true,
        <span class="s2">&quot;uri&quot;</span>: <span class="s2">&quot;/todo/api/v1.0/tasks/2&quot;</span>
    <span class="o">}</span>
<span class="o">}</span>


<span class="c1"># 删除任务</span>
$ curl -i -X DELETE http://localhost:5000/todo/api/v1.0/tasks/3
HTTP/1.1 <span class="m">200</span> OK
Server: Werkzeug/2.2.2 Python/3.8.8
Date: Mon, <span class="m">05</span> Sep <span class="m">2022</span> <span class="m">09</span>:17:30 GMT
Content-Type: application/json
Content-Length: <span class="m">23</span>
Connection: close

<span class="o">{</span>
    <span class="s2">&quot;result&quot;</span>: <span class="nb">true</span>
<span class="o">}</span>
</pre></div>
</div>
</section>
<section id="id20">
<h3><a class="toc-backref" href="#id46">5.认证</a><a class="headerlink" href="#id20" title="Permalink to this headline">¶</a></h3>
<p>在 REST 服务器中的路由都是由 HTTP
基本身份验证保护着。在最初的那个服务器是通过使用 Flask-HTTPAuth
扩展来实现的。</p>
<p>因为 Resouce 类是继承自 Flask 的 MethodView，它能够通过定义 decorators
变量并且把装饰器赋予给它:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask.ext.httpauth</span> <span class="kn">import</span> <span class="n">HTTPBasicAuth</span>
<span class="c1"># ...</span>
<span class="n">auth</span> <span class="o">=</span> <span class="n">HTTPBasicAuth</span><span class="p">()</span>
<span class="c1"># ...</span>

<span class="k">class</span> <span class="nc">TaskAPI</span><span class="p">(</span><span class="n">Resource</span><span class="p">):</span>
    <span class="c1"># HTTP 基本身份验</span>
    <span class="n">decorators</span> <span class="o">=</span> <span class="p">[</span><span class="n">auth</span><span class="o">.</span><span class="n">login_required</span><span class="p">]</span>
    <span class="c1"># ...</span>

<span class="k">class</span> <span class="nc">TaskAPI</span><span class="p">(</span><span class="n">Resource</span><span class="p">):</span>
    <span class="c1"># HTTP 基本身份验</span>
    <span class="n">decorators</span> <span class="o">=</span> <span class="p">[</span><span class="n">auth</span><span class="o">.</span><span class="n">login_required</span><span class="p">]</span>
    <span class="c1"># ...</span>
</pre></div>
</div>
</section>
<section id="id21">
<h3><a class="toc-backref" href="#id47">6.在flask-restful中添加日志</a><a class="headerlink" href="#id21" title="Permalink to this headline">¶</a></h3>
<p>在<code class="docutils literal notranslate"><span class="pre">flask-restful</span></code>中，<code class="docutils literal notranslate"><span class="pre">logger</span></code>的使用有更优雅的方式，来看示例</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">abort</span>
<span class="kn">from</span> <span class="nn">flask_restful</span> <span class="kn">import</span> <span class="n">Api</span><span class="p">,</span> <span class="n">Resource</span><span class="p">,</span> <span class="n">reqparse</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">marshal</span>
<span class="kn">from</span> <span class="nn">flask_httpauth</span> <span class="kn">import</span> <span class="n">HTTPBasicAuth</span>
<span class="kn">import</span> <span class="nn">logging.config</span>

<span class="n">logging</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">dictConfig</span><span class="p">(</span>
    <span class="p">{</span>
        <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s2">&quot;disable_existing_loggers&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;formatters&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;simple&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;format&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">%(asctime)s</span><span class="s2"> - </span><span class="si">%(name)s</span><span class="s2"> - </span><span class="si">%(levelname)s</span><span class="s2"> - </span><span class="si">%(message)s</span><span class="s2">&quot;</span><span class="p">}</span>
        <span class="p">},</span>
        <span class="s2">&quot;handlers&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;console&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;class&quot;</span><span class="p">:</span> <span class="s2">&quot;logging.StreamHandler&quot;</span><span class="p">,</span>
                <span class="s2">&quot;level&quot;</span><span class="p">:</span> <span class="s2">&quot;DEBUG&quot;</span><span class="p">,</span>
                <span class="s2">&quot;formatter&quot;</span><span class="p">:</span> <span class="s2">&quot;simple&quot;</span><span class="p">,</span>
                <span class="s2">&quot;stream&quot;</span><span class="p">:</span> <span class="s2">&quot;ext://sys.stdout&quot;</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s2">&quot;info_file_handler&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;class&quot;</span><span class="p">:</span> <span class="s2">&quot;logging.handlers.RotatingFileHandler&quot;</span><span class="p">,</span>
                <span class="s2">&quot;level&quot;</span><span class="p">:</span> <span class="s2">&quot;INFO&quot;</span><span class="p">,</span>
                <span class="s2">&quot;formatter&quot;</span><span class="p">:</span> <span class="s2">&quot;simple&quot;</span><span class="p">,</span>
                <span class="s2">&quot;filename&quot;</span><span class="p">:</span> <span class="s2">&quot;info.log&quot;</span><span class="p">,</span>
                <span class="s2">&quot;maxBytes&quot;</span><span class="p">:</span> <span class="mi">10485760</span><span class="p">,</span>
                <span class="s2">&quot;backupCount&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
                <span class="s2">&quot;encoding&quot;</span><span class="p">:</span> <span class="s2">&quot;utf8&quot;</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s2">&quot;error_file_handler&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;class&quot;</span><span class="p">:</span> <span class="s2">&quot;logging.handlers.RotatingFileHandler&quot;</span><span class="p">,</span>
                <span class="s2">&quot;level&quot;</span><span class="p">:</span> <span class="s2">&quot;ERROR&quot;</span><span class="p">,</span>
                <span class="s2">&quot;formatter&quot;</span><span class="p">:</span> <span class="s2">&quot;simple&quot;</span><span class="p">,</span>
                <span class="s2">&quot;filename&quot;</span><span class="p">:</span> <span class="s2">&quot;errors.log&quot;</span><span class="p">,</span>
                <span class="s2">&quot;maxBytes&quot;</span><span class="p">:</span> <span class="mi">10485760</span><span class="p">,</span>
                <span class="s2">&quot;backupCount&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
                <span class="s2">&quot;encoding&quot;</span><span class="p">:</span> <span class="s2">&quot;utf8&quot;</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s2">&quot;debug_file_handler&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;class&quot;</span><span class="p">:</span> <span class="s2">&quot;logging.handlers.RotatingFileHandler&quot;</span><span class="p">,</span>
                <span class="s2">&quot;level&quot;</span><span class="p">:</span> <span class="s2">&quot;DEBUG&quot;</span><span class="p">,</span>
                <span class="s2">&quot;formatter&quot;</span><span class="p">:</span> <span class="s2">&quot;simple&quot;</span><span class="p">,</span>
                <span class="s2">&quot;filename&quot;</span><span class="p">:</span> <span class="s2">&quot;debug.log&quot;</span><span class="p">,</span>
                <span class="s2">&quot;maxBytes&quot;</span><span class="p">:</span> <span class="mi">10485760</span><span class="p">,</span>
                <span class="s2">&quot;backupCount&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
                <span class="s2">&quot;encoding&quot;</span><span class="p">:</span> <span class="s2">&quot;utf8&quot;</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">},</span>
        <span class="s2">&quot;loggers&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;my_module&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;level&quot;</span><span class="p">:</span> <span class="s2">&quot;ERROR&quot;</span><span class="p">,</span> <span class="s2">&quot;handlers&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;console&quot;</span><span class="p">],</span> <span class="s2">&quot;propagate&quot;</span><span class="p">:</span> <span class="s2">&quot;no&quot;</span><span class="p">}</span>
        <span class="p">},</span>
        <span class="s2">&quot;root&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;level&quot;</span><span class="p">:</span> <span class="s2">&quot;DEBUG&quot;</span><span class="p">,</span>
            <span class="s2">&quot;handlers&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;error_file_handler&quot;</span><span class="p">,</span> <span class="s2">&quot;debug_file_handler&quot;</span><span class="p">],</span>
        <span class="p">},</span>
    <span class="p">}</span>
<span class="p">)</span>

<span class="n">auth</span> <span class="o">=</span> <span class="n">HTTPBasicAuth</span><span class="p">()</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">api</span> <span class="o">=</span> <span class="n">Api</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">default_mediatype</span><span class="o">=</span><span class="s2">&quot;application/json&quot;</span><span class="p">)</span>

<span class="n">task_fields</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">fields</span><span class="o">.</span><span class="n">String</span><span class="p">,</span>
    <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">fields</span><span class="o">.</span><span class="n">String</span><span class="p">,</span>
    <span class="s1">&#39;done&#39;</span><span class="p">:</span> <span class="n">fields</span><span class="o">.</span><span class="n">Boolean</span><span class="p">,</span>
    <span class="s1">&#39;uri&#39;</span><span class="p">:</span> <span class="n">fields</span><span class="o">.</span><span class="n">Url</span><span class="p">(</span><span class="s1">&#39;task&#39;</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;Buy groceries&#39;</span><span class="p">,</span>
        <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;Milk, Cheese, Pizza, Fruit, Tylenol&#39;</span><span class="p">,</span>
        <span class="s1">&#39;done&#39;</span><span class="p">:</span> <span class="kc">False</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;Learn Python&#39;</span><span class="p">,</span>
        <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;Need to find a good Python tutorial on the web&#39;</span><span class="p">,</span>
        <span class="s1">&#39;done&#39;</span><span class="p">:</span> <span class="kc">False</span>
    <span class="p">}</span>
<span class="p">]</span>


<span class="k">class</span> <span class="nc">TaskListAPI</span><span class="p">(</span><span class="n">Resource</span><span class="p">):</span>
    <span class="c1"># HTTP 基本身份验</span>
    <span class="c1"># decorators = [auth.login_required]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">kargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;logger&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reqparse</span> <span class="o">=</span> <span class="n">reqparse</span><span class="o">.</span><span class="n">RequestParser</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reqparse</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;No task title provided&#39;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="s1">&#39;json&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reqparse</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="s1">&#39;json&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reqparse</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TaskListAPI</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

    <span class="c1"># 检索任务列表</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># return jsonify({&#39;tasks&#39;: [make_public_task(task) for task in tasks]})</span>

        <span class="c1"># 自定义状态码</span>
        <span class="c1"># return {&#39;task&#39;: marshal(tasks, task_fields)}, 201</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;task&#39;</span><span class="p">:</span> <span class="n">marshal</span><span class="p">(</span><span class="n">tasks</span><span class="p">,</span> <span class="n">task_fields</span><span class="p">)}</span>

    <span class="c1"># 创建新任务</span>
    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span> <span class="ow">or</span> <span class="ow">not</span> <span class="s1">&#39;title&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">:</span>
            <span class="n">abort</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span>
        <span class="n">task</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">tasks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">],</span>
            <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
            <span class="s1">&#39;done&#39;</span><span class="p">:</span> <span class="kc">False</span>
        <span class="p">}</span>
        <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;task&#39;</span><span class="p">:</span> <span class="n">marshal</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">task_fields</span><span class="p">)}</span>


<span class="k">class</span> <span class="nc">TaskAPI</span><span class="p">(</span><span class="n">Resource</span><span class="p">):</span>
    <span class="c1"># HTTP 基本身份验</span>
    <span class="c1"># decorators = [auth.login_required]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">kargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;logger&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reqparse</span> <span class="o">=</span> <span class="n">reqparse</span><span class="o">.</span><span class="n">RequestParser</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reqparse</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="s1">&#39;json&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reqparse</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="s1">&#39;json&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reqparse</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;done&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="s1">&#39;json&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reqparse</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TaskAPI</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

    <span class="c1"># 检索某个任务</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
        <span class="n">task</span> <span class="o">=</span> <span class="p">[</span><span class="n">task</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasks</span> <span class="k">if</span> <span class="n">task</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="nb">id</span><span class="p">]</span>
        <span class="c1"># task = list(filter(lambda t: t[&#39;id&#39;] == task_id, tasks))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">task</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">abort</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;task&#39;</span><span class="p">:</span> <span class="n">marshal</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">task_fields</span><span class="p">)}</span>

    <span class="c1"># 更新任务</span>
    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
        <span class="n">task</span> <span class="o">=</span> <span class="p">[</span><span class="n">task</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasks</span> <span class="k">if</span> <span class="n">task</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="nb">id</span><span class="p">]</span>
        <span class="c1"># task = list(filter(lambda t: t[&#39;id&#39;] == id, tasks))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">task</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">abort</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">task</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># print(task)</span>
        <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reqparse</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">task</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;task&#39;</span><span class="p">:</span> <span class="n">marshal</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">task_fields</span><span class="p">)}</span>
        <span class="c1"># return jsonify({&#39;task&#39;: make_public_task(task)})</span>

    <span class="c1"># 删除任务</span>
    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
        <span class="n">task</span> <span class="o">=</span> <span class="p">[</span><span class="n">task</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasks</span> <span class="k">if</span> <span class="n">task</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="nb">id</span><span class="p">]</span>
        <span class="c1"># task = list(filter(lambda t: t[&#39;id&#39;] == id, tasks))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">task</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">abort</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
        <span class="n">tasks</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">task</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>


<span class="n">api</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span><span class="n">TaskListAPI</span><span class="p">,</span> <span class="s1">&#39;/todo/api/v1.0/tasks&#39;</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="s1">&#39;tasks&#39;</span><span class="p">,</span>
                 <span class="n">resource_class_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;logger&quot;</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;/TaskListAPI&#39;</span><span class="p">)})</span>

<span class="n">api</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span><span class="n">TaskAPI</span><span class="p">,</span> <span class="s1">&#39;/todo/api/v1.0/tasks/&lt;int:id&gt;&#39;</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="s1">&#39;task&#39;</span><span class="p">,</span>
                 <span class="n">resource_class_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;logger&quot;</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;/TaskAPI&#39;</span><span class="p">)})</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s1">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span> <span class="n">use_reloader</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>我们使用上次用到的<code class="docutils literal notranslate"><span class="pre">dictConfig</span></code>，</p>
<p>主要的区别在于<code class="docutils literal notranslate"><span class="pre">api.add_resource()</span></code>方法中，使用了参数<code class="docutils literal notranslate"><span class="pre">resource_class_kwargs</span></code>，然后在<code class="docutils literal notranslate"><span class="pre">Resource</span></code>子类中的构造函数<code class="docutils literal notranslate"><span class="pre">__init__</span></code>，将日志记录器获取到，后面就可以在各个处理方法中使用了。</p>
<p>再次使用<code class="docutils literal notranslate"><span class="pre">postman</span></code>发起<code class="docutils literal notranslate"><span class="pre">POST</span></code>请求，可以看到<code class="docutils literal notranslate"><span class="pre">debug.log</span></code>是这个样子的</p>
<img alt="../../../_images/image-20220905175349613.png" src="../../../_images/image-20220905175349613.png" />
<p>参考文献：</p>
<p><a class="reference external" href="https://www.yuque.com/keep_running/python/hyegx6#iiVXa">https://www.yuque.com/keep_running/python/hyegx6#iiVXa</a></p>
<p><a class="reference external" href="https://blog.csdn.net/djstavaV/article/details/112261872">https://blog.csdn.net/djstavaV/article/details/112261872</a></p>
</section>
</section>
<section id="id22">
<h2><a class="toc-backref" href="#id48">5. 跨域访问</a><a class="headerlink" href="#id22" title="Permalink to this headline">¶</a></h2>
<section id="id23">
<h3><a class="toc-backref" href="#id49">什么是跨域？</a><a class="headerlink" href="#id23" title="Permalink to this headline">¶</a></h3>
<p>跨域是指，浏览器从服务器<code class="docutils literal notranslate"><span class="pre">A</span></code>获取的静态资源，包括<code class="docutils literal notranslate"><span class="pre">html</span></code>、<code class="docutils literal notranslate"><span class="pre">css</span></code>、<code class="docutils literal notranslate"><span class="pre">javascript</span></code>，然后在<code class="docutils literal notranslate"><span class="pre">javascript</span></code>中通过<code class="docutils literal notranslate"><span class="pre">ajax</span></code>访问服务器<code class="docutils literal notranslate"><span class="pre">B</span></code>的静态资源或请求。</p>
</section>
<section id="cors">
<h3><a class="toc-backref" href="#id50">CORS</a><a class="headerlink" href="#cors" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">w3c</span></code>组织制定了
<code class="docutils literal notranslate"><span class="pre">[Cross</span> <span class="pre">Origin</span> <span class="pre">Resource</span> <span class="pre">Sharing](https://www.w3.org/TR/cors/)</span></code>
的规范，简写为<code class="docutils literal notranslate"><span class="pre">CORS</span></code>，现在这个规范已经被大多数浏览器支持。</p>
<p>使用上面的示例</p>
<p>前端页面<code class="docutils literal notranslate"><span class="pre">index.html</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>&lt;html&gt;
&lt;body&gt;
&lt;button type=&quot;button&quot; onclick=&quot;jump()&quot;&gt;Click Me!&lt;/button&gt;
&lt;script&gt;
    function jump(){
        let xhr = new XMLHttpRequest();
        xhr.open(&#39;GET&#39;, &quot;http://172.16.3.134:5000/todo/api/v1.0/tasks&quot;, true);
        xhr.send();
        xhr.onreadystatechange = processRequest;
        function processRequest(e) {
            if (xhr.readyState == 4 &amp;&amp; xhr.status == 200) {
                let response = JSON.parse(xhr.responseText);
                console.log(response)
            }
        }
    }
&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;
</pre></div>
</div>
<p>我们将<code class="docutils literal notranslate"><span class="pre">index.html</span></code>部署在一台机器上(172.16.3.134)，<code class="docutils literal notranslate"><span class="pre">flask</span></code>应用部署在另一台机器上(172.16.3.134)，然后在浏览器中访问<code class="docutils literal notranslate"><span class="pre">index.html</span></code>，点击页面中的按钮，这时候就会报错了</p>
<img alt="../../../_images/image-20220905175806809.png" src="../../../_images/image-20220905175806809.png" />
</section>
<section id="flaskcors">
<h3><a class="toc-backref" href="#id51">Flask配置cors</a><a class="headerlink" href="#flaskcors" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">CORS</span></code>需要在后端应用中进行配置。在<code class="docutils literal notranslate"><span class="pre">flask</span></code>中，可以使用扩展<code class="docutils literal notranslate"><span class="pre">flask-cors</span></code>，首先安装</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ pip install flask-cors
</pre></div>
</div>
<p>接下来来到<code class="docutils literal notranslate"><span class="pre">app.py</span></code>，导入模块，并将<code class="docutils literal notranslate"><span class="pre">flask</span></code>应用包括起来就可以了，如下</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask_cors</span> <span class="kn">import</span> <span class="n">CORS</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">CORS</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
</pre></div>
</div>
<p>重新启动应用，再次访问<code class="docutils literal notranslate"><span class="pre">index.html</span></code>，这时候，返回的结果就正常了</p>
<img alt="../../../_images/image-20220905180049136.png" src="../../../_images/image-20220905180049136.png" />
</section>
</section>
<section id="model">
<h2><a class="toc-backref" href="#id52">6.模型 Model</a><a class="headerlink" href="#model" title="Permalink to this headline">¶</a></h2>
<p>在Flask Web应用程序中使用原始SQL对数据库执行CRUD操作可能很繁琐。</p>
<p>相反， <strong>SQLAlchemy</strong> ，Python工具包是一个强大的<strong>OR
Mapper</strong>，它为应用程序开发人员提供了SQL的全部功能和灵活性。</p>
<p>Flask-SQLAlchemy是Flask扩展，它将对SQLAlchemy的支持添加到Flask应用程序中。</p>
</section>
<section id="flaskrestful">
<h2><a class="toc-backref" href="#id53">使用 Flask设计RESTful 的认证</a><a class="headerlink" href="#flaskrestful" title="Permalink to this headline">¶</a></h2>
<section id="flask-jwt-extended">
<h3><a class="toc-backref" href="#id54">1. flask-jwt-extended</a><a class="headerlink" href="#flask-jwt-extended" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="https://www.yuque.com/keep_running/python/fnlswf">https://www.yuque.com/keep_running/python/fnlswf</a></p>
<p>使用Flask设计带认证token的RESTful API接口</p>
<p><a class="reference external" href="https://www.cnblogs.com/vovlie/p/4182814.html">https://www.cnblogs.com/vovlie/p/4182814.html</a></p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="02.%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87.html" class="btn btn-neutral float-left" title="23.6.2. 开发环境准备" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../07.Python-Django-Web%E5%85%B8%E5%9E%8B%E6%A8%A1%E5%9D%97%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98/index.html" class="btn btn-neutral float-right" title="23.7. Python-Django-Web典型模块开发实战" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019, huxiaojian.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>